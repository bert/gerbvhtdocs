<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>gerbv: src/drill.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0fba06f62092f0c8d9ff47b96507f331.html">src</a>
  </div>
</div>
<div class="contents">
<h1>drill.c</h1><a href="drill_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * gEDA - GNU Electronic Design Automation</span>
<a name="l00003"></a>00003 <span class="comment"> * drill.c</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 2000-2006 Andreas Andersson</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * $Id$</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00009"></a>00009 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00010"></a>00010 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00011"></a>00011 <span class="comment"> * (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00016"></a>00016 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00019"></a>00019 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00020"></a>00020 <span class="comment"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 
<a name="l00028"></a>00028 <span class="comment">/*</span>
<a name="l00029"></a>00029 <span class="comment"> * 21 Feb 2007 patch for metric drill files:</span>
<a name="l00030"></a>00030 <span class="comment"> * 1) METRIC/INCH commands (partly) parsed to define units of the header</span>
<a name="l00031"></a>00031 <span class="comment"> * 2) units of the header and the program body are independent</span>
<a name="l00032"></a>00032 <span class="comment"> * 3) ICI command parsed in the header</span>
<a name="l00033"></a>00033 <span class="comment"> */</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#endif</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;glib.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;locale.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#ifdef HAVE_STRING_H</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#endif</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;math.h&gt;</span>  <span class="comment">/* pow() */</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#ifdef HAVE_UNISTD_H</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#endif</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="gerbv_8h.html" title="The main header file for the libgerbv library.">gerbv.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="drill_8h.html" title="Header infor for the Excellon drill parsing functions.">drill.h</a>"</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include "<a class="code" href="drill__stats_8h.html" title="Header info to the statistics generating functions for Excellon drill files.">drill_stats.h</a>"</span>
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#include "<a class="code" href="common_8h.html" title="Contains basic defines for debug messages.">common.h</a>"</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="comment">/* DEBUG printing.  #define DEBUG 1 in config.h to use this fcn. */</span>
<a name="l00064"></a>00064 <span class="preprocessor">#define dprintf if(DEBUG) printf</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="preprocessor">#define NOT_IMPL(fd, s) do { \</span>
<a name="l00067"></a>00067 <span class="preprocessor">                             GERB_MESSAGE("Not Implemented:%s\n", s); \</span>
<a name="l00068"></a>00068 <span class="preprocessor">                           } while(0)</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00070"></a>00070 <span class="preprocessor">#define MAXL 200</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="preprocessor">#undef max</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span><span class="preprocessor">#define max(a,b) ((a) &gt; (b) ? (a) : (b))</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor">#undef min</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#define min(a,b) ((a) &lt; (b) ? (a) : (b))</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>
<a name="l00078"></a>00078 <span class="keyword">enum</span> drill_file_section_t {DRILL_NONE, DRILL_HEADER, DRILL_DATA};
<a name="l00079"></a>00079 <span class="keyword">enum</span> drill_coordinate_mode_t {DRILL_MODE_ABSOLUTE, DRILL_MODE_INCREMENTAL};
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="keyword">enum</span> drill_m_code_t {DRILL_M_UNKNOWN, DRILL_M_NOT_IMPLEMENTED,
<a name="l00082"></a>00082                    DRILL_M_END, DRILL_M_ENDREWIND,
<a name="l00083"></a>00083                    DRILL_M_MESSAGE, DRILL_M_LONGMESSAGE,
<a name="l00084"></a>00084                    DRILL_M_HEADER, DRILL_M_ENDHEADER,
<a name="l00085"></a>00085                    DRILL_M_METRIC, DRILL_M_IMPERIAL,
<a name="l00086"></a>00086                    DRILL_M_BEGINPATTERN, DRILL_M_ENDPATTERN,
<a name="l00087"></a>00087                    DRILL_M_CANNEDTEXT, DRILL_M_TIPCHECK,
<a name="l00088"></a>00088                    DRILL_M_METRICHEADER, DRILL_M_IMPERIALHEADER};
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="keyword">enum</span> drill_g_code_t {DRILL_G_ABSOLUTE, DRILL_G_INCREMENTAL,
<a name="l00092"></a>00092                    DRILL_G_ZEROSET, DRILL_G_UNKNOWN,
<a name="l00093"></a>00093                    DRILL_G_ROUT, DRILL_G_DRILL,
<a name="l00094"></a>00094                    DRILL_G_LINEARMOVE, DRILL_G_CWMOVE, DRILL_G_CCWMOVE};
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="keyword">enum</span> number_fmt_t {FMT_00_0000 <span class="comment">/* INCH */</span>,
<a name="l00097"></a>00097                  FMT_000_000 <span class="comment">/* METRIC 6-digit, 1 um */</span>,
<a name="l00098"></a>00098                  FMT_000_00  <span class="comment">/* METRIC 5-digit, 10 um */</span>,
<a name="l00099"></a>00099                  FMT_0000_00 <span class="comment">/* METRIC 6-digit, 10 um */</span>,
<a name="l00100"></a>00100                  FMT_USER    <span class="comment">/* User defined format */</span>};
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 <span class="keyword">typedef</span> <span class="keyword">struct </span>drill_state {
<a name="l00103"></a>00103     <span class="keywordtype">double</span> curr_x;
<a name="l00104"></a>00104     <span class="keywordtype">double</span> curr_y;
<a name="l00105"></a>00105     <span class="keywordtype">int</span> current_tool;
<a name="l00106"></a>00106     <span class="keywordtype">int</span> curr_section;
<a name="l00107"></a>00107     <span class="keywordtype">int</span> coordinate_mode;
<a name="l00108"></a>00108     <span class="keywordtype">double</span> origin_x;
<a name="l00109"></a>00109     <span class="keywordtype">double</span> origin_y;
<a name="l00110"></a>00110     <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce">gerbv_unit_t</a> unit;
<a name="l00111"></a>00111     <span class="comment">/* number_format is used throughout the file itself.</span>
<a name="l00112"></a>00112 <span class="comment"></span>
<a name="l00113"></a>00113 <span class="comment">       header_number_format is used to parse the tool definition C</span>
<a name="l00114"></a>00114 <span class="comment">       codes within the header.  It is fixed to FMT_00_0000 for INCH</span>
<a name="l00115"></a>00115 <span class="comment">       measures, and FMT_000_000 (1 um resolution) for metric</span>
<a name="l00116"></a>00116 <span class="comment">       measures. */</span>
<a name="l00117"></a>00117     <span class="keyword">enum</span> number_fmt_t number_format, header_number_format;
<a name="l00118"></a>00118     <span class="comment">/* Used as a backup when temporarily switching to INCH. */</span>
<a name="l00119"></a>00119     <span class="keyword">enum</span> number_fmt_t backup_number_format;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     <span class="comment">/* 0 means we don't try to autodetect any of the other values */</span>
<a name="l00122"></a>00122     <span class="keywordtype">int</span> autod;
<a name="l00123"></a>00123     
<a name="l00124"></a>00124     <span class="comment">/* in FMT_USER this specifies the number of digits after the decimal </span>
<a name="l00125"></a>00125 <span class="comment">     * place in the file</span>
<a name="l00126"></a>00126 <span class="comment">     */</span>
<a name="l00127"></a>00127     <span class="keywordtype">int</span> decimals;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 } drill_state_t;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="comment">/* Local function prototypes */</span>
<a name="l00132"></a>00132 <span class="keyword">static</span> <span class="keywordtype">int</span> drill_parse_G_code(gerb_file_t *fd, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image);
<a name="l00133"></a>00133 <span class="keyword">static</span> <span class="keywordtype">int</span> drill_parse_M_code(gerb_file_t *fd, drill_state_t *state, 
<a name="l00134"></a>00134                            <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image);
<a name="l00135"></a>00135 <span class="keyword">static</span> <span class="keywordtype">int</span> drill_parse_T_code(gerb_file_t *fd, drill_state_t *state, 
<a name="l00136"></a>00136                            <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image);
<a name="l00137"></a>00137 <span class="keyword">static</span> <span class="keywordtype">void</span> drill_parse_coordinate(gerb_file_t *fd, <span class="keywordtype">char</span> firstchar, 
<a name="l00138"></a>00138                                <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image, drill_state_t *state);
<a name="l00139"></a>00139 <span class="keyword">static</span> drill_state_t *new_state(drill_state_t *state);
<a name="l00140"></a>00140 <span class="keyword">static</span> <span class="keywordtype">double</span> read_double(gerb_file_t *fd, <span class="keyword">enum</span> number_fmt_t fmt, 
<a name="l00141"></a>00141                        <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7">gerbv_omit_zeros_t</a> omit_zeros, <span class="keywordtype">int</span> decimals);
<a name="l00142"></a>00142 <span class="keyword">static</span> <span class="keywordtype">void</span> eat_line(gerb_file_t *fd);
<a name="l00143"></a>00143 <span class="keyword">static</span> <span class="keywordtype">char</span> *get_line(gerb_file_t *fd);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l00146"></a>00146 <span class="comment">/* This is the list of specific attributes a drill file may have from</span>
<a name="l00147"></a>00147 <span class="comment"> * the point of view of parsing it.</span>
<a name="l00148"></a>00148 <span class="comment"> */</span>
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *supression_list[] = {
<a name="l00151"></a>00151     <span class="stringliteral">"None"</span>,
<a name="l00152"></a>00152 <span class="preprocessor">#define SUP_NONE 0</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span>    <span class="stringliteral">"Leading"</span>,
<a name="l00154"></a>00154 <span class="preprocessor">#define SUP_LEAD 1</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>    <span class="stringliteral">"Trailing"</span>,
<a name="l00156"></a>00156 <span class="preprocessor">#define SUP_TRAIL 2</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span>    0
<a name="l00158"></a>00158 };
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *units_list[] = {
<a name="l00161"></a>00161     <span class="stringliteral">"inch"</span>,
<a name="l00162"></a>00162 <span class="preprocessor">#define UNITS_INCH 0</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>    <span class="stringliteral">"mil (1/1000 inch)"</span>,
<a name="l00164"></a>00164 <span class="preprocessor">#define UNITS_MIL 1</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span>    <span class="stringliteral">"mm"</span>,
<a name="l00166"></a>00166 <span class="preprocessor">#define UNITS_MM 2</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>    0
<a name="l00168"></a>00168 };
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 <span class="keyword">static</span> gerbv_HID_Attribute drill_attribute_list[] = {
<a name="l00171"></a>00171     <span class="comment">/* This should be first */</span>
<a name="l00172"></a>00172   {<span class="stringliteral">"Autodetect file format"</span>, <span class="stringliteral">"Try to autodetect the file format"</span>,
<a name="l00173"></a>00173    HID_Boolean, 0, 0, {1, 0, 0}, 0, 0},
<a name="l00174"></a>00174 <span class="preprocessor">#define HA_auto 0</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>
<a name="l00176"></a>00176   {<span class="stringliteral">"zero_supression"</span>, <span class="stringliteral">"Zero supression"</span>,
<a name="l00177"></a>00177    HID_Enum, 0, 0, {0, 0, 0}, supression_list, 0},
<a name="l00178"></a>00178 <span class="preprocessor">#define HA_supression 1</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span>
<a name="l00180"></a>00180   {<span class="stringliteral">"units"</span>, <span class="stringliteral">"Units"</span>,
<a name="l00181"></a>00181    HID_Enum, 0, 0, {0, 0, 0}, units_list, 0},
<a name="l00182"></a>00182 <span class="preprocessor">#define HA_xy_units 2</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>
<a name="l00184"></a>00184 <span class="preprocessor">#if 0</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span>  {<span class="stringliteral">"tool_units"</span>, <span class="stringliteral">"Tool size units"</span>,
<a name="l00186"></a>00186    HID_Enum, 0, 0, {0, 0, 0}, units_list, 0},
<a name="l00187"></a>00187 <span class="preprocessor">#define HA_tool_units 3</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span>
<a name="l00190"></a>00190   {<span class="stringliteral">"digits"</span>, <span class="stringliteral">"Number of digits"</span>,
<a name="l00191"></a>00191    HID_Integer, 0, 20, {5, 0, 0}, 0, 0},
<a name="l00192"></a>00192 <span class="preprocessor">#define HA_digits 3</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span>};
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="keywordtype">void</span>
<a name="l00197"></a>00197 drill_attribute_merge (gerbv_HID_Attribute *dest, <span class="keywordtype">int</span> ndest, gerbv_HID_Attribute *src, <span class="keywordtype">int</span> nsrc)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199     <span class="keywordtype">int</span> i, j;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="comment">/* Here is a brain dead merge algorithm which shold make anyone cringe.</span>
<a name="l00202"></a>00202 <span class="comment">     * Still, it is simple and we won't merge many attributes and not</span>
<a name="l00203"></a>00203 <span class="comment">     * many times either.</span>
<a name="l00204"></a>00204 <span class="comment">     */</span>
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="keywordflow">for</span> (i = 0 ; i &lt; nsrc ; i++) {
<a name="l00207"></a>00207        <span class="comment">/* see if our destination wants this attribute */</span>
<a name="l00208"></a>00208        j = 0;
<a name="l00209"></a>00209        <span class="keywordflow">while</span> (j &lt; ndest &amp;&amp; strcmp (src[i].name, dest[j].name) != 0)
<a name="l00210"></a>00210            j++;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212        <span class="comment">/* if we wanted it and it is the same type, copy it over */</span>
<a name="l00213"></a>00213        <span class="keywordflow">if</span> (j &lt; ndest &amp;&amp; src[i].type == dest[j].type) {
<a name="l00214"></a>00214            dest[j].default_val = src[i].default_val;
<a name="l00215"></a>00215        }
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l00222"></a>00222 <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *
<a name="l00223"></a>00223 parse_drillfile(gerb_file_t *fd, gerbv_HID_Attribute *attr_list, <span class="keywordtype">int</span> n_attr, <span class="keywordtype">int</span> reload)
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225     drill_state_t *state = NULL;
<a name="l00226"></a>00226     <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image = NULL;
<a name="l00227"></a>00227     <a class="code" href="structgerbv__net.html">gerbv_net_t</a> *curr_net = NULL;
<a name="l00228"></a>00228     <span class="keywordtype">int</span> read;
<a name="l00229"></a>00229     <a class="code" href="structgerbv__drill__stats__t.html">gerbv_drill_stats_t</a> *stats;
<a name="l00230"></a>00230     <span class="keywordtype">int</span> i;
<a name="l00231"></a>00231     gchar *tmps;
<a name="l00232"></a>00232     gchar *string;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="comment">/* </span>
<a name="l00235"></a>00235 <span class="comment">     * many locales redefine "." as "," and so on, so sscanf and strtod </span>
<a name="l00236"></a>00236 <span class="comment">     * has problems when reading files using %f format.</span>
<a name="l00237"></a>00237 <span class="comment">     * Fixes bug #1963618 reported by Lorenzo Marcantonio.</span>
<a name="l00238"></a>00238 <span class="comment">     */</span>
<a name="l00239"></a>00239     setlocale(LC_NUMERIC, <span class="stringliteral">"C"</span> );
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <span class="comment">/* Create new image for this layer */</span>
<a name="l00242"></a>00242     dprintf(<span class="stringliteral">"In parse_drillfile, about to create image for this layer\n"</span>);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     image = <a class="code" href="gerb__image_8c.html#a875910d3a77c167893b04b03beb8023" title="Allocate a new gerbv_image structure.">gerbv_create_image</a>(image, <span class="stringliteral">"Excellon Drill File"</span>);
<a name="l00245"></a>00245     <span class="keywordflow">if</span> (image == NULL)
<a name="l00246"></a>00246        GERB_FATAL_ERROR(<span class="stringliteral">"malloc image failed\n"</span>);
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="keywordflow">if</span> (reload &amp;&amp; attr_list != NULL) {
<a name="l00249"></a>00249        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a> = attr_list;
<a name="l00250"></a>00250        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#1d0fa3f31efbb0d88cf8de263ca2f65b">n_attr</a> = n_attr;
<a name="l00251"></a>00251     } <span class="keywordflow">else</span> {
<a name="l00252"></a>00252        <span class="comment">/* Copy in the default attribute list for drill files.  We make a</span>
<a name="l00253"></a>00253 <span class="comment">        * copy here because we will allow per-layer editing of the</span>
<a name="l00254"></a>00254 <span class="comment">        * attributes.</span>
<a name="l00255"></a>00255 <span class="comment">        */</span>
<a name="l00256"></a>00256        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#1d0fa3f31efbb0d88cf8de263ca2f65b">n_attr</a> = <span class="keyword">sizeof</span> (drill_attribute_list) / <span class="keyword">sizeof</span> (drill_attribute_list[0]);
<a name="l00257"></a>00257        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a> = (gerbv_HID_Attribute *) malloc (<span class="keyword">sizeof</span> (drill_attribute_list));
<a name="l00258"></a>00258        <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a> == NULL) {
<a name="l00259"></a>00259            fprintf (stderr, <span class="stringliteral">"%s():  malloc failed\n"</span>, __FUNCTION__);
<a name="l00260"></a>00260            exit (1);
<a name="l00261"></a>00261        }
<a name="l00262"></a>00262        dprintf (<span class="stringliteral">"%s(): New attribute list is %p\n"</span>, __FUNCTION__, image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264        <span class="keywordflow">for</span> (i = 0 ; i &lt; image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#1d0fa3f31efbb0d88cf8de263ca2f65b">n_attr</a> ; i++) {
<a name="l00265"></a>00265            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[i] = drill_attribute_list[i];
<a name="l00266"></a>00266        }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268        <span class="comment">/* now merge any project attributes */</span>
<a name="l00269"></a>00269        drill_attribute_merge (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>, image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#1d0fa3f31efbb0d88cf8de263ca2f65b">n_attr</a>,
<a name="l00270"></a>00270                       attr_list, n_attr);
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272     
<a name="l00273"></a>00273     curr_net = image-&gt;<a class="code" href="structgerbv__image__t.html#4ce3cbd8ab0949d0da18653890184120">netlist</a>;
<a name="l00274"></a>00274     curr_net-&gt;<a class="code" href="structgerbv__net.html#13bb1433bc8ba893ab8d18dc83b3ec0c">layer</a> = image-&gt;<a class="code" href="structgerbv__image__t.html#13fdf9e40c8e6efc8f9eec2ec5e25801">layers</a>;
<a name="l00275"></a>00275     curr_net-&gt;<a class="code" href="structgerbv__net.html#61c550ee3a7c7aeeb4b9d39993f6ded4">state</a> = image-&gt;<a class="code" href="structgerbv__image__t.html#b81e3c6363cf0014970ca1cbcb3182f6">states</a>;
<a name="l00276"></a>00276     image-&gt;<a class="code" href="structgerbv__image__t.html#1989b1e87fa2e8a13cd0ab7fd449a158">layertype</a> = <a class="code" href="gerbv_8h.html#ff1f9c1b35a7164a5d5cc4f15090f40bd998fc87d25a728f35b2e0d9145b64ce">GERBV_LAYERTYPE_DRILL</a>;
<a name="l00277"></a>00277     stats = <a class="code" href="drill__stats_8c.html#ee54e8c844abf30383ba3145415c8cbb" title="Allocates a new drill_stats structure.">gerbv_drill_stats_new</a>();
<a name="l00278"></a>00278     <span class="keywordflow">if</span> (stats == NULL)
<a name="l00279"></a>00279        GERB_FATAL_ERROR(<span class="stringliteral">"malloc stats failed\n"</span>);
<a name="l00280"></a>00280     image-&gt;<a class="code" href="structgerbv__image__t.html#911cb23ad6a1b5e4a10903a761982d89">drill_stats</a> = stats;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="comment">/* Create local state variable to track photoplotter state */</span>
<a name="l00283"></a>00283     state = new_state(state);
<a name="l00284"></a>00284     <span class="keywordflow">if</span> (state == NULL)
<a name="l00285"></a>00285        GERB_FATAL_ERROR(<span class="stringliteral">"malloc state failed\n"</span>);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a> = (<a class="code" href="structgerbv__format.html">gerbv_format_t</a> *)g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structgerbv__format.html">gerbv_format_t</a>));
<a name="l00288"></a>00288     <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a> == NULL)
<a name="l00289"></a>00289        GERB_FATAL_ERROR(<span class="stringliteral">"malloc format failed\n"</span>);
<a name="l00290"></a>00290     memset((<span class="keywordtype">void</span> *)image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structgerbv__format.html">gerbv_format_t</a>));
<a name="l00291"></a>00291     image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7eded2650d44655c6179352efa0437e36">GERBV_OMIT_ZEROS_UNSPECIFIED</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <span class="keywordflow">if</span> (!image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_auto].default_val.int_value) {
<a name="l00295"></a>00295        state-&gt;autod = 0;
<a name="l00296"></a>00296        state-&gt;number_format = FMT_USER;
<a name="l00297"></a>00297        state-&gt;decimals = image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_digits].default_val.int_value;
<a name="l00298"></a>00298        <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_xy_units].default_val.int_value == UNITS_MM)
<a name="l00299"></a>00299            state-&gt;unit = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>;
<a name="l00300"></a>00300        <span class="keywordflow">switch</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_supression].default_val.int_value) {
<a name="l00301"></a>00301        <span class="keywordflow">case</span> SUP_LEAD:
<a name="l00302"></a>00302            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7e564cd07ddda272305088e9e2566b90c">GERBV_OMIT_ZEROS_LEADING</a>;
<a name="l00303"></a>00303            <span class="keywordflow">break</span>;
<a name="l00304"></a>00304            
<a name="l00305"></a>00305        <span class="keywordflow">case</span> SUP_TRAIL:
<a name="l00306"></a>00306            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7085ee95a5b4d68f30e4ab554c9b2e94a">GERBV_OMIT_ZEROS_TRAILING</a>;
<a name="l00307"></a>00307            <span class="keywordflow">break</span>;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309        <span class="keywordflow">default</span>:
<a name="l00310"></a>00310            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c781e4581fe43faf90db0f2cecc84361a3">GERBV_OMIT_ZEROS_EXPLICIT</a>;
<a name="l00311"></a>00311            <span class="keywordflow">break</span>;
<a name="l00312"></a>00312        }
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     dprintf(<span class="stringliteral">"%s():  Starting parsing of drill file\n"</span>, __FUNCTION__);
<a name="l00316"></a>00316     <span class="keywordflow">while</span> ((read = gerb_fgetc(fd)) != EOF) {
<a name="l00317"></a>00317 
<a name="l00318"></a>00318        <span class="keywordflow">switch</span> ((<span class="keywordtype">char</span>) read) {
<a name="l00319"></a>00319        <span class="keywordflow">case</span> <span class="charliteral">';'</span> :
<a name="l00320"></a>00320            <span class="comment">/* Comment found. Eat rest of line */</span>
<a name="l00321"></a>00321            eat_line(fd);
<a name="l00322"></a>00322            <span class="keywordflow">break</span>;
<a name="l00323"></a>00323        <span class="keywordflow">case</span> <span class="charliteral">'D'</span> :
<a name="l00324"></a>00324            gerb_ungetc (fd);
<a name="l00325"></a>00325            tmps = get_line (fd);
<a name="l00326"></a>00326            <span class="keywordflow">if</span> (strcmp (tmps, <span class="stringliteral">"DETECT,ON"</span>) == 0 ||
<a name="l00327"></a>00327               strcmp (tmps, <span class="stringliteral">"DETECT,GERBV_APERTURE_STATE_OFF"</span>) == 0) {
<a name="l00328"></a>00328               gchar *tmps2;
<a name="l00329"></a>00329               gchar *tmps3;
<a name="l00330"></a>00330               <span class="keywordflow">if</span> (strcmp (tmps, <span class="stringliteral">"DETECT,ON"</span>) == 0)
<a name="l00331"></a>00331                   tmps3 = <span class="stringliteral">"ON"</span>;
<a name="l00332"></a>00332               <span class="keywordflow">else</span>
<a name="l00333"></a>00333                   tmps3 = <span class="stringliteral">"GERBV_APERTURE_STATE_OFF"</span>;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335               <span class="comment">/* broken tool detect on/off.  Silently ignored. */</span>
<a name="l00336"></a>00336               <span class="keywordflow">if</span> (stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#2bbf728e3a1dd07cb28948b36a10861f">detect</a>) {
<a name="l00337"></a>00337                   tmps2 = g_strdup_printf (<span class="stringliteral">"%s\n%s"</span>, stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#2bbf728e3a1dd07cb28948b36a10861f">detect</a>, tmps3);
<a name="l00338"></a>00338                   g_free (stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#2bbf728e3a1dd07cb28948b36a10861f">detect</a>);
<a name="l00339"></a>00339               } <span class="keywordflow">else</span> {
<a name="l00340"></a>00340                   tmps2 = g_strdup_printf (<span class="stringliteral">"%s"</span>, tmps3);
<a name="l00341"></a>00341               }
<a name="l00342"></a>00342               stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#2bbf728e3a1dd07cb28948b36a10861f">detect</a> = tmps2;
<a name="l00343"></a>00343            } <span class="keywordflow">else</span> {
<a name="l00344"></a>00344               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Undefined header line = '%s'\n"</span>,tmps);
<a name="l00345"></a>00345               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00346"></a>00346                                   -1,
<a name="l00347"></a>00347                                   <span class="keywordtype">string</span>,
<a name="l00348"></a>00348                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d381c8a82d58481911eecdacbf5ada3de2">GERBV_MESSAGE_NOTE</a>);
<a name="l00349"></a>00349               g_free(<span class="keywordtype">string</span>);
<a name="l00350"></a>00350            }
<a name="l00351"></a>00351            g_free (tmps);
<a name="l00352"></a>00352            <span class="keywordflow">break</span>;
<a name="l00353"></a>00353        <span class="keywordflow">case</span> <span class="charliteral">'F'</span> :
<a name="l00354"></a>00354            gerb_ungetc (fd);
<a name="l00355"></a>00355            tmps = get_line (fd);
<a name="l00356"></a>00356            <span class="comment">/* Silently ignore FMAT,2.  Not sure what others are allowed */</span>
<a name="l00357"></a>00357            <span class="keywordflow">if</span> (strcmp (tmps, <span class="stringliteral">"FMAT,2"</span>) != 0) {
<a name="l00358"></a>00358               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Undefined header line = '%s'\n"</span>,tmps);
<a name="l00359"></a>00359               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00360"></a>00360                                   -1,
<a name="l00361"></a>00361                                   <span class="keywordtype">string</span>,
<a name="l00362"></a>00362                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d381c8a82d58481911eecdacbf5ada3de2">GERBV_MESSAGE_NOTE</a>);
<a name="l00363"></a>00363               g_free(<span class="keywordtype">string</span>);
<a name="l00364"></a>00364            }
<a name="l00365"></a>00365            g_free (tmps);
<a name="l00366"></a>00366            <span class="keywordflow">break</span>;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368        <span class="keywordflow">case</span> <span class="charliteral">'G'</span>:
<a name="l00369"></a>00369            <span class="comment">/* Most G codes aren't used, for now */</span>
<a name="l00370"></a>00370            <span class="keywordflow">switch</span>(drill_parse_G_code(fd, image)) {
<a name="l00371"></a>00371            <span class="keywordflow">case</span> DRILL_G_ROUT :
<a name="l00372"></a>00372               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00373"></a>00373                                   -1,
<a name="l00374"></a>00374                                   <span class="stringliteral">"Rout mode data is not supported\n"</span>,
<a name="l00375"></a>00375                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00376"></a>00376               <span class="keywordflow">break</span>;
<a name="l00377"></a>00377            <span class="keywordflow">case</span> DRILL_G_DRILL :
<a name="l00378"></a>00378               <span class="keywordflow">break</span>;
<a name="l00379"></a>00379            <span class="keywordflow">case</span> DRILL_G_ABSOLUTE :
<a name="l00380"></a>00380               state-&gt;coordinate_mode = DRILL_MODE_ABSOLUTE;
<a name="l00381"></a>00381               <span class="keywordflow">break</span>;
<a name="l00382"></a>00382            <span class="keywordflow">case</span> DRILL_G_INCREMENTAL :
<a name="l00383"></a>00383               state-&gt;coordinate_mode = DRILL_MODE_INCREMENTAL;
<a name="l00384"></a>00384               <span class="keywordflow">break</span>;
<a name="l00385"></a>00385            <span class="keywordflow">case</span> DRILL_G_ZEROSET :
<a name="l00386"></a>00386               <span class="keywordflow">if</span>((read = gerb_fgetc(fd)) == EOF)
<a name="l00387"></a>00387               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00388"></a>00388                                   -1,
<a name="l00389"></a>00389                                   <span class="stringliteral">"Unexpected EOF found.\n"</span>,
<a name="l00390"></a>00390                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00391"></a>00391               drill_parse_coordinate(fd, (<span class="keywordtype">char</span>)read, image, state);
<a name="l00392"></a>00392               state-&gt;origin_x = state-&gt;curr_x;
<a name="l00393"></a>00393               state-&gt;origin_y = state-&gt;curr_y;
<a name="l00394"></a>00394               <span class="keywordflow">break</span>;
<a name="l00395"></a>00395            <span class="keywordflow">default</span> :
<a name="l00396"></a>00396               eat_line(fd);
<a name="l00397"></a>00397               <span class="keywordflow">break</span>;
<a name="l00398"></a>00398            }
<a name="l00399"></a>00399            <span class="keywordflow">break</span>;
<a name="l00400"></a>00400        <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
<a name="l00401"></a>00401           <span class="keywordflow">if</span> (state-&gt;curr_section != DRILL_HEADER) 
<a name="l00402"></a>00402               <span class="keywordflow">break</span>;
<a name="l00403"></a>00403           {
<a name="l00404"></a>00404               <span class="keywordtype">int</span> c = gerb_fgetc(fd);
<a name="l00405"></a>00405               <span class="keywordflow">switch</span> (c) {
<a name="l00406"></a>00406               <span class="keywordflow">case</span> <span class="charliteral">'N'</span>:
<a name="l00407"></a>00407                  <span class="keywordflow">if</span> (<span class="charliteral">'C'</span> == gerb_fgetc(fd)) {
<a name="l00408"></a>00408                      <span class="keywordflow">if</span> (<span class="charliteral">'H'</span> == gerb_fgetc(fd)) {
<a name="l00409"></a>00409                         state-&gt;unit = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce46256f1b4adec6e863e6373f80963126">GERBV_UNIT_INCH</a>;
<a name="l00410"></a>00410                         
<a name="l00411"></a>00411                         <span class="comment">/* Look for TZ/LZ */</span>
<a name="l00412"></a>00412                         <span class="keywordflow">if</span> (<span class="charliteral">','</span> == gerb_fgetc(fd)) {
<a name="l00413"></a>00413                             c = gerb_fgetc(fd);
<a name="l00414"></a>00414                             <span class="keywordflow">if</span> (c != EOF &amp;&amp; <span class="charliteral">'Z'</span> == gerb_fgetc(fd)) {
<a name="l00415"></a>00415                                <span class="keywordflow">switch</span> (c) {
<a name="l00416"></a>00416                                <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
<a name="l00417"></a>00417                                    <span class="keywordflow">if</span> (state-&gt;autod) {
<a name="l00418"></a>00418                                       image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7085ee95a5b4d68f30e4ab554c9b2e94a">GERBV_OMIT_ZEROS_TRAILING</a>;
<a name="l00419"></a>00419                                       state-&gt;header_number_format =
<a name="l00420"></a>00420                                           state-&gt;number_format = FMT_00_0000;
<a name="l00421"></a>00421                                       state-&gt;decimals = 4;
<a name="l00422"></a>00422                                    }
<a name="l00423"></a>00423                                    <span class="keywordflow">break</span>;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425                                <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
<a name="l00426"></a>00426                                    <span class="keywordflow">if</span> (state-&gt;autod) {
<a name="l00427"></a>00427                                       image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7e564cd07ddda272305088e9e2566b90c">GERBV_OMIT_ZEROS_LEADING</a>;
<a name="l00428"></a>00428                                       state-&gt;header_number_format =
<a name="l00429"></a>00429                                           state-&gt;number_format = FMT_00_0000;
<a name="l00430"></a>00430                                       state-&gt;decimals = 4;
<a name="l00431"></a>00431                                    }
<a name="l00432"></a>00432                                    <span class="keywordflow">break</span>;
<a name="l00433"></a>00433                                    
<a name="l00434"></a>00434                                <span class="keywordflow">default</span>:
<a name="l00435"></a>00435                                    drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00436"></a>00436                                                       -1,
<a name="l00437"></a>00437                                                       <span class="stringliteral">"Found junk after INCH command\n"</span>,
<a name="l00438"></a>00438                                                       <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l00439"></a>00439                                    <span class="keywordflow">break</span>;
<a name="l00440"></a>00440                                }
<a name="l00441"></a>00441                             } <span class="keywordflow">else</span> {
<a name="l00442"></a>00442                                drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00443"></a>00443                                                   -1,
<a name="l00444"></a>00444                                                   <span class="stringliteral">"Found junk after INCH command\n"</span>,
<a name="l00445"></a>00445                                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l00446"></a>00446                             }
<a name="l00447"></a>00447                         }
<a name="l00448"></a>00448                      }
<a name="l00449"></a>00449                  }
<a name="l00450"></a>00450                  <span class="keywordflow">break</span>;
<a name="l00451"></a>00451               <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
<a name="l00452"></a>00452                  <span class="keywordflow">if</span> (<span class="charliteral">'I'</span> == gerb_fgetc(fd))
<a name="l00453"></a>00453                  <span class="keywordflow">if</span> (<span class="charliteral">','</span> == gerb_fgetc(fd))
<a name="l00454"></a>00454                  <span class="keywordflow">if</span> (<span class="charliteral">'O'</span> == gerb_fgetc(fd)) {
<a name="l00455"></a>00455                      <span class="keywordflow">if</span> (<span class="charliteral">'N'</span> == (c = gerb_fgetc(fd)))
<a name="l00456"></a>00456                         state-&gt;coordinate_mode = DRILL_MODE_INCREMENTAL;
<a name="l00457"></a>00457                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">'F'</span> == c) <span class="keywordflow">if</span> (<span class="charliteral">'F'</span> == gerb_fgetc(fd))
<a name="l00458"></a>00458                         state-&gt;coordinate_mode = DRILL_MODE_ABSOLUTE;
<a name="l00459"></a>00459                  }
<a name="l00460"></a>00460                  <span class="keywordflow">break</span>;
<a name="l00461"></a>00461               }
<a name="l00462"></a>00462               eat_line(fd);
<a name="l00463"></a>00463           }
<a name="l00464"></a>00464           <span class="keywordflow">break</span>;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466        <span class="keywordflow">case</span> <span class="charliteral">'M'</span>:
<a name="l00467"></a>00467            <span class="keywordflow">switch</span>(drill_parse_M_code(fd, state, image)) {
<a name="l00468"></a>00468            <span class="keywordflow">case</span> DRILL_M_HEADER :
<a name="l00469"></a>00469               state-&gt;curr_section = DRILL_HEADER;
<a name="l00470"></a>00470               <span class="keywordflow">break</span>;
<a name="l00471"></a>00471            <span class="keywordflow">case</span> DRILL_M_ENDHEADER :
<a name="l00472"></a>00472               state-&gt;curr_section = DRILL_DATA;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474               <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> == <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7eded2650d44655c6179352efa0437e36">GERBV_OMIT_ZEROS_UNSPECIFIED</a>) {
<a name="l00475"></a>00475                   <span class="comment">/* Excellon says they default to specify leading</span>
<a name="l00476"></a>00476 <span class="comment">                     zeros, i.e. omit trailing zeros.    The Excellon</span>
<a name="l00477"></a>00477 <span class="comment">                     files floating around that don't specify the</span>
<a name="l00478"></a>00478 <span class="comment">                     leading/trailing zeros in the header seem to</span>
<a name="l00479"></a>00479 <span class="comment">                     contradict to this though.</span>
<a name="l00480"></a>00480 <span class="comment"></span>
<a name="l00481"></a>00481 <span class="comment">                     XXX We should probably ask the user. */</span>
<a name="l00482"></a>00482 
<a name="l00483"></a>00483                   drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00484"></a>00484                                      -1,
<a name="l00485"></a>00485                                      <span class="stringliteral">"End of Excellon header reached but no leading/trailing zero handling specified.\n"</span>,
<a name="l00486"></a>00486                                      <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00487"></a>00487                   drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00488"></a>00488                                      -1,
<a name="l00489"></a>00489                                      <span class="stringliteral">"Assuming leading zeros.\n"</span>,
<a name="l00490"></a>00490                                      <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l00491"></a>00491                   image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7e564cd07ddda272305088e9e2566b90c">GERBV_OMIT_ZEROS_LEADING</a>;
<a name="l00492"></a>00492               }
<a name="l00493"></a>00493               <span class="keywordflow">break</span>;
<a name="l00494"></a>00494            <span class="keywordflow">case</span> DRILL_M_METRIC :
<a name="l00495"></a>00495               <span class="keywordflow">if</span> (state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dcebd4891809b810b7f6d2506e46b6a1859">GERBV_UNIT_UNSPECIFIED</a> &amp;&amp;
<a name="l00496"></a>00496                   state-&gt;curr_section != DRILL_HEADER) {
<a name="l00497"></a>00497                   drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00498"></a>00498                                      -1,
<a name="l00499"></a>00499                                      <span class="stringliteral">"M71 code found but no METRIC specification in header.\n"</span>,
<a name="l00500"></a>00500                                      <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00501"></a>00501                   drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00502"></a>00502                                      -1,
<a name="l00503"></a>00503                                      <span class="stringliteral">"Assuming all tool sizes are MM.\n"</span>,
<a name="l00504"></a>00504                                      <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l00505"></a>00505                   <span class="keywordtype">int</span> tool_num;
<a name="l00506"></a>00506                   <span class="keywordtype">double</span> size;
<a name="l00507"></a>00507                   stats = image-&gt;<a class="code" href="structgerbv__image__t.html#911cb23ad6a1b5e4a10903a761982d89">drill_stats</a>;
<a name="l00508"></a>00508                   <span class="keywordflow">for</span> (tool_num = TOOL_MIN; tool_num &lt; TOOL_MAX; tool_num++) {
<a name="l00509"></a>00509                      <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a> &amp;&amp; image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]) {
<a name="l00510"></a>00510                          <span class="comment">/* First update stats.   Do this before changing drill dias.</span>
<a name="l00511"></a>00511 <span class="comment">                          * Maybe also put error into stats? */</span>
<a name="l00512"></a>00512                          size = image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;parameter[0];
<a name="l00513"></a>00513                          drill_stats_modify_drill_list(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#e8e4149abe4a86c6c1a9f0d82d733275">drill_list</a>, 
<a name="l00514"></a>00514                                                    tool_num, 
<a name="l00515"></a>00515                                                    size, 
<a name="l00516"></a>00516                                                    <span class="stringliteral">"MM"</span>);
<a name="l00517"></a>00517                          <span class="comment">/* Now go back and update all tool dias, since</span>
<a name="l00518"></a>00518 <span class="comment">                          * tools are displayed in inch units</span>
<a name="l00519"></a>00519 <span class="comment">                          */</span>
<a name="l00520"></a>00520                          image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;parameter[0] /= 25.4;
<a name="l00521"></a>00521                      }
<a name="l00522"></a>00522                   }
<a name="l00523"></a>00523               }
<a name="l00524"></a>00524               <span class="keywordflow">if</span> (state-&gt;autod) {
<a name="l00525"></a>00525                   state-&gt;number_format = state-&gt;backup_number_format;
<a name="l00526"></a>00526                   state-&gt;unit = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>;
<a name="l00527"></a>00527               }
<a name="l00528"></a>00528               <span class="keywordflow">break</span>;
<a name="l00529"></a>00529            <span class="keywordflow">case</span> DRILL_M_IMPERIAL :
<a name="l00530"></a>00530               <span class="keywordflow">if</span> (state-&gt;autod) {
<a name="l00531"></a>00531                   <span class="keywordflow">if</span> (state-&gt;number_format != FMT_00_0000)
<a name="l00532"></a>00532                      <span class="comment">/* save metric format definition for later */</span>
<a name="l00533"></a>00533                      state-&gt;backup_number_format = state-&gt;number_format;
<a name="l00534"></a>00534                   state-&gt;number_format = FMT_00_0000;
<a name="l00535"></a>00535                   state-&gt;decimals = 4;
<a name="l00536"></a>00536                   state-&gt;unit = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce46256f1b4adec6e863e6373f80963126">GERBV_UNIT_INCH</a>;
<a name="l00537"></a>00537               }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539               <span class="keywordflow">break</span>;
<a name="l00540"></a>00540            <span class="keywordflow">case</span> DRILL_M_LONGMESSAGE :
<a name="l00541"></a>00541            <span class="keywordflow">case</span> DRILL_M_MESSAGE :
<a name="l00542"></a>00542            <span class="keywordflow">case</span> DRILL_M_CANNEDTEXT :
<a name="l00543"></a>00543               tmps = get_line(fd);
<a name="l00544"></a>00544               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Message embedded in drill file: '%s'\n"</span>, 
<a name="l00545"></a>00545                                     tmps);
<a name="l00546"></a>00546               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00547"></a>00547                                   -1,
<a name="l00548"></a>00548                                   <span class="keywordtype">string</span>,
<a name="l00549"></a>00549                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d381c8a82d58481911eecdacbf5ada3de2">GERBV_MESSAGE_NOTE</a>);
<a name="l00550"></a>00550               g_free(<span class="keywordtype">string</span>);
<a name="l00551"></a>00551               g_free(tmps);
<a name="l00552"></a>00552               <span class="keywordflow">break</span>;
<a name="l00553"></a>00553            <span class="keywordflow">case</span> DRILL_M_NOT_IMPLEMENTED :
<a name="l00554"></a>00554            <span class="keywordflow">case</span> DRILL_M_ENDPATTERN :
<a name="l00555"></a>00555            <span class="keywordflow">case</span> DRILL_M_TIPCHECK :
<a name="l00556"></a>00556               <span class="keywordflow">break</span>;
<a name="l00557"></a>00557            <span class="keywordflow">case</span> DRILL_M_END :
<a name="l00558"></a>00558               <span class="comment">/* M00 has optional arguments */</span>
<a name="l00559"></a>00559               eat_line(fd);
<a name="l00560"></a>00560            <span class="keywordflow">case</span> DRILL_M_ENDREWIND :
<a name="l00561"></a>00561               <span class="keywordflow">goto</span> drill_parse_end;
<a name="l00562"></a>00562               <span class="keywordflow">break</span>;
<a name="l00563"></a>00563            <span class="keywordflow">case</span> DRILL_M_METRICHEADER :
<a name="l00564"></a>00564              state-&gt;unit = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>;
<a name="l00565"></a>00565              <span class="keywordflow">break</span>;
<a name="l00566"></a>00566            <span class="keywordflow">default</span>:
<a name="l00567"></a>00567               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00568"></a>00568                                   -1,
<a name="l00569"></a>00569                                   <span class="stringliteral">"Undefined M code found.\n"</span>,
<a name="l00570"></a>00570                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00571"></a>00571            }
<a name="l00572"></a>00572            <span class="keywordflow">break</span>;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574        <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
<a name="l00575"></a>00575            drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00576"></a>00576                               -1,
<a name="l00577"></a>00577                               <span class="stringliteral">"Drill file sets spindle speed -- ignoring.\n"</span>,
<a name="l00578"></a>00578                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d381c8a82d58481911eecdacbf5ada3de2">GERBV_MESSAGE_NOTE</a>);
<a name="l00579"></a>00579            eat_line(fd);
<a name="l00580"></a>00580            <span class="keywordflow">break</span>;
<a name="l00581"></a>00581        <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
<a name="l00582"></a>00582            drill_parse_T_code(fd, state, image);
<a name="l00583"></a>00583            <span class="keywordflow">break</span>;
<a name="l00584"></a>00584        <span class="keywordflow">case</span> <span class="charliteral">'V'</span> :
<a name="l00585"></a>00585            gerb_ungetc (fd);
<a name="l00586"></a>00586            tmps = get_line (fd);
<a name="l00587"></a>00587            <span class="comment">/* Silently ignore VER,1.  Not sure what others are allowed */</span>
<a name="l00588"></a>00588            <span class="keywordflow">if</span> (strcmp (tmps, <span class="stringliteral">"VER,1"</span>) != 0) {
<a name="l00589"></a>00589               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Undefined header line = '%s'\n"</span>,tmps);
<a name="l00590"></a>00590               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00591"></a>00591                                   -1,
<a name="l00592"></a>00592                                   g_strdup_printf(<span class="stringliteral">"Undefined header line = '%s'\n"</span>,tmps),
<a name="l00593"></a>00593                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d381c8a82d58481911eecdacbf5ada3de2">GERBV_MESSAGE_NOTE</a>);
<a name="l00594"></a>00594               g_free(<span class="keywordtype">string</span>);
<a name="l00595"></a>00595            }
<a name="l00596"></a>00596            g_free (tmps);
<a name="l00597"></a>00597            <span class="keywordflow">break</span>;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599        <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
<a name="l00600"></a>00600        <span class="keywordflow">case</span> <span class="charliteral">'Y'</span>:
<a name="l00601"></a>00601            <span class="comment">/* Hole coordinate found. Do some parsing */</span>
<a name="l00602"></a>00602            drill_parse_coordinate(fd, read, image, state);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604            <span class="comment">/* Add one to drill stats  for the current tool */</span>
<a name="l00605"></a>00605            drill_stats_increment_drill_counter(image-&gt;<a class="code" href="structgerbv__image__t.html#911cb23ad6a1b5e4a10903a761982d89">drill_stats</a>-&gt;<a class="code" href="structgerbv__drill__stats__t.html#e8e4149abe4a86c6c1a9f0d82d733275">drill_list</a>,
<a name="l00606"></a>00606                                           state-&gt;current_tool);
<a name="l00607"></a>00607 
<a name="l00608"></a>00608            curr_net-&gt;<a class="code" href="structgerbv__net.html#74453be5449de76efa6cc12df4b2886c">next</a> = (<a class="code" href="structgerbv__net.html">gerbv_net_t</a> *)g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structgerbv__net.html">gerbv_net_t</a>));
<a name="l00609"></a>00609            <span class="keywordflow">if</span> (curr_net-&gt;<a class="code" href="structgerbv__net.html#74453be5449de76efa6cc12df4b2886c">next</a> == NULL)
<a name="l00610"></a>00610               GERB_FATAL_ERROR(<span class="stringliteral">"malloc curr_net-&gt;next failed\n"</span>);
<a name="l00611"></a>00611            curr_net = curr_net-&gt;<a class="code" href="structgerbv__net.html#74453be5449de76efa6cc12df4b2886c">next</a>;
<a name="l00612"></a>00612            memset((<span class="keywordtype">void</span> *)curr_net, 0, <span class="keyword">sizeof</span>(<a class="code" href="structgerbv__net.html">gerbv_net_t</a>));
<a name="l00613"></a>00613            curr_net-&gt;layer = image-&gt;<a class="code" href="structgerbv__image__t.html#13fdf9e40c8e6efc8f9eec2ec5e25801">layers</a>;
<a name="l00614"></a>00614            curr_net-&gt;state = image-&gt;<a class="code" href="structgerbv__image__t.html#b81e3c6363cf0014970ca1cbcb3182f6">states</a>;
<a name="l00615"></a>00615            curr_net-&gt;start_x = (double)state-&gt;curr_x;
<a name="l00616"></a>00616            curr_net-&gt;start_y = (<span class="keywordtype">double</span>)state-&gt;curr_y;
<a name="l00617"></a>00617            <span class="comment">/* KLUDGE. This function isn't allowed to return anything</span>
<a name="l00618"></a>00618 <span class="comment">              but inches */</span>
<a name="l00619"></a>00619            <span class="keywordflow">if</span>(state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>) {
<a name="l00620"></a>00620               curr_net-&gt;start_x /= 25.4;
<a name="l00621"></a>00621               curr_net-&gt;start_y /= 25.4;
<a name="l00622"></a>00622               <span class="comment">/* KLUDGE. All images, regardless of input format,</span>
<a name="l00623"></a>00623 <span class="comment">                 are returned in INCH format */</span>
<a name="l00624"></a>00624               curr_net-&gt;state-&gt;<a class="code" href="structgerbv__netstate__t.html#ec5f911e09684330a9cacefa7ff5956f">unit</a> = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce46256f1b4adec6e863e6373f80963126">GERBV_UNIT_INCH</a>;
<a name="l00625"></a>00625            }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627            curr_net-&gt;stop_x = curr_net-&gt;start_x - state-&gt;origin_x;
<a name="l00628"></a>00628            curr_net-&gt;stop_y = curr_net-&gt;start_y - state-&gt;origin_y;
<a name="l00629"></a>00629            curr_net-&gt;aperture = state-&gt;current_tool;
<a name="l00630"></a>00630            curr_net-&gt;aperture_state = <a class="code" href="gerbv_8h.html#1bde819e0800e9b6efd3718c28b6c8f5e29aaa9ec01ade417353bc82c42fafcc">GERBV_APERTURE_STATE_FLASH</a>;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632            <span class="comment">/* Find min and max of image.</span>
<a name="l00633"></a>00633 <span class="comment">              Mustn't forget (again) to add the hole radius */</span>
<a name="l00634"></a>00634 
<a name="l00635"></a>00635            <span class="comment">/* Check if aperture is set. Ignore the below instead of</span>
<a name="l00636"></a>00636 <span class="comment">              causing SEGV... */</span>
<a name="l00637"></a>00637            <span class="keywordflow">if</span>(image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[state-&gt;current_tool] == NULL)
<a name="l00638"></a>00638               <span class="keywordflow">break</span>;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a> =
<a name="l00641"></a>00641               min(image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a>,
<a name="l00642"></a>00642                   (curr_net-&gt;start_x -
<a name="l00643"></a>00643                    image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[state-&gt;current_tool]-&gt;parameter[0] / 2));
<a name="l00644"></a>00644            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a> =
<a name="l00645"></a>00645               min(image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a>,
<a name="l00646"></a>00646                   (curr_net-&gt;start_y -
<a name="l00647"></a>00647                    image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[state-&gt;current_tool]-&gt;parameter[0] / 2));
<a name="l00648"></a>00648            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a> =
<a name="l00649"></a>00649               max(image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a>,
<a name="l00650"></a>00650                   (curr_net-&gt;start_x +
<a name="l00651"></a>00651                    image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[state-&gt;current_tool]-&gt;parameter[0] / 2));
<a name="l00652"></a>00652            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a> =
<a name="l00653"></a>00653               max(image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a>,
<a name="l00654"></a>00654                   (curr_net-&gt;start_y +
<a name="l00655"></a>00655                    image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[state-&gt;current_tool]-&gt;parameter[0] / 2));
<a name="l00656"></a>00656            <span class="keywordflow">break</span>;
<a name="l00657"></a>00657        <span class="keywordflow">case</span> <span class="charliteral">'%'</span>:
<a name="l00658"></a>00658            state-&gt;curr_section = DRILL_DATA;
<a name="l00659"></a>00659            <span class="keywordflow">break</span>;
<a name="l00660"></a>00660        <span class="keywordflow">case</span> 10 :   <span class="comment">/* White space */</span>
<a name="l00661"></a>00661        <span class="keywordflow">case</span> 13 :
<a name="l00662"></a>00662        <span class="keywordflow">case</span> <span class="charliteral">' '</span> :
<a name="l00663"></a>00663        <span class="keywordflow">case</span> <span class="charliteral">'\t'</span> :
<a name="l00664"></a>00664            <span class="keywordflow">break</span>;
<a name="l00665"></a>00665        <span class="keywordflow">default</span>:
<a name="l00666"></a>00666            <span class="keywordflow">if</span>(state-&gt;curr_section == DRILL_HEADER) {
<a name="l00667"></a>00667               <span class="comment">/* Unrecognised crap in the header is thrown away */</span>
<a name="l00668"></a>00668               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00669"></a>00669                                   -1,
<a name="l00670"></a>00670                                   <span class="stringliteral">"Undefined codes found in header.\n"</span>,
<a name="l00671"></a>00671                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00672"></a>00672               gerb_ungetc(fd);
<a name="l00673"></a>00673               tmps = get_line(fd);
<a name="l00674"></a>00674               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Undefined header line = '%s'\n"</span>,
<a name="l00675"></a>00675                                     tmps);
<a name="l00676"></a>00676               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00677"></a>00677                                   -1,
<a name="l00678"></a>00678                                   <span class="keywordtype">string</span>,
<a name="l00679"></a>00679                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d381c8a82d58481911eecdacbf5ada3de2">GERBV_MESSAGE_NOTE</a>);
<a name="l00680"></a>00680               g_free(<span class="keywordtype">string</span>);
<a name="l00681"></a>00681               g_free (tmps);
<a name="l00682"></a>00682            } <span class="keywordflow">else</span> {
<a name="l00683"></a>00683               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Undefined character '%c' [0x%02x] found inside data, ignoring\n"</span>,
<a name="l00684"></a>00684                                     read, read);
<a name="l00685"></a>00685               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00686"></a>00686                                   -1,
<a name="l00687"></a>00687                                   <span class="keywordtype">string</span>,
<a name="l00688"></a>00688                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00689"></a>00689               g_free(<span class="keywordtype">string</span>);
<a name="l00690"></a>00690            }
<a name="l00691"></a>00691        }
<a name="l00692"></a>00692     }
<a name="l00693"></a>00693     drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00694"></a>00694                        -1,
<a name="l00695"></a>00695                        <span class="stringliteral">"No EOF found in drill file.\n"</span>,
<a name="l00696"></a>00696                        <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00697"></a>00697 
<a name="l00698"></a>00698  drill_parse_end:
<a name="l00699"></a>00699     dprintf (<span class="stringliteral">"%s():  Populating file attributes\n"</span>, __FUNCTION__);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     <span class="keywordflow">switch</span> (state-&gt;unit) {
<a name="l00702"></a>00702     <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>:
<a name="l00703"></a>00703        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_xy_units].default_val.int_value = UNITS_MM;
<a name="l00704"></a>00704        <span class="keywordflow">break</span>;
<a name="l00705"></a>00705            
<a name="l00706"></a>00706     <span class="keywordflow">default</span>:
<a name="l00707"></a>00707        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_xy_units].default_val.int_value = UNITS_INCH;
<a name="l00708"></a>00708        <span class="keywordflow">break</span>;
<a name="l00709"></a>00709     }
<a name="l00710"></a>00710 
<a name="l00711"></a>00711     <span class="keywordflow">switch</span> (state-&gt;number_format) {
<a name="l00712"></a>00712     <span class="keywordflow">case</span> FMT_000_00:
<a name="l00713"></a>00713     <span class="keywordflow">case</span> FMT_0000_00:
<a name="l00714"></a>00714        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_digits].default_val.int_value = 2;
<a name="l00715"></a>00715        <span class="keywordflow">break</span>;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="keywordflow">case</span> FMT_000_000:
<a name="l00718"></a>00718        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_digits].default_val.int_value = 3;
<a name="l00719"></a>00719        <span class="keywordflow">break</span>;
<a name="l00720"></a>00720        
<a name="l00721"></a>00721     <span class="keywordflow">case</span> FMT_00_0000:
<a name="l00722"></a>00722        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_digits].default_val.int_value = 4;
<a name="l00723"></a>00723        <span class="keywordflow">break</span>;
<a name="l00724"></a>00724        
<a name="l00725"></a>00725     <span class="keywordflow">case</span> FMT_USER:
<a name="l00726"></a>00726        dprintf (<span class="stringliteral">"%s():  Keeping user specified number of decimal places (%d)\n"</span>,
<a name="l00727"></a>00727                __FUNCTION__,
<a name="l00728"></a>00728                image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_digits].default_val.int_value);
<a name="l00729"></a>00729        <span class="keywordflow">break</span>;
<a name="l00730"></a>00730        
<a name="l00731"></a>00731     <span class="keywordflow">default</span>:
<a name="l00732"></a>00732        <span class="keywordflow">break</span>;
<a name="l00733"></a>00733     }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735     <span class="keywordflow">switch</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a>) {
<a name="l00736"></a>00736     <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7e564cd07ddda272305088e9e2566b90c">GERBV_OMIT_ZEROS_LEADING</a>:
<a name="l00737"></a>00737        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_supression].default_val.int_value = SUP_LEAD;
<a name="l00738"></a>00738        <span class="keywordflow">break</span>;
<a name="l00739"></a>00739            
<a name="l00740"></a>00740     <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7085ee95a5b4d68f30e4ab554c9b2e94a">GERBV_OMIT_ZEROS_TRAILING</a>:
<a name="l00741"></a>00741        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_supression].default_val.int_value = SUP_TRAIL;
<a name="l00742"></a>00742        <span class="keywordflow">break</span>;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="keywordflow">default</span>:
<a name="l00745"></a>00745        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>[HA_supression].default_val.int_value = SUP_NONE;
<a name="l00746"></a>00746        <span class="keywordflow">break</span>;
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     g_free(state);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751     <span class="keywordflow">return</span> image;
<a name="l00752"></a>00752 } <span class="comment">/* parse_drillfile */</span>
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l00756"></a>00756 <span class="comment">/*</span>
<a name="l00757"></a>00757 <span class="comment"> * Checks for signs that this is a drill file</span>
<a name="l00758"></a>00758 <span class="comment"> * Returns TRUE if it is, FALSE if not.</span>
<a name="l00759"></a>00759 <span class="comment"> */</span>
<a name="l00760"></a>00760 gboolean
<a name="l00761"></a>00761 drill_file_p(gerb_file_t *fd, gboolean *returnFoundBinary)
<a name="l00762"></a>00762 {
<a name="l00763"></a>00763     <span class="keywordtype">char</span> *buf;
<a name="l00764"></a>00764     <span class="keywordtype">int</span> len = 0;
<a name="l00765"></a>00765     <span class="keywordtype">char</span> *letter;
<a name="l00766"></a>00766     <span class="keywordtype">int</span> ascii;
<a name="l00767"></a>00767     <span class="keywordtype">int</span> zero = 48; <span class="comment">/* ascii 0 */</span>
<a name="l00768"></a>00768     <span class="keywordtype">int</span> nine = 57; <span class="comment">/* ascii 9 */</span>
<a name="l00769"></a>00769     <span class="keywordtype">int</span> i;
<a name="l00770"></a>00770     gboolean found_binary = FALSE;
<a name="l00771"></a>00771     gboolean found_M48 = FALSE;
<a name="l00772"></a>00772     gboolean found_M30 = FALSE;
<a name="l00773"></a>00773     gboolean found_percent = FALSE;
<a name="l00774"></a>00774     gboolean found_T = FALSE;
<a name="l00775"></a>00775     gboolean found_X = FALSE;
<a name="l00776"></a>00776     gboolean found_Y = FALSE;
<a name="l00777"></a>00777  
<a name="l00778"></a>00778     buf = g_malloc(MAXL);
<a name="l00779"></a>00779     <span class="keywordflow">if</span> (buf == NULL) 
<a name="l00780"></a>00780        GERB_FATAL_ERROR(<span class="stringliteral">"malloc buf failed while checking for drill file.\n"</span>);
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     <span class="keywordflow">while</span> (fgets(buf, MAXL, fd-&gt;fd) != NULL) {
<a name="l00783"></a>00783        len = strlen(buf);
<a name="l00784"></a>00784 
<a name="l00785"></a>00785        <span class="comment">/* First look through the file for indications of its type */</span>
<a name="l00786"></a>00786 
<a name="l00787"></a>00787        <span class="comment">/* check that file is not binary (non-printing chars) */</span>
<a name="l00788"></a>00788        <span class="keywordflow">for</span> (i = 0; i &lt; len; i++) {
<a name="l00789"></a>00789            ascii = (int) buf[i];
<a name="l00790"></a>00790            <span class="keywordflow">if</span> ((ascii &gt; 128) || (ascii &lt; 0)) {
<a name="l00791"></a>00791               found_binary = TRUE;
<a name="l00792"></a>00792            }
<a name="l00793"></a>00793        }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795        <span class="comment">/* Check for M48 = start of drill header */</span>
<a name="l00796"></a>00796        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"M48"</span>)) {
<a name="l00797"></a>00797            found_M48 = TRUE; 
<a name="l00798"></a>00798        }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800        <span class="comment">/* Check for M30 = end of drill program */</span>
<a name="l00801"></a>00801        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"M30"</span>)) {
<a name="l00802"></a>00802            <span class="keywordflow">if</span> (found_percent) {
<a name="l00803"></a>00803               found_M30 = TRUE; <span class="comment">/* Found M30 after % = good */</span>
<a name="l00804"></a>00804            }
<a name="l00805"></a>00805        }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807        <span class="comment">/* Check for % on its own line at end of header */</span>
<a name="l00808"></a>00808        <span class="keywordflow">if</span> ((letter = g_strstr_len(buf, len, <span class="stringliteral">"%"</span>)) != NULL) {
<a name="l00809"></a>00809            <span class="keywordflow">if</span> ((letter[1] ==  <span class="charliteral">'\r'</span>) || (letter[1] ==  <span class="charliteral">'\n'</span>))
<a name="l00810"></a>00810               found_percent = TRUE;
<a name="l00811"></a>00811        }
<a name="l00812"></a>00812 
<a name="l00813"></a>00813        <span class="comment">/* Check for T&lt;number&gt; */</span>
<a name="l00814"></a>00814        <span class="keywordflow">if</span> ((letter = g_strstr_len(buf, len, <span class="stringliteral">"T"</span>)) != NULL) {
<a name="l00815"></a>00815            <span class="keywordflow">if</span> (!found_T &amp;&amp; (found_X || found_Y)) {
<a name="l00816"></a>00816               found_T = FALSE;  <span class="comment">/* Found first T after X or Y */</span>
<a name="l00817"></a>00817            } <span class="keywordflow">else</span> {
<a name="l00818"></a>00818               <span class="keywordflow">if</span> (isdigit( (<span class="keywordtype">int</span>) letter[1])) { <span class="comment">/* verify next char is digit */</span>
<a name="l00819"></a>00819                   found_T = TRUE;
<a name="l00820"></a>00820               }
<a name="l00821"></a>00821            }
<a name="l00822"></a>00822        }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824        <span class="comment">/* look for X&lt;number&gt; or Y&lt;number&gt; */</span>
<a name="l00825"></a>00825        <span class="keywordflow">if</span> ((letter = g_strstr_len(buf, len, <span class="stringliteral">"X"</span>)) != NULL) {
<a name="l00826"></a>00826            ascii = (int) letter[1]; <span class="comment">/* grab char after X */</span>
<a name="l00827"></a>00827            <span class="keywordflow">if</span> ((ascii &gt;= zero) &amp;&amp; (ascii &lt;= nine)) {
<a name="l00828"></a>00828               found_X = TRUE;
<a name="l00829"></a>00829            }
<a name="l00830"></a>00830        }
<a name="l00831"></a>00831        <span class="keywordflow">if</span> ((letter = g_strstr_len(buf, len, <span class="stringliteral">"Y"</span>)) != NULL) {
<a name="l00832"></a>00832            ascii = (int) letter[1]; <span class="comment">/* grab char after Y */</span>
<a name="l00833"></a>00833            <span class="keywordflow">if</span> ((ascii &gt;= zero) &amp;&amp; (ascii &lt;= nine)) {
<a name="l00834"></a>00834               found_Y = TRUE;
<a name="l00835"></a>00835            }
<a name="l00836"></a>00836        }
<a name="l00837"></a>00837     } <span class="comment">/* while (fgets(buf, MAXL, fd-&gt;fd) */</span>
<a name="l00838"></a>00838 
<a name="l00839"></a>00839     rewind(fd-&gt;fd);
<a name="l00840"></a>00840     free(buf);
<a name="l00841"></a>00841     *returnFoundBinary = found_binary;
<a name="l00842"></a>00842     
<a name="l00843"></a>00843     <span class="comment">/* Now form logical expression determining if this is a drill file */</span>
<a name="l00844"></a>00844     <span class="keywordflow">if</span> ( ((found_X || found_Y) &amp;&amp; found_T) &amp;&amp; 
<a name="l00845"></a>00845         (found_M48 || (found_percent &amp;&amp; found_M30)) ) 
<a name="l00846"></a>00846        <span class="keywordflow">return</span> TRUE;
<a name="l00847"></a>00847     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (found_M48 &amp;&amp; found_T &amp;&amp; found_percent &amp;&amp; found_M30)
<a name="l00848"></a>00848        <span class="comment">/* Pathological case of drill file with valid header </span>
<a name="l00849"></a>00849 <span class="comment">          and EOF but no drill XY locations. */</span>
<a name="l00850"></a>00850        <span class="keywordflow">return</span> TRUE;
<a name="l00851"></a>00851     <span class="keywordflow">else</span> 
<a name="l00852"></a>00852        <span class="keywordflow">return</span> FALSE;
<a name="l00853"></a>00853 } <span class="comment">/* drill_file_p */</span>
<a name="l00854"></a>00854 
<a name="l00855"></a>00855 
<a name="l00856"></a>00856 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l00857"></a>00857 <span class="comment">/* Parse tool definition. This can get a bit tricky since it can</span>
<a name="l00858"></a>00858 <span class="comment">   appear in the header and/or data section.</span>
<a name="l00859"></a>00859 <span class="comment">   Returns tool number on success, -1 on error */</span>
<a name="l00860"></a>00860 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00861"></a>00861 drill_parse_T_code(gerb_file_t *fd, drill_state_t *state, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image)
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863     <span class="keywordtype">int</span> tool_num;
<a name="l00864"></a>00864     gboolean done = FALSE;
<a name="l00865"></a>00865     <span class="keywordtype">int</span> temp;
<a name="l00866"></a>00866     <span class="keywordtype">double</span> size;
<a name="l00867"></a>00867     <a class="code" href="structgerbv__drill__stats__t.html">gerbv_drill_stats_t</a> *stats = image-&gt;<a class="code" href="structgerbv__image__t.html#911cb23ad6a1b5e4a10903a761982d89">drill_stats</a>;
<a name="l00868"></a>00868     gchar *tmps;
<a name="l00869"></a>00869     gchar *string;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871     <span class="comment">/* Sneak a peek at what's hiding after the 'T'. Ugly fix for</span>
<a name="l00872"></a>00872 <span class="comment">       broken headers from Orcad, which is crap */</span>
<a name="l00873"></a>00873     temp = gerb_fgetc(fd);
<a name="l00874"></a>00874     dprintf(<span class="stringliteral">"Found a char %d after the T\n"</span>, temp);
<a name="l00875"></a>00875     
<a name="l00876"></a>00876     <span class="comment">/* might be a tool tool change stop switch on/off*/</span>
<a name="l00877"></a>00877     <span class="keywordflow">if</span>((temp == <span class="charliteral">'C'</span>) &amp;&amp; ((fd-&gt;ptr + 2) &lt; fd-&gt;datalen)){
<a name="l00878"></a>00878        <span class="keywordflow">if</span>(gerb_fgetc(fd) == <span class="charliteral">'S'</span>){
<a name="l00879"></a>00879            <span class="keywordflow">if</span> (gerb_fgetc(fd) == <span class="charliteral">'T'</span> ){
<a name="l00880"></a>00880               fd-&gt;ptr -= 4;
<a name="l00881"></a>00881               tmps = get_line(fd++);
<a name="l00882"></a>00882               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Tool change stop switch found: %s\n"</span>, tmps);
<a name="l00883"></a>00883               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>, 
<a name="l00884"></a>00884                                   -1,
<a name="l00885"></a>00885                                   <span class="keywordtype">string</span>,
<a name="l00886"></a>00886                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d381c8a82d58481911eecdacbf5ada3de2">GERBV_MESSAGE_NOTE</a>);
<a name="l00887"></a>00887               g_free(<span class="keywordtype">string</span>);
<a name="l00888"></a>00888               g_free (tmps);
<a name="l00889"></a>00889               <span class="keywordflow">return</span> -1;
<a name="l00890"></a>00890            }
<a name="l00891"></a>00891            gerb_ungetc(fd);
<a name="l00892"></a>00892        }
<a name="l00893"></a>00893        gerb_ungetc(fd);
<a name="l00894"></a>00894     }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <span class="keywordflow">if</span>( !(isdigit(temp) != 0 || temp == <span class="charliteral">'+'</span> || temp ==<span class="charliteral">'-'</span>) ) {
<a name="l00897"></a>00897        <span class="keywordflow">if</span>(temp != EOF) {
<a name="l00898"></a>00898            drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00899"></a>00899                               -1,
<a name="l00900"></a>00900                               <span class="stringliteral">"Orcad bug: Junk text found in place of tool definition.\n"</span>,
<a name="l00901"></a>00901                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00902"></a>00902            tmps = get_line(fd);
<a name="l00903"></a>00903            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Junk text = %s\n"</span>, 
<a name="l00904"></a>00904                                  tmps);
<a name="l00905"></a>00905            drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00906"></a>00906                               -1,
<a name="l00907"></a>00907                               <span class="keywordtype">string</span>,
<a name="l00908"></a>00908                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d381c8a82d58481911eecdacbf5ada3de2">GERBV_MESSAGE_NOTE</a>);
<a name="l00909"></a>00909            g_free(<span class="keywordtype">string</span>);
<a name="l00910"></a>00910            g_free (tmps);
<a name="l00911"></a>00911            drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00912"></a>00912                               -1,
<a name="l00913"></a>00913                               <span class="stringliteral">"Ignorning junk text.\n"</span>,
<a name="l00914"></a>00914                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l00915"></a>00915        }
<a name="l00916"></a>00916        <span class="keywordflow">return</span> -1;
<a name="l00917"></a>00917     }
<a name="l00918"></a>00918     gerb_ungetc(fd);
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     tool_num = (int) gerb_fgetint(fd, NULL);
<a name="l00921"></a>00921     dprintf (<span class="stringliteral">"In %s: handling tool_num = %d\n"</span>, __FUNCTION__, tool_num);
<a name="l00922"></a>00922 
<a name="l00923"></a>00923     <span class="keywordflow">if</span> (tool_num == 0) 
<a name="l00924"></a>00924        <span class="keywordflow">return</span> tool_num; <span class="comment">/* T00 is a command to unload the drill */</span>
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     <span class="keywordflow">if</span> ( (tool_num &lt; TOOL_MIN) || (tool_num &gt;= TOOL_MAX) ) {
<a name="l00927"></a>00927        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Drill number out of bounds: %d.\n"</span>, tool_num);
<a name="l00928"></a>00928        drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00929"></a>00929                            -1,
<a name="l00930"></a>00930                            <span class="keywordtype">string</span>,
<a name="l00931"></a>00931                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00932"></a>00932        g_free(<span class="keywordtype">string</span>);
<a name="l00933"></a>00933     }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935     <span class="comment">/* Set the current tool to the correct one */</span>
<a name="l00936"></a>00936     state-&gt;current_tool = tool_num;
<a name="l00937"></a>00937 
<a name="l00938"></a>00938     <span class="comment">/* Check for a size definition */</span>
<a name="l00939"></a>00939     temp = gerb_fgetc(fd);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <span class="comment">/* This bit of code looks for a tool definition by scanning for strings</span>
<a name="l00942"></a>00942 <span class="comment">     * of form TxxC, TxxF, TxxS.  */</span>
<a name="l00943"></a>00943     <span class="keywordflow">while</span>(!done) {
<a name="l00944"></a>00944        
<a name="l00945"></a>00945        <span class="keywordflow">switch</span>((<span class="keywordtype">char</span>)temp) {
<a name="l00946"></a>00946        <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
<a name="l00947"></a>00947            size = read_double(fd, state-&gt;header_number_format, <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7085ee95a5b4d68f30e4ab554c9b2e94a">GERBV_OMIT_ZEROS_TRAILING</a>, state-&gt;decimals);
<a name="l00948"></a>00948            dprintf (<span class="stringliteral">"%s: Read a size of %g %s\n"</span>, __FUNCTION__, size,
<a name="l00949"></a>00949                    state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a> ? <span class="stringliteral">"mm"</span> : <span class="stringliteral">"inch"</span>);
<a name="l00950"></a>00950            <span class="keywordflow">if</span>(state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>) {
<a name="l00951"></a>00951               size /= 25.4;
<a name="l00952"></a>00952            } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(size &gt;= 4.0) {
<a name="l00953"></a>00953               <span class="comment">/* If the drill size is &gt;= 4 inches, assume that this</span>
<a name="l00954"></a>00954 <span class="comment">                 must be wrong and that the units are mils.</span>
<a name="l00955"></a>00955 <span class="comment">                 The limit being 4 inches is because the smallest drill</span>
<a name="l00956"></a>00956 <span class="comment">                 I've ever seen used is 0,3mm(about 12mil). Half of that</span>
<a name="l00957"></a>00957 <span class="comment">                 seemed a bit too small a margin, so a third it is */</span>
<a name="l00958"></a>00958               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Read a drill of diameter %g inches.\n"</span>, size);
<a name="l00959"></a>00959               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00960"></a>00960                                   -1,
<a name="l00961"></a>00961                                   <span class="keywordtype">string</span>,
<a name="l00962"></a>00962                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>); 
<a name="l00963"></a>00963               g_free(<span class="keywordtype">string</span>);
<a name="l00964"></a>00964               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Assuming units are mils.\n"</span>);
<a name="l00965"></a>00965               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00966"></a>00966                                   -1,
<a name="l00967"></a>00967                                   <span class="keywordtype">string</span>,
<a name="l00968"></a>00968                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>); 
<a name="l00969"></a>00969               g_free(<span class="keywordtype">string</span>);
<a name="l00970"></a>00970               size /= 1000.0;
<a name="l00971"></a>00971            }
<a name="l00972"></a>00972 
<a name="l00973"></a>00973            <span class="keywordflow">if</span>(size &lt;= 0. || size &gt;= 10000.) {
<a name="l00974"></a>00974               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Unreasonable drill size found for drill %d: %g\n"</span>, tool_num, size);
<a name="l00975"></a>00975               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00976"></a>00976                                   -1,
<a name="l00977"></a>00977                                   <span class="keywordtype">string</span>,
<a name="l00978"></a>00978                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00979"></a>00979               g_free(<span class="keywordtype">string</span>);
<a name="l00980"></a>00980            } <span class="keywordflow">else</span> {
<a name="l00981"></a>00981               <span class="keywordflow">if</span>(image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num] != NULL) {
<a name="l00982"></a>00982                   <span class="comment">/* allow a redefine of a tool only if the new definition is exactly the same.</span>
<a name="l00983"></a>00983 <span class="comment">                   * This avoid lots of spurious complaints with the output of some cad</span>
<a name="l00984"></a>00984 <span class="comment">                   * tools while keeping complaints if there is a true problem</span>
<a name="l00985"></a>00985 <span class="comment">                   */</span>
<a name="l00986"></a>00986                   <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;parameter[0] != size ||
<a name="l00987"></a>00987                      image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;type != <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237562331d94d824b3711bd0c8b7296e366">GERBV_APTYPE_CIRCLE</a> ||
<a name="l00988"></a>00988                      image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;nuf_parameters != 1 ||
<a name="l00989"></a>00989                      image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;unit != <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce46256f1b4adec6e863e6373f80963126">GERBV_UNIT_INCH</a>) {
<a name="l00990"></a>00990                      <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Found redefinition of drill %d.\n"</span>, tool_num);
<a name="l00991"></a>00991                      drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l00992"></a>00992                                          -1,
<a name="l00993"></a>00993                                          <span class="keywordtype">string</span>,
<a name="l00994"></a>00994                                          <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00995"></a>00995                      g_free(<span class="keywordtype">string</span>);
<a name="l00996"></a>00996                   }
<a name="l00997"></a>00997               } <span class="keywordflow">else</span> {
<a name="l00998"></a>00998                   image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num] =
<a name="l00999"></a>00999                      (gerbv_aperture_t *)g_malloc(<span class="keyword">sizeof</span>(gerbv_aperture_t));
<a name="l01000"></a>01000                   <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num] == NULL) {
<a name="l01001"></a>01001                      GERB_FATAL_ERROR(<span class="stringliteral">"malloc tool failed\n"</span>);
<a name="l01002"></a>01002                   }
<a name="l01003"></a>01003                   <span class="comment">/* make sure we zero out all aperature parameters */</span>
<a name="l01004"></a>01004                   memset((<span class="keywordtype">void</span> *)image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num], 0, <span class="keyword">sizeof</span>(gerbv_aperture_t));
<a name="l01005"></a>01005                   <span class="comment">/* There's really no way of knowing what unit the tools</span>
<a name="l01006"></a>01006 <span class="comment">                     are defined in without sneaking a peek in the rest of</span>
<a name="l01007"></a>01007 <span class="comment">                     the file first. That's done in drill_guess_format() */</span>
<a name="l01008"></a>01008                   image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;parameter[0] = size;
<a name="l01009"></a>01009                   image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237562331d94d824b3711bd0c8b7296e366">GERBV_APTYPE_CIRCLE</a>;
<a name="l01010"></a>01010                   image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;nuf_parameters = 1;
<a name="l01011"></a>01011                   image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;unit = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce46256f1b4adec6e863e6373f80963126">GERBV_UNIT_INCH</a>;
<a name="l01012"></a>01012               }
<a name="l01013"></a>01013            }
<a name="l01014"></a>01014            
<a name="l01015"></a>01015            <span class="comment">/* Add the tool whose definition we just found into the list</span>
<a name="l01016"></a>01016 <span class="comment">            * of tools for this layer used to generate statistics. */</span>
<a name="l01017"></a>01017            stats = image-&gt;<a class="code" href="structgerbv__image__t.html#911cb23ad6a1b5e4a10903a761982d89">drill_stats</a>;
<a name="l01018"></a>01018            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"%s"</span>, (state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a> ? <span class="stringliteral">"mm"</span> : <span class="stringliteral">"inch"</span>));
<a name="l01019"></a>01019            drill_stats_add_to_drill_list(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#e8e4149abe4a86c6c1a9f0d82d733275">drill_list</a>, 
<a name="l01020"></a>01020                                      tool_num, 
<a name="l01021"></a>01021                                      state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a> ? size*25.4 : size, 
<a name="l01022"></a>01022                                      <span class="keywordtype">string</span>);
<a name="l01023"></a>01023            g_free(<span class="keywordtype">string</span>);
<a name="l01024"></a>01024            <span class="keywordflow">break</span>;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026        <span class="keywordflow">case</span> <span class="charliteral">'F'</span>:
<a name="l01027"></a>01027        <span class="keywordflow">case</span> <span class="charliteral">'S'</span> :
<a name="l01028"></a>01028            <span class="comment">/* Silently ignored. They're not important. */</span>
<a name="l01029"></a>01029            gerb_fgetint(fd, NULL);
<a name="l01030"></a>01030            <span class="keywordflow">break</span>;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032        <span class="keywordflow">default</span>:
<a name="l01033"></a>01033            <span class="comment">/* Stop when finding anything but what's expected</span>
<a name="l01034"></a>01034 <span class="comment">              (and put it back) */</span>
<a name="l01035"></a>01035            gerb_ungetc(fd);
<a name="l01036"></a>01036            done = TRUE;
<a name="l01037"></a>01037            <span class="keywordflow">break</span>;
<a name="l01038"></a>01038        }  <span class="comment">/* switch((char)temp) */</span>
<a name="l01039"></a>01039 
<a name="l01040"></a>01040        <span class="keywordflow">if</span>( (temp = gerb_fgetc(fd)) == EOF) {
<a name="l01041"></a>01041            drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l01042"></a>01042                               -1,
<a name="l01043"></a>01043                               <span class="stringliteral">"Unexpected EOF encountered header of drill file.\n"</span>,
<a name="l01044"></a>01044                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01045"></a>01045        }
<a name="l01046"></a>01046     }   <span class="comment">/* while(!done) */</span>  <span class="comment">/* Done looking at tool definitions */</span>
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     <span class="comment">/* Catch the tools that aren't defined.</span>
<a name="l01049"></a>01049 <span class="comment">       This isn't strictly a good thing, but at least something is shown */</span>
<a name="l01050"></a>01050     <span class="keywordflow">if</span>(image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num] == NULL) {
<a name="l01051"></a>01051         <span class="keywordtype">double</span> dia;
<a name="l01052"></a>01052 
<a name="l01053"></a>01053        image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num] =
<a name="l01054"></a>01054            (gerbv_aperture_t *)g_malloc(<span class="keyword">sizeof</span>(gerbv_aperture_t));
<a name="l01055"></a>01055        <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num] == NULL) {
<a name="l01056"></a>01056            GERB_FATAL_ERROR(<span class="stringliteral">"malloc tool failed\n"</span>);
<a name="l01057"></a>01057        }
<a name="l01058"></a>01058        <span class="comment">/* make sure we zero out all aperature parameters */</span>
<a name="l01059"></a>01059        memset((<span class="keywordtype">void</span> *)image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num], 0, <span class="keyword">sizeof</span>(gerbv_aperture_t));
<a name="l01060"></a>01060 
<a name="l01061"></a>01061         <span class="comment">/* See if we have the tool table */</span>
<a name="l01062"></a>01062         dia = gerbv_get_tool_diameter(tool_num);
<a name="l01063"></a>01063         <span class="keywordflow">if</span> (dia &lt;= 0) {
<a name="l01064"></a>01064             <span class="comment">/*</span>
<a name="l01065"></a>01065 <span class="comment">             * There is no tool. So go out and make some.</span>
<a name="l01066"></a>01066 <span class="comment">             * This size calculation is, of course, totally bogus.</span>
<a name="l01067"></a>01067 <span class="comment">             */</span>
<a name="l01068"></a>01068             dia = (double)(16 + 8 * tool_num) / 1000;
<a name="l01069"></a>01069             <span class="comment">/*</span>
<a name="l01070"></a>01070 <span class="comment">             * Oooh, this is sooo ugly. But some CAD systems seem to always</span>
<a name="l01071"></a>01071 <span class="comment">             * use T00 at the end of the file while others that don't have</span>
<a name="l01072"></a>01072 <span class="comment">             * tool definitions inside the file never seem to use T00 at all.</span>
<a name="l01073"></a>01073 <span class="comment">             */</span>
<a name="l01074"></a>01074             <span class="keywordflow">if</span>(tool_num != 0) {
<a name="l01075"></a>01075               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Tool %02d used without being defined\n"</span>, tool_num);
<a name="l01076"></a>01076               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l01077"></a>01077                                   -1,
<a name="l01078"></a>01078                                   <span class="keywordtype">string</span>,
<a name="l01079"></a>01079                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01080"></a>01080               g_free(<span class="keywordtype">string</span>);
<a name="l01081"></a>01081               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Setting a default size of %g\"\n"</span>, dia);
<a name="l01082"></a>01082               drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l01083"></a>01083                                   -1,
<a name="l01084"></a>01084                                   <span class="keywordtype">string</span>,
<a name="l01085"></a>01085                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l01086"></a>01086               g_free(<span class="keywordtype">string</span>);
<a name="l01087"></a>01087             }
<a name="l01088"></a>01088        }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090        image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237562331d94d824b3711bd0c8b7296e366">GERBV_APTYPE_CIRCLE</a>;
<a name="l01091"></a>01091        image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;nuf_parameters = 1;
<a name="l01092"></a>01092        image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[tool_num]-&gt;parameter[0] = dia;
<a name="l01093"></a>01093 
<a name="l01094"></a>01094        <span class="comment">/* Add the tool whose definition we just found into the list</span>
<a name="l01095"></a>01095 <span class="comment">        * of tools for this layer used to generate statistics. */</span>
<a name="l01096"></a>01096        <span class="keywordflow">if</span> (tool_num != 0) {  <span class="comment">/* Only add non-zero tool nums.  </span>
<a name="l01097"></a>01097 <span class="comment">                            * Zero = unload command. */</span>
<a name="l01098"></a>01098            stats = image-&gt;<a class="code" href="structgerbv__image__t.html#911cb23ad6a1b5e4a10903a761982d89">drill_stats</a>;
<a name="l01099"></a>01099            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"%s"</span>, 
<a name="l01100"></a>01100                                  (state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a> ? <span class="stringliteral">"mm"</span> : <span class="stringliteral">"inch"</span>));
<a name="l01101"></a>01101            drill_stats_add_to_drill_list(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#e8e4149abe4a86c6c1a9f0d82d733275">drill_list</a>, 
<a name="l01102"></a>01102                                      tool_num, 
<a name="l01103"></a>01103                                      state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a> ? dia*25.4 : dia,
<a name="l01104"></a>01104                                      <span class="keywordtype">string</span>);
<a name="l01105"></a>01105            g_free(<span class="keywordtype">string</span>);
<a name="l01106"></a>01106        }
<a name="l01107"></a>01107     } <span class="comment">/* if(image-&gt;aperture[tool_num] == NULL) */</span>       
<a name="l01108"></a>01108     
<a name="l01109"></a>01109     <span class="keywordflow">return</span> tool_num;
<a name="l01110"></a>01110 } <span class="comment">/* drill_parse_T_code */</span>
<a name="l01111"></a>01111 
<a name="l01112"></a>01112 
<a name="l01113"></a>01113 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l01114"></a>01114 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01115"></a>01115 drill_parse_M_code(gerb_file_t *fd, drill_state_t *state, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image)
<a name="l01116"></a>01116 {
<a name="l01117"></a>01117     <span class="keywordtype">char</span> op[3] = <span class="stringliteral">"  "</span>;
<a name="l01118"></a>01118     <span class="keywordtype">int</span>  read[3];
<a name="l01119"></a>01119     <a class="code" href="structgerbv__drill__stats__t.html">gerbv_drill_stats_t</a> *stats = image-&gt;<a class="code" href="structgerbv__image__t.html#911cb23ad6a1b5e4a10903a761982d89">drill_stats</a>;
<a name="l01120"></a>01120     <span class="keywordtype">int</span> result=0;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122     dprintf(<span class="stringliteral">"---&gt; entering drill_parse_M_code ...\n"</span>);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     read[0] = gerb_fgetc(fd);
<a name="l01125"></a>01125     read[1] = gerb_fgetc(fd);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127     <span class="keywordflow">if</span> ((read[0] == EOF) || (read[1] == EOF))
<a name="l01128"></a>01128        drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l01129"></a>01129                            -1,
<a name="l01130"></a>01130                            <span class="stringliteral">"Unexpected EOF found while parsing M code.\n"</span>,
<a name="l01131"></a>01131                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01132"></a>01132     op[0] = read[0], op[1] = read[1], op[2] = 0;
<a name="l01133"></a>01133  
<a name="l01134"></a>01134     <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"00"</span>, 2) == 0) {
<a name="l01135"></a>01135        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#a02554aec77295a1f0e9d0c6e6c2fc27">M00</a>++;
<a name="l01136"></a>01136        result = DRILL_M_END;
<a name="l01137"></a>01137     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"01"</span>, 2) == 0) {
<a name="l01138"></a>01138        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#e317dd15992e6f8af0ca4ca4a95fa37f">M01</a>++;
<a name="l01139"></a>01139        result = DRILL_M_ENDPATTERN;
<a name="l01140"></a>01140     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"18"</span>, 2) == 0) {
<a name="l01141"></a>01141        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#0c49ea5bff5684786955f276be0775e7">M18</a>++;
<a name="l01142"></a>01142        result = DRILL_M_TIPCHECK;
<a name="l01143"></a>01143     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"25"</span>, 2) == 0) {
<a name="l01144"></a>01144        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#d7b6b447b520d30fca330feaf0e54902">M25</a>++;
<a name="l01145"></a>01145        result = DRILL_M_BEGINPATTERN;
<a name="l01146"></a>01146     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"31"</span>, 2) == 0) {
<a name="l01147"></a>01147        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#cb1e8d31a702118831d4912117b3f261">M31</a>++;
<a name="l01148"></a>01148        result = DRILL_M_BEGINPATTERN;
<a name="l01149"></a>01149     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"30"</span>, 2) == 0) {
<a name="l01150"></a>01150        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#9b081d7de7e025923c32af3f8277bf51">M30</a>++;
<a name="l01151"></a>01151        result = DRILL_M_ENDREWIND;
<a name="l01152"></a>01152     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"45"</span>, 2) == 0) {
<a name="l01153"></a>01153        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#74a9a8ba40a25f84555d176a9086b4e9">M45</a>++;
<a name="l01154"></a>01154        result = DRILL_M_LONGMESSAGE;
<a name="l01155"></a>01155     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"47"</span>, 2) == 0) {
<a name="l01156"></a>01156        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#66000bea410bd97882f58b8659675f95">M47</a>++;
<a name="l01157"></a>01157        result = DRILL_M_MESSAGE;
<a name="l01158"></a>01158     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"48"</span>, 2) == 0) {
<a name="l01159"></a>01159        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#a379c3e5c30010b541f6f4a081e66fe9">M48</a>++;
<a name="l01160"></a>01160        result = DRILL_M_HEADER;
<a name="l01161"></a>01161     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"71"</span>, 2) == 0) {
<a name="l01162"></a>01162        eat_line(fd);
<a name="l01163"></a>01163        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#afd761172f95a6e8d968a5cb5e7e2924">M71</a>++;
<a name="l01164"></a>01164        result = DRILL_M_METRIC;
<a name="l01165"></a>01165     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"72"</span>, 2) == 0) {
<a name="l01166"></a>01166        eat_line(fd);
<a name="l01167"></a>01167        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#32ed19a0ac50da69fe0695e5824c5dd5">M72</a>++;
<a name="l01168"></a>01168        result = DRILL_M_IMPERIAL;
<a name="l01169"></a>01169     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"95"</span>, 2) == 0) {
<a name="l01170"></a>01170        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#bb4d9cae9891835e4e010ed5992b40d1">M95</a>++;
<a name="l01171"></a>01171        result = DRILL_M_ENDHEADER;
<a name="l01172"></a>01172     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"97"</span>, 2) == 0) {
<a name="l01173"></a>01173        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#2554459d1adc11ef105971e2a39f4492">M97</a>++;
<a name="l01174"></a>01174        result = DRILL_M_CANNEDTEXT;
<a name="l01175"></a>01175     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"98"</span>, 2) == 0) {
<a name="l01176"></a>01176        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#6819515faa7b562de13ac98ff6961d64">M98</a>++;
<a name="l01177"></a>01177        <span class="keywordflow">return</span> DRILL_M_CANNEDTEXT;
<a name="l01178"></a>01178     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state-&gt;curr_section == DRILL_HEADER &amp;&amp;
<a name="l01179"></a>01179               strncmp(op, <span class="stringliteral">"ET"</span>, 2) == 0) {
<a name="l01180"></a>01180        <span class="comment">/* METRIC is not an actual M code but a command that is only</span>
<a name="l01181"></a>01181 <span class="comment">          acceptable within the header.</span>
<a name="l01182"></a>01182 <span class="comment"></span>
<a name="l01183"></a>01183 <span class="comment">          The syntax is</span>
<a name="l01184"></a>01184 <span class="comment">          METRIC[,{TZ|LZ}][,{000.000|000.00|0000.00}]</span>
<a name="l01185"></a>01185 <span class="comment">       */</span>
<a name="l01186"></a>01186        <span class="keywordflow">if</span> (<span class="charliteral">'R'</span> == gerb_fgetc(fd) &amp;&amp;
<a name="l01187"></a>01187            <span class="charliteral">'I'</span> == gerb_fgetc(fd) &amp;&amp;
<a name="l01188"></a>01188            <span class="charliteral">'C'</span> == gerb_fgetc(fd)) {
<a name="l01189"></a>01189        again:
<a name="l01190"></a>01190            <span class="keywordflow">if</span> (<span class="charliteral">','</span> == gerb_fgetc(fd)) {
<a name="l01191"></a>01191               <span class="keywordtype">int</span> c;
<a name="l01192"></a>01192 
<a name="l01193"></a>01193               <span class="comment">/* Is it tzlz, or zerofmt? */</span>
<a name="l01194"></a>01194               <span class="keywordflow">switch</span> ((c = gerb_fgetc(fd))) {
<a name="l01195"></a>01195               <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
<a name="l01196"></a>01196               <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
<a name="l01197"></a>01197                   <span class="keywordflow">if</span> (<span class="charliteral">'Z'</span> != gerb_fgetc(fd))
<a name="l01198"></a>01198                      <span class="keywordflow">goto</span> junk;
<a name="l01199"></a>01199                   <span class="keywordflow">if</span> (c == <span class="charliteral">'L'</span>)
<a name="l01200"></a>01200                      {
<a name="l01201"></a>01201                          dprintf (<span class="stringliteral">"%s(): Detected a file that probably has trailing zero supression\n"</span>, __FUNCTION__);
<a name="l01202"></a>01202                          <span class="keywordflow">if</span> (state-&gt;autod)
<a name="l01203"></a>01203                             {
<a name="l01204"></a>01204                                 image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7085ee95a5b4d68f30e4ab554c9b2e94a">GERBV_OMIT_ZEROS_TRAILING</a>;
<a name="l01205"></a>01205                             }
<a name="l01206"></a>01206                      }
<a name="l01207"></a>01207                   <span class="keywordflow">else</span>
<a name="l01208"></a>01208                      {
<a name="l01209"></a>01209                          dprintf (<span class="stringliteral">"%s(): Detected a file that probably has leading zero supression\n"</span>, __FUNCTION__);
<a name="l01210"></a>01210                          <span class="keywordflow">if</span> (state-&gt;autod)
<a name="l01211"></a>01211                             {
<a name="l01212"></a>01212                                 image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7e564cd07ddda272305088e9e2566b90c">GERBV_OMIT_ZEROS_LEADING</a>;
<a name="l01213"></a>01213                             }
<a name="l01214"></a>01214                      }
<a name="l01215"></a>01215                   <span class="keywordflow">if</span> (state-&gt;autod)
<a name="l01216"></a>01216                      {
<a name="l01217"></a>01217                          <span class="comment">/* Default metric number format is 6-digit, 1 um</span>
<a name="l01218"></a>01218 <span class="comment">                            resolution.  The header number format (for T#C#</span>
<a name="l01219"></a>01219 <span class="comment">                            definitions) is fixed to that, while the number</span>
<a name="l01220"></a>01220 <span class="comment">                            format within the file can differ. */</span>
<a name="l01221"></a>01221                          state-&gt;header_number_format =
<a name="l01222"></a>01222                             state-&gt;number_format = FMT_000_000;
<a name="l01223"></a>01223                          state-&gt;decimals = 3;
<a name="l01224"></a>01224                      }
<a name="l01225"></a>01225                   c = gerb_fgetc(fd);
<a name="l01226"></a>01226                   gerb_ungetc(fd);
<a name="l01227"></a>01227                   <span class="keywordflow">if</span> (c == <span class="charliteral">','</span>)
<a name="l01228"></a>01228                      <span class="comment">/* anticipate number format will follow */</span>
<a name="l01229"></a>01229                      <span class="keywordflow">goto</span> again;
<a name="l01230"></a>01230                   <span class="keywordflow">break</span>;
<a name="l01231"></a>01231 
<a name="l01232"></a>01232               <span class="keywordflow">case</span> <span class="charliteral">'0'</span>:
<a name="l01233"></a>01233                   <span class="keywordflow">if</span> (<span class="charliteral">'0'</span> != gerb_fgetc(fd) ||
<a name="l01234"></a>01234                      <span class="charliteral">'0'</span> != gerb_fgetc(fd))
<a name="l01235"></a>01235                      <span class="keywordflow">goto</span> junk;
<a name="l01236"></a>01236                   <span class="comment">/* We just parsed three 0s, the remainder options</span>
<a name="l01237"></a>01237 <span class="comment">                     so far are: .000 | .00 | 0.00 */</span>
<a name="l01238"></a>01238                   read[0] = gerb_fgetc(fd);
<a name="l01239"></a>01239                   read[1] = gerb_fgetc(fd);
<a name="l01240"></a>01240                   <span class="keywordflow">if</span> (read[0] == EOF || read[1] == EOF)
<a name="l01241"></a>01241                      <span class="keywordflow">goto</span> junk;
<a name="l01242"></a>01242                   op[0] = read[0];
<a name="l01243"></a>01243                   op[1] = read[1];
<a name="l01244"></a>01244                   <span class="keywordflow">if</span> (strcmp(op, <span class="stringliteral">"0."</span>) == 0) {
<a name="l01245"></a>01245                      <span class="comment">/* expecting FMT_0000_00,</span>
<a name="l01246"></a>01246 <span class="comment">                        two trailing 0s must follow */</span>
<a name="l01247"></a>01247                      <span class="keywordflow">if</span> (<span class="charliteral">'0'</span> != gerb_fgetc(fd) ||
<a name="l01248"></a>01248                          <span class="charliteral">'0'</span> != gerb_fgetc(fd))
<a name="l01249"></a>01249                          <span class="keywordflow">goto</span> junk;
<a name="l01250"></a>01250                      eat_line(fd);
<a name="l01251"></a>01251                      <span class="keywordflow">if</span> (state-&gt;autod)
<a name="l01252"></a>01252                          {
<a name="l01253"></a>01253                             state-&gt;number_format = FMT_0000_00;
<a name="l01254"></a>01254                             state-&gt;decimals = 2;
<a name="l01255"></a>01255                          }
<a name="l01256"></a>01256                      <span class="keywordflow">break</span>;
<a name="l01257"></a>01257                   }
<a name="l01258"></a>01258                   <span class="keywordflow">if</span> (strcmp(op, <span class="stringliteral">".0"</span>) != 0)
<a name="l01259"></a>01259                      <span class="keywordflow">goto</span> junk;
<a name="l01260"></a>01260                   <span class="comment">/* must be either FMT_000_000 or FMT_000_00, depending</span>
<a name="l01261"></a>01261 <span class="comment">                     on whether one or two 0s are following */</span>
<a name="l01262"></a>01262                   <span class="keywordflow">if</span> (<span class="charliteral">'0'</span> != gerb_fgetc(fd))
<a name="l01263"></a>01263                      <span class="keywordflow">goto</span> junk;
<a name="l01264"></a>01264                   <span class="keywordflow">if</span> (<span class="charliteral">'0'</span> == gerb_fgetc(fd) &amp;&amp; state-&gt;autod)
<a name="l01265"></a>01265                      {
<a name="l01266"></a>01266                          state-&gt;number_format = FMT_000_000;
<a name="l01267"></a>01267                          state-&gt;decimals = 3;
<a name="l01268"></a>01268                      }
<a name="l01269"></a>01269                   <span class="keywordflow">else</span> {
<a name="l01270"></a>01270                      gerb_ungetc(fd);
<a name="l01271"></a>01271                      <span class="keywordflow">if</span> (state-&gt;autod)
<a name="l01272"></a>01272                          {
<a name="l01273"></a>01273                             state-&gt;number_format = FMT_000_00;
<a name="l01274"></a>01274                             state-&gt;decimals = 2;
<a name="l01275"></a>01275                          }
<a name="l01276"></a>01276                   }
<a name="l01277"></a>01277                   eat_line(fd);
<a name="l01278"></a>01278                   <span class="keywordflow">break</span>;
<a name="l01279"></a>01279 
<a name="l01280"></a>01280               <span class="keywordflow">default</span>:
<a name="l01281"></a>01281               junk:
<a name="l01282"></a>01282                   drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l01283"></a>01283                                      -1,
<a name="l01284"></a>01284                                      <span class="stringliteral">"Found junk after METRIC command\n"</span>,
<a name="l01285"></a>01285                                      <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l01286"></a>01286                   gerb_ungetc(fd);
<a name="l01287"></a>01287                   eat_line(fd);
<a name="l01288"></a>01288                   <span class="keywordflow">break</span>;
<a name="l01289"></a>01289               }
<a name="l01290"></a>01290            } <span class="keywordflow">else</span> {
<a name="l01291"></a>01291               gerb_ungetc(fd);
<a name="l01292"></a>01292               eat_line(fd);
<a name="l01293"></a>01293            }
<a name="l01294"></a>01294 
<a name="l01295"></a>01295            <span class="keywordflow">return</span> DRILL_M_METRICHEADER;
<a name="l01296"></a>01296        }
<a name="l01297"></a>01297     } <span class="keywordflow">else</span> {
<a name="l01298"></a>01298        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#39b7c23c1dc8535595504241a442ee87">M_unknown</a>++;
<a name="l01299"></a>01299        result = DRILL_M_UNKNOWN;
<a name="l01300"></a>01300     }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302     dprintf(<span class="stringliteral">"&lt;----  ...leaving drill_parse_M_code.\n"</span>);
<a name="l01303"></a>01303     <span class="keywordflow">return</span> result;
<a name="l01304"></a>01304 } <span class="comment">/* drill_parse_M_code */</span>
<a name="l01305"></a>01305 
<a name="l01306"></a>01306 
<a name="l01307"></a>01307 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l01308"></a>01308 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01309"></a>01309 drill_parse_G_code(gerb_file_t *fd, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image)
<a name="l01310"></a>01310 {
<a name="l01311"></a>01311     <span class="keywordtype">char</span> op[3] = <span class="stringliteral">"  "</span>;
<a name="l01312"></a>01312     <span class="keywordtype">int</span>  read[3];
<a name="l01313"></a>01313     <a class="code" href="structgerbv__drill__stats__t.html">gerbv_drill_stats_t</a> *stats = image-&gt;<a class="code" href="structgerbv__image__t.html#911cb23ad6a1b5e4a10903a761982d89">drill_stats</a>;
<a name="l01314"></a>01314     <span class="keywordtype">int</span> result;
<a name="l01315"></a>01315     
<a name="l01316"></a>01316     dprintf(<span class="stringliteral">"---&gt; entering drill_parse_G_code ...\n"</span>);
<a name="l01317"></a>01317 
<a name="l01318"></a>01318     read[0] = gerb_fgetc(fd);
<a name="l01319"></a>01319     read[1] = gerb_fgetc(fd);
<a name="l01320"></a>01320 
<a name="l01321"></a>01321     <span class="keywordflow">if</span> ((read[0] == EOF) || (read[1] == EOF)) {
<a name="l01322"></a>01322        drill_stats_add_error(stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b2ed548dbb3927425c4a78956ff0fc3e">error_list</a>,
<a name="l01323"></a>01323                            -1,
<a name="l01324"></a>01324                            <span class="stringliteral">"Unexpected EOF found while parsing G code.\n"</span>,
<a name="l01325"></a>01325                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01326"></a>01326     }
<a name="l01327"></a>01327 
<a name="l01328"></a>01328     op[0] = read[0], op[1] = read[1], op[2] = 0;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"00"</span>, 2) == 0) {
<a name="l01331"></a>01331        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#2b9d4a8bdfd48f153f72df661ccab542">G00</a>++;
<a name="l01332"></a>01332        result = DRILL_G_ROUT;
<a name="l01333"></a>01333     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"01"</span>, 2) == 0) {
<a name="l01334"></a>01334        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#427838ff39bb24a08f8840d620d20bb4">G01</a>++;
<a name="l01335"></a>01335        result = DRILL_G_LINEARMOVE;
<a name="l01336"></a>01336     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"02"</span>, 2) == 0) {
<a name="l01337"></a>01337        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#e52798d68060fb365a9be14be022a13c">G02</a>++;
<a name="l01338"></a>01338        result = DRILL_G_CWMOVE;
<a name="l01339"></a>01339     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"03"</span>, 2) == 0) {
<a name="l01340"></a>01340        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#b6bca609ee2b2367c03f823995d25012">G03</a>++;
<a name="l01341"></a>01341        result = DRILL_G_CCWMOVE;
<a name="l01342"></a>01342     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"05"</span>, 2) == 0) {
<a name="l01343"></a>01343        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#d5c214851ce88b57425a41d08244a04a">G05</a>++;
<a name="l01344"></a>01344        result = DRILL_G_DRILL;
<a name="l01345"></a>01345     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"90"</span>, 2) == 0) {
<a name="l01346"></a>01346        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#1d54358d5496399a315d3b3a3df67011">G90</a>++;
<a name="l01347"></a>01347        result = DRILL_G_ABSOLUTE;
<a name="l01348"></a>01348     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"91"</span>, 2) == 0) {
<a name="l01349"></a>01349        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#ed5fd4c7c90dd9b41edbac234cbebb03">G91</a>++;
<a name="l01350"></a>01350        result = DRILL_G_INCREMENTAL;
<a name="l01351"></a>01351     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(op, <span class="stringliteral">"93"</span>, 2) == 0) {
<a name="l01352"></a>01352        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#c19c8ef09c868737f9d154f1053ee6cc">G93</a>++;
<a name="l01353"></a>01353        result = DRILL_G_ZEROSET;
<a name="l01354"></a>01354     } <span class="keywordflow">else</span> {  
<a name="l01355"></a>01355        stats-&gt;<a class="code" href="structgerbv__drill__stats__t.html#4086da36e84b6a9012e78b279d83503d">G_unknown</a>++;
<a name="l01356"></a>01356        result = DRILL_G_UNKNOWN;
<a name="l01357"></a>01357     }
<a name="l01358"></a>01358 
<a name="l01359"></a>01359     dprintf(<span class="stringliteral">"&lt;----  ...leaving drill_parse_G_code.\n"</span>);
<a name="l01360"></a>01360     <span class="keywordflow">return</span> result;
<a name="l01361"></a>01361 
<a name="l01362"></a>01362 } <span class="comment">/* drill_parse_G_code */</span>
<a name="l01363"></a>01363 
<a name="l01364"></a>01364 
<a name="l01365"></a>01365 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l01366"></a>01366 <span class="comment">/* Parse on drill file coordinate.</span>
<a name="l01367"></a>01367 <span class="comment">   Returns nothing, but modifies state */</span>
<a name="l01368"></a>01368 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01369"></a>01369 drill_parse_coordinate(gerb_file_t *fd, <span class="keywordtype">char</span> firstchar,
<a name="l01370"></a>01370                      <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image, drill_state_t *state)
<a name="l01371"></a>01371 
<a name="l01372"></a>01372 {
<a name="l01373"></a>01373     <span class="keywordtype">int</span> read;
<a name="l01374"></a>01374 
<a name="l01375"></a>01375     <span class="keywordflow">if</span>(state-&gt;coordinate_mode == DRILL_MODE_ABSOLUTE) {
<a name="l01376"></a>01376        <span class="keywordflow">if</span>(firstchar == <span class="charliteral">'X'</span>) {
<a name="l01377"></a>01377            state-&gt;curr_x = read_double(fd, state-&gt;number_format, image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a>, state-&gt;decimals);
<a name="l01378"></a>01378            <span class="keywordflow">if</span>((read = (<span class="keywordtype">char</span>)gerb_fgetc(fd)) == <span class="charliteral">'Y'</span>) {
<a name="l01379"></a>01379               state-&gt;curr_y = read_double(fd, state-&gt;number_format, image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a>, state-&gt;decimals);
<a name="l01380"></a>01380            }
<a name="l01381"></a>01381        } <span class="keywordflow">else</span> {
<a name="l01382"></a>01382            state-&gt;curr_y = read_double(fd, state-&gt;number_format, image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a>, state-&gt;decimals);
<a name="l01383"></a>01383        }
<a name="l01384"></a>01384     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(state-&gt;coordinate_mode == DRILL_MODE_INCREMENTAL) {
<a name="l01385"></a>01385        <span class="keywordflow">if</span>(firstchar == <span class="charliteral">'X'</span>) {
<a name="l01386"></a>01386            state-&gt;curr_x += read_double(fd, state-&gt;number_format, image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a>, state-&gt;decimals);
<a name="l01387"></a>01387            <span class="keywordflow">if</span>((read = (<span class="keywordtype">char</span>)gerb_fgetc(fd)) == <span class="charliteral">'Y'</span>) {
<a name="l01388"></a>01388               state-&gt;curr_y += read_double(fd, state-&gt;number_format, image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a>, state-&gt;decimals);
<a name="l01389"></a>01389            }
<a name="l01390"></a>01390        } <span class="keywordflow">else</span> {
<a name="l01391"></a>01391            state-&gt;curr_y += read_double(fd, state-&gt;number_format, image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a>, state-&gt;decimals);
<a name="l01392"></a>01392        }
<a name="l01393"></a>01393     }
<a name="l01394"></a>01394 
<a name="l01395"></a>01395 } <span class="comment">/* drill_parse_coordinate */</span>
<a name="l01396"></a>01396 
<a name="l01397"></a>01397 
<a name="l01398"></a>01398 <span class="comment">/* Allocates and returns a new drill_state structure</span>
<a name="l01399"></a>01399 <span class="comment">   Returns state pointer on success, NULL on ERROR */</span>
<a name="l01400"></a>01400 <span class="keyword">static</span> drill_state_t *
<a name="l01401"></a>01401 new_state(drill_state_t *state)
<a name="l01402"></a>01402 {
<a name="l01403"></a>01403     state = (drill_state_t *)g_malloc(<span class="keyword">sizeof</span>(drill_state_t));
<a name="l01404"></a>01404     <span class="keywordflow">if</span> (state != NULL) {
<a name="l01405"></a>01405        <span class="comment">/* Init structure */</span>
<a name="l01406"></a>01406        memset((<span class="keywordtype">void</span> *)state, 0, <span class="keyword">sizeof</span>(drill_state_t));
<a name="l01407"></a>01407        state-&gt;curr_section = DRILL_NONE;
<a name="l01408"></a>01408        state-&gt;coordinate_mode = DRILL_MODE_ABSOLUTE;
<a name="l01409"></a>01409        state-&gt;origin_x = 0.0;
<a name="l01410"></a>01410        state-&gt;origin_y = 0.0;
<a name="l01411"></a>01411        state-&gt;unit = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dcebd4891809b810b7f6d2506e46b6a1859">GERBV_UNIT_UNSPECIFIED</a>;
<a name="l01412"></a>01412        state-&gt;backup_number_format = FMT_000_000; <span class="comment">/* only used for METRIC */</span>
<a name="l01413"></a>01413        state-&gt;header_number_format = state-&gt;number_format = FMT_00_0000; <span class="comment">/* i. e. INCH */</span>
<a name="l01414"></a>01414        state-&gt;autod = 1;
<a name="l01415"></a>01415        state-&gt;decimals = 4;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417     }
<a name="l01418"></a>01418     <span class="keywordflow">return</span> state;
<a name="l01419"></a>01419 } <span class="comment">/* new_state */</span>
<a name="l01420"></a>01420 
<a name="l01421"></a>01421 
<a name="l01422"></a>01422 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l01423"></a>01423 <span class="comment">/* Reads one double from fd and returns it.</span>
<a name="l01424"></a>01424 <span class="comment">   If a decimal point is found, fmt is not used. */</span>
<a name="l01425"></a>01425 <span class="keyword">static</span> <span class="keywordtype">double</span>
<a name="l01426"></a>01426 read_double(gerb_file_t *fd, <span class="keyword">enum</span> number_fmt_t fmt, <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7">gerbv_omit_zeros_t</a> omit_zeros, <span class="keywordtype">int</span> decimals)
<a name="l01427"></a>01427 {
<a name="l01428"></a>01428     <span class="keywordtype">int</span> read;
<a name="l01429"></a>01429     <span class="keywordtype">char</span> temp[0x20];
<a name="l01430"></a>01430     <span class="keywordtype">int</span> i = 0, ndigits = 0;
<a name="l01431"></a>01431     <span class="keywordtype">double</span> result;
<a name="l01432"></a>01432     gboolean decimal_point = FALSE;
<a name="l01433"></a>01433 
<a name="l01434"></a>01434     memset(temp, 0, <span class="keyword">sizeof</span>(temp));
<a name="l01435"></a>01435 
<a name="l01436"></a>01436     read = gerb_fgetc(fd);
<a name="l01437"></a>01437     <span class="keywordflow">while</span>(read != EOF &amp;&amp; i &lt; <span class="keyword">sizeof</span>(temp) &amp;&amp;
<a name="l01438"></a>01438          (isdigit(read) || read == <span class="charliteral">'.'</span> || read == <span class="charliteral">','</span> || read == <span class="charliteral">'+'</span> || read == <span class="charliteral">'-'</span>)) {
<a name="l01439"></a>01439        <span class="keywordflow">if</span>(read == <span class="charliteral">','</span> || read == <span class="charliteral">'.'</span>) decimal_point = TRUE;
<a name="l01440"></a>01440        <span class="keywordflow">if</span>(read == <span class="charliteral">','</span>)
<a name="l01441"></a>01441            read = <span class="charliteral">'.'</span>; <span class="comment">/* adjust for strtod() */</span>
<a name="l01442"></a>01442        <span class="keywordflow">if</span>(isdigit(read)) ndigits++;
<a name="l01443"></a>01443        temp[i++] = (char)read;
<a name="l01444"></a>01444        read = gerb_fgetc(fd);
<a name="l01445"></a>01445     }
<a name="l01446"></a>01446     temp[i] = 0;
<a name="l01447"></a>01447 
<a name="l01448"></a>01448     gerb_ungetc(fd);
<a name="l01449"></a>01449     <span class="keywordflow">if</span> (decimal_point) {
<a name="l01450"></a>01450        result = strtod(temp, NULL);
<a name="l01451"></a>01451     } <span class="keywordflow">else</span> {
<a name="l01452"></a>01452        <span class="keywordtype">int</span> wantdigits;
<a name="l01453"></a>01453        <span class="keywordtype">double</span> scale;
<a name="l01454"></a>01454 
<a name="l01455"></a>01455        <span class="comment">/* Nothing to take care for when leading zeros are</span>
<a name="l01456"></a>01456 <span class="comment">          omitted. */</span>
<a name="l01457"></a>01457        <span class="keywordflow">if</span> (omit_zeros == <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7085ee95a5b4d68f30e4ab554c9b2e94a">GERBV_OMIT_ZEROS_TRAILING</a>) {
<a name="l01458"></a>01458            <span class="keywordflow">switch</span> (fmt) {
<a name="l01459"></a>01459            <span class="keywordflow">case</span> FMT_00_0000:
<a name="l01460"></a>01460            <span class="keywordflow">case</span> FMT_000_000:
<a name="l01461"></a>01461            <span class="keywordflow">case</span> FMT_0000_00:
<a name="l01462"></a>01462               wantdigits = 6;
<a name="l01463"></a>01463               <span class="keywordflow">break</span>;
<a name="l01464"></a>01464 
<a name="l01465"></a>01465            <span class="keywordflow">case</span> FMT_000_00:
<a name="l01466"></a>01466               wantdigits = 5;
<a name="l01467"></a>01467               <span class="keywordflow">break</span>;
<a name="l01468"></a>01468 
<a name="l01469"></a>01469            <span class="keywordflow">default</span>:
<a name="l01470"></a>01470               <span class="comment">/* cannot happen, just plugs a compiler warning */</span>
<a name="l01471"></a>01471               <span class="keywordflow">return</span> 0;
<a name="l01472"></a>01472            }
<a name="l01473"></a>01473 
<a name="l01474"></a>01474            <span class="comment">/* fill missing trailing digits */</span>
<a name="l01475"></a>01475            <span class="keywordflow">while</span> (ndigits &lt; wantdigits) {
<a name="l01476"></a>01476               temp[i++] = <span class="charliteral">'0'</span>;
<a name="l01477"></a>01477               ndigits++;
<a name="l01478"></a>01478            }
<a name="l01479"></a>01479            temp[i] = 0;
<a name="l01480"></a>01480        }
<a name="l01481"></a>01481 
<a name="l01482"></a>01482        <span class="keywordflow">switch</span> (fmt) {
<a name="l01483"></a>01483        <span class="keywordflow">case</span> FMT_00_0000:
<a name="l01484"></a>01484            scale = 1E-4;
<a name="l01485"></a>01485            <span class="keywordflow">break</span>;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487        <span class="keywordflow">case</span> FMT_000_000:
<a name="l01488"></a>01488            scale = 1E-3;
<a name="l01489"></a>01489            <span class="keywordflow">break</span>;
<a name="l01490"></a>01490 
<a name="l01491"></a>01491        <span class="keywordflow">case</span> FMT_000_00:
<a name="l01492"></a>01492        <span class="keywordflow">case</span> FMT_0000_00:
<a name="l01493"></a>01493            scale = 1E-2;
<a name="l01494"></a>01494            <span class="keywordflow">break</span>;
<a name="l01495"></a>01495 
<a name="l01496"></a>01496        <span class="keywordflow">case</span> FMT_USER:
<a name="l01497"></a>01497            scale = pow (10.0, -1.0*decimals);
<a name="l01498"></a>01498            <span class="keywordflow">break</span>;
<a name="l01499"></a>01499 
<a name="l01500"></a>01500        <span class="keywordflow">default</span>:
<a name="l01501"></a>01501            <span class="comment">/* cannot happen, just plugs a compiler warning */</span>
<a name="l01502"></a>01502            fprintf (stderr, <span class="stringliteral">"%s(): Unhandled fmt ` %d\n"</span>, __FUNCTION__, fmt);
<a name="l01503"></a>01503            exit (1);
<a name="l01504"></a>01504        }
<a name="l01505"></a>01505 
<a name="l01506"></a>01506        result = strtod(temp, NULL) * scale;
<a name="l01507"></a>01507     }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509     <span class="keywordflow">return</span> result;
<a name="l01510"></a>01510 } <span class="comment">/* read_double */</span>
<a name="l01511"></a>01511 
<a name="l01512"></a>01512 
<a name="l01513"></a>01513 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l01514"></a>01514 <span class="comment">/* Eats all characters up to and including </span>
<a name="l01515"></a>01515 <span class="comment">   the first one of CR or LF */</span>
<a name="l01516"></a>01516 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01517"></a>01517 eat_line(gerb_file_t *fd)
<a name="l01518"></a>01518 {
<a name="l01519"></a>01519     <span class="keywordtype">int</span> read = gerb_fgetc(fd);
<a name="l01520"></a>01520     
<a name="l01521"></a>01521     <span class="keywordflow">while</span>(read != 10 &amp;&amp; read != 13) {
<a name="l01522"></a>01522        <span class="keywordflow">if</span> (read == EOF) <span class="keywordflow">return</span>;
<a name="l01523"></a>01523        read = gerb_fgetc(fd);
<a name="l01524"></a>01524     }
<a name="l01525"></a>01525 } <span class="comment">/* eat_line */</span>
<a name="l01526"></a>01526 
<a name="l01527"></a>01527 
<a name="l01528"></a>01528 <span class="comment">/* -------------------------------------------------------------- */</span>
<a name="l01529"></a>01529 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01530"></a>01530 get_line(gerb_file_t *fd)
<a name="l01531"></a>01531 {
<a name="l01532"></a>01532     <span class="keywordtype">int</span> read = gerb_fgetc(fd);
<a name="l01533"></a>01533     gchar *retstring = <span class="stringliteral">""</span>;
<a name="l01534"></a>01534     gchar *tmps = NULL;
<a name="l01535"></a>01535 
<a name="l01536"></a>01536     <span class="keywordflow">while</span>(read != 10 &amp;&amp; read != 13) {
<a name="l01537"></a>01537        <span class="keywordflow">if</span> (read == EOF) <span class="keywordflow">return</span> retstring;
<a name="l01538"></a>01538        retstring = g_strdup_printf(<span class="stringliteral">"%s%c"</span>, retstring, read);
<a name="l01539"></a>01539 
<a name="l01540"></a>01540        <span class="comment">/* since g_strdup_printf allocates memory, we need to free it */</span>
<a name="l01541"></a>01541        <span class="keywordflow">if</span> (tmps)  {
<a name="l01542"></a>01542            g_free (tmps);
<a name="l01543"></a>01543            tmps = NULL;
<a name="l01544"></a>01544        }
<a name="l01545"></a>01545        tmps = retstring;;
<a name="l01546"></a>01546        read = gerb_fgetc(fd);
<a name="l01547"></a>01547     }
<a name="l01548"></a>01548     <span class="keywordflow">return</span> retstring;
<a name="l01549"></a>01549 } <span class="comment">/* get_line */</span>
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Aug 19 00:14:48 2008 for gerbv by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
