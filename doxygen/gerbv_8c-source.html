<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>gerbv: src/gerbv.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0fba06f62092f0c8d9ff47b96507f331.html">src</a>
  </div>
</div>
<div class="contents">
<h1>gerbv.c</h1><a href="gerbv_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * gEDA - GNU Electronic Design Automation</span>
<a name="l00003"></a>00003 <span class="comment"> * This file is a part of gerbv.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *   Copyright (C) 2000-2003 Stefan Petersen (spe@stacken.kth.se)</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * $Id$</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00010"></a>00010 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00011"></a>00011 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00012"></a>00012 <span class="comment"> * (at your option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00017"></a>00017 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00020"></a>00020 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00021"></a>00021 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111 USA</span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023  
<a name="l00024"></a>00024  
<a name="l00030"></a>00030 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
<a name="l00032"></a>00032 <span class="preprocessor">#endif</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#ifdef HAVE_LIBGEN_H</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#include &lt;libgen.h&gt;</span> <span class="comment">/* dirname */</span>
<a name="l00040"></a>00040 <span class="preprocessor">#endif</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#ifdef HAVE_STRING_H</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#endif</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="preprocessor">#ifdef HAVE_UNISTD_H</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#endif</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;glib.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;gtk/gtk.h&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;gdk/gdk.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;gdk/gdkkeysyms.h&gt;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#ifdef HAVE_GETOPT_H</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">  #include &lt;getopt.h&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#endif</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;pango/pango.h&gt;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;locale.h&gt;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#include "<a class="code" href="gerbv_8h.html" title="The main header file for the libgerbv library.">gerbv.h</a>"</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include "<a class="code" href="gerber_8h.html" title="Header info for the RS274X parsing functions.">gerber.h</a>"</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include "<a class="code" href="drill_8h.html" title="Header infor for the Excellon drill parsing functions.">drill.h</a>"</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#ifdef RENDER_USING_GDK</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">  #include "<a class="code" href="draw-gdk_8h.html" title="Header info for the GDK rendering functions.">draw-gdk.h</a>"</span>
<a name="l00070"></a>00070 <span class="preprocessor">#else</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span><span class="preprocessor">  #include "<a class="code" href="draw-gdk_8h.html" title="Header info for the GDK rendering functions.">draw-gdk.h</a>"</span>
<a name="l00072"></a>00072 <span class="preprocessor">  #include "<a class="code" href="draw_8h.html" title="Header info for the cairo rendering functions and the related selection calculating...">draw.h</a>"</span>
<a name="l00073"></a>00073 <span class="preprocessor">#endif</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 <span class="preprocessor">#include "<a class="code" href="pick-and-place_8h.html" title="Header info for the PNP (pick-and-place) parsing functions.">pick-and-place.h</a>"</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">/* DEBUG printing.  #define DEBUG 1 in config.h to use this fcn. */</span>
<a name="l00078"></a>00078 <span class="preprocessor">#define dprintf if(DEBUG) printf</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>
<a name="l00080"></a>00080 <span class="preprocessor">#define NUMBER_OF_DEFAULT_COLORS 18</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#define NUMBER_OF_DEFAULT_TRANSFORMATIONS 20</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>
<a name="l00083"></a>00083 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00084"></a>00084 <span class="keyword">static</span> <a class="code" href="structgerbv__layer__color.html">gerbv_layer_color</a> defaultColors[NUMBER_OF_DEFAULT_COLORS] = {
<a name="l00085"></a>00085        {115,115,222,177},
<a name="l00086"></a>00086        {255,127,115,177},
<a name="l00087"></a>00087        {193,0,224,177},
<a name="l00088"></a>00088        {117,242,103,177},
<a name="l00089"></a>00089        {0,195,195,177},
<a name="l00090"></a>00090        {213,253,51,177},
<a name="l00091"></a>00091        {209,27,104,177},
<a name="l00092"></a>00092        {255,197,51,177},
<a name="l00093"></a>00093        {186,186,186,177},
<a name="l00094"></a>00094        {211,211,255,177},
<a name="l00095"></a>00095        {253,210,206,177},
<a name="l00096"></a>00096        {236,194,242,177},
<a name="l00097"></a>00097        {208,249,204,177},
<a name="l00098"></a>00098        {183,255,255,177},
<a name="l00099"></a>00099        {241,255,183,177},
<a name="l00100"></a>00100        {255,202,225,177},
<a name="l00101"></a>00101        {253,238,197,177},
<a name="l00102"></a>00102        {226,226,226,177}
<a name="l00103"></a>00103 };
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00106"></a>00106 <span class="keyword">static</span> <a class="code" href="structgerbv__user__transformation__t.html">gerbv_user_transformation_t</a> defaultTransformations[NUMBER_OF_DEFAULT_TRANSFORMATIONS] = {
<a name="l00107"></a>00107        {0,0,0,0,FALSE},
<a name="l00108"></a>00108        {0,0,0,0,FALSE},
<a name="l00109"></a>00109        {0,0,0,0,FALSE},
<a name="l00110"></a>00110        {0,0,0,0,FALSE},
<a name="l00111"></a>00111        {0,0,0,0,FALSE},     
<a name="l00112"></a>00112        {0,0,0,0,FALSE},
<a name="l00113"></a>00113        {0,0,0,0,FALSE},
<a name="l00114"></a>00114        {0,0,0,0,FALSE},
<a name="l00115"></a>00115        {0,0,0,0,FALSE},
<a name="l00116"></a>00116        {0,0,0,0,FALSE},            
<a name="l00117"></a>00117        {0,0,0,0,FALSE},
<a name="l00118"></a>00118        {0,0,0,0,FALSE},
<a name="l00119"></a>00119        {0,0,0,0,FALSE},
<a name="l00120"></a>00120        {0,0,0,0,FALSE},
<a name="l00121"></a>00121        {0,0,0,0,FALSE},     
<a name="l00122"></a>00122        {0,0,0,0,FALSE},
<a name="l00123"></a>00123        {0,0,0,0,FALSE},
<a name="l00124"></a>00124        {0,0,0,0,FALSE},
<a name="l00125"></a>00125        {0,0,0,0,FALSE},
<a name="l00126"></a>00126        {0,0,0,0,FALSE},
<a name="l00127"></a>00127 };
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00130"></a>00130 <a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *
<a name="l00131"></a><a class="code" href="gerbv_8h.html#5320e4f59b98078e635681ef0c5454c8">00131</a> <a class="code" href="gerbv_8c.html#5320e4f59b98078e635681ef0c5454c8" title="Create a new project structure and initialize some important variables.">gerbv_create_project</a> (<span class="keywordtype">void</span>) {
<a name="l00132"></a>00132        <a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *returnProject= (<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *) g_new0(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a>,1);
<a name="l00133"></a>00133        
<a name="l00134"></a>00134        <span class="comment">/* default to using the current directory path for our starting guesses</span>
<a name="l00135"></a>00135 <span class="comment">              on future file loads */</span>
<a name="l00136"></a>00136        returnProject-&gt;<a class="code" href="structgerbv__project__t.html#8b8fc06714c48c6282639412d964ad9a">path</a> = g_get_current_dir ();
<a name="l00137"></a>00137        <span class="comment">/* Will be updated to 0 when first Gerber is loaded */</span>
<a name="l00138"></a>00138        returnProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a> = -1;
<a name="l00139"></a>00139        returnProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a> = 1;
<a name="l00140"></a>00140        returnProject-&gt;<a class="code" href="structgerbv__project__t.html#575394096f3cd4e249bbe85bc1c2a18c">check_before_delete</a> = TRUE;
<a name="l00141"></a>00141        returnProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a> = (<a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a> **) calloc (returnProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>, sizeof (<a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a> *));
<a name="l00142"></a>00142 
<a name="l00143"></a>00143        <span class="keywordflow">return</span> returnProject;
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00147"></a>00147 <span class="keywordtype">void</span>
<a name="l00148"></a><a class="code" href="gerbv_8h.html#2e09480d52ed08f73975eec160946b0c">00148</a> <a class="code" href="gerbv_8c.html#2e09480d52ed08f73975eec160946b0c" title="Free a project and all related variables.">gerbv_destroy_project</a> (<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject){
<a name="l00149"></a>00149        <span class="keywordtype">int</span> i;
<a name="l00150"></a>00150        
<a name="l00151"></a>00151        <span class="comment">/* destroy all the files attached to the project */</span>
<a name="l00152"></a>00152        <span class="keywordflow">for</span>(i = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>-1; i &gt;= 0; i--) {
<a name="l00153"></a>00153               <span class="keywordflow">if</span> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i])
<a name="l00154"></a>00154                      <a class="code" href="gerbv_8c.html#b43d1b7b60326dbba1f4ab0e092566bf" title="Free a fileinfo structure.">gerbv_destroy_fileinfo</a> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]);
<a name="l00155"></a>00155        }
<a name="l00156"></a>00156        <span class="comment">/* destroy the fileinfo array */</span>
<a name="l00157"></a>00157        g_free (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>);
<a name="l00158"></a>00158        g_free (gerbvProject);
<a name="l00159"></a>00159 }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00162"></a>00162 <span class="keywordtype">void</span>
<a name="l00163"></a><a class="code" href="gerbv_8h.html#b43d1b7b60326dbba1f4ab0e092566bf">00163</a> <a class="code" href="gerbv_8c.html#b43d1b7b60326dbba1f4ab0e092566bf" title="Free a fileinfo structure.">gerbv_destroy_fileinfo</a> (<a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a> *fileInfo){
<a name="l00164"></a>00164        <a class="code" href="gerb__image_8c.html#2394060b1868594b1ae8b8edcca793e9" title="Free an image structure.">gerbv_destroy_image</a> (fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>);
<a name="l00165"></a>00165        g_free (fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0706ff252b9298d43d32beac6c99ec5d">fullPathname</a>);
<a name="l00166"></a>00166        g_free (fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#32bf3fed3f7a68bbd855a86839b52532">name</a>);
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00170"></a>00170 <span class="keywordtype">void</span> 
<a name="l00171"></a><a class="code" href="gerbv_8h.html#99cc1512fb3e47976604fde92ae3ce8c">00171</a> <a class="code" href="gerbv_8c.html#99cc1512fb3e47976604fde92ae3ce8c" title="Open a file, parse the contents, and add a new layer to an existing project.">gerbv_open_layer_from_filename</a>(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, gchar *filename) 
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173   gint idx_loaded;
<a name="l00174"></a>00174   dprintf(<span class="stringliteral">"Opening filename = %s\n"</span>, (gchar *) filename);
<a name="l00175"></a>00175   
<a name="l00176"></a>00176   <span class="keywordflow">if</span> (gerbv_open_image(gerbvProject, filename, ++gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a>, FALSE, NULL, 0, TRUE) == -1) {
<a name="l00177"></a>00177     GERB_MESSAGE(<span class="stringliteral">"could not read %s[%d]"</span>, (gchar *) filename,
<a name="l00178"></a>00178                gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a>);
<a name="l00179"></a>00179     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a>--;
<a name="l00180"></a>00180   } <span class="keywordflow">else</span> {
<a name="l00181"></a>00181     idx_loaded = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a>;
<a name="l00182"></a>00182     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx_loaded]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#aa8bf32fb43e02cb6613d9b07624b5bc">layer_dirty</a> = FALSE;
<a name="l00183"></a>00183     dprintf(<span class="stringliteral">"     Successfully opened file!\n"</span>); 
<a name="l00184"></a>00184   }
<a name="l00185"></a>00185 } <span class="comment">/* gerbv_open_layer_from_filename */</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00188"></a>00188 <span class="keywordtype">void</span> 
<a name="l00189"></a><a class="code" href="gerbv_8h.html#62a43082bcb669b8fb3fe3da0769eff0">00189</a> <a class="code" href="gerbv_8c.html#62a43082bcb669b8fb3fe3da0769eff0" title="Open a file, parse the contents, and add a new layer to an existing project while...">gerbv_open_layer_from_filename_with_color</a>(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, gchar *filename,
<a name="l00190"></a>00190               guint16 red, guint16 green, guint16 blue, guint16 alpha)
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192   gint idx_loaded;
<a name="l00193"></a>00193   dprintf(<span class="stringliteral">"Opening filename = %s\n"</span>, (gchar *) filename);
<a name="l00194"></a>00194   
<a name="l00195"></a>00195   <span class="keywordflow">if</span> (gerbv_open_image(gerbvProject, filename, ++gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a>, FALSE, NULL, 0, TRUE) == -1) {
<a name="l00196"></a>00196     GERB_MESSAGE(<span class="stringliteral">"could not read %s[%d]"</span>, (gchar *) filename,
<a name="l00197"></a>00197                gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a>);
<a name="l00198"></a>00198     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a>--;
<a name="l00199"></a>00199   } <span class="keywordflow">else</span> {
<a name="l00200"></a>00200     idx_loaded = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a>;
<a name="l00201"></a>00201     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx_loaded]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#aa8bf32fb43e02cb6613d9b07624b5bc">layer_dirty</a> = FALSE;
<a name="l00202"></a>00202     GdkColor colorTemplate = {0, red, green, blue};
<a name="l00203"></a>00203     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx_loaded]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#412c5aa0e56866c1d0d10edfd09a5a1d">color</a> = colorTemplate;
<a name="l00204"></a>00204     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx_loaded]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#00d1a74686e09a34d72cfeb357a1004d">alpha</a> = alpha;
<a name="l00205"></a>00205     dprintf(<span class="stringliteral">"     Successfully opened file!\n"</span>); 
<a name="l00206"></a>00206   }
<a name="l00207"></a>00207 } <span class="comment">/* gerbv_open_layer_from_filename_with_color */</span>  
<a name="l00208"></a>00208     
<a name="l00209"></a>00209 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00210"></a>00210 gboolean 
<a name="l00211"></a>00211 gerbv_save_layer_from_index(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, gint index, gchar *filename) 
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213     <span class="keywordflow">if</span> (strcmp (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#19e8f705e0adc68d5385069009e20fe4">type</a>,<span class="stringliteral">"RS274-X (Gerber) File"</span>)==0) {
<a name="l00214"></a>00214        <a class="code" href="export-rs274x_8c.html#49e264bfff8ce4ae783c173b48bba31d" title="Export an image to a new file in RS274X format.">gerbv_export_rs274x_file_from_image</a> (filename, gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>);
<a name="l00215"></a>00215     }
<a name="l00216"></a>00216     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#19e8f705e0adc68d5385069009e20fe4">type</a>,<span class="stringliteral">"Excellon Drill File"</span>)==0) {
<a name="l00217"></a>00217        <a class="code" href="export-drill_8c.html#1c57c267a10404d6fb15fd987f9052f6" title="Export an image to a new file in Excellon drill format.">gerbv_export_drill_file_from_image</a> (filename, gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>);
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219     <span class="keywordflow">else</span> {
<a name="l00220"></a>00220        <span class="keywordflow">return</span> FALSE;
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#aa8bf32fb43e02cb6613d9b07624b5bc">layer_dirty</a> = FALSE;
<a name="l00223"></a>00223     <span class="keywordflow">return</span> TRUE;
<a name="l00224"></a>00224 } <span class="comment">/* gerbv_save_project_from_filename */</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00228"></a>00228 <span class="keywordtype">int</span>
<a name="l00229"></a>00229 gerbv_revert_file(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, <span class="keywordtype">int</span> idx){
<a name="l00230"></a>00230   <span class="keywordtype">int</span> rv;
<a name="l00231"></a>00231   
<a name="l00232"></a>00232   rv = gerbv_open_image(gerbvProject, gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0706ff252b9298d43d32beac6c99ec5d">fullPathname</a>, idx, TRUE, NULL, 0, TRUE);
<a name="l00233"></a>00233   gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#aa8bf32fb43e02cb6613d9b07624b5bc">layer_dirty</a> = FALSE;
<a name="l00234"></a>00234   <span class="keywordflow">return</span> rv;
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00238"></a>00238 <span class="keywordtype">void</span> 
<a name="l00239"></a>00239 gerbv_revert_all_files(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject) 
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241   <span class="keywordtype">int</span> idx;
<a name="l00242"></a>00242   
<a name="l00243"></a>00243   <span class="keywordflow">for</span> (idx = 0; idx &lt; gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>; idx++) {
<a name="l00244"></a>00244     <span class="keywordflow">if</span> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx] &amp;&amp; gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0706ff252b9298d43d32beac6c99ec5d">fullPathname</a>) {
<a name="l00245"></a>00245       (void) gerbv_revert_file (gerbvProject, idx);
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247   }
<a name="l00248"></a>00248 } <span class="comment">/* gerbv_revert_all_files */</span>
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00251"></a>00251 <span class="keywordtype">void</span> 
<a name="l00252"></a>00252 gerbv_unload_layer(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, <span class="keywordtype">int</span> index) 
<a name="l00253"></a>00253 {
<a name="l00254"></a>00254     gint i;
<a name="l00255"></a>00255     
<a name="l00256"></a>00256     <a class="code" href="gerb__image_8c.html#2394060b1868594b1ae8b8edcca793e9" title="Free an image structure.">gerbv_destroy_image</a>(gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>);  gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a> = NULL;
<a name="l00257"></a>00257     g_free(gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#32bf3fed3f7a68bbd855a86839b52532">name</a>);
<a name="l00258"></a>00258     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#32bf3fed3f7a68bbd855a86839b52532">name</a> = NULL;
<a name="l00259"></a>00259     g_free(gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]);
<a name="l00260"></a>00260     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index] = NULL;
<a name="l00261"></a>00261     
<a name="l00262"></a>00262     <span class="comment">/* slide all later layers down to fill the empty slot */</span>
<a name="l00263"></a>00263     <span class="keywordflow">for</span> (i=index; i&lt;(gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>-1); i++) {
<a name="l00264"></a>00264        gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]=gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i+1];
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266     <span class="comment">/* make sure the final spot is clear */</span>
<a name="l00267"></a>00267     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>-1] = NULL;
<a name="l00268"></a>00268     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#e46aefcf0d2e857be2d4c3c2370ede82">last_loaded</a>--;
<a name="l00269"></a>00269 } <span class="comment">/* gerbv_unload_layer */</span>
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00272"></a>00272 <span class="keywordtype">void</span> 
<a name="l00273"></a>00273 gerbv_unload_all_layers (<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject) 
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275     <span class="keywordtype">int</span> index;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="comment">/* Must count down since gerbv_unload_layer collapses</span>
<a name="l00278"></a>00278 <span class="comment">     * layers down.  Otherwise, layers slide past the index */</span>
<a name="l00279"></a>00279     <span class="keywordflow">for</span> (index = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>-1 ; index &gt;= 0; index--) {
<a name="l00280"></a>00280        <span class="keywordflow">if</span> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index] &amp;&amp; gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#32bf3fed3f7a68bbd855a86839b52532">name</a>) {
<a name="l00281"></a>00281            gerbv_unload_layer (gerbvProject, index);
<a name="l00282"></a>00282        }
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284 } <span class="comment">/* gerbv_unload_all_layers */</span>
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00288"></a>00288 <span class="keywordtype">void</span> 
<a name="l00289"></a>00289 gerbv_change_layer_order(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, gint oldPosition, gint newPosition) 
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     <a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a> *temp_file;
<a name="l00292"></a>00292     <span class="keywordtype">int</span> index;
<a name="l00293"></a>00293     
<a name="l00294"></a>00294     temp_file = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[oldPosition];
<a name="l00295"></a>00295        
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (oldPosition &lt; newPosition){
<a name="l00297"></a>00297        <span class="keywordflow">for</span> (index = oldPosition; index &lt; newPosition; index++) {
<a name="l00298"></a>00298            gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index] = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index + 1];
<a name="l00299"></a>00299        }
<a name="l00300"></a>00300     } <span class="keywordflow">else</span> {
<a name="l00301"></a>00301        <span class="keywordflow">for</span> (index = oldPosition; index &gt; newPosition; index--) {
<a name="l00302"></a>00302            gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index] = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[index - 1];
<a name="l00303"></a>00303        }
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[newPosition] = temp_file;
<a name="l00306"></a>00306 } <span class="comment">/* gerbv_change_layer_order */</span>
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00310"></a>00310 gint
<a name="l00311"></a>00311 gerbv_add_parsed_image_to_project (<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *parsed_image,
<a name="l00312"></a>00312                      gchar *filename, gchar *baseName, <span class="keywordtype">int</span> idx, <span class="keywordtype">int</span> reload){
<a name="l00313"></a>00313     gerb_verify_error_t error = GERB_IMAGE_OK;
<a name="l00314"></a>00314     <span class="keywordtype">int</span> r, g, b; 
<a name="l00315"></a>00315     
<a name="l00316"></a>00316     dprintf(<span class="stringliteral">"In open_image, now error check file....\n"</span>);
<a name="l00317"></a>00317     error = gerbv_image_verify(parsed_image);
<a name="l00318"></a>00318     <span class="keywordflow">if</span> (error) {
<a name="l00319"></a>00319        GERB_COMPILE_ERROR(<span class="stringliteral">"%s: Parse error:\n"</span>, filename);
<a name="l00320"></a>00320        <span class="keywordflow">if</span> (error &amp; GERB_IMAGE_MISSING_NETLIST)
<a name="l00321"></a>00321            GERB_COMPILE_ERROR(<span class="stringliteral">"* Missing netlist\n"</span>);
<a name="l00322"></a>00322        <span class="keywordflow">if</span> (error &amp; GERB_IMAGE_MISSING_FORMAT)
<a name="l00323"></a>00323            GERB_COMPILE_ERROR(<span class="stringliteral">"* Missing format\n"</span>);
<a name="l00324"></a>00324        <span class="keywordflow">if</span> (error &amp; GERB_IMAGE_MISSING_APERTURES) 
<a name="l00325"></a>00325            GERB_COMPILE_ERROR(<span class="stringliteral">"* Missing apertures/drill sizes\n"</span>);
<a name="l00326"></a>00326        <span class="keywordflow">if</span> (error &amp; GERB_IMAGE_MISSING_INFO)
<a name="l00327"></a>00327            GERB_COMPILE_ERROR(<span class="stringliteral">"* Missing info\n"</span>);
<a name="l00328"></a>00328        GERB_COMPILE_ERROR(<span class="stringliteral">"\n"</span>);
<a name="l00329"></a>00329        GERB_COMPILE_ERROR(<span class="stringliteral">"You probably tried to read an RS-274D file, which gerbv doesn't support\n"</span>);
<a name="l00330"></a>00330        <a class="code" href="gerb__image_8c.html#2394060b1868594b1ae8b8edcca793e9" title="Free an image structure.">gerbv_destroy_image</a>(parsed_image);
<a name="l00331"></a>00331        <span class="keywordflow">return</span> -1;
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333     
<a name="l00334"></a>00334     <span class="comment">/* Used to debug parser */</span>
<a name="l00335"></a>00335     <span class="comment">//if (gerbvProject-&gt;dump_parsed_image)</span>
<a name="l00336"></a>00336        <span class="comment">//gerb_image_dump(parsed_image);</span>
<a name="l00337"></a>00337     
<a name="l00338"></a>00338     <span class="comment">/*</span>
<a name="l00339"></a>00339 <span class="comment">     * If reload, just exchange the image. Else we have to allocate</span>
<a name="l00340"></a>00340 <span class="comment">     * a new memory before we define anything more.</span>
<a name="l00341"></a>00341 <span class="comment">     */</span>
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (reload) {
<a name="l00343"></a>00343        <a class="code" href="gerb__image_8c.html#2394060b1868594b1ae8b8edcca793e9" title="Free an image structure.">gerbv_destroy_image</a>(gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>);
<a name="l00344"></a>00344        gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a> = parsed_image;
<a name="l00345"></a>00345        <span class="keywordflow">return</span> 0;
<a name="l00346"></a>00346     } <span class="keywordflow">else</span> {
<a name="l00347"></a>00347        <span class="comment">/* Load new file. */</span>
<a name="l00348"></a>00348        gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx] = (<a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a> *) g_new0 (<a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a>, 1);
<a name="l00349"></a>00349        gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a> = parsed_image;
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351     
<a name="l00352"></a>00352     <span class="comment">/*</span>
<a name="l00353"></a>00353 <span class="comment">     * Store filename for eventual reload</span>
<a name="l00354"></a>00354 <span class="comment">     */</span>
<a name="l00355"></a>00355     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0706ff252b9298d43d32beac6c99ec5d">fullPathname</a> = g_strdup (filename);
<a name="l00356"></a>00356     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#32bf3fed3f7a68bbd855a86839b52532">name</a> = g_strdup (baseName);
<a name="l00357"></a>00357     
<a name="l00358"></a>00358     
<a name="l00359"></a>00359     {
<a name="l00360"></a>00360        r = defaultColors[idx % NUMBER_OF_DEFAULT_COLORS].<a class="code" href="structgerbv__layer__color.html#dabfffba7088a6824dce09b25cb4a7ce">red</a>*257;
<a name="l00361"></a>00361        g = defaultColors[idx % NUMBER_OF_DEFAULT_COLORS].<a class="code" href="structgerbv__layer__color.html#6621fb6bf3d3dca2463d00d671cb683f">green</a>*257;
<a name="l00362"></a>00362        b = defaultColors[idx % NUMBER_OF_DEFAULT_COLORS].<a class="code" href="structgerbv__layer__color.html#4c4e5a9e5832cca1e9381ccb6287677f">blue</a>*257;
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     GdkColor colorTemplate = {0, r, g, b};
<a name="l00366"></a>00366     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#412c5aa0e56866c1d0d10edfd09a5a1d">color</a> = colorTemplate;
<a name="l00367"></a>00367     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#00d1a74686e09a34d72cfeb357a1004d">alpha</a> = defaultColors[idx % NUMBER_OF_DEFAULT_COLORS].<a class="code" href="structgerbv__layer__color.html#3d03fbd669ad1784fbde7308b618cca9">alpha</a>*257;
<a name="l00368"></a>00368     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#fc59b2ffc535696e81b3086d025370c5">isVisible</a> = TRUE;
<a name="l00369"></a>00369     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#145b4c98b74e7b07d262e5ecad32199e">transform</a> = defaultTransformations[idx % NUMBER_OF_DEFAULT_TRANSFORMATIONS];
<a name="l00370"></a>00370     <span class="keywordflow">return</span> 1;
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00374"></a>00374 <span class="keywordtype">int</span>
<a name="l00375"></a>00375 gerbv_open_image(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, <span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> idx, <span class="keywordtype">int</span> reload,
<a name="l00376"></a>00376               gerbv_HID_Attribute *fattr, <span class="keywordtype">int</span> n_fattr, gboolean forceLoadFile)
<a name="l00377"></a>00377 {
<a name="l00378"></a>00378     gerb_file_t *fd;
<a name="l00379"></a>00379     <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *parsed_image = NULL, *parsed_image2 = NULL;
<a name="l00380"></a>00380     gint retv = -1;
<a name="l00381"></a>00381     gboolean isPnpFile = FALSE, foundBinary;
<a name="l00382"></a>00382     gerbv_HID_Attribute *attr_list = NULL;
<a name="l00383"></a>00383     <span class="keywordtype">int</span> n_attr = 0;
<a name="l00384"></a>00384     <span class="comment">/* If we're reloading, we'll pass in our file format attribute list</span>
<a name="l00385"></a>00385 <span class="comment">     * since this is our hook for letting the user override the fileformat.</span>
<a name="l00386"></a>00386 <span class="comment">     */</span>
<a name="l00387"></a>00387     <span class="keywordflow">if</span> (reload)
<a name="l00388"></a>00388        {
<a name="l00389"></a>00389            <span class="comment">/* We're reloading so use the attribute list in memory */</span>
<a name="l00390"></a>00390            attr_list =  gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7326c22fef5c370ec26ba3dc9c5f3f35">attr_list</a>;
<a name="l00391"></a>00391            n_attr =  gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#1d0fa3f31efbb0d88cf8de263ca2f65b">n_attr</a>;
<a name="l00392"></a>00392        }
<a name="l00393"></a>00393     <span class="keywordflow">else</span>
<a name="l00394"></a>00394        {
<a name="l00395"></a>00395            <span class="comment">/* We're not reloading so use the attribute list read from the </span>
<a name="l00396"></a>00396 <span class="comment">            * project file if given or NULL otherwise.</span>
<a name="l00397"></a>00397 <span class="comment">            */</span>
<a name="l00398"></a>00398            attr_list = fattr;
<a name="l00399"></a>00399            n_attr = n_fattr;
<a name="l00400"></a>00400        }
<a name="l00401"></a>00401     <span class="comment">/* if we don't have enough spots, then grow the file list by 2 to account for the possible </span>
<a name="l00402"></a>00402 <span class="comment">       loading of two images for PNP files */</span>
<a name="l00403"></a>00403     <span class="keywordflow">if</span> ((idx+1) &gt;= gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>) {
<a name="l00404"></a>00404        gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a> = (<a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a> **) realloc (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>, (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a> + 2) * <span class="keyword">sizeof</span> (<a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a> *));
<a name="l00405"></a>00405 
<a name="l00406"></a>00406        <span class="keywordflow">if</span> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a> == NULL)
<a name="l00407"></a>00407            {
<a name="l00408"></a>00408               fprintf (stderr, <span class="stringliteral">"realloc failed\n"</span>);
<a name="l00409"></a>00409               exit (1);
<a name="l00410"></a>00410            }
<a name="l00411"></a>00411        gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>] = NULL;
<a name="l00412"></a>00412        gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>+1] = NULL;
<a name="l00413"></a>00413        gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a> += 2;
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415     
<a name="l00416"></a>00416     dprintf(<span class="stringliteral">"In open_image, about to try opening filename = %s\n"</span>, filename);
<a name="l00417"></a>00417     
<a name="l00418"></a>00418     fd = gerb_fopen(filename);
<a name="l00419"></a>00419     <span class="keywordflow">if</span> (fd == NULL) {
<a name="l00420"></a>00420        GERB_MESSAGE(<span class="stringliteral">"Trying to open %s:%s\n"</span>, filename, strerror(errno));
<a name="l00421"></a>00421        <span class="keywordflow">return</span> -1;
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="comment">/* Store filename info fd for further use */</span>
<a name="l00425"></a>00425     fd-&gt;filename = g_strdup(filename);
<a name="l00426"></a>00426     
<a name="l00427"></a>00427     dprintf(<span class="stringliteral">"In open_image, successfully opened file.  Now check its type....\n"</span>);
<a name="l00428"></a>00428     <span class="comment">/* Here's where we decide what file type we have */</span>
<a name="l00429"></a>00429     <span class="comment">/* Note: if the file has some invalid characters in it but still appears to</span>
<a name="l00430"></a>00430 <span class="comment">       be a valid file, we check with the user if he wants to continue (only</span>
<a name="l00431"></a>00431 <span class="comment">       if user opens the layer from the menu...if from the command line, we go</span>
<a name="l00432"></a>00432 <span class="comment">       ahead and try to load it anyways) */</span>
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <span class="keywordflow">if</span> (<a class="code" href="gerber_8c.html#c8d477d089cfc66eb15a40fe2a72940e">gerber_is_rs274x_p</a>(fd, &amp;foundBinary)) {
<a name="l00435"></a>00435        dprintf(<span class="stringliteral">"Found RS-274X file\n"</span>);
<a name="l00436"></a>00436        <span class="keywordflow">if</span> ((!foundBinary || forceLoadFile)) {
<a name="l00437"></a>00437               <span class="comment">/* figure out the directory path in case parse_gerb needs to</span>
<a name="l00438"></a>00438 <span class="comment">               * load any include files */</span>
<a name="l00439"></a>00439               gchar *currentLoadDirectory = g_path_get_dirname (filename);
<a name="l00440"></a>00440               parsed_image = <a class="code" href="gerber_8c.html#fed2f7eb78aa79c288d341fa986d19f5">parse_gerb</a>(fd, currentLoadDirectory);
<a name="l00441"></a>00441               g_free (currentLoadDirectory);
<a name="l00442"></a>00442        }
<a name="l00443"></a>00443     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(drill_file_p(fd, &amp;foundBinary)) {
<a name="l00444"></a>00444        dprintf(<span class="stringliteral">"Found drill file\n"</span>);
<a name="l00445"></a>00445        <span class="keywordflow">if</span> ((!foundBinary || forceLoadFile))
<a name="l00446"></a>00446            parsed_image = parse_drillfile(fd, attr_list, n_attr, reload);
<a name="l00447"></a>00447        
<a name="l00448"></a>00448     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pick_and_place_check_file_type(fd, &amp;foundBinary)) {
<a name="l00449"></a>00449        dprintf(<span class="stringliteral">"Found pick-n-place file\n"</span>);
<a name="l00450"></a>00450        <span class="keywordflow">if</span> ((!foundBinary || forceLoadFile)) {
<a name="l00451"></a>00451               pick_and_place_parse_file_to_images(fd, &amp;parsed_image, &amp;parsed_image2);
<a name="l00452"></a>00452               isPnpFile = TRUE;
<a name="l00453"></a>00453        }
<a name="l00454"></a>00454     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gerber_8c.html#1f3c64ad0d66dca00fa2bf07012e3fc6">gerber_is_rs274d_p</a>(fd)) {
<a name="l00455"></a>00455        dprintf(<span class="stringliteral">"Found RS-274D file"</span>);
<a name="l00456"></a>00456        GERB_COMPILE_ERROR(<span class="stringliteral">"%s: Found RS-274D file -- not supported by gerbv.\n"</span>, filename);
<a name="l00457"></a>00457        parsed_image = NULL;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     } <span class="keywordflow">else</span> {
<a name="l00460"></a>00460        <span class="comment">/* This is not a known file */</span>
<a name="l00461"></a>00461        dprintf(<span class="stringliteral">"Unknown filetype"</span>);
<a name="l00462"></a>00462        GERB_COMPILE_ERROR(<span class="stringliteral">"%s: Unknown file type.\n"</span>, filename);
<a name="l00463"></a>00463        parsed_image = NULL;
<a name="l00464"></a>00464     }
<a name="l00465"></a>00465     
<a name="l00466"></a>00466     gerb_fclose(fd);
<a name="l00467"></a>00467     <span class="keywordflow">if</span> (parsed_image == NULL) {
<a name="l00468"></a>00468        <span class="keywordflow">return</span> -1;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470     
<a name="l00471"></a>00471     <span class="keywordflow">if</span> (parsed_image) {
<a name="l00472"></a>00472        <span class="comment">/* strip the filename to the base */</span>
<a name="l00473"></a>00473        gchar *baseName = g_path_get_basename (filename);
<a name="l00474"></a>00474        gchar *displayedName;
<a name="l00475"></a>00475        <span class="keywordflow">if</span> (isPnpFile)
<a name="l00476"></a>00476               displayedName = g_strconcat (baseName, <span class="stringliteral">" (top)"</span>,NULL);
<a name="l00477"></a>00477        <span class="keywordflow">else</span>
<a name="l00478"></a>00478               displayedName = g_strdup (baseName);
<a name="l00479"></a>00479        retv = gerbv_add_parsed_image_to_project (gerbvProject, parsed_image, filename, displayedName, idx, reload);
<a name="l00480"></a>00480        g_free (baseName);
<a name="l00481"></a>00481        g_free (displayedName);
<a name="l00482"></a>00482     }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="comment">/* Set layer_dirty flag to FALSE */</span>
<a name="l00485"></a>00485     gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[idx]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#aa8bf32fb43e02cb6613d9b07624b5bc">layer_dirty</a> = FALSE;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <span class="comment">/* for PNP place files, we may need to add a second image for the other</span>
<a name="l00488"></a>00488 <span class="comment">       board side */</span>
<a name="l00489"></a>00489     <span class="keywordflow">if</span> (parsed_image2) {
<a name="l00490"></a>00490       <span class="comment">/* strip the filename to the base */</span>
<a name="l00491"></a>00491        gchar *baseName = g_path_get_basename (filename);
<a name="l00492"></a>00492        gchar *displayedName;
<a name="l00493"></a>00493        displayedName = g_strconcat (baseName, <span class="stringliteral">" (bottom)"</span>,NULL);
<a name="l00494"></a>00494        retv = gerbv_add_parsed_image_to_project (gerbvProject, parsed_image2, filename, displayedName, idx + 1, reload);
<a name="l00495"></a>00495        g_free (baseName);
<a name="l00496"></a>00496        g_free (displayedName);
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="keywordflow">return</span> retv;
<a name="l00500"></a>00500 } <span class="comment">/* open_image */</span>
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *
<a name="l00503"></a><a class="code" href="gerbv_8h.html#58e7e7e29c445f965db9a142af542931">00503</a> <a class="code" href="gerbv_8c.html#58e7e7e29c445f965db9a142af542931" title="Parse a RS274X file and return the parsed image.">gerbv_create_rs274x_image_from_filename</a> (gchar *filename){
<a name="l00504"></a>00504        <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *returnImage;
<a name="l00505"></a>00505        gerb_file_t *fd;
<a name="l00506"></a>00506        
<a name="l00507"></a>00507        fd = gerb_fopen(filename);
<a name="l00508"></a>00508        <span class="keywordflow">if</span> (fd == NULL) {
<a name="l00509"></a>00509               GERB_MESSAGE(<span class="stringliteral">"Trying to open %s:%s\n"</span>, filename, strerror(errno));
<a name="l00510"></a>00510               <span class="keywordflow">return</span> NULL;
<a name="l00511"></a>00511        }
<a name="l00512"></a>00512        gchar *currentLoadDirectory = g_path_get_dirname (filename);
<a name="l00513"></a>00513        returnImage = <a class="code" href="gerber_8c.html#fed2f7eb78aa79c288d341fa986d19f5">parse_gerb</a>(fd, currentLoadDirectory);
<a name="l00514"></a>00514        g_free (currentLoadDirectory);
<a name="l00515"></a>00515        gerb_fclose(fd);
<a name="l00516"></a>00516        <span class="keywordflow">return</span> returnImage;
<a name="l00517"></a>00517 }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00520"></a>00520 <span class="keywordtype">void</span>
<a name="l00521"></a>00521 gerbv_render_get_boundingbox(<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, gerbv_render_size_t *boundingbox)
<a name="l00522"></a>00522 {
<a name="l00523"></a>00523        <span class="keywordtype">double</span> x1=HUGE_VAL,y1=HUGE_VAL, x2=-HUGE_VAL,y2=-HUGE_VAL;
<a name="l00524"></a>00524        <span class="keywordtype">int</span> i;
<a name="l00525"></a>00525        <a class="code" href="structgerbv__image__info.html">gerbv_image_info_t</a> *info;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527        <span class="keywordflow">for</span>(i = 0; i &lt; gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>; i++) {
<a name="l00528"></a>00528               <span class="keywordflow">if</span> ((gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]) &amp;&amp; (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#fc59b2ffc535696e81b3086d025370c5">isVisible</a>)){
<a name="l00529"></a>00529                      info = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>;
<a name="l00530"></a>00530                      <span class="comment">/* </span>
<a name="l00531"></a>00531 <span class="comment">                     * Find the biggest image and use as a size reference</span>
<a name="l00532"></a>00532 <span class="comment">                     */</span>
<a name="l00533"></a>00533 <span class="preprocessor">#ifdef RENDER_USING_GDK</span>
<a name="l00534"></a>00534 <span class="preprocessor"></span>                     x1 = MIN(x1, info-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a> + info-&gt;<a class="code" href="structgerbv__image__info.html#3f145d47793e723d09e5a75758b25295">offsetA</a>);
<a name="l00535"></a>00535                      y1 = MIN(y1, info-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a> + info-&gt;<a class="code" href="structgerbv__image__info.html#db9f3d343e14f84e23181b17c0bf3a73">offsetB</a>);
<a name="l00536"></a>00536                      x2 = MAX(x2, info-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a> + info-&gt;<a class="code" href="structgerbv__image__info.html#3f145d47793e723d09e5a75758b25295">offsetA</a>);
<a name="l00537"></a>00537                      y2 = MAX(y2, info-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a> + info-&gt;<a class="code" href="structgerbv__image__info.html#db9f3d343e14f84e23181b17c0bf3a73">offsetB</a>);
<a name="l00538"></a>00538 <span class="preprocessor">#else</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span>                     <span class="comment">/* cairo info already has offset calculated into min/max */</span>
<a name="l00540"></a>00540                      x1 = MIN(x1, info-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a>);
<a name="l00541"></a>00541                      y1 = MIN(y1, info-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a>);
<a name="l00542"></a>00542                      x2 = MAX(x2, info-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a>);
<a name="l00543"></a>00543                      y2 = MAX(y2, info-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a>);
<a name="l00544"></a>00544 <span class="preprocessor">#endif</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span>              }
<a name="l00546"></a>00546        }
<a name="l00547"></a>00547        boundingbox-&gt;left    = x1;
<a name="l00548"></a>00548        boundingbox-&gt;right   = x2;
<a name="l00549"></a>00549        boundingbox-&gt;top    = y1;
<a name="l00550"></a>00550        boundingbox-&gt;bottom = y2;
<a name="l00551"></a>00551 }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00554"></a>00554 <span class="keywordtype">void</span>
<a name="l00555"></a><a class="code" href="gerbv_8h.html#c4a1b93b36ae9b6cbda1da4441bf087d">00555</a> <a class="code" href="gerbv_8c.html#c4a1b93b36ae9b6cbda1da4441bf087d" title="Calculate the zoom and translations to fit the rendered scene inside the given scene...">gerbv_render_zoom_to_fit_display</a> (<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, <a class="code" href="structgerbv__render__info__t.html">gerbv_render_info_t</a> *renderInfo) {
<a name="l00556"></a>00556        gerbv_render_size_t bb;
<a name="l00557"></a>00557        <span class="keywordtype">double</span> width, height;
<a name="l00558"></a>00558        <span class="keywordtype">double</span> x_scale, y_scale;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560        <span class="comment">/* Grab maximal width and height of all layers */</span>
<a name="l00561"></a>00561        gerbv_render_get_boundingbox(gerbvProject, &amp;bb);
<a name="l00562"></a>00562        width = bb.right - bb.left;
<a name="l00563"></a>00563        height = bb.bottom - bb.top;
<a name="l00564"></a>00564        <span class="comment">/* add in a 5% buffer around the drawing */</span>
<a name="l00565"></a>00565        width *= 1.05;
<a name="l00566"></a>00566        height *=1.05;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568        <span class="comment">/* if the values aren't sane (probably we have no models loaded), then</span>
<a name="l00569"></a>00569 <span class="comment">          put in some defaults */</span>
<a name="l00570"></a>00570        <span class="keywordflow">if</span> ((width &lt; 0.01) &amp;&amp; (height &lt; 0.01)) {
<a name="l00571"></a>00571               renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#71983cbd44f96fba693f200e7dbd5416">lowerLeftX</a> = 0.0;
<a name="l00572"></a>00572               renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#0f7fb11737241af0fdc2e6e5b8c95327">lowerLeftY</a> = 0.0;
<a name="l00573"></a>00573               renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a> = 200;
<a name="l00574"></a>00574               renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#f55b7a0baaf4614a54d67858e48e9347">scaleFactorY</a> = 200;
<a name="l00575"></a>00575               <span class="keywordflow">return</span>;
<a name="l00576"></a>00576        }
<a name="l00577"></a>00577        <span class="comment">/*</span>
<a name="l00578"></a>00578 <span class="comment">       * Calculate scale for both x axis and y axis</span>
<a name="l00579"></a>00579 <span class="comment">       */</span>
<a name="l00580"></a>00580        x_scale = renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#c1f647d0380e07c39a350f21a37e7a5c">displayWidth</a> / width;
<a name="l00581"></a>00581        y_scale = renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#465fcc1f9e903179b0f44ac028ad7dbc">displayHeight</a> / height;
<a name="l00582"></a>00582        <span class="comment">/*</span>
<a name="l00583"></a>00583 <span class="comment">       * Take the scale that fits both directions with some extra checks</span>
<a name="l00584"></a>00584 <span class="comment">       */</span>
<a name="l00585"></a>00585        renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a> = MIN(x_scale, y_scale);
<a name="l00586"></a>00586        renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#f55b7a0baaf4614a54d67858e48e9347">scaleFactorY</a> = renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a>;
<a name="l00587"></a>00587        <span class="keywordflow">if</span> (renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a> &lt; 1){
<a name="l00588"></a>00588            renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a> = 1;
<a name="l00589"></a>00589            renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#f55b7a0baaf4614a54d67858e48e9347">scaleFactorY</a> = 1;
<a name="l00590"></a>00590        }
<a name="l00591"></a>00591        renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#71983cbd44f96fba693f200e7dbd5416">lowerLeftX</a> = ((bb.left + bb.right) / 2.0) -
<a name="l00592"></a>00592               ((double) renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#c1f647d0380e07c39a350f21a37e7a5c">displayWidth</a> / 2.0 / renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a>);
<a name="l00593"></a>00593        renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#0f7fb11737241af0fdc2e6e5b8c95327">lowerLeftY</a> = ((bb.top + bb.bottom) / 2.0) -
<a name="l00594"></a>00594               ((double) renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#465fcc1f9e903179b0f44ac028ad7dbc">displayHeight</a> / 2.0 / renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#f55b7a0baaf4614a54d67858e48e9347">scaleFactorY</a>);
<a name="l00595"></a>00595        <span class="keywordflow">return</span>;
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00599"></a>00599 <span class="keywordtype">void</span>
<a name="l00600"></a>00600 gerbv_render_translate_to_fit_display (<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, <a class="code" href="structgerbv__render__info__t.html">gerbv_render_info_t</a> *renderInfo) {
<a name="l00601"></a>00601        <span class="keywordtype">double</span> x1=HUGE_VAL,y1=HUGE_VAL;
<a name="l00602"></a>00602        <span class="keywordtype">int</span> i;
<a name="l00603"></a>00603        <a class="code" href="structgerbv__image__info.html">gerbv_image_info_t</a> *info;
<a name="l00604"></a>00604        
<a name="l00605"></a>00605        <span class="keywordflow">for</span>(i = 0; i &lt; gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>; i++) {
<a name="l00606"></a>00606               <span class="keywordflow">if</span> ((gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]) &amp;&amp; (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#fc59b2ffc535696e81b3086d025370c5">isVisible</a>)){
<a name="l00607"></a>00607                      info = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609                      <span class="comment">/* cairo info already has offset calculated into min/max */</span>
<a name="l00610"></a>00610                      x1 = MIN(x1, info-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a>);
<a name="l00611"></a>00611                      y1 = MIN(y1, info-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a>);
<a name="l00612"></a>00612               }
<a name="l00613"></a>00613        }
<a name="l00614"></a>00614        renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#71983cbd44f96fba693f200e7dbd5416">lowerLeftX</a> = x1;
<a name="l00615"></a>00615        renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#0f7fb11737241af0fdc2e6e5b8c95327">lowerLeftY</a> = y1;
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00619"></a>00619 <span class="keywordtype">void</span>
<a name="l00620"></a>00620 gerbv_render_to_pixmap_using_gdk (<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, GdkPixmap *pixmap,
<a name="l00621"></a>00621               <a class="code" href="structgerbv__render__info__t.html">gerbv_render_info_t</a> *renderInfo, <a class="code" href="structgerbv__selection__info__t.html">gerbv_selection_info_t</a> *selectionInfo,
<a name="l00622"></a>00622               GdkColor *selectionColor){
<a name="l00623"></a>00623        GdkGC *gc = gdk_gc_new(pixmap);
<a name="l00624"></a>00624        GdkPixmap *colorStamp, *clipmask;
<a name="l00625"></a>00625        <span class="keywordtype">int</span> i;
<a name="l00626"></a>00626        
<a name="l00627"></a>00627        <span class="comment">/* </span>
<a name="l00628"></a>00628 <span class="comment">        * Remove old pixmap, allocate a new one, draw the background.</span>
<a name="l00629"></a>00629 <span class="comment">        */</span>
<a name="l00630"></a>00630        <span class="keywordflow">if</span> (!gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#545040772fbe22865784f8ddca0a3d5d">background</a>.pixel)
<a name="l00631"></a>00631               gdk_colormap_alloc_color(gdk_colormap_get_system(), &amp;gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#545040772fbe22865784f8ddca0a3d5d">background</a>, FALSE, TRUE);
<a name="l00632"></a>00632        gdk_gc_set_foreground(gc, &amp;gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#545040772fbe22865784f8ddca0a3d5d">background</a>);
<a name="l00633"></a>00633        gdk_draw_rectangle(pixmap, gc, TRUE, 0, 0, -1, -1);
<a name="l00634"></a>00634 
<a name="l00635"></a>00635        <span class="comment">/*</span>
<a name="l00636"></a>00636 <span class="comment">        * Allocate the pixmap and the clipmask (a one pixel pixmap)</span>
<a name="l00637"></a>00637 <span class="comment">        */</span>
<a name="l00638"></a>00638        colorStamp = gdk_pixmap_new(pixmap, renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#c1f647d0380e07c39a350f21a37e7a5c">displayWidth</a>,
<a name="l00639"></a>00639                                           renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#465fcc1f9e903179b0f44ac028ad7dbc">displayHeight</a>, -1);
<a name="l00640"></a>00640        clipmask = gdk_pixmap_new(NULL, renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#c1f647d0380e07c39a350f21a37e7a5c">displayWidth</a>,
<a name="l00641"></a>00641                                           renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#465fcc1f9e903179b0f44ac028ad7dbc">displayHeight</a>, 1);
<a name="l00642"></a>00642                                                  
<a name="l00643"></a>00643        <span class="comment">/* </span>
<a name="l00644"></a>00644 <span class="comment">       * This now allows drawing several layers on top of each other.</span>
<a name="l00645"></a>00645 <span class="comment">       * Higher layer numbers have higher priority in the Z-order. </span>
<a name="l00646"></a>00646 <span class="comment">       */</span>
<a name="l00647"></a>00647        <span class="keywordflow">for</span>(i = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>-1; i &gt;= 0; i--) {
<a name="l00648"></a>00648               <span class="keywordflow">if</span> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i] &amp;&amp; gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#fc59b2ffc535696e81b3086d025370c5">isVisible</a>) {
<a name="l00649"></a>00649                      <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f465">gerbv_polarity_t</a> polarity;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651                      <span class="keywordflow">if</span> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#145b4c98b74e7b07d262e5ecad32199e">transform</a>.<a class="code" href="structgerbv__user__transformation__t.html#4c5d3155d0f4aa77896b1f88535cbb4e">inverted</a>) {
<a name="l00652"></a>00652                             <span class="keywordflow">if</span> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#18c534ca1aec8e2cb2c8dd0faef4d3f1">polarity</a> == <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f4658e6f0ae27a8b633eb76a92830b62703b">GERBV_POLARITY_POSITIVE</a>)
<a name="l00653"></a>00653                                    polarity = <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f4653f7beb089cc8fa9de323dca063c3e3f3">GERBV_POLARITY_NEGATIVE</a>;
<a name="l00654"></a>00654                             <span class="keywordflow">else</span>
<a name="l00655"></a>00655                                    polarity = <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f4658e6f0ae27a8b633eb76a92830b62703b">GERBV_POLARITY_POSITIVE</a>;
<a name="l00656"></a>00656                      } <span class="keywordflow">else</span> {
<a name="l00657"></a>00657                             polarity = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#18c534ca1aec8e2cb2c8dd0faef4d3f1">polarity</a>;
<a name="l00658"></a>00658                      }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660                      <span class="comment">/*</span>
<a name="l00661"></a>00661 <span class="comment">                     * Fill up image with all the foreground color. Excess pixels</span>
<a name="l00662"></a>00662 <span class="comment">                     * will be removed by clipmask.</span>
<a name="l00663"></a>00663 <span class="comment">                     */</span>
<a name="l00664"></a>00664                      <span class="keywordflow">if</span> (!gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#412c5aa0e56866c1d0d10edfd09a5a1d">color</a>.pixel)
<a name="l00665"></a>00665                             gdk_colormap_alloc_color(gdk_colormap_get_system(), &amp;gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#412c5aa0e56866c1d0d10edfd09a5a1d">color</a>, FALSE, TRUE);
<a name="l00666"></a>00666                      gdk_gc_set_foreground(gc, &amp;gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#412c5aa0e56866c1d0d10edfd09a5a1d">color</a>);
<a name="l00667"></a>00667                      
<a name="l00668"></a>00668                      <span class="comment">/* switch back to regular draw function for the initial</span>
<a name="l00669"></a>00669 <span class="comment">                        bitmap clear */</span>
<a name="l00670"></a>00670                      gdk_gc_set_function(gc, GDK_COPY);
<a name="l00671"></a>00671                      gdk_draw_rectangle(colorStamp, gc, TRUE, 0, 0, -1, -1);
<a name="l00672"></a>00672                      
<a name="l00673"></a>00673                      <span class="keywordflow">if</span> (renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#902b5d841ab7a246a3ffa4fd2a6a9d26">renderType</a> == 0) {
<a name="l00674"></a>00674                             gdk_gc_set_function(gc, GDK_COPY);
<a name="l00675"></a>00675                      }
<a name="l00676"></a>00676                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#902b5d841ab7a246a3ffa4fd2a6a9d26">renderType</a> == 1) {
<a name="l00677"></a>00677                             gdk_gc_set_function(gc, GDK_XOR);
<a name="l00678"></a>00678                      }
<a name="l00679"></a>00679                      <span class="comment">/*</span>
<a name="l00680"></a>00680 <span class="comment">                     * Translation is to get it inside the allocated pixmap,</span>
<a name="l00681"></a>00681 <span class="comment">                     * which is not always centered perfectly for GTK/X.</span>
<a name="l00682"></a>00682 <span class="comment">                     */</span>
<a name="l00683"></a>00683                      dprintf(<span class="stringliteral">"  .... calling image2pixmap on image %d...\n"</span>, i);
<a name="l00684"></a>00684                      <span class="comment">// Dirty scaling solution when using GDK; simply use scaling factor for x-axis, ignore y-axis</span>
<a name="l00685"></a>00685                      draw_gdk_image_to_pixmap(&amp;clipmask, gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>,
<a name="l00686"></a>00686                             renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a>, -(renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#71983cbd44f96fba693f200e7dbd5416">lowerLeftX</a> * renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a>),
<a name="l00687"></a>00687                             (renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#0f7fb11737241af0fdc2e6e5b8c95327">lowerLeftY</a> * renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#f55b7a0baaf4614a54d67858e48e9347">scaleFactorY</a>) + renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#465fcc1f9e903179b0f44ac028ad7dbc">displayHeight</a>,
<a name="l00688"></a>00688                             polarity, DRAW_IMAGE, NULL);
<a name="l00689"></a>00689 
<a name="l00690"></a>00690                      <span class="comment">/* </span>
<a name="l00691"></a>00691 <span class="comment">                     * Set clipmask and draw the clipped out image onto the</span>
<a name="l00692"></a>00692 <span class="comment">                     * screen pixmap. Afterwards we remove the clipmask, else</span>
<a name="l00693"></a>00693 <span class="comment">                     * it will screw things up when run this loop again.</span>
<a name="l00694"></a>00694 <span class="comment">                     */</span>
<a name="l00695"></a>00695                      gdk_gc_set_clip_mask(gc, clipmask);
<a name="l00696"></a>00696                      gdk_gc_set_clip_origin(gc, 0, 0);
<a name="l00697"></a>00697                      gdk_draw_drawable(pixmap, gc, colorStamp, 0, 0, 0, 0, -1, -1);
<a name="l00698"></a>00698                      gdk_gc_set_clip_mask(gc, NULL);
<a name="l00699"></a>00699               }
<a name="l00700"></a>00700        }
<a name="l00701"></a>00701        <span class="comment">/* render the selection group to the top of the output */</span>
<a name="l00702"></a>00702        <span class="keywordflow">if</span> (selectionInfo-&gt;<a class="code" href="structgerbv__selection__info__t.html#874e3ecafb1ea0537c2e05a84f75d6d1">type</a> != <a class="code" href="gerbv_8h.html#91d08347e830450bb1b3d8593c89fce7e442f58229590aad8ec1a39afd4e01ce">GERBV_SELECTION_EMPTY</a>) {
<a name="l00703"></a>00703               <span class="keywordflow">if</span> (!selectionColor-&gt;pixel)
<a name="l00704"></a>00704                      gdk_colormap_alloc_color(gdk_colormap_get_system(), selectionColor, FALSE, TRUE);
<a name="l00705"></a>00705                      
<a name="l00706"></a>00706               gdk_gc_set_foreground(gc, selectionColor);
<a name="l00707"></a>00707               gdk_gc_set_function(gc, GDK_COPY);
<a name="l00708"></a>00708               gdk_draw_rectangle(colorStamp, gc, TRUE, 0, 0, -1, -1);
<a name="l00709"></a>00709               
<a name="l00710"></a>00710               <span class="comment">/* for now, assume everything in the selection buffer is from one image */</span>
<a name="l00711"></a>00711               <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *matchImage;
<a name="l00712"></a>00712               <span class="keywordtype">int</span> j;
<a name="l00713"></a>00713               <span class="keywordflow">if</span> (selectionInfo-&gt;<a class="code" href="structgerbv__selection__info__t.html#0d5d16901c7c3660c772caf63d85209c">selectedNodeArray</a>-&gt;len &gt; 0) {
<a name="l00714"></a>00714                      gerbv_selection_item_t sItem = g_array_index (selectionInfo-&gt;<a class="code" href="structgerbv__selection__info__t.html#0d5d16901c7c3660c772caf63d85209c">selectedNodeArray</a>,
<a name="l00715"></a>00715                                    gerbv_selection_item_t, 0);
<a name="l00716"></a>00716                      matchImage = (<a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *) sItem.image;      
<a name="l00717"></a>00717 
<a name="l00718"></a>00718                      <span class="keywordflow">for</span>(j = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>-1; j &gt;= 0; j--) {
<a name="l00719"></a>00719                             <span class="keywordflow">if</span> ((gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[j]) &amp;&amp; (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[j]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a> == matchImage)) {
<a name="l00720"></a>00720                                    draw_gdk_image_to_pixmap(&amp;clipmask, gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[j]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>,
<a name="l00721"></a>00721                                           renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a>, -(renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#71983cbd44f96fba693f200e7dbd5416">lowerLeftX</a> * renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a>),
<a name="l00722"></a>00722                                           (renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#0f7fb11737241af0fdc2e6e5b8c95327">lowerLeftY</a> * renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#f55b7a0baaf4614a54d67858e48e9347">scaleFactorY</a>) + renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#465fcc1f9e903179b0f44ac028ad7dbc">displayHeight</a>,
<a name="l00723"></a>00723                                           <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f4658e6f0ae27a8b633eb76a92830b62703b">GERBV_POLARITY_POSITIVE</a>, DRAW_SELECTIONS, selectionInfo);
<a name="l00724"></a>00724                             }
<a name="l00725"></a>00725                      }
<a name="l00726"></a>00726                      gdk_gc_set_clip_mask(gc, clipmask);
<a name="l00727"></a>00727                      gdk_gc_set_clip_origin(gc, 0, 0);
<a name="l00728"></a>00728                      gdk_draw_drawable(pixmap, gc, colorStamp, 0, 0, 0, 0, -1, -1);
<a name="l00729"></a>00729                      gdk_gc_set_clip_mask(gc, NULL);
<a name="l00730"></a>00730               }
<a name="l00731"></a>00731        }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733        gdk_pixmap_unref(colorStamp);
<a name="l00734"></a>00734        gdk_pixmap_unref(clipmask);
<a name="l00735"></a>00735        gdk_gc_unref(gc);
<a name="l00736"></a>00736 }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00739"></a>00739 <span class="preprocessor">#ifndef RENDER_USING_GDK</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span><span class="keywordtype">void</span>
<a name="l00741"></a>00741 gerbv_render_all_layers_to_cairo_target_for_vector_output (<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject,
<a name="l00742"></a>00742               cairo_t *cr, <a class="code" href="structgerbv__render__info__t.html">gerbv_render_info_t</a> *renderInfo) {
<a name="l00743"></a>00743        <span class="keywordtype">int</span> i;
<a name="l00744"></a>00744        gerbv_render_cairo_set_scale_and_translation(cr, renderInfo);
<a name="l00745"></a>00745        <span class="comment">/* don't paint background for vector output, since it isn't needed */</span>
<a name="l00746"></a>00746        <span class="keywordflow">for</span>(i = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>-1; i &gt;= 0; i--) {
<a name="l00747"></a>00747               <span class="keywordflow">if</span> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i] &amp;&amp; gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#fc59b2ffc535696e81b3086d025370c5">isVisible</a>) {
<a name="l00748"></a>00748 
<a name="l00749"></a>00749                   gerbv_render_layer_to_cairo_target_without_transforming(cr, gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i], renderInfo);
<a name="l00750"></a>00750               }
<a name="l00751"></a>00751        }
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 <span class="preprocessor">#endif</span>
<a name="l00754"></a>00754 <span class="preprocessor"></span>
<a name="l00755"></a>00755 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00756"></a>00756 <span class="preprocessor">#ifndef RENDER_USING_GDK</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span><span class="keywordtype">void</span>
<a name="l00758"></a>00758 gerbv_render_all_layers_to_cairo_target (<a class="code" href="structgerbv__project__t.html">gerbv_project_t</a> *gerbvProject, cairo_t *cr,
<a name="l00759"></a>00759                      <a class="code" href="structgerbv__render__info__t.html">gerbv_render_info_t</a> *renderInfo) {
<a name="l00760"></a>00760        <span class="keywordtype">int</span> i;
<a name="l00761"></a>00761        <span class="comment">/* fill the background with the appropriate color */</span>
<a name="l00762"></a>00762        cairo_set_source_rgba (cr, (<span class="keywordtype">double</span>) gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#545040772fbe22865784f8ddca0a3d5d">background</a>.red/G_MAXUINT16,
<a name="l00763"></a>00763               (<span class="keywordtype">double</span>) gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#545040772fbe22865784f8ddca0a3d5d">background</a>.green/G_MAXUINT16,
<a name="l00764"></a>00764               (<span class="keywordtype">double</span>) gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#545040772fbe22865784f8ddca0a3d5d">background</a>.blue/G_MAXUINT16, 1);
<a name="l00765"></a>00765        cairo_paint (cr);
<a name="l00766"></a>00766        <span class="keywordflow">for</span>(i = gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#bab05758e52aca9b2b2c171ec923a4bf">max_files</a>-1; i &gt;= 0; i--) {
<a name="l00767"></a>00767               <span class="keywordflow">if</span> (gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i] &amp;&amp; gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#fc59b2ffc535696e81b3086d025370c5">isVisible</a>) {
<a name="l00768"></a>00768                      cairo_push_group (cr);
<a name="l00769"></a>00769                      <a class="code" href="gerbv_8c.html#fda4267bf9cd1e1f69976cf6320a43b7" title="Render a layer to a cairo context.">gerbv_render_layer_to_cairo_target</a> (cr, gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i], renderInfo);
<a name="l00770"></a>00770                      cairo_pop_group_to_source (cr);
<a name="l00771"></a>00771                      cairo_paint_with_alpha (cr, (<span class="keywordtype">double</span>) gerbvProject-&gt;<a class="code" href="structgerbv__project__t.html#3ecaa11fbc1cef45f458e2b88445ac35">file</a>[i]-&gt;<a class="code" href="structgerbv__fileinfo__t.html#00d1a74686e09a34d72cfeb357a1004d">alpha</a>/G_MAXUINT16);
<a name="l00772"></a>00772               }
<a name="l00773"></a>00773        }
<a name="l00774"></a>00774 }
<a name="l00775"></a>00775 <span class="preprocessor">#endif</span>
<a name="l00776"></a>00776 <span class="preprocessor"></span>
<a name="l00777"></a>00777 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00778"></a>00778 <span class="preprocessor">#ifndef RENDER_USING_GDK</span>
<a name="l00779"></a>00779 <span class="preprocessor"></span><span class="keywordtype">void</span>
<a name="l00780"></a><a class="code" href="gerbv_8h.html#fda4267bf9cd1e1f69976cf6320a43b7">00780</a> <a class="code" href="gerbv_8c.html#fda4267bf9cd1e1f69976cf6320a43b7" title="Render a layer to a cairo context.">gerbv_render_layer_to_cairo_target</a> (cairo_t *cr, <a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a> *fileInfo,
<a name="l00781"></a>00781                                           <a class="code" href="structgerbv__render__info__t.html">gerbv_render_info_t</a> *renderInfo) {
<a name="l00782"></a>00782        gerbv_render_cairo_set_scale_and_translation(cr, renderInfo);
<a name="l00783"></a>00783        gerbv_render_layer_to_cairo_target_without_transforming(cr, fileInfo, renderInfo);
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 <span class="preprocessor">#endif</span>
<a name="l00786"></a>00786 <span class="preprocessor"></span>
<a name="l00787"></a>00787 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00788"></a>00788 <span class="preprocessor">#ifndef RENDER_USING_GDK</span>
<a name="l00789"></a>00789 <span class="preprocessor"></span><span class="keywordtype">void</span>
<a name="l00790"></a>00790 gerbv_render_cairo_set_scale_and_translation(cairo_t *cr, <a class="code" href="structgerbv__render__info__t.html">gerbv_render_info_t</a> *renderInfo){
<a name="l00791"></a>00791        gdouble translateX, translateY;
<a name="l00792"></a>00792        
<a name="l00793"></a>00793        translateX = (renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#71983cbd44f96fba693f200e7dbd5416">lowerLeftX</a> * renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a>);
<a name="l00794"></a>00794        translateY = (renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#0f7fb11737241af0fdc2e6e5b8c95327">lowerLeftY</a> * renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#f55b7a0baaf4614a54d67858e48e9347">scaleFactorY</a>);
<a name="l00795"></a>00795        
<a name="l00796"></a>00796        <span class="comment">/* renderTypes 0 and 1 use GDK rendering, so we shouldn't have made it</span>
<a name="l00797"></a>00797 <span class="comment">          this far */</span>
<a name="l00798"></a>00798        <span class="keywordflow">if</span> (renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#902b5d841ab7a246a3ffa4fd2a6a9d26">renderType</a> == 2) {
<a name="l00799"></a>00799               cairo_set_tolerance (cr, 1.5);
<a name="l00800"></a>00800               cairo_set_antialias (cr, CAIRO_ANTIALIAS_NONE);
<a name="l00801"></a>00801        }
<a name="l00802"></a>00802        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#902b5d841ab7a246a3ffa4fd2a6a9d26">renderType</a> == 3) {
<a name="l00803"></a>00803               cairo_set_tolerance (cr, 1);
<a name="l00804"></a>00804               <span class="comment">/* disable ALL anti-aliasing for now due to the way cairo is rendering</span>
<a name="l00805"></a>00805 <span class="comment">                 ground planes from PCB output */</span>
<a name="l00806"></a>00806               cairo_set_antialias (cr, CAIRO_ANTIALIAS_DEFAULT);
<a name="l00807"></a>00807        }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809        <span class="comment">/* translate the draw area before drawing.  We must translate the whole</span>
<a name="l00810"></a>00810 <span class="comment">          drawing down an additional displayHeight to account for the negative</span>
<a name="l00811"></a>00811 <span class="comment">          y flip done later */</span>
<a name="l00812"></a>00812        cairo_translate (cr, -translateX, translateY + renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#465fcc1f9e903179b0f44ac028ad7dbc">displayHeight</a>);
<a name="l00813"></a>00813        <span class="comment">/* scale the drawing by the specified scale factor (inverting y since</span>
<a name="l00814"></a>00814 <span class="comment">              cairo y axis points down) */</span>
<a name="l00815"></a>00815        cairo_scale (cr, renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a>, -renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#f55b7a0baaf4614a54d67858e48e9347">scaleFactorY</a>);
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 <span class="preprocessor">#endif</span>
<a name="l00818"></a>00818 <span class="preprocessor"></span>
<a name="l00819"></a>00819 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00820"></a>00820 <span class="preprocessor">#ifndef RENDER_USING_GDK</span>
<a name="l00821"></a>00821 <span class="preprocessor"></span><span class="keywordtype">void</span>
<a name="l00822"></a>00822 gerbv_render_layer_to_cairo_target_without_transforming(cairo_t *cr, <a class="code" href="structgerbv__fileinfo__t.html">gerbv_fileinfo_t</a> *fileInfo, <a class="code" href="structgerbv__render__info__t.html">gerbv_render_info_t</a> *renderInfo ) {
<a name="l00823"></a>00823        cairo_set_source_rgba (cr, (<span class="keywordtype">double</span>) fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#412c5aa0e56866c1d0d10edfd09a5a1d">color</a>.red/G_MAXUINT16,
<a name="l00824"></a>00824               (<span class="keywordtype">double</span>) fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#412c5aa0e56866c1d0d10edfd09a5a1d">color</a>.green/G_MAXUINT16,
<a name="l00825"></a>00825               (<span class="keywordtype">double</span>) fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#412c5aa0e56866c1d0d10edfd09a5a1d">color</a>.blue/G_MAXUINT16, 1);
<a name="l00826"></a>00826        
<a name="l00827"></a>00827        <span class="comment">/* translate the image based on the layer-specific transformation struct */</span>
<a name="l00828"></a>00828        cairo_save (cr);
<a name="l00829"></a>00829        cairo_translate (cr, fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#145b4c98b74e7b07d262e5ecad32199e">transform</a>.<a class="code" href="structgerbv__user__transformation__t.html#4e3b3a2a90019950374d5f969c176140">translateX</a>, fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#145b4c98b74e7b07d262e5ecad32199e">transform</a>.<a class="code" href="structgerbv__user__transformation__t.html#d60fd2201908a685667656981f708522">translateY</a>);
<a name="l00830"></a>00830        draw_image_to_cairo_target (cr, fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#0aec7123b754ed7cb0adc9c98e985f84">image</a>, fileInfo-&gt;<a class="code" href="structgerbv__fileinfo__t.html#145b4c98b74e7b07d262e5ecad32199e">transform</a>.<a class="code" href="structgerbv__user__transformation__t.html#4c5d3155d0f4aa77896b1f88535cbb4e">inverted</a>,
<a name="l00831"></a>00831               1.0/MAX(renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#2323896b8bb588ad34fb404cd808bfa1">scaleFactorX</a>, renderInfo-&gt;<a class="code" href="structgerbv__render__info__t.html#f55b7a0baaf4614a54d67858e48e9347">scaleFactorY</a>), DRAW_IMAGE, NULL);
<a name="l00832"></a>00832        cairo_restore (cr);
<a name="l00833"></a>00833 }
<a name="l00834"></a>00834 <span class="preprocessor">#endif</span>
<a name="l00835"></a>00835 <span class="preprocessor"></span>
<a name="l00836"></a>00836 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Aug 19 00:14:48 2008 for gerbv by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
