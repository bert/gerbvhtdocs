<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>gerbv: src/gerber.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0fba06f62092f0c8d9ff47b96507f331.html">src</a>
  </div>
</div>
<div class="contents">
<h1>gerber.c</h1><a href="gerber_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * gEDA - GNU Electronic Design Automation</span>
<a name="l00003"></a>00003 <span class="comment"> * This is a part of gerbv</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> *   Copyright (C) 2000-2003 Stefan Petersen (spe@stacken.kth.se)</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * $Id$</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00010"></a>00010 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00011"></a>00011 <span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00012"></a>00012 <span class="comment"> * (at your option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00017"></a>00017 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00020"></a>00020 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00021"></a>00021 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111 USA</span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;math.h&gt;</span>  <span class="comment">/* pow() */</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;glib.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;locale.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include "config.h"</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include "<a class="code" href="gerbv_8h.html" title="The main header file for the libgerbv library.">gerbv.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="gerb__image_8h.html" title="Header info for the image editing and support functions.">gerb_image.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="gerber_8h.html" title="Header info for the RS274X parsing functions.">gerber.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="gerb__stats_8h.html" title="Header info for the statistics generating functions for RS274X files.">gerb_stats.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="amacro_8h.html" title="Aperture macro parsing header info.">amacro.h</a>"</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">//#define AMACRO_DEBUG</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#ifndef RENDER_USING_GDK</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#include &lt;cairo.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#endif</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span>
<a name="l00050"></a>00050 <span class="comment">/* include this for macro enums */</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="draw-gdk_8h.html" title="Header info for the GDK rendering functions.">draw-gdk.h</a>"</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">/* DEBUG printing.  #define DEBUG 1 in config.h to use this fcn. */</span>
<a name="l00054"></a>00054 <span class="preprocessor">#define dprintf if(DEBUG) printf</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a>00056 <span class="comment">//#define AMACRO_DEBUG</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#define A2I(a,b) (((a &amp; 0xff) &lt;&lt; 8) + (b &amp; 0xff))</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00060"></a>00060 <span class="preprocessor">#define MAXL 200</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>
<a name="l00062"></a>00062 <span class="comment">/* Local function prototypes */</span>
<a name="l00063"></a>00063 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="gerber_8c.html#1619c05f6081185f49f6c36513ebb04b">parse_G_code</a>(gerb_file_t *fd, gerb_state_t *state, 
<a name="l00064"></a>00064                       <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image);
<a name="l00065"></a>00065 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="gerber_8c.html#9da9fc25bd1d004b20e7b43033c22544">parse_D_code</a>(gerb_file_t *fd, gerb_state_t *state, 
<a name="l00066"></a>00066                       <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image);
<a name="l00067"></a>00067 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_M_code(gerb_file_t *fd, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image);
<a name="l00068"></a>00068 <span class="keyword">static</span> <span class="keywordtype">void</span> parse_rs274x(gint levelOfRecursion, gerb_file_t *fd, 
<a name="l00069"></a>00069                       <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image, gerb_state_t *state, 
<a name="l00070"></a>00070                       <a class="code" href="structgerbv__net.html">gerbv_net_t</a> *curr_net, <a class="code" href="structgerbv__stats__t.html">gerbv_stats_t</a> *stats, 
<a name="l00071"></a>00071                       gchar *directoryPath);
<a name="l00072"></a>00072 <span class="keyword">static</span> <span class="keywordtype">int</span> parse_aperture_definition(gerb_file_t *fd, 
<a name="l00073"></a>00073                                  gerbv_aperture_t *aperture,
<a name="l00074"></a>00074                                  <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image, gdouble scale);
<a name="l00075"></a>00075 <span class="keyword">static</span> <span class="keywordtype">void</span> calc_cirseg_sq(<span class="keyword">struct</span> <a class="code" href="structgerbv__net.html">gerbv_net</a> *net, <span class="keywordtype">int</span> cw, 
<a name="l00076"></a>00076                         <span class="keywordtype">double</span> delta_cp_x, <span class="keywordtype">double</span> delta_cp_y);
<a name="l00077"></a>00077 <span class="keyword">static</span> <span class="keywordtype">void</span> calc_cirseg_mq(<span class="keyword">struct</span> <a class="code" href="structgerbv__net.html">gerbv_net</a> *net, <span class="keywordtype">int</span> cw, 
<a name="l00078"></a>00078                         <span class="keywordtype">double</span> delta_cp_x, <span class="keywordtype">double</span> delta_cp_y);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00081"></a>00081 gerber_update_min_and_max(<a class="code" href="structgerbv__image__info.html">gerbv_image_info_t</a> *info, gdouble repeatX, gdouble repeatY,
<a name="l00082"></a>00082                        gdouble x, gdouble y, gdouble apertureSizeX1,
<a name="l00083"></a>00083                        gdouble apertureSizeX2,gdouble apertureSizeY1,
<a name="l00084"></a>00084                        gdouble apertureSizeY2);
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="keyword">static</span> <span class="keywordtype">void</span> gerber_update_any_running_knockout_measurements(<a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image);
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="keyword">static</span> <span class="keywordtype">void</span> gerber_calculate_final_justify_effects (<a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image);
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 gboolean knockoutMeasure = FALSE;
<a name="l00092"></a>00092 gdouble knockoutLimitXmin, knockoutLimitYmin, knockoutLimitXmax, 
<a name="l00093"></a>00093     knockoutLimitYmax;
<a name="l00094"></a>00094 <a class="code" href="structgerbv__layer__t.html">gerbv_layer_t</a> *knockoutLayer = NULL;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="preprocessor">#ifndef RENDER_USING_GDK</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>cairo_matrix_t currentMatrix;
<a name="l00098"></a>00098 <span class="preprocessor">#endif  </span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>
<a name="l00100"></a>00100 <span class="comment">/* --------------------------------------------------------- */</span>
<a name="l00101"></a>00101 <a class="code" href="structgerbv__net.html">gerbv_net_t</a> *
<a name="l00102"></a>00102 gerber_create_new_net (<a class="code" href="structgerbv__net.html">gerbv_net_t</a> *currentNet, <a class="code" href="structgerbv__layer__t.html">gerbv_layer_t</a> *layer, <a class="code" href="structgerbv__netstate__t.html">gerbv_netstate_t</a> *state){
<a name="l00103"></a>00103        <a class="code" href="structgerbv__net.html">gerbv_net_t</a> *newNet = g_new0 (<a class="code" href="structgerbv__net.html">gerbv_net_t</a>, 1);
<a name="l00104"></a>00104        
<a name="l00105"></a>00105        currentNet-&gt;<a class="code" href="structgerbv__net.html#74453be5449de76efa6cc12df4b2886c">next</a> = newNet;
<a name="l00106"></a>00106        <span class="keywordflow">if</span> (layer)
<a name="l00107"></a>00107               newNet-&gt;<a class="code" href="structgerbv__net.html#13bb1433bc8ba893ab8d18dc83b3ec0c">layer</a> = layer;
<a name="l00108"></a>00108        <span class="keywordflow">else</span>
<a name="l00109"></a>00109               newNet-&gt;<a class="code" href="structgerbv__net.html#13bb1433bc8ba893ab8d18dc83b3ec0c">layer</a> = currentNet-&gt;<a class="code" href="structgerbv__net.html#13bb1433bc8ba893ab8d18dc83b3ec0c">layer</a>;
<a name="l00110"></a>00110        <span class="keywordflow">if</span> (state)
<a name="l00111"></a>00111               newNet-&gt;<a class="code" href="structgerbv__net.html#61c550ee3a7c7aeeb4b9d39993f6ded4">state</a> = state;
<a name="l00112"></a>00112        <span class="keywordflow">else</span>
<a name="l00113"></a>00113               newNet-&gt;<a class="code" href="structgerbv__net.html#61c550ee3a7c7aeeb4b9d39993f6ded4">state</a> = currentNet-&gt;<a class="code" href="structgerbv__net.html#61c550ee3a7c7aeeb4b9d39993f6ded4">state</a>;
<a name="l00114"></a>00114        <span class="keywordflow">return</span> newNet;
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="comment">/* --------------------------------------------------------- */</span>
<a name="l00118"></a>00118 gboolean
<a name="l00119"></a>00119 gerber_create_new_aperture (<a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image, <span class="keywordtype">int</span> *indexNumber,
<a name="l00120"></a>00120               <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237">gerbv_aperture_type_t</a> apertureType, gdouble parameter1, gdouble parameter2){
<a name="l00121"></a>00121        <span class="keywordtype">int</span> i;
<a name="l00122"></a>00122        
<a name="l00123"></a>00123        <span class="comment">/* search for an available aperture spot */</span>
<a name="l00124"></a>00124        <span class="keywordflow">for</span> (i = APERTURE_MIN; i &lt;= APERTURE_MAX; i++) {
<a name="l00125"></a>00125               <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[i] == NULL) {
<a name="l00126"></a>00126                      image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[i] = g_new0 (gerbv_aperture_t, 1);
<a name="l00127"></a>00127                      image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[i]-&gt;type = apertureType;
<a name="l00128"></a>00128                      image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[i]-&gt;amacro = NULL;
<a name="l00129"></a>00129                      image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[i]-&gt;parameter[0] = parameter1;
<a name="l00130"></a>00130                      image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[i]-&gt;parameter[1] = parameter2;
<a name="l00131"></a>00131                      *indexNumber = i;
<a name="l00132"></a>00132                      <span class="keywordflow">return</span> TRUE;
<a name="l00133"></a>00133               }
<a name="l00134"></a>00134        }
<a name="l00135"></a>00135        <span class="keywordflow">return</span> FALSE;
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="comment">/* --------------------------------------------------------- */</span>
<a name="l00148"></a>00148 gboolean
<a name="l00149"></a><a class="code" href="gerber_8c.html#e50502bd658a484dcd07c4360bafe435">00149</a> <a class="code" href="gerber_8c.html#e50502bd658a484dcd07c4360bafe435">gerber_parse_file_segment</a> (gint levelOfRecursion, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image, 
<a name="l00150"></a>00150                         gerb_state_t *state,     <a class="code" href="structgerbv__net.html">gerbv_net_t</a> *curr_net, 
<a name="l00151"></a>00151                         <a class="code" href="structgerbv__stats__t.html">gerbv_stats_t</a> *stats, gerb_file_t *fd, 
<a name="l00152"></a>00152                         gchar *directoryPath) {
<a name="l00153"></a>00153     <span class="keywordtype">int</span> read, coord, len, polygonPoints=0;
<a name="l00154"></a>00154     <span class="keywordtype">double</span> x_scale = 0.0, y_scale = 0.0;
<a name="l00155"></a>00155     <span class="keywordtype">double</span> delta_cp_x = 0.0, delta_cp_y = 0.0;
<a name="l00156"></a>00156     <span class="keywordtype">double</span> aperture_size;
<a name="l00157"></a>00157     <span class="keywordtype">double</span> scale;
<a name="l00158"></a>00158     gboolean foundEOF = FALSE;
<a name="l00159"></a>00159     gchar *string;
<a name="l00160"></a>00160     
<a name="l00161"></a>00161     <span class="keywordflow">while</span> ((read = gerb_fgetc(fd)) != EOF) {
<a name="l00162"></a>00162         <span class="comment">/* figure out the scale, since we need to normalize </span>
<a name="l00163"></a>00163 <span class="comment">          all dimensions to inches */</span>
<a name="l00164"></a>00164         <span class="keywordflow">if</span> (state-&gt;state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>)
<a name="l00165"></a>00165             scale = 25.4;
<a name="l00166"></a>00166         <span class="keywordflow">else</span>
<a name="l00167"></a>00167             scale = 1.0;
<a name="l00168"></a>00168        <span class="keywordflow">switch</span> ((<span class="keywordtype">char</span>)(read &amp; 0xff)) {
<a name="l00169"></a>00169        <span class="keywordflow">case</span> <span class="charliteral">'G'</span>:
<a name="l00170"></a>00170            dprintf(<span class="stringliteral">"... Found G code\n"</span>);
<a name="l00171"></a>00171            <a class="code" href="gerber_8c.html#1619c05f6081185f49f6c36513ebb04b">parse_G_code</a>(fd, state, image);
<a name="l00172"></a>00172            <span class="keywordflow">break</span>;
<a name="l00173"></a>00173        <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
<a name="l00174"></a>00174            dprintf(<span class="stringliteral">"... Found D code\n"</span>);
<a name="l00175"></a>00175            <a class="code" href="gerber_8c.html#9da9fc25bd1d004b20e7b43033c22544">parse_D_code</a>(fd, state, image);
<a name="l00176"></a>00176            <span class="keywordflow">break</span>;
<a name="l00177"></a>00177        <span class="keywordflow">case</span> <span class="charliteral">'M'</span>:
<a name="l00178"></a>00178            dprintf(<span class="stringliteral">"... Found M code\n"</span>);
<a name="l00179"></a>00179            <span class="keywordflow">switch</span>(parse_M_code(fd, image)) {
<a name="l00180"></a>00180            <span class="keywordflow">case</span> 1 :
<a name="l00181"></a>00181            <span class="keywordflow">case</span> 2 :
<a name="l00182"></a>00182            <span class="keywordflow">case</span> 3 :
<a name="l00183"></a>00183               foundEOF = TRUE;
<a name="l00184"></a>00184               <span class="keywordflow">break</span>;
<a name="l00185"></a>00185            <span class="keywordflow">default</span>:
<a name="l00186"></a>00186               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l00187"></a>00187                                  -1,
<a name="l00188"></a>00188                                  <span class="stringliteral">"Unknown M code found.\n"</span>,
<a name="l00189"></a>00189                                  <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00190"></a>00190            } <span class="comment">/* switch(parse_M_code) */</span>
<a name="l00191"></a>00191            <span class="keywordflow">break</span>;
<a name="l00192"></a>00192        <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
<a name="l00193"></a>00193            dprintf(<span class="stringliteral">"... Found X code\n"</span>);
<a name="l00194"></a>00194            stats-&gt;<a class="code" href="structgerbv__stats__t.html#f4244f8911d9d0081b0f2805f66c0c3a">X</a>++;
<a name="l00195"></a>00195            coord = gerb_fgetint(fd, &amp;len);
<a name="l00196"></a>00196            <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a> &amp;&amp; image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> == <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7085ee95a5b4d68f30e4ab554c9b2e94a">GERBV_OMIT_ZEROS_TRAILING</a>) {
<a name="l00197"></a>00197               
<a name="l00198"></a>00198               <span class="keywordflow">switch</span> ((image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#7fdb0532c06bf680102fcc0d810cb7bb">x_int</a> + image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#b6913f904b190541f1311c2aba6cc126">x_dec</a>) - len) {
<a name="l00199"></a>00199               <span class="keywordflow">case</span> 5:
<a name="l00200"></a>00200                   coord *= 10;
<a name="l00201"></a>00201               <span class="keywordflow">case</span> 4:
<a name="l00202"></a>00202                   coord *= 10;
<a name="l00203"></a>00203               <span class="keywordflow">case</span> 3:
<a name="l00204"></a>00204                   coord *= 10;
<a name="l00205"></a>00205               <span class="keywordflow">case</span> 2:
<a name="l00206"></a>00206                   coord *= 10;
<a name="l00207"></a>00207               <span class="keywordflow">case</span> 1:
<a name="l00208"></a>00208                   coord *= 10;
<a name="l00209"></a>00209                   <span class="keywordflow">break</span>;
<a name="l00210"></a>00210               <span class="keywordflow">default</span>:
<a name="l00211"></a>00211                   ;
<a name="l00212"></a>00212               }
<a name="l00213"></a>00213            }
<a name="l00214"></a>00214            <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a> &amp;&amp; (image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#41e03d02ae44c27cec09e19a7f42e4de">coordinate</a>==<a class="code" href="gerbv_8h.html#68b01b1e7e85c756cec2a18913164288a7acfe8f8e0ed42869b831292df0d096">GERBV_COORDINATE_INCREMENTAL</a>))
<a name="l00215"></a>00215                state-&gt;curr_x += coord;
<a name="l00216"></a>00216            <span class="keywordflow">else</span>
<a name="l00217"></a>00217                state-&gt;curr_x = coord;
<a name="l00218"></a>00218            state-&gt;changed = 1;
<a name="l00219"></a>00219            <span class="keywordflow">break</span>;
<a name="l00220"></a>00220        <span class="keywordflow">case</span> <span class="charliteral">'Y'</span>:
<a name="l00221"></a>00221            dprintf(<span class="stringliteral">"... Found Y code\n"</span>);
<a name="l00222"></a>00222            stats-&gt;<a class="code" href="structgerbv__stats__t.html#d401e15e4639c5e56f81de30418b7ac6">Y</a>++;
<a name="l00223"></a>00223            coord = gerb_fgetint(fd, &amp;len);
<a name="l00224"></a>00224            <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a> &amp;&amp; image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> == <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7085ee95a5b4d68f30e4ab554c9b2e94a">GERBV_OMIT_ZEROS_TRAILING</a>) {
<a name="l00225"></a>00225 
<a name="l00226"></a>00226               <span class="keywordflow">switch</span> ((image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#2cd781f2d92c62f5777aae89a5417f56">y_int</a> + image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#515caa5e3104bd023ada920c6782c08c">y_dec</a>) - len) {
<a name="l00227"></a>00227               <span class="keywordflow">case</span> 5:
<a name="l00228"></a>00228                   coord *= 10;
<a name="l00229"></a>00229               <span class="keywordflow">case</span> 4:
<a name="l00230"></a>00230                   coord *= 10;
<a name="l00231"></a>00231               <span class="keywordflow">case</span> 3:
<a name="l00232"></a>00232                   coord *= 10;
<a name="l00233"></a>00233               <span class="keywordflow">case</span> 2:
<a name="l00234"></a>00234                   coord *= 10;
<a name="l00235"></a>00235               <span class="keywordflow">case</span> 1:
<a name="l00236"></a>00236                   coord *= 10;
<a name="l00237"></a>00237                   <span class="keywordflow">break</span>;
<a name="l00238"></a>00238               <span class="keywordflow">default</span>:
<a name="l00239"></a>00239                   ;
<a name="l00240"></a>00240               }
<a name="l00241"></a>00241            }
<a name="l00242"></a>00242            <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a> &amp;&amp; (image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#41e03d02ae44c27cec09e19a7f42e4de">coordinate</a>==<a class="code" href="gerbv_8h.html#68b01b1e7e85c756cec2a18913164288a7acfe8f8e0ed42869b831292df0d096">GERBV_COORDINATE_INCREMENTAL</a>))
<a name="l00243"></a>00243                state-&gt;curr_y += coord;
<a name="l00244"></a>00244            <span class="keywordflow">else</span>
<a name="l00245"></a>00245                state-&gt;curr_y = coord;
<a name="l00246"></a>00246            state-&gt;changed = 1;
<a name="l00247"></a>00247            <span class="keywordflow">break</span>;
<a name="l00248"></a>00248        <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
<a name="l00249"></a>00249            dprintf(<span class="stringliteral">"... Found I code\n"</span>);
<a name="l00250"></a>00250            stats-&gt;<a class="code" href="structgerbv__stats__t.html#755e83eace8027661c27454569d3b5e2">I</a>++;
<a name="l00251"></a>00251            state-&gt;delta_cp_x = gerb_fgetint(fd, NULL);
<a name="l00252"></a>00252            state-&gt;changed = 1;
<a name="l00253"></a>00253            <span class="keywordflow">break</span>;
<a name="l00254"></a>00254        <span class="keywordflow">case</span> <span class="charliteral">'J'</span>:
<a name="l00255"></a>00255            dprintf(<span class="stringliteral">"... Found J code\n"</span>);
<a name="l00256"></a>00256            stats-&gt;<a class="code" href="structgerbv__stats__t.html#5c8ac440fb01f7be01ff4f2be1c7d2ae">J</a>++;
<a name="l00257"></a>00257            state-&gt;delta_cp_y = gerb_fgetint(fd, NULL);
<a name="l00258"></a>00258            state-&gt;changed = 1;
<a name="l00259"></a>00259            <span class="keywordflow">break</span>;
<a name="l00260"></a>00260        <span class="keywordflow">case</span> <span class="charliteral">'%'</span>:
<a name="l00261"></a>00261            dprintf(<span class="stringliteral">"... Found %% code\n"</span>);
<a name="l00262"></a>00262            parse_rs274x(levelOfRecursion, fd, image, state, curr_net, stats, directoryPath);
<a name="l00263"></a>00263            <span class="keywordflow">while</span> (1) {
<a name="l00264"></a>00264               <span class="keywordtype">int</span> c = gerb_fgetc(fd);
<a name="l00265"></a>00265               <span class="keywordflow">if</span>(c == EOF || c == <span class="charliteral">'%'</span>)
<a name="l00266"></a>00266                   <span class="keywordflow">break</span>;
<a name="l00267"></a>00267            }
<a name="l00268"></a>00268            <span class="keywordflow">break</span>;
<a name="l00269"></a>00269        <span class="keywordflow">case</span> <span class="charliteral">'*'</span>:  
<a name="l00270"></a>00270            dprintf(<span class="stringliteral">"... Found * code\n"</span>);
<a name="l00271"></a>00271            stats-&gt;<a class="code" href="structgerbv__stats__t.html#104c217a2d2d1b508a50e14ba20a89ba">star</a>++;
<a name="l00272"></a>00272            <span class="keywordflow">if</span> (state-&gt;changed == 0) <span class="keywordflow">break</span>;
<a name="l00273"></a>00273            state-&gt;changed = 0;
<a name="l00274"></a>00274            
<a name="l00275"></a>00275            <span class="comment">/* don't even bother saving the net if the aperture state is GERBV_APERTURE_STATE_OFF and we</span>
<a name="l00276"></a>00276 <span class="comment">              aren't starting a polygon fill (where we need it to get to the start point) */</span>
<a name="l00277"></a>00277            <span class="keywordflow">if</span> ((state-&gt;aperture_state == <a class="code" href="gerbv_8h.html#1bde819e0800e9b6efd3718c28b6c8f521b7ab32e7803243140cc7abc199eed1">GERBV_APERTURE_STATE_OFF</a>)&amp;&amp;(!state-&gt;in_parea_fill)&amp;&amp;
<a name="l00278"></a>00278                      (state-&gt;interpolation != <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e418a4b1cc85b83c63417078058325eef">GERBV_INTERPOLATION_PAREA_START</a>)) {
<a name="l00279"></a>00279               <span class="comment">/* save the coordinate so the next net can use it for a start point */</span>
<a name="l00280"></a>00280               state-&gt;prev_x = state-&gt;curr_x;
<a name="l00281"></a>00281               state-&gt;prev_y = state-&gt;curr_y;
<a name="l00282"></a>00282               <span class="keywordflow">break</span>;
<a name="l00283"></a>00283            }
<a name="l00284"></a>00284            curr_net = gerber_create_new_net (curr_net, state-&gt;<a class="code" href="structgerbv__net.html#13bb1433bc8ba893ab8d18dc83b3ec0c">layer</a>, state-&gt;state);
<a name="l00285"></a>00285            <span class="comment">/*</span>
<a name="l00286"></a>00286 <span class="comment">            * Scale to given coordinate format</span>
<a name="l00287"></a>00287 <span class="comment">            * XXX only "omit leading zeros".</span>
<a name="l00288"></a>00288 <span class="comment">            */</span>
<a name="l00289"></a>00289            <span class="keywordflow">if</span> (image &amp;&amp; image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a> ){
<a name="l00290"></a>00290               x_scale = pow(10.0, (<span class="keywordtype">double</span>)image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#b6913f904b190541f1311c2aba6cc126">x_dec</a>);
<a name="l00291"></a>00291               y_scale = pow(10.0, (<span class="keywordtype">double</span>)image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#515caa5e3104bd023ada920c6782c08c">y_dec</a>);
<a name="l00292"></a>00292            }
<a name="l00293"></a>00293            x_scale *= scale;
<a name="l00294"></a>00294            y_scale *= scale;
<a name="l00295"></a>00295            curr_net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> = (double)state-&gt;prev_x / x_scale;
<a name="l00296"></a>00296            curr_net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> = (<span class="keywordtype">double</span>)state-&gt;prev_y / y_scale;
<a name="l00297"></a>00297            curr_net-&gt;<a class="code" href="structgerbv__net.html#5e221f216fd25e09358da99191821d25">stop_x</a> = (double)state-&gt;curr_x / x_scale;
<a name="l00298"></a>00298            curr_net-&gt;<a class="code" href="structgerbv__net.html#322975adbc33c1a642fb5e8cfadd2eb7">stop_y</a> = (<span class="keywordtype">double</span>)state-&gt;curr_y / y_scale;
<a name="l00299"></a>00299            delta_cp_x = (double)state-&gt;delta_cp_x / x_scale;
<a name="l00300"></a>00300            delta_cp_y = (<span class="keywordtype">double</span>)state-&gt;delta_cp_y / y_scale;
<a name="l00301"></a>00301            
<a name="l00302"></a>00302            
<a name="l00303"></a>00303            <span class="keywordflow">switch</span> (state-&gt;interpolation) {
<a name="l00304"></a>00304            <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e922b94e7291b681b05cded85daa1eb98">GERBV_INTERPOLATION_CW_CIRCULAR</a> :
<a name="l00305"></a>00305               curr_net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a> = g_new0 (gerbv_cirseg_t,1);
<a name="l00306"></a>00306               <span class="keywordflow">if</span> (state-&gt;mq_on)
<a name="l00307"></a>00307                   calc_cirseg_mq(curr_net, 1, delta_cp_x, delta_cp_y);
<a name="l00308"></a>00308               <span class="keywordflow">else</span>
<a name="l00309"></a>00309                   calc_cirseg_sq(curr_net, 1, delta_cp_x, delta_cp_y);
<a name="l00310"></a>00310               <span class="keywordflow">break</span>;
<a name="l00311"></a>00311            <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5ef738d54521d612942753090b943a7426">GERBV_INTERPOLATION_CCW_CIRCULAR</a> :
<a name="l00312"></a>00312               curr_net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a> = g_new0 (gerbv_cirseg_t,1);
<a name="l00313"></a>00313               <span class="keywordflow">if</span> (state-&gt;mq_on)
<a name="l00314"></a>00314                   calc_cirseg_mq(curr_net, 0, delta_cp_x, delta_cp_y);
<a name="l00315"></a>00315               <span class="keywordflow">else</span>
<a name="l00316"></a>00316                   calc_cirseg_sq(curr_net, 0, delta_cp_x, delta_cp_y);
<a name="l00317"></a>00317               <span class="keywordflow">break</span>;
<a name="l00318"></a>00318            <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e418a4b1cc85b83c63417078058325eef">GERBV_INTERPOLATION_PAREA_START</a> :
<a name="l00319"></a>00319               <span class="comment">/* </span>
<a name="l00320"></a>00320 <span class="comment">               * To be able to get back and fill in number of polygon corners</span>
<a name="l00321"></a>00321 <span class="comment">               */</span>
<a name="l00322"></a>00322               state-&gt;parea_start_node = curr_net;
<a name="l00323"></a>00323               state-&gt;in_parea_fill = 1;
<a name="l00324"></a>00324               polygonPoints = 0;
<a name="l00325"></a>00325               <span class="keywordflow">break</span>;
<a name="l00326"></a>00326            <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e9a0c81abf80482847b58c54d3ea4218e">GERBV_INTERPOLATION_PAREA_END</a> :
<a name="l00327"></a>00327               state-&gt;parea_start_node = NULL;
<a name="l00328"></a>00328               state-&gt;in_parea_fill = 0;
<a name="l00329"></a>00329               polygonPoints = 0;
<a name="l00330"></a>00330               <span class="keywordflow">break</span>;
<a name="l00331"></a>00331            <span class="keywordflow">default</span> :
<a name="l00332"></a>00332               <span class="keywordflow">break</span>;
<a name="l00333"></a>00333            }  <span class="comment">/* switch(state-&gt;interpolation) */</span>
<a name="l00334"></a>00334 
<a name="l00335"></a>00335            <span class="comment">/* </span>
<a name="l00336"></a>00336 <span class="comment">            * Count number of points in Polygon Area </span>
<a name="l00337"></a>00337 <span class="comment">            */</span>
<a name="l00338"></a>00338            <span class="keywordflow">if</span> (state-&gt;in_parea_fill &amp;&amp; state-&gt;parea_start_node) {
<a name="l00339"></a>00339               <span class="comment">/* </span>
<a name="l00340"></a>00340 <span class="comment">               * "...all lines drawn with D01 are considered edges of the</span>
<a name="l00341"></a>00341 <span class="comment">               * polygon. D02 closes and fills the polygon."</span>
<a name="l00342"></a>00342 <span class="comment">               * p.49 rs274xrevd_e.pdf</span>
<a name="l00343"></a>00343 <span class="comment">               * D02 -&gt; state-&gt;aperture_state == GERBV_APERTURE_STATE_OFF</span>
<a name="l00344"></a>00344 <span class="comment">               */</span>
<a name="l00345"></a>00345                
<a name="l00346"></a>00346                <span class="comment">/* UPDATE: only end the polygon during a D02 call if we've already</span>
<a name="l00347"></a>00347 <span class="comment">                  drawn a polygon edge (with D01) */</span>
<a name="l00348"></a>00348                  
<a name="l00349"></a>00349               <span class="keywordflow">if</span> ((state-&gt;aperture_state == <a class="code" href="gerbv_8h.html#1bde819e0800e9b6efd3718c28b6c8f521b7ab32e7803243140cc7abc199eed1">GERBV_APERTURE_STATE_OFF</a> &amp;&amp;
<a name="l00350"></a>00350                      state-&gt;interpolation != <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e418a4b1cc85b83c63417078058325eef">GERBV_INTERPOLATION_PAREA_START</a>) &amp;&amp; (polygonPoints &gt; 0)) {
<a name="l00351"></a>00351                   curr_net-&gt;<a class="code" href="structgerbv__net.html#ad3bee195bd0592bf1521e94a5451d42">interpolation</a> = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e9a0c81abf80482847b58c54d3ea4218e">GERBV_INTERPOLATION_PAREA_END</a>;
<a name="l00352"></a>00352                   
<a name="l00353"></a>00353                   curr_net = gerber_create_new_net (curr_net, state-&gt;<a class="code" href="structgerbv__net.html#13bb1433bc8ba893ab8d18dc83b3ec0c">layer</a>, state-&gt;state);
<a name="l00354"></a>00354                   curr_net-&gt;<a class="code" href="structgerbv__net.html#ad3bee195bd0592bf1521e94a5451d42">interpolation</a> = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e418a4b1cc85b83c63417078058325eef">GERBV_INTERPOLATION_PAREA_START</a>;
<a name="l00355"></a>00355                   state-&gt;parea_start_node = curr_net;
<a name="l00356"></a>00356                   
<a name="l00357"></a>00357                   curr_net = gerber_create_new_net (curr_net, state-&gt;<a class="code" href="structgerbv__net.html#13bb1433bc8ba893ab8d18dc83b3ec0c">layer</a>, state-&gt;state);            
<a name="l00358"></a>00358                   curr_net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> = (double)state-&gt;prev_x / x_scale;
<a name="l00359"></a>00359                   curr_net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> = (<span class="keywordtype">double</span>)state-&gt;prev_y / y_scale;
<a name="l00360"></a>00360                   curr_net-&gt;<a class="code" href="structgerbv__net.html#5e221f216fd25e09358da99191821d25">stop_x</a> = (double)state-&gt;curr_x / x_scale;
<a name="l00361"></a>00361                   curr_net-&gt;<a class="code" href="structgerbv__net.html#322975adbc33c1a642fb5e8cfadd2eb7">stop_y</a> = (<span class="keywordtype">double</span>)state-&gt;curr_y / y_scale;
<a name="l00362"></a>00362               }
<a name="l00363"></a>00363               <span class="keywordflow">if</span> (state-&gt;interpolation != <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e418a4b1cc85b83c63417078058325eef">GERBV_INTERPOLATION_PAREA_START</a>)
<a name="l00364"></a>00364                   polygonPoints++;
<a name="l00365"></a>00365               
<a name="l00366"></a>00366            }  <span class="comment">/* if (state-&gt;in_parea_fill &amp;&amp; state-&gt;parea_start_node) */</span>
<a name="l00367"></a>00367            
<a name="l00368"></a>00368            curr_net-&gt;<a class="code" href="structgerbv__net.html#ad3bee195bd0592bf1521e94a5451d42">interpolation</a> = state-&gt;interpolation;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370            <span class="comment">/* </span>
<a name="l00371"></a>00371 <span class="comment">            * Override circular interpolation if no center was given.</span>
<a name="l00372"></a>00372 <span class="comment">            * This should be a safe hack, since a good file should always </span>
<a name="l00373"></a>00373 <span class="comment">            * include I or J.  And even if the radius is zero, the endpoint </span>
<a name="l00374"></a>00374 <span class="comment">            * should be the same as the start point, creating no line </span>
<a name="l00375"></a>00375 <span class="comment">            */</span>
<a name="l00376"></a>00376            <span class="keywordflow">if</span> (((state-&gt;interpolation == <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e922b94e7291b681b05cded85daa1eb98">GERBV_INTERPOLATION_CW_CIRCULAR</a>) || 
<a name="l00377"></a>00377                (state-&gt;interpolation == <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5ef738d54521d612942753090b943a7426">GERBV_INTERPOLATION_CCW_CIRCULAR</a>)) &amp;&amp; 
<a name="l00378"></a>00378               ((state-&gt;delta_cp_x == 0.0) &amp;&amp; (state-&gt;delta_cp_y == 0.0)))
<a name="l00379"></a>00379               curr_net-&gt;<a class="code" href="structgerbv__net.html#ad3bee195bd0592bf1521e94a5451d42">interpolation</a> = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5efc1b3a7c8e48bfbf95dc57b3e3042d2d">GERBV_INTERPOLATION_LINEARx1</a>;
<a name="l00380"></a>00380            
<a name="l00381"></a>00381            <span class="comment">/*</span>
<a name="l00382"></a>00382 <span class="comment">            * If we detected the end of Polygon Area Fill we go back to</span>
<a name="l00383"></a>00383 <span class="comment">            * the interpolation we had before that.</span>
<a name="l00384"></a>00384 <span class="comment">            * Also if we detected any of the quadrant flags, since some</span>
<a name="l00385"></a>00385 <span class="comment">            * gerbers don't reset the interpolation (EagleCad again).</span>
<a name="l00386"></a>00386 <span class="comment">            */</span>
<a name="l00387"></a>00387            <span class="keywordflow">if</span> ((state-&gt;interpolation == <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e418a4b1cc85b83c63417078058325eef">GERBV_INTERPOLATION_PAREA_START</a>) ||
<a name="l00388"></a>00388               (state-&gt;interpolation == <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e9a0c81abf80482847b58c54d3ea4218e">GERBV_INTERPOLATION_PAREA_END</a>))
<a name="l00389"></a>00389               state-&gt;interpolation = state-&gt;prev_interpolation;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391            <span class="comment">/*</span>
<a name="l00392"></a>00392 <span class="comment">            * Save layer polarity and unit</span>
<a name="l00393"></a>00393 <span class="comment">            */</span>
<a name="l00394"></a>00394            curr_net-&gt;<a class="code" href="structgerbv__net.html#13bb1433bc8ba893ab8d18dc83b3ec0c">layer</a> = state-&gt;layer;  
<a name="l00395"></a>00395            
<a name="l00396"></a>00396            state-&gt;delta_cp_x = 0.0;
<a name="l00397"></a>00397            state-&gt;delta_cp_y = 0.0;
<a name="l00398"></a>00398            curr_net-&gt;<a class="code" href="structgerbv__net.html#f4db0779d7e69e16f525fef3044897fd">aperture</a> = state-&gt;curr_aperture;
<a name="l00399"></a>00399            curr_net-&gt;<a class="code" href="structgerbv__net.html#5cabb2f3b512a328ff8dc7e6ef0c803b">aperture_state</a> = state-&gt;aperture_state;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401            <span class="comment">/*</span>
<a name="l00402"></a>00402 <span class="comment">            * For next round we save the current position as</span>
<a name="l00403"></a>00403 <span class="comment">            * the previous position</span>
<a name="l00404"></a>00404 <span class="comment">            */</span>
<a name="l00405"></a>00405            state-&gt;prev_x = state-&gt;curr_x;
<a name="l00406"></a>00406            state-&gt;prev_y = state-&gt;curr_y;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408            <span class="comment">/*</span>
<a name="l00409"></a>00409 <span class="comment">            * If we have an aperture defined at the moment we find </span>
<a name="l00410"></a>00410 <span class="comment">            * min and max of image with compensation for mm.</span>
<a name="l00411"></a>00411 <span class="comment">            */</span>
<a name="l00412"></a>00412            <span class="keywordflow">if</span> ((curr_net-&gt;<a class="code" href="structgerbv__net.html#f4db0779d7e69e16f525fef3044897fd">aperture</a> == 0) &amp;&amp; !state-&gt;in_parea_fill) 
<a name="l00413"></a>00413               <span class="keywordflow">break</span>;
<a name="l00414"></a>00414            
<a name="l00415"></a>00415            <span class="comment">/* only update the min/max values and aperture stats if we are drawing */</span>
<a name="l00416"></a>00416            <span class="keywordflow">if</span> ((curr_net-&gt;<a class="code" href="structgerbv__net.html#5cabb2f3b512a328ff8dc7e6ef0c803b">aperture_state</a> != <a class="code" href="gerbv_8h.html#1bde819e0800e9b6efd3718c28b6c8f521b7ab32e7803243140cc7abc199eed1">GERBV_APERTURE_STATE_OFF</a>)){
<a name="l00417"></a>00417               <span class="keywordtype">double</span> repeat_off_X = 0.0, repeat_off_Y = 0.0;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419               <span class="comment">/* Update stats with current aperture number if not in polygon */</span>
<a name="l00420"></a>00420               <span class="keywordflow">if</span> (!state-&gt;in_parea_fill) {
<a name="l00421"></a>00421                      dprintf(<span class="stringliteral">"     In parse_D_code, adding 1 to D_list ...\n"</span>);
<a name="l00422"></a>00422                      <span class="keywordtype">int</span> retcode = gerbv_stats_increment_D_list_count(stats-&gt;<a class="code" href="structgerbv__stats__t.html#8bdcc430dea32309c7d102e4568862ce">D_code_list</a>, 
<a name="l00423"></a>00423                                                                 curr_net-&gt;<a class="code" href="structgerbv__net.html#f4db0779d7e69e16f525fef3044897fd">aperture</a>, 
<a name="l00424"></a>00424                                                                 1,
<a name="l00425"></a>00425                                                                 stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>);
<a name="l00426"></a>00426                      <span class="keywordflow">if</span> (retcode == -1) {
<a name="l00427"></a>00427                          <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Found undefined D code D%d in file \n%s\n"</span>, 
<a name="l00428"></a>00428                                                curr_net-&gt;<a class="code" href="structgerbv__net.html#f4db0779d7e69e16f525fef3044897fd">aperture</a>, 
<a name="l00429"></a>00429                                                fd-&gt;filename);
<a name="l00430"></a>00430                          gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l00431"></a>00431                                             -1,
<a name="l00432"></a>00432                                             <span class="keywordtype">string</span>,
<a name="l00433"></a>00433                                             <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00434"></a>00434                          g_free(<span class="keywordtype">string</span>);
<a name="l00435"></a>00435                          stats-&gt;<a class="code" href="structgerbv__stats__t.html#9d37781803d97f26f24165d359ebc965">D_unknown</a>++;
<a name="l00436"></a>00436                      }
<a name="l00437"></a>00437               }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439               <span class="comment">/*</span>
<a name="l00440"></a>00440 <span class="comment">               * If step_and_repeat (%SR%) is used, check min_x,max_y etc for</span>
<a name="l00441"></a>00441 <span class="comment">               * the ends of the step_and_repeat lattice. This goes wrong in </span>
<a name="l00442"></a>00442 <span class="comment">               * the case of negative dist_X or dist_Y, in which case we </span>
<a name="l00443"></a>00443 <span class="comment">               * should compare against the startpoints of the lines, not </span>
<a name="l00444"></a>00444 <span class="comment">               * the stoppoints, but that seems an uncommon case (and the </span>
<a name="l00445"></a>00445 <span class="comment">               * error isn't very big any way).</span>
<a name="l00446"></a>00446 <span class="comment">               */</span>
<a name="l00447"></a>00447               repeat_off_X = (state-&gt;layer-&gt;stepAndRepeat.X - 1) *
<a name="l00448"></a>00448                   state-&gt;layer-&gt;stepAndRepeat.dist_X;
<a name="l00449"></a>00449               repeat_off_Y = (state-&gt;layer-&gt;stepAndRepeat.Y - 1) *
<a name="l00450"></a>00450                   state-&gt;layer-&gt;stepAndRepeat.dist_Y;
<a name="l00451"></a>00451               
<a name="l00452"></a>00452               
<a name="l00453"></a>00453 <span class="preprocessor">#ifndef RENDER_USING_GDK</span>
<a name="l00454"></a>00454 <span class="preprocessor"></span>              cairo_matrix_init (&amp;currentMatrix, 1, 0, 0, 1, 0, 0);
<a name="l00455"></a>00455               <span class="comment">/* offset image */</span>
<a name="l00456"></a>00456               cairo_matrix_translate (&amp;currentMatrix, image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#3f145d47793e723d09e5a75758b25295">offsetA</a>, 
<a name="l00457"></a>00457                                    image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#db9f3d343e14f84e23181b17c0bf3a73">offsetB</a>);
<a name="l00458"></a>00458               <span class="comment">/* do image rotation */</span>
<a name="l00459"></a>00459               cairo_matrix_rotate (&amp;currentMatrix, image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#db41e52862ce0d0038506566743ff334">imageRotation</a>);
<a name="l00460"></a>00460               <span class="comment">/* it's a new layer, so recalculate the new transformation </span>
<a name="l00461"></a>00461 <span class="comment">               * matrix for it */</span>
<a name="l00462"></a>00462               <span class="comment">/* do any rotations */</span>
<a name="l00463"></a>00463               cairo_matrix_rotate (&amp;currentMatrix, state-&gt;layer-&gt;rotation);
<a name="l00464"></a>00464                      
<a name="l00465"></a>00465               <span class="comment">/* calculate current layer and state transformation matrices */</span>
<a name="l00466"></a>00466               <span class="comment">/* apply scale factor */</span>
<a name="l00467"></a>00467               cairo_matrix_scale (&amp;currentMatrix, state-&gt;state-&gt;scaleA, 
<a name="l00468"></a>00468                                 state-&gt;state-&gt;scaleB);
<a name="l00469"></a>00469               <span class="comment">/* apply offset */</span>
<a name="l00470"></a>00470               cairo_matrix_translate (&amp;currentMatrix, state-&gt;state-&gt;offsetA,
<a name="l00471"></a>00471                                    state-&gt;state-&gt;offsetB);
<a name="l00472"></a>00472               <span class="comment">/* apply mirror */</span>
<a name="l00473"></a>00473               <span class="keywordflow">switch</span> (state-&gt;state-&gt;mirrorState) {
<a name="l00474"></a>00474               <span class="keywordflow">case</span> GERBV_MIRROR_STATE_FLIPA:
<a name="l00475"></a>00475                   cairo_matrix_scale (&amp;currentMatrix, -1, 1);
<a name="l00476"></a>00476                   <span class="keywordflow">break</span>;
<a name="l00477"></a>00477               <span class="keywordflow">case</span> GERBV_MIRROR_STATE_FLIPB:
<a name="l00478"></a>00478                   cairo_matrix_scale (&amp;currentMatrix, 1, -1);
<a name="l00479"></a>00479                   <span class="keywordflow">break</span>;
<a name="l00480"></a>00480               <span class="keywordflow">case</span> GERBV_MIRROR_STATE_FLIPAB:
<a name="l00481"></a>00481                   cairo_matrix_scale (&amp;currentMatrix, -1, -1);
<a name="l00482"></a>00482                   <span class="keywordflow">break</span>;
<a name="l00483"></a>00483               <span class="keywordflow">default</span>:
<a name="l00484"></a>00484                   <span class="keywordflow">break</span>;
<a name="l00485"></a>00485               }
<a name="l00486"></a>00486               <span class="comment">/* finally, apply axis select */</span>
<a name="l00487"></a>00487               <span class="keywordflow">if</span> (state-&gt;state-&gt;axisSelect == GERBV_AXIS_SELECT_SWAPAB) {
<a name="l00488"></a>00488                   <span class="comment">/* we do this by rotating 270 (counterclockwise, then </span>
<a name="l00489"></a>00489 <span class="comment">                   *  mirroring the Y axis </span>
<a name="l00490"></a>00490 <span class="comment">                   */</span>
<a name="l00491"></a>00491                   cairo_matrix_rotate (&amp;currentMatrix, 3 * M_PI / 2);
<a name="l00492"></a>00492                   cairo_matrix_scale (&amp;currentMatrix, 1, -1);
<a name="l00493"></a>00493               }
<a name="l00494"></a>00494 <span class="preprocessor">#endif</span>
<a name="l00495"></a>00495 <span class="preprocessor"></span>              <span class="comment">/* if it's a macro, step through all the primitive components</span>
<a name="l00496"></a>00496 <span class="comment">                 and calculate the true bounding box */</span>
<a name="l00497"></a>00497               <span class="keywordflow">if</span> ((image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[curr_net-&gt;<a class="code" href="structgerbv__net.html#f4db0779d7e69e16f525fef3044897fd">aperture</a>] != NULL) &amp;&amp;
<a name="l00498"></a>00498                   (image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[curr_net-&gt;<a class="code" href="structgerbv__net.html#f4db0779d7e69e16f525fef3044897fd">aperture</a>]-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237555091fa58982b0afde79e6eb51215a7">GERBV_APTYPE_MACRO</a>)) {
<a name="l00499"></a>00499                   gerbv_simplified_amacro_t *ls = image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[curr_net-&gt;<a class="code" href="structgerbv__net.html#f4db0779d7e69e16f525fef3044897fd">aperture</a>]-&gt;simplified;
<a name="l00500"></a>00500              
<a name="l00501"></a>00501                   <span class="keywordflow">while</span> (ls != NULL) {
<a name="l00502"></a>00502                      gdouble offsetx = 0, offsety = 0, widthx = 0, widthy = 0;
<a name="l00503"></a>00503                      gboolean calculatedAlready = FALSE;
<a name="l00504"></a>00504                      
<a name="l00505"></a>00505                      <span class="keywordflow">if</span> (ls-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e12374aa4d6be02b88c38208a8d57568e0e25">GERBV_APTYPE_MACRO_CIRCLE</a>) {
<a name="l00506"></a>00506                          offsetx=ls-&gt;parameter[CIRCLE_CENTER_X];
<a name="l00507"></a>00507                          offsety=ls-&gt;parameter[CIRCLE_CENTER_Y];
<a name="l00508"></a>00508                          widthx=widthy=ls-&gt;parameter[CIRCLE_DIAMETER];
<a name="l00509"></a>00509                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ls-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123745da38f5ee1b382588d0990bb2c7a61d">GERBV_APTYPE_MACRO_OUTLINE</a>) {
<a name="l00510"></a>00510                          <span class="keywordtype">int</span> pointCounter,numberOfPoints;
<a name="l00511"></a>00511                          numberOfPoints = (int) ls-&gt;parameter[OUTLINE_NUMBER_OF_POINTS];
<a name="l00512"></a>00512               
<a name="l00513"></a>00513                          for (pointCounter = 0; pointCounter &lt; numberOfPoints; pointCounter++) {
<a name="l00514"></a>00514                             gerber_update_min_and_max (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>, repeat_off_X, repeat_off_Y,
<a name="l00515"></a>00515                                                     ls-&gt;parameter[pointCounter * 2 + OUTLINE_FIRST_X],
<a name="l00516"></a>00516                                                     ls-&gt;parameter[pointCounter * 2 + OUTLINE_FIRST_Y], 
<a name="l00517"></a>00517                                                     0,0,0,0);
<a name="l00518"></a>00518                          }
<a name="l00519"></a>00519                          calculatedAlready = TRUE;
<a name="l00520"></a>00520                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ls-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237a102b604a3b05bf6c141edacf5ed1126">GERBV_APTYPE_MACRO_POLYGON</a>) {
<a name="l00521"></a>00521                          offsetx = ls-&gt;parameter[POLYGON_CENTER_X];
<a name="l00522"></a>00522                          offsety = ls-&gt;parameter[POLYGON_CENTER_Y];
<a name="l00523"></a>00523                          widthx = widthy = ls-&gt;parameter[POLYGON_DIAMETER];
<a name="l00524"></a>00524                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ls-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237e76651c204dbffde21b0dc5332565e18">GERBV_APTYPE_MACRO_MOIRE</a>) {
<a name="l00525"></a>00525                          offsetx = ls-&gt;parameter[MOIRE_CENTER_X];
<a name="l00526"></a>00526                          offsety = ls-&gt;parameter[MOIRE_CENTER_Y];
<a name="l00527"></a>00527                          widthx = widthy = ls-&gt;parameter[MOIRE_OUTSIDE_DIAMETER];
<a name="l00528"></a>00528                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ls-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237dabe9b77a94c2120f39baed9ac18df4e">GERBV_APTYPE_MACRO_THERMAL</a>) {
<a name="l00529"></a>00529                          offsetx = ls-&gt;parameter[THERMAL_CENTER_X];
<a name="l00530"></a>00530                          offsety = ls-&gt;parameter[THERMAL_CENTER_Y];
<a name="l00531"></a>00531                          widthx = widthy = ls-&gt;parameter[THERMAL_OUTSIDE_DIAMETER];
<a name="l00532"></a>00532                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ls-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123705b2b411854f499ec367cba6143dd725">GERBV_APTYPE_MACRO_LINE20</a>) {
<a name="l00533"></a>00533                          widthx = widthy = ls-&gt;parameter[LINE20_LINE_WIDTH];
<a name="l00534"></a>00534                          gerber_update_min_and_max (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>, repeat_off_X, repeat_off_Y,
<a name="l00535"></a>00535                                                  ls-&gt;parameter[LINE20_START_X] + offsetx,
<a name="l00536"></a>00536                                                  ls-&gt;parameter[LINE20_START_Y] + offsety, 
<a name="l00537"></a>00537                                                  widthx/2,widthx/2,widthy/2,widthy/2);
<a name="l00538"></a>00538                          gerber_update_min_and_max (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>, repeat_off_X, repeat_off_Y,
<a name="l00539"></a>00539                                                  ls-&gt;parameter[LINE20_END_X] + offsetx,
<a name="l00540"></a>00540                                                  ls-&gt;parameter[LINE20_END_Y] + offsety, 
<a name="l00541"></a>00541                                                  widthx/2,widthx/2,widthy/2,widthy/2);
<a name="l00542"></a>00542                          calculatedAlready = TRUE;
<a name="l00543"></a>00543                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ls-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123706618241ba60c1d2e90a63a13033a419">GERBV_APTYPE_MACRO_LINE21</a>) {
<a name="l00544"></a>00544                          gdouble largestDimension = sqrt (ls-&gt;parameter[LINE21_WIDTH]/2 *
<a name="l00545"></a>00545                                                       ls-&gt;parameter[LINE21_WIDTH]/2 + ls-&gt;parameter[LINE21_HEIGHT/2] *
<a name="l00546"></a>00546                                                       ls-&gt;parameter[LINE21_HEIGHT]/2);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548                          offsetx = ls-&gt;parameter[LINE21_CENTER_X];
<a name="l00549"></a>00549                          offsety = ls-&gt;parameter[LINE21_CENTER_Y];
<a name="l00550"></a>00550                          widthx = widthy=largestDimension;
<a name="l00551"></a>00551                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ls-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237e52e5a1629e8f1e68c29b66eb78e6021">GERBV_APTYPE_MACRO_LINE22</a>) {
<a name="l00552"></a>00552                          gdouble largestDimension = sqrt (ls-&gt;parameter[LINE22_WIDTH]/2 *
<a name="l00553"></a>00553                                                       ls-&gt;parameter[LINE22_WIDTH]/2 + ls-&gt;parameter[LINE22_HEIGHT/2] *
<a name="l00554"></a>00554                                                       ls-&gt;parameter[LINE22_HEIGHT]/2);
<a name="l00555"></a>00555 
<a name="l00556"></a>00556                          offsetx = ls-&gt;parameter[LINE22_LOWER_LEFT_X] +
<a name="l00557"></a>00557                             ls-&gt;parameter[LINE22_WIDTH]/2;
<a name="l00558"></a>00558                          offsety = ls-&gt;parameter[LINE22_LOWER_LEFT_Y] +
<a name="l00559"></a>00559                             ls-&gt;parameter[LINE22_HEIGHT]/2;
<a name="l00560"></a>00560                          widthx = widthy=largestDimension;
<a name="l00561"></a>00561                      }
<a name="l00562"></a>00562               
<a name="l00563"></a>00563                      <span class="keywordflow">if</span> (!calculatedAlready) {
<a name="l00564"></a>00564                          gerber_update_min_and_max (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>, repeat_off_X, repeat_off_Y,
<a name="l00565"></a>00565                                                  curr_net-&gt;<a class="code" href="structgerbv__net.html#5e221f216fd25e09358da99191821d25">stop_x</a> + offsetx,
<a name="l00566"></a>00566                                                  curr_net-&gt;<a class="code" href="structgerbv__net.html#322975adbc33c1a642fb5e8cfadd2eb7">stop_y</a> + offsety, 
<a name="l00567"></a>00567                                                  widthx/2,widthx/2,widthy/2,widthy/2);
<a name="l00568"></a>00568                      }
<a name="l00569"></a>00569                      ls = ls-&gt;next;
<a name="l00570"></a>00570                   }
<a name="l00571"></a>00571               } <span class="keywordflow">else</span> {
<a name="l00572"></a>00572                   <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[curr_net-&gt;<a class="code" href="structgerbv__net.html#f4db0779d7e69e16f525fef3044897fd">aperture</a>] != NULL) {
<a name="l00573"></a>00573                      aperture_size = image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[curr_net-&gt;<a class="code" href="structgerbv__net.html#f4db0779d7e69e16f525fef3044897fd">aperture</a>]-&gt;parameter[0];
<a name="l00574"></a>00574                   } <span class="keywordflow">else</span> {
<a name="l00575"></a>00575                      <span class="comment">/* this is usually for polygon fills, where the aperture width</span>
<a name="l00576"></a>00576 <span class="comment">                        if "zero" */</span>
<a name="l00577"></a>00577                      aperture_size = 0;
<a name="l00578"></a>00578                   }
<a name="l00579"></a>00579                   
<a name="l00580"></a>00580                   <span class="comment">/* check both the start and stop of the aperture points against</span>
<a name="l00581"></a>00581 <span class="comment">                     a running min/max counter */</span>
<a name="l00582"></a>00582                   <span class="comment">/* Note: only check start coordinate if this isn't a flash, </span>
<a name="l00583"></a>00583 <span class="comment">                     since the start point may be bogus if it is a flash */</span>
<a name="l00584"></a>00584                   <span class="keywordflow">if</span> (curr_net-&gt;<a class="code" href="structgerbv__net.html#5cabb2f3b512a328ff8dc7e6ef0c803b">aperture_state</a> != <a class="code" href="gerbv_8h.html#1bde819e0800e9b6efd3718c28b6c8f5e29aaa9ec01ade417353bc82c42fafcc">GERBV_APERTURE_STATE_FLASH</a>) {
<a name="l00585"></a>00585                      gerber_update_min_and_max (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>, repeat_off_X, repeat_off_Y,
<a name="l00586"></a>00586                                              curr_net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a>, curr_net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a>, 
<a name="l00587"></a>00587                                              aperture_size/2,aperture_size/2,
<a name="l00588"></a>00588                                              aperture_size/2,aperture_size/2);
<a name="l00589"></a>00589                   }
<a name="l00590"></a>00590                   gerber_update_min_and_max (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>, repeat_off_X, repeat_off_Y,
<a name="l00591"></a>00591                                           curr_net-&gt;<a class="code" href="structgerbv__net.html#5e221f216fd25e09358da99191821d25">stop_x</a>, curr_net-&gt;<a class="code" href="structgerbv__net.html#322975adbc33c1a642fb5e8cfadd2eb7">stop_y</a>, 
<a name="l00592"></a>00592                                           aperture_size/2,aperture_size/2,
<a name="l00593"></a>00593                                           aperture_size/2,aperture_size/2);
<a name="l00594"></a>00594               }
<a name="l00595"></a>00595            }
<a name="l00596"></a>00596            <span class="keywordflow">break</span>;
<a name="l00597"></a>00597        <span class="keywordflow">case</span> 10 :   <span class="comment">/* White space */</span>
<a name="l00598"></a>00598        <span class="keywordflow">case</span> 13 :
<a name="l00599"></a>00599        <span class="keywordflow">case</span> <span class="charliteral">' '</span> :
<a name="l00600"></a>00600        <span class="keywordflow">case</span> <span class="charliteral">'\t'</span> :
<a name="l00601"></a>00601        <span class="keywordflow">case</span> 0 :
<a name="l00602"></a>00602            <span class="keywordflow">break</span>;
<a name="l00603"></a>00603        <span class="keywordflow">default</span>:
<a name="l00604"></a>00604            stats-&gt;<a class="code" href="structgerbv__stats__t.html#bbd09c0352bef256b7128020359939c3">unknown</a>++;
<a name="l00605"></a>00605            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Found unknown character (whitespace?) [%d]%c\n"</span>, 
<a name="l00606"></a>00606                                  read, read);
<a name="l00607"></a>00607            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l00608"></a>00608                               -1,
<a name="l00609"></a>00609                               <span class="keywordtype">string</span>, 
<a name="l00610"></a>00610                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00611"></a>00611            g_free(<span class="keywordtype">string</span>);
<a name="l00612"></a>00612        }  <span class="comment">/* switch((char) (read &amp; 0xff)) */</span>
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614     <span class="keywordflow">return</span> foundEOF;
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l00625"></a>00625 <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *
<a name="l00626"></a><a class="code" href="gerber_8h.html#fed2f7eb78aa79c288d341fa986d19f5">00626</a> <a class="code" href="gerber_8c.html#fed2f7eb78aa79c288d341fa986d19f5">parse_gerb</a>(gerb_file_t *fd, gchar *directoryPath)
<a name="l00627"></a>00627 {
<a name="l00628"></a>00628     gerb_state_t *state = NULL;
<a name="l00629"></a>00629     <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image = NULL;
<a name="l00630"></a>00630     <a class="code" href="structgerbv__net.html">gerbv_net_t</a> *curr_net = NULL;
<a name="l00631"></a>00631     <a class="code" href="structgerbv__stats__t.html">gerbv_stats_t</a> *stats;
<a name="l00632"></a>00632     gboolean foundEOF = FALSE;
<a name="l00633"></a>00633     gchar *string;
<a name="l00634"></a>00634     
<a name="l00635"></a>00635     <span class="comment">/* added by t.motylewski@bfad.de</span>
<a name="l00636"></a>00636 <span class="comment">     * many locales redefine "." as "," and so on, </span>
<a name="l00637"></a>00637 <span class="comment">     * so sscanf and strtod has problems when</span>
<a name="l00638"></a>00638 <span class="comment">     * reading files using %f format */</span>
<a name="l00639"></a>00639     setlocale(LC_NUMERIC, <span class="stringliteral">"C"</span> );
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     <span class="comment">/* </span>
<a name="l00642"></a>00642 <span class="comment">     * Create new state.  This is used locally to keep track</span>
<a name="l00643"></a>00643 <span class="comment">     * of the photoplotter's state as the Gerber is read in.</span>
<a name="l00644"></a>00644 <span class="comment">     */</span>
<a name="l00645"></a>00645     state = g_new0 (gerb_state_t, 1);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647     <span class="comment">/* </span>
<a name="l00648"></a>00648 <span class="comment">     * Create new image.  This will be returned.</span>
<a name="l00649"></a>00649 <span class="comment">     */</span>
<a name="l00650"></a>00650     image = <a class="code" href="gerb__image_8c.html#a875910d3a77c167893b04b03beb8023" title="Allocate a new gerbv_image structure.">gerbv_create_image</a>(image, <span class="stringliteral">"RS274-X (Gerber) File"</span>);
<a name="l00651"></a>00651     <span class="keywordflow">if</span> (image == NULL)
<a name="l00652"></a>00652        GERB_FATAL_ERROR(<span class="stringliteral">"malloc image failed\n"</span>);
<a name="l00653"></a>00653     curr_net = image-&gt;<a class="code" href="structgerbv__image__t.html#4ce3cbd8ab0949d0da18653890184120">netlist</a>;
<a name="l00654"></a>00654     image-&gt;<a class="code" href="structgerbv__image__t.html#1989b1e87fa2e8a13cd0ab7fd449a158">layertype</a> = <a class="code" href="gerbv_8h.html#ff1f9c1b35a7164a5d5cc4f15090f40b75512ef4a42645cafd74dbed3cb6994d">GERBV_LAYERTYPE_RS274X</a>;
<a name="l00655"></a>00655     image-&gt;<a class="code" href="structgerbv__image__t.html#0d803a4e74d2247e3029b21eda386558">gerbv_stats</a> = <a class="code" href="gerb__stats_8c.html#5616195ffdb5915a0db83250296b3d79" title="Allocates a new gerbv_stats structure.">gerbv_stats_new</a>();
<a name="l00656"></a>00656     <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#0d803a4e74d2247e3029b21eda386558">gerbv_stats</a> == NULL)
<a name="l00657"></a>00657        GERB_FATAL_ERROR(<span class="stringliteral">"malloc gerbv_stats failed\n"</span>);
<a name="l00658"></a>00658     stats = (<a class="code" href="structgerbv__stats__t.html">gerbv_stats_t</a> *) image-&gt;<a class="code" href="structgerbv__image__t.html#0d803a4e74d2247e3029b21eda386558">gerbv_stats</a>;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     <span class="comment">/* set active layer and netstate to point to first default one created */</span>
<a name="l00661"></a>00661     state-&gt;layer = image-&gt;<a class="code" href="structgerbv__image__t.html#13fdf9e40c8e6efc8f9eec2ec5e25801">layers</a>;
<a name="l00662"></a>00662     state-&gt;state = image-&gt;<a class="code" href="structgerbv__image__t.html#b81e3c6363cf0014970ca1cbcb3182f6">states</a>;
<a name="l00663"></a>00663     curr_net-&gt;<a class="code" href="structgerbv__net.html#13bb1433bc8ba893ab8d18dc83b3ec0c">layer</a> = state-&gt;layer;
<a name="l00664"></a>00664     curr_net-&gt;<a class="code" href="structgerbv__net.html#61c550ee3a7c7aeeb4b9d39993f6ded4">state</a> = state-&gt;state;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     <span class="comment">/*</span>
<a name="l00667"></a>00667 <span class="comment">     * Start parsing</span>
<a name="l00668"></a>00668 <span class="comment">     */</span>
<a name="l00669"></a>00669     dprintf(<span class="stringliteral">"In parse_gerb, starting to parse file...\n"</span>);
<a name="l00670"></a>00670     foundEOF = <a class="code" href="gerber_8c.html#e50502bd658a484dcd07c4360bafe435">gerber_parse_file_segment</a> (1, image, state, curr_net, stats,
<a name="l00671"></a>00671                                      fd, directoryPath);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     <span class="keywordflow">if</span> (!foundEOF) {
<a name="l00674"></a>00674        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"File %s is missing Gerber EOF code.\n"</span>, fd-&gt;filename);
<a name="l00675"></a>00675        gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l00676"></a>00676                            -1,
<a name="l00677"></a>00677                            <span class="keywordtype">string</span>,
<a name="l00678"></a>00678                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00679"></a>00679        g_free(<span class="keywordtype">string</span>);
<a name="l00680"></a>00680     }
<a name="l00681"></a>00681     g_free(state);
<a name="l00682"></a>00682     
<a name="l00683"></a>00683     dprintf(<span class="stringliteral">"               ... done parsing Gerber file\n"</span>);
<a name="l00684"></a>00684     gerber_update_any_running_knockout_measurements (image);
<a name="l00685"></a>00685     gerber_calculate_final_justify_effects(image);
<a name="l00686"></a>00686 
<a name="l00687"></a>00687     <span class="keywordflow">return</span> image;
<a name="l00688"></a>00688 } <span class="comment">/* parse_gerb */</span>
<a name="l00689"></a>00689 
<a name="l00690"></a>00690 
<a name="l00691"></a>00691 <span class="comment">/* ------------------------------------------------------------------- */</span>
<a name="l00695"></a>00695 gboolean
<a name="l00696"></a><a class="code" href="gerber_8h.html#c8d477d089cfc66eb15a40fe2a72940e">00696</a> <a class="code" href="gerber_8c.html#c8d477d089cfc66eb15a40fe2a72940e">gerber_is_rs274x_p</a>(gerb_file_t *fd, gboolean *returnFoundBinary) 
<a name="l00697"></a>00697 {
<a name="l00698"></a>00698     <span class="keywordtype">char</span> *buf;
<a name="l00699"></a>00699     <span class="keywordtype">int</span> len = 0;
<a name="l00700"></a>00700     <span class="keywordtype">char</span> *letter;
<a name="l00701"></a>00701     <span class="keywordtype">int</span> i;
<a name="l00702"></a>00702     gboolean found_binary = FALSE;
<a name="l00703"></a>00703     gboolean found_ADD = FALSE;
<a name="l00704"></a>00704     gboolean found_D0 = FALSE;
<a name="l00705"></a>00705     gboolean found_D2 = FALSE;
<a name="l00706"></a>00706     gboolean found_M0 = FALSE;
<a name="l00707"></a>00707     gboolean found_M2 = FALSE;
<a name="l00708"></a>00708     gboolean found_star = FALSE;
<a name="l00709"></a>00709     gboolean found_X = FALSE;
<a name="l00710"></a>00710     gboolean found_Y = FALSE;
<a name="l00711"></a>00711    
<a name="l00712"></a>00712     dprintf (<span class="stringliteral">"gerber_is_rs274x_p(%p, %p), fd-&gt;fd = %p\n"</span>, fd, returnFoundBinary, fd-&gt;fd); 
<a name="l00713"></a>00713     buf = (<span class="keywordtype">char</span> *) g_malloc(MAXL);
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (buf == NULL) 
<a name="l00715"></a>00715        GERB_FATAL_ERROR(<span class="stringliteral">"malloc buf failed while checking for rs274x.\n"</span>);
<a name="l00716"></a>00716     
<a name="l00717"></a>00717     <span class="keywordflow">while</span> (fgets(buf, MAXL, fd-&gt;fd) != NULL) {
<a name="l00718"></a>00718         dprintf (<span class="stringliteral">"buf = \"%s\"\n"</span>, buf);
<a name="l00719"></a>00719        len = strlen(buf);
<a name="l00720"></a>00720     
<a name="l00721"></a>00721        <span class="comment">/* First look through the file for indications of its type by</span>
<a name="l00722"></a>00722 <span class="comment">        * checking that file is not binary (non-printing chars and white </span>
<a name="l00723"></a>00723 <span class="comment">        * spaces)</span>
<a name="l00724"></a>00724 <span class="comment">        */</span>
<a name="l00725"></a>00725        <span class="keywordflow">for</span> (i = 0; i &lt; len; i++) {
<a name="l00726"></a>00726            <span class="keywordflow">if</span> (!isprint((<span class="keywordtype">int</span>) buf[i]) &amp;&amp; (buf[i] != <span class="charliteral">'\r'</span>) &amp;&amp; 
<a name="l00727"></a>00727               (buf[i] != <span class="charliteral">'\n'</span>) &amp;&amp; (buf[i] != <span class="charliteral">'\t'</span>)) {
<a name="l00728"></a>00728               found_binary = TRUE;
<a name="l00729"></a>00729                 dprintf (<span class="stringliteral">"found_binary (%d)\n"</span>, buf[i]);
<a name="l00730"></a>00730            }
<a name="l00731"></a>00731        }
<a name="l00732"></a>00732        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"%ADD"</span>)) {
<a name="l00733"></a>00733            found_ADD = TRUE;
<a name="l00734"></a>00734             dprintf (<span class="stringliteral">"found_ADD\n"</span>);
<a name="l00735"></a>00735        }
<a name="l00736"></a>00736        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"D00"</span>)) {
<a name="l00737"></a>00737            found_D0 = TRUE;
<a name="l00738"></a>00738             dprintf (<span class="stringliteral">"found_D0\n"</span>);
<a name="l00739"></a>00739        }
<a name="l00740"></a>00740        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"D02"</span>)) {
<a name="l00741"></a>00741            found_D2 = TRUE;
<a name="l00742"></a>00742             dprintf (<span class="stringliteral">"found_D2\n"</span>);
<a name="l00743"></a>00743        }
<a name="l00744"></a>00744        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"M0"</span>)) {
<a name="l00745"></a>00745            found_M0 = TRUE;
<a name="l00746"></a>00746             dprintf (<span class="stringliteral">"found_M0\n"</span>);
<a name="l00747"></a>00747        }
<a name="l00748"></a>00748        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"M00"</span>)) {
<a name="l00749"></a>00749            found_M0 = TRUE;
<a name="l00750"></a>00750             dprintf (<span class="stringliteral">"found_M0\n"</span>);
<a name="l00751"></a>00751        }
<a name="l00752"></a>00752        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"M2"</span>)) {
<a name="l00753"></a>00753            found_M2 = TRUE;
<a name="l00754"></a>00754             dprintf (<span class="stringliteral">"found_M2\n"</span>);
<a name="l00755"></a>00755        }
<a name="l00756"></a>00756        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"M02"</span>)) {
<a name="l00757"></a>00757            found_M2 = TRUE;
<a name="l00758"></a>00758             dprintf (<span class="stringliteral">"found_M2\n"</span>);
<a name="l00759"></a>00759        }
<a name="l00760"></a>00760        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"*"</span>)) {
<a name="l00761"></a>00761            found_star = TRUE;
<a name="l00762"></a>00762             dprintf (<span class="stringliteral">"found_star\n"</span>);
<a name="l00763"></a>00763        }
<a name="l00764"></a>00764        <span class="comment">/* look for X&lt;number&gt; or Y&lt;number&gt; */</span>
<a name="l00765"></a>00765        <span class="keywordflow">if</span> ((letter = g_strstr_len(buf, len, <span class="stringliteral">"X"</span>)) != NULL) {
<a name="l00766"></a>00766            <span class="keywordflow">if</span> (isdigit((<span class="keywordtype">int</span>) letter[1])) { <span class="comment">/* grab char after X */</span>
<a name="l00767"></a>00767               found_X = TRUE;
<a name="l00768"></a>00768                 dprintf (<span class="stringliteral">"found_X\n"</span>);
<a name="l00769"></a>00769            }
<a name="l00770"></a>00770        }
<a name="l00771"></a>00771        <span class="keywordflow">if</span> ((letter = g_strstr_len(buf, len, <span class="stringliteral">"Y"</span>)) != NULL) {
<a name="l00772"></a>00772            <span class="keywordflow">if</span> (isdigit((<span class="keywordtype">int</span>) letter[1])) { <span class="comment">/* grab char after Y */</span>
<a name="l00773"></a>00773               found_Y = TRUE;
<a name="l00774"></a>00774                 dprintf (<span class="stringliteral">"found_Y\n"</span>);
<a name="l00775"></a>00775            }
<a name="l00776"></a>00776        }
<a name="l00777"></a>00777     }
<a name="l00778"></a>00778     rewind(fd-&gt;fd);
<a name="l00779"></a>00779     free(buf);
<a name="l00780"></a>00780    
<a name="l00781"></a>00781     *returnFoundBinary = found_binary;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783     <span class="comment">/* Now form logical expression determining if the file is RS-274X */</span>
<a name="l00784"></a>00784     <span class="keywordflow">if</span> ((found_D0 || found_D2 || found_M0 || found_M2) &amp;&amp; 
<a name="l00785"></a>00785        found_ADD &amp;&amp; found_star &amp;&amp; (found_X || found_Y)) 
<a name="l00786"></a>00786        <span class="keywordflow">return</span> TRUE;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788     
<a name="l00789"></a>00789     <span class="keywordflow">return</span> FALSE;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 } <span class="comment">/* gerber_is_rs274x */</span>
<a name="l00792"></a>00792 
<a name="l00793"></a>00793 
<a name="l00794"></a>00794 <span class="comment">/* ------------------------------------------------------------------- */</span>
<a name="l00798"></a>00798 gboolean
<a name="l00799"></a><a class="code" href="gerber_8h.html#1f3c64ad0d66dca00fa2bf07012e3fc6">00799</a> <a class="code" href="gerber_8c.html#1f3c64ad0d66dca00fa2bf07012e3fc6">gerber_is_rs274d_p</a>(gerb_file_t *fd) 
<a name="l00800"></a>00800 {
<a name="l00801"></a>00801     <span class="keywordtype">char</span> *buf;
<a name="l00802"></a>00802     <span class="keywordtype">int</span> len = 0;
<a name="l00803"></a>00803     <span class="keywordtype">char</span> *letter;
<a name="l00804"></a>00804     <span class="keywordtype">int</span> i;
<a name="l00805"></a>00805     gboolean found_binary = FALSE;
<a name="l00806"></a>00806     gboolean found_ADD = FALSE;
<a name="l00807"></a>00807     gboolean found_D0 = FALSE;
<a name="l00808"></a>00808     gboolean found_D2 = FALSE;
<a name="l00809"></a>00809     gboolean found_M0 = FALSE;
<a name="l00810"></a>00810     gboolean found_M2 = FALSE;
<a name="l00811"></a>00811     gboolean found_star = FALSE;
<a name="l00812"></a>00812     gboolean found_X = FALSE;
<a name="l00813"></a>00813     gboolean found_Y = FALSE;
<a name="l00814"></a>00814     
<a name="l00815"></a>00815     buf = malloc(MAXL);
<a name="l00816"></a>00816     <span class="keywordflow">if</span> (buf == NULL) 
<a name="l00817"></a>00817        GERB_FATAL_ERROR(<span class="stringliteral">"malloc buf failed while checking for rs274d.\n"</span>);
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="keywordflow">while</span> (fgets(buf, MAXL, fd-&gt;fd) != NULL) {
<a name="l00820"></a>00820        len = strlen(buf);
<a name="l00821"></a>00821     
<a name="l00822"></a>00822        <span class="comment">/* First look through the file for indications of its type */</span>
<a name="l00823"></a>00823     
<a name="l00824"></a>00824        <span class="comment">/* check that file is not binary (non-printing chars */</span>
<a name="l00825"></a>00825        <span class="keywordflow">for</span> (i = 0; i &lt; len; i++) {
<a name="l00826"></a>00826            <span class="keywordflow">if</span> (!isprint( (<span class="keywordtype">int</span>) buf[i]) &amp;&amp; (buf[i] != <span class="charliteral">'\r'</span>) &amp;&amp; 
<a name="l00827"></a>00827               (buf[i] != <span class="charliteral">'\n'</span>) &amp;&amp; (buf[i] != <span class="charliteral">'\t'</span>)) {
<a name="l00828"></a>00828               found_binary = TRUE;
<a name="l00829"></a>00829            }
<a name="l00830"></a>00830        }
<a name="l00831"></a>00831        
<a name="l00832"></a>00832        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"%ADD"</span>)) {
<a name="l00833"></a>00833            found_ADD = TRUE;
<a name="l00834"></a>00834        }
<a name="l00835"></a>00835        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"D00"</span>)) {
<a name="l00836"></a>00836            found_D0 = TRUE;
<a name="l00837"></a>00837        }
<a name="l00838"></a>00838        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"D02"</span>)) {
<a name="l00839"></a>00839            found_D2 = TRUE;
<a name="l00840"></a>00840        }
<a name="l00841"></a>00841        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"M0"</span>)) {
<a name="l00842"></a>00842            found_M0 = TRUE;
<a name="l00843"></a>00843        }
<a name="l00844"></a>00844        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"M00"</span>)) {
<a name="l00845"></a>00845            found_M0 = TRUE;
<a name="l00846"></a>00846        }
<a name="l00847"></a>00847        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"M02"</span>)) {
<a name="l00848"></a>00848            found_M2 = TRUE;
<a name="l00849"></a>00849        }
<a name="l00850"></a>00850        <span class="keywordflow">if</span> (g_strstr_len(buf, len, <span class="stringliteral">"*"</span>)) {
<a name="l00851"></a>00851            found_star = TRUE;
<a name="l00852"></a>00852        }
<a name="l00853"></a>00853        <span class="comment">/* look for X&lt;number&gt; or Y&lt;number&gt; */</span>
<a name="l00854"></a>00854        <span class="keywordflow">if</span> ((letter = g_strstr_len(buf, len, <span class="stringliteral">"X"</span>)) != NULL) {
<a name="l00855"></a>00855            <span class="comment">/* grab char after X */</span>
<a name="l00856"></a>00856            <span class="keywordflow">if</span> (isdigit( (<span class="keywordtype">int</span>) letter[1])) {
<a name="l00857"></a>00857               found_X = TRUE;
<a name="l00858"></a>00858            }
<a name="l00859"></a>00859        }
<a name="l00860"></a>00860        <span class="keywordflow">if</span> ((letter = g_strstr_len(buf, len, <span class="stringliteral">"Y"</span>)) != NULL) {
<a name="l00861"></a>00861            <span class="comment">/* grab char after Y */</span>
<a name="l00862"></a>00862            <span class="keywordflow">if</span> (isdigit( (<span class="keywordtype">int</span>) letter[1])) {
<a name="l00863"></a>00863               found_Y = TRUE;
<a name="l00864"></a>00864            }
<a name="l00865"></a>00865        }
<a name="l00866"></a>00866     }
<a name="l00867"></a>00867     rewind(fd-&gt;fd);
<a name="l00868"></a>00868     free(buf);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     <span class="comment">/* Now form logical expression determining if the file is RS-274D */</span>
<a name="l00871"></a>00871     <span class="keywordflow">if</span> ((found_D0 || found_D2 || found_M0 || found_M2) &amp;&amp; 
<a name="l00872"></a>00872        !found_ADD &amp;&amp; found_star &amp;&amp; (found_X || found_Y) &amp;&amp; 
<a name="l00873"></a>00873        !found_binary) 
<a name="l00874"></a>00874        <span class="keywordflow">return</span> TRUE;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     <span class="keywordflow">return</span> FALSE;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878 } <span class="comment">/* gerber_is_rs274d */</span>
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 
<a name="l00881"></a>00881 <span class="comment">/* ------------------------------------------------------------------- */</span>
<a name="l00885"></a>00885 <span class="keyword">static</span> <span class="keywordtype">void</span> 
<a name="l00886"></a><a class="code" href="gerber_8c.html#1619c05f6081185f49f6c36513ebb04b">00886</a> <a class="code" href="gerber_8c.html#1619c05f6081185f49f6c36513ebb04b">parse_G_code</a>(gerb_file_t *fd, gerb_state_t *state, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image)
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888     <span class="keywordtype">int</span>  op_int;
<a name="l00889"></a>00889     <a class="code" href="structgerbv__format.html">gerbv_format_t</a> *format = image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>;
<a name="l00890"></a>00890     <a class="code" href="structgerbv__stats__t.html">gerbv_stats_t</a> *stats = image-&gt;<a class="code" href="structgerbv__image__t.html#0d803a4e74d2247e3029b21eda386558">gerbv_stats</a>;
<a name="l00891"></a>00891     <span class="keywordtype">int</span> c;
<a name="l00892"></a>00892     gchar *string;
<a name="l00893"></a>00893 
<a name="l00894"></a>00894     op_int=gerb_fgetint(fd, NULL);
<a name="l00895"></a>00895     
<a name="l00896"></a>00896     <span class="keywordflow">switch</span>(op_int) {
<a name="l00897"></a>00897     <span class="keywordflow">case</span> 0:  <span class="comment">/* Move */</span>
<a name="l00898"></a>00898        <span class="comment">/* Is this doing anything really? */</span>
<a name="l00899"></a>00899        stats-&gt;<a class="code" href="structgerbv__stats__t.html#7fd6404f50ab4c12dba6848145d3a471">G0</a>++;
<a name="l00900"></a>00900        <span class="keywordflow">break</span>;
<a name="l00901"></a>00901     <span class="keywordflow">case</span> 1:  <span class="comment">/* Linear Interpolation (1X scale) */</span>
<a name="l00902"></a>00902        state-&gt;interpolation = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5efc1b3a7c8e48bfbf95dc57b3e3042d2d">GERBV_INTERPOLATION_LINEARx1</a>;
<a name="l00903"></a>00903        stats-&gt;<a class="code" href="structgerbv__stats__t.html#20c76a50ec0b905fdc0b22c8a93705be">G1</a>++;
<a name="l00904"></a>00904        <span class="keywordflow">break</span>;
<a name="l00905"></a>00905     <span class="keywordflow">case</span> 2:  <span class="comment">/* Clockwise Linear Interpolation */</span>
<a name="l00906"></a>00906        state-&gt;interpolation = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e922b94e7291b681b05cded85daa1eb98">GERBV_INTERPOLATION_CW_CIRCULAR</a>;
<a name="l00907"></a>00907        stats-&gt;<a class="code" href="structgerbv__stats__t.html#cb7f003824607ce14666ab1c37fbd3d7">G2</a>++;
<a name="l00908"></a>00908        <span class="keywordflow">break</span>;
<a name="l00909"></a>00909     <span class="keywordflow">case</span> 3:  <span class="comment">/* Counter Clockwise Linear Interpolation */</span>
<a name="l00910"></a>00910        state-&gt;interpolation = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5ef738d54521d612942753090b943a7426">GERBV_INTERPOLATION_CCW_CIRCULAR</a>;
<a name="l00911"></a>00911        stats-&gt;<a class="code" href="structgerbv__stats__t.html#dcb2715281495355b6b78e4be0e356c4">G3</a>++;
<a name="l00912"></a>00912        <span class="keywordflow">break</span>;
<a name="l00913"></a>00913     <span class="keywordflow">case</span> 4:  <span class="comment">/* Ignore Data Block */</span>
<a name="l00914"></a>00914        <span class="comment">/* Don't do anything, just read 'til * */</span>
<a name="l00915"></a>00915         <span class="comment">/* SDB asks:  Should we look for other codes while reading G04 in case</span>
<a name="l00916"></a>00916 <span class="comment">        * user forgot to put * at end of comment block? */</span>
<a name="l00917"></a>00917        c = gerb_fgetc(fd);
<a name="l00918"></a>00918        <span class="keywordflow">while</span> ((c != EOF) &amp;&amp; (c != <span class="charliteral">'*'</span>)) {
<a name="l00919"></a>00919            c = gerb_fgetc(fd);
<a name="l00920"></a>00920        }
<a name="l00921"></a>00921        stats-&gt;<a class="code" href="structgerbv__stats__t.html#08b90872671b182a6481ff3dfb015e34">G4</a>++;
<a name="l00922"></a>00922        <span class="keywordflow">break</span>;
<a name="l00923"></a>00923     <span class="keywordflow">case</span> 10: <span class="comment">/* Linear Interpolation (10X scale) */</span>
<a name="l00924"></a>00924        state-&gt;interpolation = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5eafb605f54313fd8299abb57f749a5f72">GERBV_INTERPOLATION_x10</a>;
<a name="l00925"></a>00925        stats-&gt;<a class="code" href="structgerbv__stats__t.html#c6c5cb4a5ac073262f7d945ecf19cf40">G10</a>++;
<a name="l00926"></a>00926        <span class="keywordflow">break</span>;
<a name="l00927"></a>00927     <span class="keywordflow">case</span> 11: <span class="comment">/* Linear Interpolation (0.1X scale) */</span>
<a name="l00928"></a>00928        state-&gt;interpolation = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e162b6f84fe9933e3d8f8d9d712222584">GERBV_INTERPOLATION_LINEARx01</a>;
<a name="l00929"></a>00929        stats-&gt;<a class="code" href="structgerbv__stats__t.html#76a89f69381b84fe7fbcc0f9c008cbe2">G11</a>++;
<a name="l00930"></a>00930        <span class="keywordflow">break</span>;
<a name="l00931"></a>00931     <span class="keywordflow">case</span> 12: <span class="comment">/* Linear Interpolation (0.01X scale) */</span>
<a name="l00932"></a>00932        state-&gt;interpolation = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e713750d93715d25cc1306fb07cfc3090">GERBV_INTERPOLATION_LINEARx001</a>;
<a name="l00933"></a>00933        stats-&gt;<a class="code" href="structgerbv__stats__t.html#809d12c600c5e436becefa6ac68a9899">G12</a>++;
<a name="l00934"></a>00934        <span class="keywordflow">break</span>;
<a name="l00935"></a>00935     <span class="keywordflow">case</span> 36: <span class="comment">/* Turn on Polygon Area Fill */</span>
<a name="l00936"></a>00936        state-&gt;prev_interpolation = state-&gt;interpolation;
<a name="l00937"></a>00937        state-&gt;interpolation = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e418a4b1cc85b83c63417078058325eef">GERBV_INTERPOLATION_PAREA_START</a>;
<a name="l00938"></a>00938        state-&gt;changed = 1;
<a name="l00939"></a>00939        stats-&gt;<a class="code" href="structgerbv__stats__t.html#db97474c53d0d6556aa0db191290343b">G36</a>++;
<a name="l00940"></a>00940        <span class="keywordflow">break</span>;
<a name="l00941"></a>00941     <span class="keywordflow">case</span> 37: <span class="comment">/* Turn off Polygon Area Fill */</span>
<a name="l00942"></a>00942        state-&gt;interpolation = <a class="code" href="gerbv_8h.html#f06070b85e638637eae8960cdaa2cf5e9a0c81abf80482847b58c54d3ea4218e">GERBV_INTERPOLATION_PAREA_END</a>;
<a name="l00943"></a>00943        state-&gt;changed = 1;
<a name="l00944"></a>00944        stats-&gt;<a class="code" href="structgerbv__stats__t.html#36a212db6e2b56accbd171d323646f0c">G37</a>++;
<a name="l00945"></a>00945        <span class="keywordflow">break</span>;
<a name="l00946"></a>00946     <span class="keywordflow">case</span> 54: <span class="comment">/* Tool prepare */</span>
<a name="l00947"></a>00947        <span class="comment">/* XXX Maybe uneccesary??? */</span>
<a name="l00948"></a>00948        <span class="keywordflow">if</span> (gerb_fgetc(fd) == <span class="charliteral">'D'</span>) {
<a name="l00949"></a>00949            <span class="keywordtype">int</span> a = gerb_fgetint(fd, NULL);
<a name="l00950"></a>00950            <span class="keywordflow">if</span> ((a &gt;= APERTURE_MIN) &amp;&amp; (a &lt;= APERTURE_MAX)) {
<a name="l00951"></a>00951               state-&gt;curr_aperture = a;
<a name="l00952"></a>00952            } <span class="keywordflow">else</span> { 
<a name="l00953"></a>00953               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Found aperture D%d out of bounds while parsing G code in file \n%s\n"</span>, 
<a name="l00954"></a>00954                                     a, fd-&gt;filename);
<a name="l00955"></a>00955               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l00956"></a>00956                                   -1,
<a name="l00957"></a>00957                                   <span class="keywordtype">string</span>,
<a name="l00958"></a>00958                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00959"></a>00959               g_free(<span class="keywordtype">string</span>);
<a name="l00960"></a>00960            }
<a name="l00961"></a>00961        } <span class="keywordflow">else</span> {
<a name="l00962"></a>00962            <span class="keywordtype">string</span> =  g_strdup_printf(<span class="stringliteral">"Found unexpected code after G54 in file \n%s\n"</span>, fd-&gt;filename);
<a name="l00963"></a>00963            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l00964"></a>00964                               -1,
<a name="l00965"></a>00965                               <span class="keywordtype">string</span>, 
<a name="l00966"></a>00966                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l00967"></a>00967            g_free(<span class="keywordtype">string</span>);
<a name="l00968"></a>00968            <span class="comment">/* Must insert error count here */</span>
<a name="l00969"></a>00969        }
<a name="l00970"></a>00970        stats-&gt;<a class="code" href="structgerbv__stats__t.html#866c0a5ce629c59e90c3bdf3454bdb4c">G54</a>++;
<a name="l00971"></a>00971        <span class="keywordflow">break</span>;
<a name="l00972"></a>00972     <span class="keywordflow">case</span> 55: <span class="comment">/* Prepare for flash */</span>
<a name="l00973"></a>00973        stats-&gt;<a class="code" href="structgerbv__stats__t.html#1ecbf942f961d3924ac13f4a0e2eb8cb">G55</a>++;
<a name="l00974"></a>00974        <span class="keywordflow">break</span>;
<a name="l00975"></a>00975     <span class="keywordflow">case</span> 70: <span class="comment">/* Specify inches */</span>
<a name="l00976"></a>00976        state-&gt;state = gerbv_image_return_new_netstate (state-&gt;state);
<a name="l00977"></a>00977        state-&gt;state-&gt;unit = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce46256f1b4adec6e863e6373f80963126">GERBV_UNIT_INCH</a>;
<a name="l00978"></a>00978        stats-&gt;<a class="code" href="structgerbv__stats__t.html#77266675215ecba5beb327dd8040c0c2">G70</a>++;
<a name="l00979"></a>00979        <span class="keywordflow">break</span>;
<a name="l00980"></a>00980     <span class="keywordflow">case</span> 71: <span class="comment">/* Specify millimeters */</span>
<a name="l00981"></a>00981        state-&gt;state = gerbv_image_return_new_netstate (state-&gt;state);
<a name="l00982"></a>00982        state-&gt;state-&gt;unit = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>;
<a name="l00983"></a>00983        stats-&gt;<a class="code" href="structgerbv__stats__t.html#fa38f315e69cd1afc4d5ac2ed28c82f0">G71</a>++;
<a name="l00984"></a>00984        <span class="keywordflow">break</span>;
<a name="l00985"></a>00985     <span class="keywordflow">case</span> 74: <span class="comment">/* Disable 360 circular interpolation */</span>
<a name="l00986"></a>00986        state-&gt;mq_on = 0;
<a name="l00987"></a>00987        stats-&gt;<a class="code" href="structgerbv__stats__t.html#342f86af65ebbb3662b48c244579f99b">G74</a>++;
<a name="l00988"></a>00988        <span class="keywordflow">break</span>;
<a name="l00989"></a>00989     <span class="keywordflow">case</span> 75: <span class="comment">/* Enable 360 circular interpolation */</span>
<a name="l00990"></a>00990        state-&gt;mq_on = 1;
<a name="l00991"></a>00991        stats-&gt;<a class="code" href="structgerbv__stats__t.html#ba868ff9baaf7c34b63ea45735dd60f5">G75</a>++;
<a name="l00992"></a>00992        <span class="keywordflow">break</span>;
<a name="l00993"></a>00993     <span class="keywordflow">case</span> 90: <span class="comment">/* Specify absolut format */</span>
<a name="l00994"></a>00994        <span class="keywordflow">if</span> (format) format-&gt;<a class="code" href="structgerbv__format.html#41e03d02ae44c27cec09e19a7f42e4de">coordinate</a> = <a class="code" href="gerbv_8h.html#68b01b1e7e85c756cec2a18913164288fbb8394e900f1f8d0355dded75324a25">GERBV_COORDINATE_ABSOLUTE</a>;
<a name="l00995"></a>00995        stats-&gt;<a class="code" href="structgerbv__stats__t.html#ede29de3a70dd8923119063f41e38dc5">G90</a>++;
<a name="l00996"></a>00996        <span class="keywordflow">break</span>;
<a name="l00997"></a>00997     <span class="keywordflow">case</span> 91: <span class="comment">/* Specify incremental format */</span>
<a name="l00998"></a>00998        <span class="keywordflow">if</span> (format) format-&gt;<a class="code" href="structgerbv__format.html#41e03d02ae44c27cec09e19a7f42e4de">coordinate</a> = <a class="code" href="gerbv_8h.html#68b01b1e7e85c756cec2a18913164288a7acfe8f8e0ed42869b831292df0d096">GERBV_COORDINATE_INCREMENTAL</a>;
<a name="l00999"></a>00999        stats-&gt;<a class="code" href="structgerbv__stats__t.html#e2ea45ad9b2d7905bf5e53cab19e68f8">G91</a>++;
<a name="l01000"></a>01000        <span class="keywordflow">break</span>;
<a name="l01001"></a>01001     <span class="keywordflow">default</span>:
<a name="l01002"></a>01002        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Encountered unknown G code G%d in file \n%s\n"</span>, op_int, fd-&gt;filename);
<a name="l01003"></a>01003        gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01004"></a>01004                            -1,
<a name="l01005"></a>01005                            <span class="keywordtype">string</span>,
<a name="l01006"></a>01006                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01007"></a>01007        g_free(<span class="keywordtype">string</span>);
<a name="l01008"></a>01008        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Ignorning unknown G code G%d\n"</span>, op_int);
<a name="l01009"></a>01009        gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01010"></a>01010                            -1,
<a name="l01011"></a>01011                            <span class="keywordtype">string</span>,
<a name="l01012"></a>01012                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l01013"></a>01013        g_free(<span class="keywordtype">string</span>);
<a name="l01014"></a>01014        stats-&gt;<a class="code" href="structgerbv__stats__t.html#2cf538b65e8b825c9097b6e4c67262b8">G_unknown</a>++;
<a name="l01015"></a>01015        <span class="comment">/* Enter error count here */</span>
<a name="l01016"></a>01016        <span class="keywordflow">break</span>;
<a name="l01017"></a>01017     }
<a name="l01018"></a>01018     
<a name="l01019"></a>01019     <span class="keywordflow">return</span>;
<a name="l01020"></a>01020 } <span class="comment">/* parse_G_code */</span>
<a name="l01021"></a>01021 
<a name="l01022"></a>01022 
<a name="l01023"></a>01023 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l01027"></a>01027 <span class="keyword">static</span> <span class="keywordtype">void</span> 
<a name="l01028"></a><a class="code" href="gerber_8c.html#9da9fc25bd1d004b20e7b43033c22544">01028</a> <a class="code" href="gerber_8c.html#9da9fc25bd1d004b20e7b43033c22544">parse_D_code</a>(gerb_file_t *fd, gerb_state_t *state, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image)
<a name="l01029"></a>01029 {
<a name="l01030"></a>01030     <span class="keywordtype">int</span> a;
<a name="l01031"></a>01031     <a class="code" href="structgerbv__stats__t.html">gerbv_stats_t</a> *stats = image-&gt;<a class="code" href="structgerbv__image__t.html#0d803a4e74d2247e3029b21eda386558">gerbv_stats</a>;
<a name="l01032"></a>01032     gchar *string;
<a name="l01033"></a>01033 
<a name="l01034"></a>01034     a = gerb_fgetint(fd, NULL);
<a name="l01035"></a>01035     dprintf(<span class="stringliteral">"     In parse_D_code, found D number = %d ... \n"</span>, a);
<a name="l01036"></a>01036     <span class="keywordflow">switch</span>(a) {
<a name="l01037"></a>01037     <span class="keywordflow">case</span> 0 : <span class="comment">/* Invalid code */</span>
<a name="l01038"></a>01038        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Found invalid D00 code in file \n%s.\n"</span>, fd-&gt;filename);
<a name="l01039"></a>01039         gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01040"></a>01040                            -1,
<a name="l01041"></a>01041                            <span class="keywordtype">string</span>, 
<a name="l01042"></a>01042                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01043"></a>01043        g_free(<span class="keywordtype">string</span>);
<a name="l01044"></a>01044         stats-&gt;<a class="code" href="structgerbv__stats__t.html#55e13bae20c8e1e25856da76a254dd9a">D_error</a>++;
<a name="l01045"></a>01045        <span class="keywordflow">break</span>;
<a name="l01046"></a>01046     <span class="keywordflow">case</span> 1 : <span class="comment">/* Exposure on */</span>
<a name="l01047"></a>01047        state-&gt;aperture_state = <a class="code" href="gerbv_8h.html#1bde819e0800e9b6efd3718c28b6c8f5522a02cbf231eae94b370a73e021bdc1">GERBV_APERTURE_STATE_ON</a>;
<a name="l01048"></a>01048        state-&gt;changed = 1;
<a name="l01049"></a>01049        stats-&gt;<a class="code" href="structgerbv__stats__t.html#2ef56b5b06f489df9395bd773952a33b">D1</a>++;
<a name="l01050"></a>01050        <span class="keywordflow">break</span>;
<a name="l01051"></a>01051     <span class="keywordflow">case</span> 2 : <span class="comment">/* Exposure off */</span>
<a name="l01052"></a>01052        state-&gt;aperture_state = <a class="code" href="gerbv_8h.html#1bde819e0800e9b6efd3718c28b6c8f521b7ab32e7803243140cc7abc199eed1">GERBV_APERTURE_STATE_OFF</a>;
<a name="l01053"></a>01053        state-&gt;changed = 1;
<a name="l01054"></a>01054        stats-&gt;<a class="code" href="structgerbv__stats__t.html#7beaff4100609e1ffa0142ec4545ba78">D2</a>++;
<a name="l01055"></a>01055        <span class="keywordflow">break</span>;
<a name="l01056"></a>01056     <span class="keywordflow">case</span> 3 : <span class="comment">/* Flash aperture */</span>
<a name="l01057"></a>01057        state-&gt;aperture_state = <a class="code" href="gerbv_8h.html#1bde819e0800e9b6efd3718c28b6c8f5e29aaa9ec01ade417353bc82c42fafcc">GERBV_APERTURE_STATE_FLASH</a>;
<a name="l01058"></a>01058        state-&gt;changed = 1;
<a name="l01059"></a>01059        stats-&gt;<a class="code" href="structgerbv__stats__t.html#e237cc36435ea2b6606ce8a3c2c4165a">D3</a>++;
<a name="l01060"></a>01060        <span class="keywordflow">break</span>;
<a name="l01061"></a>01061     <span class="keywordflow">default</span>: <span class="comment">/* Aperture in use */</span>
<a name="l01062"></a>01062        <span class="keywordflow">if</span> ((a &gt;= APERTURE_MIN) &amp;&amp; (a &lt;= APERTURE_MAX)) {
<a name="l01063"></a>01063            state-&gt;curr_aperture = a;
<a name="l01064"></a>01064            
<a name="l01065"></a>01065        } <span class="keywordflow">else</span> {
<a name="l01066"></a>01066            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Found out of bounds aperture D%d in file \n%s\n"</span>, 
<a name="l01067"></a>01067                                  a, fd-&gt;filename);
<a name="l01068"></a>01068            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01069"></a>01069                               -1,
<a name="l01070"></a>01070                               <span class="keywordtype">string</span>,
<a name="l01071"></a>01071                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01072"></a>01072            g_free(<span class="keywordtype">string</span>);
<a name="l01073"></a>01073            stats-&gt;<a class="code" href="structgerbv__stats__t.html#55e13bae20c8e1e25856da76a254dd9a">D_error</a>++;
<a name="l01074"></a>01074        }
<a name="l01075"></a>01075        state-&gt;changed = 0;
<a name="l01076"></a>01076        <span class="keywordflow">break</span>;
<a name="l01077"></a>01077     }
<a name="l01078"></a>01078     
<a name="l01079"></a>01079     <span class="keywordflow">return</span>;
<a name="l01080"></a>01080 } <span class="comment">/* parse_D_code */</span>
<a name="l01081"></a>01081 
<a name="l01082"></a>01082 
<a name="l01083"></a>01083 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l01084"></a>01084 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01085"></a>01085 parse_M_code(gerb_file_t *fd, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image)
<a name="l01086"></a>01086 {
<a name="l01087"></a>01087     <span class="keywordtype">int</span> op_int;
<a name="l01088"></a>01088     <a class="code" href="structgerbv__stats__t.html">gerbv_stats_t</a> *stats = image-&gt;<a class="code" href="structgerbv__image__t.html#0d803a4e74d2247e3029b21eda386558">gerbv_stats</a>;
<a name="l01089"></a>01089     gchar *string;
<a name="l01090"></a>01090     
<a name="l01091"></a>01091     op_int=gerb_fgetint(fd, NULL);
<a name="l01092"></a>01092     
<a name="l01093"></a>01093     <span class="keywordflow">switch</span> (op_int) {
<a name="l01094"></a>01094     <span class="keywordflow">case</span> 0:  <span class="comment">/* Program stop */</span>
<a name="l01095"></a>01095        stats-&gt;<a class="code" href="structgerbv__stats__t.html#892f665ca815eb68e06a545a5f5dcab1">M0</a>++;
<a name="l01096"></a>01096        <span class="keywordflow">return</span> 1;
<a name="l01097"></a>01097     <span class="keywordflow">case</span> 1:  <span class="comment">/* Optional stop */</span>
<a name="l01098"></a>01098        stats-&gt;<a class="code" href="structgerbv__stats__t.html#3a65b98ad8962039eb8b105185f56e06">M1</a>++;
<a name="l01099"></a>01099        <span class="keywordflow">return</span> 2;
<a name="l01100"></a>01100     <span class="keywordflow">case</span> 2:  <span class="comment">/* End of program */</span>
<a name="l01101"></a>01101        stats-&gt;<a class="code" href="structgerbv__stats__t.html#22c9557f482e15fdae13b31bf2365bc8">M2</a>++;
<a name="l01102"></a>01102        <span class="keywordflow">return</span> 3;
<a name="l01103"></a>01103     <span class="keywordflow">default</span>:
<a name="l01104"></a>01104        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Encountered unknown M code M%d in file \n%s\n"</span>, 
<a name="l01105"></a>01105                              op_int, fd-&gt;filename);
<a name="l01106"></a>01106        gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01107"></a>01107                            -1,
<a name="l01108"></a>01108                            <span class="keywordtype">string</span>, 
<a name="l01109"></a>01109                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01110"></a>01110        g_free(<span class="keywordtype">string</span>);
<a name="l01111"></a>01111        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Ignorning unknown M code M%d\n"</span>, op_int);
<a name="l01112"></a>01112        gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01113"></a>01113                            -1,
<a name="l01114"></a>01114                            <span class="keywordtype">string</span>, 
<a name="l01115"></a>01115                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l01116"></a>01116        g_free(<span class="keywordtype">string</span>);
<a name="l01117"></a>01117        stats-&gt;<a class="code" href="structgerbv__stats__t.html#24af01afcc2942563feba4b9a2542246">M_unknown</a>++;
<a name="l01118"></a>01118     }
<a name="l01119"></a>01119     <span class="keywordflow">return</span> 0;
<a name="l01120"></a>01120 } <span class="comment">/* parse_M_code */</span>
<a name="l01121"></a>01121 
<a name="l01122"></a>01122 
<a name="l01123"></a>01123 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l01124"></a>01124 <span class="keyword">static</span> <span class="keywordtype">void</span> 
<a name="l01125"></a>01125 parse_rs274x(gint levelOfRecursion, gerb_file_t *fd, <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image, 
<a name="l01126"></a>01126             gerb_state_t *state, <a class="code" href="structgerbv__net.html">gerbv_net_t</a> *curr_net, <a class="code" href="structgerbv__stats__t.html">gerbv_stats_t</a> *stats, 
<a name="l01127"></a>01127             gchar *directoryPath)
<a name="l01128"></a>01128 {
<a name="l01129"></a>01129     <span class="keywordtype">int</span> op[2];
<a name="l01130"></a>01130     <span class="keywordtype">char</span> str[3];
<a name="l01131"></a>01131     <span class="keywordtype">int</span> tmp;
<a name="l01132"></a>01132     gerbv_aperture_t *a = NULL;
<a name="l01133"></a>01133     gerbv_amacro_t *tmp_amacro;
<a name="l01134"></a>01134     <span class="keywordtype">int</span> ano;
<a name="l01135"></a>01135     gdouble scale = 1.0;
<a name="l01136"></a>01136     gchar *string;
<a name="l01137"></a>01137     
<a name="l01138"></a>01138     <span class="keywordflow">if</span> (state-&gt;state-&gt;unit == <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>)
<a name="l01139"></a>01139        scale = 25.4;
<a name="l01140"></a>01140     
<a name="l01141"></a>01141     op[0] = gerb_fgetc(fd);
<a name="l01142"></a>01142     op[1] = gerb_fgetc(fd);
<a name="l01143"></a>01143     
<a name="l01144"></a>01144     <span class="keywordflow">if</span> ((op[0] == EOF) || (op[1] == EOF)) {
<a name="l01145"></a>01145        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Unexpected EOF found in file \n%s\n"</span>, fd-&gt;filename);
<a name="l01146"></a>01146        gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01147"></a>01147                            -1,
<a name="l01148"></a>01148                            <span class="keywordtype">string</span>, 
<a name="l01149"></a>01149                            <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01150"></a>01150        g_free(<span class="keywordtype">string</span>);
<a name="l01151"></a>01151     }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153     <span class="keywordflow">switch</span> (A2I(op[0], op[1])){
<a name="l01154"></a>01154        
<a name="l01155"></a>01155        <span class="comment">/* </span>
<a name="l01156"></a>01156 <span class="comment">        * Directive parameters </span>
<a name="l01157"></a>01157 <span class="comment">        */</span>
<a name="l01158"></a>01158     <span class="keywordflow">case</span> A2I(<span class="charliteral">'A'</span>,<span class="charliteral">'S'</span>): <span class="comment">/* Axis Select */</span>
<a name="l01159"></a>01159        op[0] = gerb_fgetc(fd);
<a name="l01160"></a>01160        op[1] = gerb_fgetc(fd);
<a name="l01161"></a>01161        state-&gt;state = gerbv_image_return_new_netstate (state-&gt;state);
<a name="l01162"></a>01162        
<a name="l01163"></a>01163        <span class="keywordflow">if</span> ((op[0] == EOF) || (op[1] == EOF)) {
<a name="l01164"></a>01164            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Unexpected EOF found in file \n%s\n"</span>, fd-&gt;filename);
<a name="l01165"></a>01165            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01166"></a>01166                               -1,
<a name="l01167"></a>01167                               <span class="keywordtype">string</span>,
<a name="l01168"></a>01168                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01169"></a>01169            g_free(<span class="keywordtype">string</span>);
<a name="l01170"></a>01170        }
<a name="l01171"></a>01171        
<a name="l01172"></a>01172        <span class="keywordflow">if</span> (((op[0] == <span class="charliteral">'A'</span>) &amp;&amp; (op[1] == <span class="charliteral">'Y'</span>)) ||
<a name="l01173"></a>01173            ((op[0] == <span class="charliteral">'B'</span>) &amp;&amp; (op[1] == <span class="charliteral">'X'</span>))) {
<a name="l01174"></a>01174            state-&gt;state-&gt;axisSelect = GERBV_AXIS_SELECT_SWAPAB;
<a name="l01175"></a>01175        } <span class="keywordflow">else</span> {
<a name="l01176"></a>01176            state-&gt;state-&gt;axisSelect = GERBV_AXIS_SELECT_NOSELECT;
<a name="l01177"></a>01177        }
<a name="l01178"></a>01178 
<a name="l01179"></a>01179        op[0] = gerb_fgetc(fd);
<a name="l01180"></a>01180        op[1] = gerb_fgetc(fd);
<a name="l01181"></a>01181        
<a name="l01182"></a>01182        <span class="keywordflow">if</span> ((op[0] == EOF) || (op[1] == EOF)) {
<a name="l01183"></a>01183            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Unexpected EOF found in file \n%s\n"</span>, fd-&gt;filename);
<a name="l01184"></a>01184            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01185"></a>01185                              -1,
<a name="l01186"></a>01186                               <span class="keywordtype">string</span>, 
<a name="l01187"></a>01187                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01188"></a>01188            g_free(<span class="keywordtype">string</span>);
<a name="l01189"></a>01189        }
<a name="l01190"></a>01190 
<a name="l01191"></a>01191        <span class="keywordflow">if</span> (((op[0] == <span class="charliteral">'A'</span>) &amp;&amp; (op[1] == <span class="charliteral">'Y'</span>)) ||
<a name="l01192"></a>01192            ((op[0] == <span class="charliteral">'B'</span>) &amp;&amp; (op[1] == <span class="charliteral">'X'</span>))) {
<a name="l01193"></a>01193            state-&gt;state-&gt;axisSelect = GERBV_AXIS_SELECT_SWAPAB;
<a name="l01194"></a>01194        } <span class="keywordflow">else</span> {
<a name="l01195"></a>01195            state-&gt;state-&gt;axisSelect = GERBV_AXIS_SELECT_NOSELECT;
<a name="l01196"></a>01196        }
<a name="l01197"></a>01197        <span class="keywordflow">break</span>;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <span class="keywordflow">case</span> A2I(<span class="charliteral">'F'</span>,<span class="charliteral">'S'</span>): <span class="comment">/* Format Statement */</span>
<a name="l01200"></a>01200        image-&gt;format = g_new0 (<a class="code" href="structgerbv__format.html">gerbv_format_t</a>,1);
<a name="l01201"></a>01201        
<a name="l01202"></a>01202        <span class="keywordflow">switch</span> (gerb_fgetc(fd)) {
<a name="l01203"></a>01203        <span class="keywordflow">case</span> <span class="charliteral">'L'</span>:
<a name="l01204"></a>01204            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7e564cd07ddda272305088e9e2566b90c">GERBV_OMIT_ZEROS_LEADING</a>;
<a name="l01205"></a>01205            <span class="keywordflow">break</span>;
<a name="l01206"></a>01206        <span class="keywordflow">case</span> <span class="charliteral">'T'</span>:
<a name="l01207"></a>01207            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7085ee95a5b4d68f30e4ab554c9b2e94a">GERBV_OMIT_ZEROS_TRAILING</a>;
<a name="l01208"></a>01208            <span class="keywordflow">break</span>;
<a name="l01209"></a>01209        <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
<a name="l01210"></a>01210            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c781e4581fe43faf90db0f2cecc84361a3">GERBV_OMIT_ZEROS_EXPLICIT</a>;
<a name="l01211"></a>01211            <span class="keywordflow">break</span>;
<a name="l01212"></a>01212        <span class="keywordflow">default</span>:
<a name="l01213"></a>01213            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"EagleCad bug detected: Undefined handling of zeros in format code in file \n%s\n"</span>,
<a name="l01214"></a>01214                                  fd-&gt;filename);
<a name="l01215"></a>01215            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01216"></a>01216                              -1,
<a name="l01217"></a>01217                               <span class="keywordtype">string</span>, 
<a name="l01218"></a>01218                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01219"></a>01219            g_free(<span class="keywordtype">string</span>);
<a name="l01220"></a>01220            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Defaulting to omitting leading zeros.\n"</span>);
<a name="l01221"></a>01221            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01222"></a>01222                               -1,
<a name="l01223"></a>01223                               <span class="keywordtype">string</span>,
<a name="l01224"></a>01224                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l01225"></a>01225            g_free(<span class="keywordtype">string</span>);
<a name="l01226"></a>01226            gerb_ungetc(fd);
<a name="l01227"></a>01227            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#e0db44f83a18a0cdb598487c43fe3aed">omit_zeros</a> = <a class="code" href="gerbv_8h.html#3f01d5a1ac7db9631c7f68cc73a331c7e564cd07ddda272305088e9e2566b90c">GERBV_OMIT_ZEROS_LEADING</a>;
<a name="l01228"></a>01228        }
<a name="l01229"></a>01229        
<a name="l01230"></a>01230        <span class="keywordflow">switch</span> (gerb_fgetc(fd)) {
<a name="l01231"></a>01231        <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
<a name="l01232"></a>01232            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#41e03d02ae44c27cec09e19a7f42e4de">coordinate</a> = <a class="code" href="gerbv_8h.html#68b01b1e7e85c756cec2a18913164288fbb8394e900f1f8d0355dded75324a25">GERBV_COORDINATE_ABSOLUTE</a>;
<a name="l01233"></a>01233            <span class="keywordflow">break</span>;
<a name="l01234"></a>01234        <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
<a name="l01235"></a>01235            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#41e03d02ae44c27cec09e19a7f42e4de">coordinate</a> = <a class="code" href="gerbv_8h.html#68b01b1e7e85c756cec2a18913164288a7acfe8f8e0ed42869b831292df0d096">GERBV_COORDINATE_INCREMENTAL</a>;
<a name="l01236"></a>01236            <span class="keywordflow">break</span>;
<a name="l01237"></a>01237        <span class="keywordflow">default</span>:
<a name="l01238"></a>01238            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Invalid coordinate type defined in format code in file \n%s\n"</span>,
<a name="l01239"></a>01239                                  fd-&gt;filename);
<a name="l01240"></a>01240            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01241"></a>01241                               -1,
<a name="l01242"></a>01242                               <span class="keywordtype">string</span>, 
<a name="l01243"></a>01243                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01244"></a>01244            g_free(<span class="keywordtype">string</span>);
<a name="l01245"></a>01245            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Defaulting to absolute coordinates.\n"</span>);
<a name="l01246"></a>01246            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01247"></a>01247                              -1,
<a name="l01248"></a>01248                               <span class="keywordtype">string</span>,
<a name="l01249"></a>01249                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l01250"></a>01250            g_free(<span class="keywordtype">string</span>);
<a name="l01251"></a>01251            image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#41e03d02ae44c27cec09e19a7f42e4de">coordinate</a> = <a class="code" href="gerbv_8h.html#68b01b1e7e85c756cec2a18913164288fbb8394e900f1f8d0355dded75324a25">GERBV_COORDINATE_ABSOLUTE</a>;
<a name="l01252"></a>01252        }
<a name="l01253"></a>01253        op[0] = gerb_fgetc(fd);
<a name="l01254"></a>01254        <span class="keywordflow">while</span>((op[0] != <span class="charliteral">'*'</span>)&amp;&amp;(op[0] != EOF)) {
<a name="l01255"></a>01255            <span class="keywordflow">switch</span> (op[0]) {
<a name="l01256"></a>01256            <span class="keywordflow">case</span> <span class="charliteral">'N'</span>:
<a name="l01257"></a>01257               op[0] = (char)gerb_fgetc(fd);
<a name="l01258"></a>01258               image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#8ca61e9cba3071a8cd79c3935a172cac">lim_seqno</a> = op[0] - <span class="charliteral">'0'</span>;
<a name="l01259"></a>01259               <span class="keywordflow">break</span>;
<a name="l01260"></a>01260            <span class="keywordflow">case</span> <span class="charliteral">'G'</span>:
<a name="l01261"></a>01261               op[0] = (char)gerb_fgetc(fd);
<a name="l01262"></a>01262               image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#956658835b8c7e8b0a96847ae8dda67d">lim_gf</a> = op[0] - <span class="charliteral">'0'</span>;
<a name="l01263"></a>01263               <span class="keywordflow">break</span>;
<a name="l01264"></a>01264            <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
<a name="l01265"></a>01265               op[0] = (char)gerb_fgetc(fd);
<a name="l01266"></a>01266               image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#376f20e46609add9f0612d46771028cd">lim_pf</a> = op[0] - <span class="charliteral">'0'</span>;
<a name="l01267"></a>01267               <span class="keywordflow">break</span>;
<a name="l01268"></a>01268            <span class="keywordflow">case</span> <span class="charliteral">'M'</span>:
<a name="l01269"></a>01269               op[0] = (char)gerb_fgetc(fd);
<a name="l01270"></a>01270               image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#36585b001c429d2c51bdd69f1e7934fe">lim_mf</a> = op[0] - <span class="charliteral">'0'</span>;
<a name="l01271"></a>01271               <span class="keywordflow">break</span>;
<a name="l01272"></a>01272            <span class="keywordflow">case</span> <span class="charliteral">'X'</span> :
<a name="l01273"></a>01273               op[0] = gerb_fgetc(fd);
<a name="l01274"></a>01274               <span class="keywordflow">if</span> ((op[0] &lt; <span class="charliteral">'0'</span>) || (op[0] &gt; <span class="charliteral">'6'</span>)) {
<a name="l01275"></a>01275                   <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Illegal format size %c in file \n%s\n"</span>, 
<a name="l01276"></a>01276                                         (<span class="keywordtype">char</span>)op[0], fd-&gt;filename);
<a name="l01277"></a>01277                   gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01278"></a>01278                                     -1,
<a name="l01279"></a>01279                                      <span class="keywordtype">string</span>,
<a name="l01280"></a>01280                                      <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01281"></a>01281                   g_free(<span class="keywordtype">string</span>);
<a name="l01282"></a>01282               }
<a name="l01283"></a>01283               image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#7fdb0532c06bf680102fcc0d810cb7bb">x_int</a> = op[0] - <span class="charliteral">'0'</span>;
<a name="l01284"></a>01284               op[0] = gerb_fgetc(fd);
<a name="l01285"></a>01285               <span class="keywordflow">if</span> ((op[0] &lt; <span class="charliteral">'0'</span>) || (op[0] &gt; <span class="charliteral">'6'</span>)) {
<a name="l01286"></a>01286                   <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Illegal format size %c in file \n%s\n"</span>, 
<a name="l01287"></a>01287                                         (<span class="keywordtype">char</span>)op[0], fd-&gt;filename);
<a name="l01288"></a>01288                   gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01289"></a>01289                                      -1,
<a name="l01290"></a>01290                                      <span class="keywordtype">string</span>, 
<a name="l01291"></a>01291                                      <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01292"></a>01292                   g_free(<span class="keywordtype">string</span>);
<a name="l01293"></a>01293               }
<a name="l01294"></a>01294               image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#b6913f904b190541f1311c2aba6cc126">x_dec</a> = op[0] - <span class="charliteral">'0'</span>;
<a name="l01295"></a>01295               <span class="keywordflow">break</span>;
<a name="l01296"></a>01296            <span class="keywordflow">case</span> <span class="charliteral">'Y'</span>:
<a name="l01297"></a>01297               op[0] = gerb_fgetc(fd);
<a name="l01298"></a>01298               <span class="keywordflow">if</span> ((op[0] &lt; <span class="charliteral">'0'</span>) || (op[0] &gt; <span class="charliteral">'6'</span>)) {
<a name="l01299"></a>01299                   <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Illegal format size %c in file \n%s\n"</span>, 
<a name="l01300"></a>01300                                         (<span class="keywordtype">char</span>)op[0], fd-&gt;filename);
<a name="l01301"></a>01301                   gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01302"></a>01302                                     -1,
<a name="l01303"></a>01303                                      <span class="keywordtype">string</span>, 
<a name="l01304"></a>01304                                     <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01305"></a>01305                   g_free(<span class="keywordtype">string</span>);
<a name="l01306"></a>01306               }
<a name="l01307"></a>01307               image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#2cd781f2d92c62f5777aae89a5417f56">y_int</a> = op[0] - <span class="charliteral">'0'</span>;
<a name="l01308"></a>01308               op[0] = gerb_fgetc(fd);
<a name="l01309"></a>01309               <span class="keywordflow">if</span> ((op[0] &lt; <span class="charliteral">'0'</span>) || (op[0] &gt; <span class="charliteral">'6'</span>)) {
<a name="l01310"></a>01310                   <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Illegal format size %c in file \n%s\n"</span>, 
<a name="l01311"></a>01311                                         (<span class="keywordtype">char</span>)op[0], fd-&gt;filename);
<a name="l01312"></a>01312                   gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01313"></a>01313                                     -1,
<a name="l01314"></a>01314                                      <span class="keywordtype">string</span>, 
<a name="l01315"></a>01315                                      <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01316"></a>01316                   g_free(<span class="keywordtype">string</span>);
<a name="l01317"></a>01317               }
<a name="l01318"></a>01318               image-&gt;<a class="code" href="structgerbv__image__t.html#0ef2e49f47737335a3389c67aca015e7">format</a>-&gt;<a class="code" href="structgerbv__format.html#515caa5e3104bd023ada920c6782c08c">y_dec</a> = op[0] - <span class="charliteral">'0'</span>;
<a name="l01319"></a>01319               <span class="keywordflow">break</span>;
<a name="l01320"></a>01320            <span class="keywordflow">default</span> :
<a name="l01321"></a>01321               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Illegal format statement [%c] in file \n%s\n"</span>, 
<a name="l01322"></a>01322                                     op[0], fd-&gt;filename);
<a name="l01323"></a>01323               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01324"></a>01324                                  -1,
<a name="l01325"></a>01325                                   <span class="keywordtype">string</span>, 
<a name="l01326"></a>01326                                  <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01327"></a>01327               g_free(<span class="keywordtype">string</span>);
<a name="l01328"></a>01328               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Ignoring invalid format statement.\n"</span>);
<a name="l01329"></a>01329               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01330"></a>01330                                  -1,
<a name="l01331"></a>01331                                   <span class="keywordtype">string</span>, 
<a name="l01332"></a>01332                                  <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l01333"></a>01333               g_free(<span class="keywordtype">string</span>);
<a name="l01334"></a>01334            }
<a name="l01335"></a>01335            op[0] = gerb_fgetc(fd);
<a name="l01336"></a>01336        }
<a name="l01337"></a>01337        <span class="keywordflow">break</span>;
<a name="l01338"></a>01338     <span class="keywordflow">case</span> A2I(<span class="charliteral">'M'</span>,<span class="charliteral">'I'</span>): <span class="comment">/* Mirror Image */</span>
<a name="l01339"></a>01339        op[0] = gerb_fgetc(fd);
<a name="l01340"></a>01340        state-&gt;state = gerbv_image_return_new_netstate (state-&gt;state);
<a name="l01341"></a>01341        
<a name="l01342"></a>01342        <span class="keywordflow">while</span> ((op[0] != <span class="charliteral">'*'</span>)&amp;&amp;(op[0] != EOF)) {
<a name="l01343"></a>01343             gint readValue=0;
<a name="l01344"></a>01344            <span class="keywordflow">switch</span> (op[0]) {
<a name="l01345"></a>01345            <span class="keywordflow">case</span> <span class="charliteral">'A'</span> :
<a name="l01346"></a>01346               readValue = gerb_fgetint(fd, NULL);
<a name="l01347"></a>01347               <span class="keywordflow">if</span> (readValue == 1) {
<a name="l01348"></a>01348                   <span class="keywordflow">if</span> (state-&gt;state-&gt;mirrorState == GERBV_MIRROR_STATE_FLIPB)
<a name="l01349"></a>01349                      state-&gt;state-&gt;mirrorState=GERBV_MIRROR_STATE_FLIPAB;
<a name="l01350"></a>01350                   <span class="keywordflow">else</span>
<a name="l01351"></a>01351                      state-&gt;state-&gt;mirrorState=GERBV_MIRROR_STATE_FLIPA;
<a name="l01352"></a>01352               }
<a name="l01353"></a>01353               <span class="keywordflow">break</span>;
<a name="l01354"></a>01354            <span class="keywordflow">case</span> <span class="charliteral">'B'</span> :
<a name="l01355"></a>01355               readValue = gerb_fgetint(fd, NULL);
<a name="l01356"></a>01356               <span class="keywordflow">if</span> (readValue == 1) {
<a name="l01357"></a>01357                   <span class="keywordflow">if</span> (state-&gt;state-&gt;mirrorState == GERBV_MIRROR_STATE_FLIPA)
<a name="l01358"></a>01358                      state-&gt;state-&gt;mirrorState=GERBV_MIRROR_STATE_FLIPAB;
<a name="l01359"></a>01359                   <span class="keywordflow">else</span>
<a name="l01360"></a>01360                      state-&gt;state-&gt;mirrorState=GERBV_MIRROR_STATE_FLIPB;
<a name="l01361"></a>01361               }
<a name="l01362"></a>01362               <span class="keywordflow">break</span>;
<a name="l01363"></a>01363            <span class="keywordflow">default</span> :
<a name="l01364"></a>01364               <span class="keywordtype">string</span> =  g_strdup_printf(<span class="stringliteral">"Wrong character in mirror:%c\n"</span>, op[0]);
<a name="l01365"></a>01365               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01366"></a>01366                                  -1,
<a name="l01367"></a>01367                                   <span class="keywordtype">string</span>,
<a name="l01368"></a>01368                                  <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01369"></a>01369               g_free(<span class="keywordtype">string</span>);
<a name="l01370"></a>01370            }
<a name="l01371"></a>01371            op[0] = gerb_fgetc(fd);
<a name="l01372"></a>01372        }
<a name="l01373"></a>01373        <span class="keywordflow">break</span>;  
<a name="l01374"></a>01374     <span class="keywordflow">case</span> A2I(<span class="charliteral">'M'</span>,<span class="charliteral">'O'</span>): <span class="comment">/* Mode of Units */</span>
<a name="l01375"></a>01375        op[0] = gerb_fgetc(fd);
<a name="l01376"></a>01376        op[1] = gerb_fgetc(fd);
<a name="l01377"></a>01377        
<a name="l01378"></a>01378        <span class="keywordflow">if</span> ((op[0] == EOF) || (op[1] == EOF))
<a name="l01379"></a>01379            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01380"></a>01380                              -1,
<a name="l01381"></a>01381                              <span class="stringliteral">"Unexpected EOF found.\n"</span>,
<a name="l01382"></a>01382                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01383"></a>01383        <span class="keywordflow">switch</span> (A2I(op[0],op[1])) {
<a name="l01384"></a>01384        <span class="keywordflow">case</span> A2I(<span class="charliteral">'I'</span>,<span class="charliteral">'N'</span>):
<a name="l01385"></a>01385            state-&gt;state = gerbv_image_return_new_netstate (state-&gt;state);
<a name="l01386"></a>01386            state-&gt;state-&gt;<a class="code" href="structgerbv__netstate__t.html#ec5f911e09684330a9cacefa7ff5956f">unit</a> = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce46256f1b4adec6e863e6373f80963126">GERBV_UNIT_INCH</a>;
<a name="l01387"></a>01387            <span class="keywordflow">break</span>;
<a name="l01388"></a>01388        <span class="keywordflow">case</span> A2I(<span class="charliteral">'M'</span>,<span class="charliteral">'M'</span>):
<a name="l01389"></a>01389            state-&gt;state = gerbv_image_return_new_netstate (state-&gt;state);
<a name="l01390"></a>01390            state-&gt;state-&gt;<a class="code" href="structgerbv__netstate__t.html#ec5f911e09684330a9cacefa7ff5956f">unit</a> = <a class="code" href="gerbv_8h.html#e090f4520c786e220d200b3ed4792dce4691658ea83e08e074367279d3e40b16">GERBV_UNIT_MM</a>;
<a name="l01391"></a>01391            <span class="keywordflow">break</span>;
<a name="l01392"></a>01392        <span class="keywordflow">default</span>:
<a name="l01393"></a>01393            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Illegal unit:%c%c\n"</span>, op[0], op[1]);
<a name="l01394"></a>01394            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01395"></a>01395                              -1,
<a name="l01396"></a>01396                               <span class="keywordtype">string</span>, 
<a name="l01397"></a>01397                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01398"></a>01398            g_free(<span class="keywordtype">string</span>);
<a name="l01399"></a>01399        }
<a name="l01400"></a>01400        <span class="keywordflow">break</span>;
<a name="l01401"></a>01401     <span class="keywordflow">case</span> A2I(<span class="charliteral">'O'</span>,<span class="charliteral">'F'</span>): <span class="comment">/* Offset */</span>
<a name="l01402"></a>01402        op[0] = gerb_fgetc(fd);
<a name="l01403"></a>01403        
<a name="l01404"></a>01404        <span class="keywordflow">while</span> ((op[0] != <span class="charliteral">'*'</span>)&amp;&amp;(op[0] != EOF)) {
<a name="l01405"></a>01405            <span class="keywordflow">switch</span> (op[0]) {
<a name="l01406"></a>01406            <span class="keywordflow">case</span> <span class="charliteral">'A'</span> :
<a name="l01407"></a>01407               state-&gt;state-&gt;offsetA = gerb_fgetdouble(fd) / scale;
<a name="l01408"></a>01408               <span class="keywordflow">break</span>;
<a name="l01409"></a>01409            <span class="keywordflow">case</span> <span class="charliteral">'B'</span> :
<a name="l01410"></a>01410               state-&gt;state-&gt;offsetB = gerb_fgetdouble(fd) / scale;
<a name="l01411"></a>01411               <span class="keywordflow">break</span>;
<a name="l01412"></a>01412            <span class="keywordflow">default</span> :
<a name="l01413"></a>01413               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Wrong character in offset:%c\n"</span>, op[0]);
<a name="l01414"></a>01414               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01415"></a>01415                                   -1,
<a name="l01416"></a>01416                                   <span class="keywordtype">string</span>, 
<a name="l01417"></a>01417                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01418"></a>01418               g_free(<span class="keywordtype">string</span>);
<a name="l01419"></a>01419            }
<a name="l01420"></a>01420            op[0] = gerb_fgetc(fd);
<a name="l01421"></a>01421        }
<a name="l01422"></a>01422        <span class="keywordflow">break</span>;
<a name="l01423"></a>01423     <span class="keywordflow">case</span> A2I(<span class="charliteral">'I'</span>,<span class="charliteral">'F'</span>): <span class="comment">/* Include file */</span>
<a name="l01424"></a>01424        {
<a name="l01425"></a>01425            gchar *includeFilename = gerb_fgetstring(fd, <span class="charliteral">'*'</span>);
<a name="l01426"></a>01426            
<a name="l01427"></a>01427            <span class="keywordflow">if</span> (includeFilename) {
<a name="l01428"></a>01428               gchar *fullPath;
<a name="l01429"></a>01429               <span class="keywordflow">if</span> (!g_path_is_absolute(includeFilename)) {
<a name="l01430"></a>01430                   fullPath = g_build_filename (directoryPath, includeFilename, NULL);
<a name="l01431"></a>01431               } <span class="keywordflow">else</span> {
<a name="l01432"></a>01432                   fullPath = g_strdup (includeFilename);
<a name="l01433"></a>01433               }
<a name="l01434"></a>01434               <span class="keywordflow">if</span> (levelOfRecursion &lt; 10) {
<a name="l01435"></a>01435                   gerb_file_t *includefd = NULL;
<a name="l01436"></a>01436                   
<a name="l01437"></a>01437                   includefd = gerb_fopen(fullPath);
<a name="l01438"></a>01438                   <span class="keywordflow">if</span> (includefd) {
<a name="l01439"></a>01439                      <a class="code" href="gerber_8c.html#e50502bd658a484dcd07c4360bafe435">gerber_parse_file_segment</a> (levelOfRecursion + 1, image, state, curr_net, stats, includefd, directoryPath);
<a name="l01440"></a>01440                      gerb_fclose(includefd);
<a name="l01441"></a>01441                   } <span class="keywordflow">else</span> {
<a name="l01442"></a>01442                      <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nIncluded file %s cannot be found\n"</span>,
<a name="l01443"></a>01443                                            fd-&gt;filename, fullPath);
<a name="l01444"></a>01444                      gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>, 
<a name="l01445"></a>01445                                          -1,
<a name="l01446"></a>01446                                          <span class="keywordtype">string</span>, 
<a name="l01447"></a>01447                                          <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01448"></a>01448                      g_free(<span class="keywordtype">string</span>);
<a name="l01449"></a>01449                   }
<a name="l01450"></a>01450                   g_free (fullPath);
<a name="l01451"></a>01451               } <span class="keywordflow">else</span> {
<a name="l01452"></a>01452                   <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Parser encountered more than 10 levels of include file recursion which is not allowed by the RS-274X spec\n"</span>);
<a name="l01453"></a>01453                   gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>, 
<a name="l01454"></a>01454                                      -1,
<a name="l01455"></a>01455                                      <span class="keywordtype">string</span>, 
<a name="l01456"></a>01456                                      <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01457"></a>01457                   g_free(<span class="keywordtype">string</span>);
<a name="l01458"></a>01458               }
<a name="l01459"></a>01459               
<a name="l01460"></a>01460            }
<a name="l01461"></a>01461        }
<a name="l01462"></a>01462        <span class="keywordflow">break</span>;
<a name="l01463"></a>01463     <span class="keywordflow">case</span> A2I(<span class="charliteral">'I'</span>,<span class="charliteral">'O'</span>): <span class="comment">/* Image offset */</span>
<a name="l01464"></a>01464        op[0] = gerb_fgetc(fd);
<a name="l01465"></a>01465        
<a name="l01466"></a>01466        <span class="keywordflow">while</span> ((op[0] != <span class="charliteral">'*'</span>)&amp;&amp;(op[0] != EOF)) {
<a name="l01467"></a>01467            <span class="keywordflow">switch</span> (op[0]) {
<a name="l01468"></a>01468            <span class="keywordflow">case</span> <span class="charliteral">'A'</span> :
<a name="l01469"></a>01469               image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#3f145d47793e723d09e5a75758b25295">offsetA</a> = gerb_fgetdouble(fd) / scale;
<a name="l01470"></a>01470               <span class="keywordflow">break</span>;
<a name="l01471"></a>01471            <span class="keywordflow">case</span> <span class="charliteral">'B'</span> :
<a name="l01472"></a>01472               image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#db9f3d343e14f84e23181b17c0bf3a73">offsetB</a> = gerb_fgetdouble(fd) / scale;
<a name="l01473"></a>01473               <span class="keywordflow">break</span>;
<a name="l01474"></a>01474            <span class="keywordflow">default</span> :
<a name="l01475"></a>01475               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nwrong character in image offset %c\n"</span>, 
<a name="l01476"></a>01476                                     fd-&gt;filename, op[0]);
<a name="l01477"></a>01477               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01478"></a>01478                                  -1,
<a name="l01479"></a>01479                                   <span class="keywordtype">string</span>,
<a name="l01480"></a>01480                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01481"></a>01481               g_free(<span class="keywordtype">string</span>);
<a name="l01482"></a>01482            }
<a name="l01483"></a>01483            op[0] = gerb_fgetc(fd);
<a name="l01484"></a>01484        }
<a name="l01485"></a>01485        <span class="keywordflow">break</span>;
<a name="l01486"></a>01486     <span class="keywordflow">case</span> A2I(<span class="charliteral">'S'</span>,<span class="charliteral">'F'</span>): <span class="comment">/* Scale Factor */</span>
<a name="l01487"></a>01487        if (gerb_fgetc(fd) == <span class="stringliteral">'A'</span>)
<a name="l01488"></a>01488            state-&gt;state-&gt;scaleA = gerb_fgetdouble(fd);
<a name="l01489"></a>01489        <span class="keywordflow">else</span> 
<a name="l01490"></a>01490            gerb_ungetc(fd);
<a name="l01491"></a>01491        <span class="keywordflow">if</span> (gerb_fgetc(fd) == <span class="charliteral">'B'</span>)
<a name="l01492"></a>01492            state-&gt;state-&gt;scaleB = gerb_fgetdouble(fd);
<a name="l01493"></a>01493        <span class="keywordflow">else</span> 
<a name="l01494"></a>01494            gerb_ungetc(fd);
<a name="l01495"></a>01495        <span class="keywordflow">break</span>;
<a name="l01496"></a>01496     <span class="keywordflow">case</span> A2I(<span class="charliteral">'I'</span>,<span class="charliteral">'C'</span>): <span class="comment">/* Input Code */</span>
<a name="l01497"></a>01497        <span class="comment">/* Thanks to Stephen Adam for providing this information. As he writes:</span>
<a name="l01498"></a>01498 <span class="comment">        *      btw, here's a logic puzzle for you.  If you need to</span>
<a name="l01499"></a>01499 <span class="comment">        * read the gerber file to see how it's encoded, then</span>
<a name="l01500"></a>01500 <span class="comment">        * how can you read it?</span>
<a name="l01501"></a>01501 <span class="comment">        */</span>
<a name="l01502"></a>01502        op[0] = gerb_fgetc(fd);
<a name="l01503"></a>01503        op[1] = gerb_fgetc(fd);
<a name="l01504"></a>01504        
<a name="l01505"></a>01505        <span class="keywordflow">if</span> ((op[0] == EOF) || (op[1] == EOF)) {
<a name="l01506"></a>01506            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Unexpected EOF found in file \n%s\n"</span>, fd-&gt;filename);
<a name="l01507"></a>01507            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01508"></a>01508                              -1,
<a name="l01509"></a>01509                               <span class="keywordtype">string</span>,
<a name="l01510"></a>01510                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01511"></a>01511            g_free(<span class="keywordtype">string</span>);
<a name="l01512"></a>01512        }
<a name="l01513"></a>01513        <span class="keywordflow">switch</span> (A2I(op[0],op[1])) {
<a name="l01514"></a>01514        <span class="keywordflow">case</span> A2I(<span class="charliteral">'A'</span>,<span class="charliteral">'S'</span>):
<a name="l01515"></a>01515            image-&gt;info-&gt;encoding = GERBV_ENCODING_ASCII;
<a name="l01516"></a>01516            <span class="keywordflow">break</span>;
<a name="l01517"></a>01517        <span class="keywordflow">case</span> A2I(<span class="charliteral">'E'</span>,<span class="charliteral">'B'</span>):
<a name="l01518"></a>01518            image-&gt;info-&gt;encoding = GERBV_ENCODING_EBCDIC;
<a name="l01519"></a>01519            <span class="keywordflow">break</span>;
<a name="l01520"></a>01520        <span class="keywordflow">case</span> A2I(<span class="charliteral">'B'</span>,<span class="charliteral">'C'</span>):
<a name="l01521"></a>01521            image-&gt;info-&gt;encoding = GERBV_ENCODING_BCD;
<a name="l01522"></a>01522            <span class="keywordflow">break</span>;
<a name="l01523"></a>01523        <span class="keywordflow">case</span> A2I(<span class="charliteral">'I'</span>,<span class="charliteral">'S'</span>):
<a name="l01524"></a>01524            image-&gt;info-&gt;encoding = GERBV_ENCODING_ISO_ASCII;
<a name="l01525"></a>01525            <span class="keywordflow">break</span>;
<a name="l01526"></a>01526        <span class="keywordflow">case</span> A2I(<span class="charliteral">'E'</span>,<span class="charliteral">'I'</span>):
<a name="l01527"></a>01527            image-&gt;info-&gt;encoding = GERBV_ENCODING_EIA;
<a name="l01528"></a>01528            <span class="keywordflow">break</span>;
<a name="l01529"></a>01529        <span class="keywordflow">default</span>:
<a name="l01530"></a>01530            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s, \nunknown input code (IC): %c%c\n"</span>, 
<a name="l01531"></a>01531                                  fd-&gt;filename, op[0], op[1]);
<a name="l01532"></a>01532            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01533"></a>01533                              -1,
<a name="l01534"></a>01534                               <span class="keywordtype">string</span>,
<a name="l01535"></a>01535                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01536"></a>01536            g_free(<span class="keywordtype">string</span>);
<a name="l01537"></a>01537        }
<a name="l01538"></a>01538        <span class="keywordflow">break</span>;
<a name="l01539"></a>01539        
<a name="l01540"></a>01540        <span class="comment">/* Image parameters */</span>
<a name="l01541"></a>01541     <span class="keywordflow">case</span> A2I(<span class="charliteral">'I'</span>,<span class="charliteral">'J'</span>): <span class="comment">/* Image Justify */</span>
<a name="l01542"></a>01542        op[0] = gerb_fgetc(fd);
<a name="l01543"></a>01543        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#50bcbb6c1aa5d238dd9b8a5084ad8e66">imageJustifyTypeA</a> = GERBV_JUSTIFY_LOWERLEFT;
<a name="l01544"></a>01544        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#fd754e52ac7c4b3447b95c25bd488ef1">imageJustifyTypeB</a> = GERBV_JUSTIFY_LOWERLEFT;
<a name="l01545"></a>01545        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#678ef7ef39870fbf61a1d1f2e2d685d6">imageJustifyOffsetA</a> = 0.0;
<a name="l01546"></a>01546        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#c2188f9f81755e4147be0d43a7f70b7c">imageJustifyOffsetB</a> = 0.0;
<a name="l01547"></a>01547        <span class="keywordflow">while</span> ((op[0] != <span class="charliteral">'*'</span>)&amp;&amp;(op[0] != EOF)) {
<a name="l01548"></a>01548            <span class="keywordflow">switch</span> (op[0]) {
<a name="l01549"></a>01549            <span class="keywordflow">case</span> <span class="charliteral">'A'</span> :
<a name="l01550"></a>01550               op[0] = gerb_fgetc(fd);
<a name="l01551"></a>01551               <span class="keywordflow">if</span> (op[0] == <span class="charliteral">'C'</span>) {
<a name="l01552"></a>01552                   image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#50bcbb6c1aa5d238dd9b8a5084ad8e66">imageJustifyTypeA</a> = GERBV_JUSTIFY_CENTERJUSTIFY;
<a name="l01553"></a>01553               } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (op[0] == <span class="charliteral">'L'</span>) {
<a name="l01554"></a>01554                   image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#50bcbb6c1aa5d238dd9b8a5084ad8e66">imageJustifyTypeA</a> = GERBV_JUSTIFY_LOWERLEFT;
<a name="l01555"></a>01555               } <span class="keywordflow">else</span> {
<a name="l01556"></a>01556                   gerb_ungetc (fd);
<a name="l01557"></a>01557                   image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#678ef7ef39870fbf61a1d1f2e2d685d6">imageJustifyOffsetA</a> = gerb_fgetdouble(fd) / scale;
<a name="l01558"></a>01558               }
<a name="l01559"></a>01559               <span class="keywordflow">break</span>;
<a name="l01560"></a>01560            <span class="keywordflow">case</span> <span class="charliteral">'B'</span> :
<a name="l01561"></a>01561               op[0] = gerb_fgetc(fd);
<a name="l01562"></a>01562               <span class="keywordflow">if</span> (op[0] == <span class="charliteral">'C'</span>) {
<a name="l01563"></a>01563                   image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#fd754e52ac7c4b3447b95c25bd488ef1">imageJustifyTypeB</a> = GERBV_JUSTIFY_CENTERJUSTIFY;
<a name="l01564"></a>01564               } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (op[0] == <span class="charliteral">'L'</span>) {
<a name="l01565"></a>01565                   image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#fd754e52ac7c4b3447b95c25bd488ef1">imageJustifyTypeB</a> = GERBV_JUSTIFY_LOWERLEFT;
<a name="l01566"></a>01566               } <span class="keywordflow">else</span> {
<a name="l01567"></a>01567                   gerb_ungetc (fd);
<a name="l01568"></a>01568                   image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#c2188f9f81755e4147be0d43a7f70b7c">imageJustifyOffsetB</a> = gerb_fgetdouble(fd) / scale;
<a name="l01569"></a>01569               }
<a name="l01570"></a>01570               <span class="keywordflow">break</span>;
<a name="l01571"></a>01571            <span class="keywordflow">default</span> :
<a name="l01572"></a>01572               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nwrong character in image justify:%c\n"</span>, 
<a name="l01573"></a>01573                                     fd-&gt;filename, op[0]);
<a name="l01574"></a>01574               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01575"></a>01575                                  -1,
<a name="l01576"></a>01576                                   <span class="keywordtype">string</span>,
<a name="l01577"></a>01577                                  <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01578"></a>01578               g_free(<span class="keywordtype">string</span>);
<a name="l01579"></a>01579            }
<a name="l01580"></a>01580            op[0] = gerb_fgetc(fd);
<a name="l01581"></a>01581        }
<a name="l01582"></a>01582        <span class="keywordflow">break</span>;
<a name="l01583"></a>01583     <span class="keywordflow">case</span> A2I(<span class="charliteral">'I'</span>,<span class="charliteral">'N'</span>): <span class="comment">/* Image Name */</span>
<a name="l01584"></a>01584        image-&gt;info-&gt;name = gerb_fgetstring(fd, <span class="stringliteral">'*'</span>);
<a name="l01585"></a>01585        <span class="keywordflow">break</span>;
<a name="l01586"></a>01586     <span class="keywordflow">case</span> A2I(<span class="charliteral">'I'</span>,<span class="charliteral">'P'</span>): <span class="comment">/* Image Polarity */</span>
<a name="l01587"></a>01587        
<a name="l01588"></a>01588        for (ano = 0; ano &lt; 3; ano++) {
<a name="l01589"></a>01589            op[0] = gerb_fgetc(fd);
<a name="l01590"></a>01590            <span class="keywordflow">if</span> (op[0] == EOF) {
<a name="l01591"></a>01591               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nunexpected EOF while reading image polarity (IP)\n"</span>,
<a name="l01592"></a>01592                                     fd-&gt;filename);
<a name="l01593"></a>01593               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01594"></a>01594                                  -1,
<a name="l01595"></a>01595                                   <span class="keywordtype">string</span>,
<a name="l01596"></a>01596                                  <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01597"></a>01597               g_free(<span class="keywordtype">string</span>);
<a name="l01598"></a>01598            }
<a name="l01599"></a>01599            str[ano] = (char)op[0];
<a name="l01600"></a>01600        }
<a name="l01601"></a>01601        
<a name="l01602"></a>01602        <span class="keywordflow">if</span> (strncmp(str, <span class="stringliteral">"POS"</span>, 3) == 0) 
<a name="l01603"></a>01603            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#18c534ca1aec8e2cb2c8dd0faef4d3f1">polarity</a> = <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f4658e6f0ae27a8b633eb76a92830b62703b">GERBV_POLARITY_POSITIVE</a>;
<a name="l01604"></a>01604        <span class="keywordflow">else</span> if (strncmp(str, <span class="stringliteral">"NEG"</span>, 3) == 0)
<a name="l01605"></a>01605            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#18c534ca1aec8e2cb2c8dd0faef4d3f1">polarity</a> = <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f4653f7beb089cc8fa9de323dca063c3e3f3">GERBV_POLARITY_NEGATIVE</a>;
<a name="l01606"></a>01606        <span class="keywordflow">else</span> {
<a name="l01607"></a>01607            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Unknown polarity : %c%c%c\n"</span>, str[0], str[1], str[2]);
<a name="l01608"></a>01608            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01609"></a>01609                              -1,
<a name="l01610"></a>01610                               <span class="keywordtype">string</span>,
<a name="l01611"></a>01611                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01612"></a>01612            g_free(<span class="keywordtype">string</span>);
<a name="l01613"></a>01613        }
<a name="l01614"></a>01614        <span class="keywordflow">break</span>;
<a name="l01615"></a>01615     <span class="keywordflow">case</span> A2I(<span class="charliteral">'I'</span>,<span class="charliteral">'R'</span>): <span class="comment">/* Image Rotation */</span>
<a name="l01616"></a>01616        tmp = gerb_fgetint(fd, NULL);
<a name="l01617"></a>01617        <span class="keywordflow">if</span> (tmp == 90)
<a name="l01618"></a>01618            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#db41e52862ce0d0038506566743ff334">imageRotation</a> = M_PI / 2.0;
<a name="l01619"></a>01619        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp == 180)
<a name="l01620"></a>01620            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#db41e52862ce0d0038506566743ff334">imageRotation</a> = M_PI;
<a name="l01621"></a>01621        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmp == 270)
<a name="l01622"></a>01622            image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#db41e52862ce0d0038506566743ff334">imageRotation</a> = 3.0 * M_PI / 2.0;
<a name="l01623"></a>01623        <span class="keywordflow">else</span> {
<a name="l01624"></a>01624            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Image rotation must be 0, 90, 180 or 270 (is actually %d)\n"</span>, tmp);
<a name="l01625"></a>01625            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01626"></a>01626                              -1,
<a name="l01627"></a>01627                               <span class="keywordtype">string</span>,
<a name="l01628"></a>01628                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01629"></a>01629            g_free(<span class="keywordtype">string</span>);
<a name="l01630"></a>01630        }
<a name="l01631"></a>01631        <span class="keywordflow">break</span>;
<a name="l01632"></a>01632     <span class="keywordflow">case</span> A2I(<span class="charliteral">'P'</span>,<span class="charliteral">'F'</span>): <span class="comment">/* Plotter Film */</span>
<a name="l01633"></a>01633        image-&gt;info-&gt;plotterFilm = gerb_fgetstring(fd, <span class="stringliteral">'*'</span>);
<a name="l01634"></a>01634        <span class="keywordflow">break</span>;
<a name="l01635"></a>01635        
<a name="l01636"></a>01636        <span class="comment">/* Aperture parameters */</span>
<a name="l01637"></a>01637     <span class="keywordflow">case</span> A2I(<span class="charliteral">'A'</span>,<span class="charliteral">'D'</span>): <span class="comment">/* Aperture Description */</span>
<a name="l01638"></a>01638        a = (gerbv_aperture_t *) g_new0 (gerbv_aperture_t,1);
<a name="l01639"></a>01639 
<a name="l01640"></a>01640        ano = parse_aperture_definition(fd, a, image, scale);
<a name="l01641"></a>01641        <span class="keywordflow">if</span> ((ano &gt;= APERTURE_MIN) &amp;&amp; (ano &lt;= APERTURE_MAX)) {
<a name="l01642"></a>01642            a-&gt;unit = state-&gt;state-&gt;unit;
<a name="l01643"></a>01643            image-&gt;<a class="code" href="structgerbv__image__t.html#b40defce85ca280ecf3804fad90fc308">aperture</a>[ano] = a;
<a name="l01644"></a>01644            dprintf(<span class="stringliteral">"     In parse_rs274x, adding new aperture to aperture list ...\n"</span>);
<a name="l01645"></a>01645            gerbv_stats_add_aperture(stats-&gt;<a class="code" href="structgerbv__stats__t.html#69ab56a163b40a24ba13cb66d69490cc">aperture_list</a>,
<a name="l01646"></a>01646                                 -1, ano, 
<a name="l01647"></a>01647                                 a-&gt;type,
<a name="l01648"></a>01648                                 a-&gt;parameter);
<a name="l01649"></a>01649            gerbv_stats_add_to_D_list(stats-&gt;<a class="code" href="structgerbv__stats__t.html#8bdcc430dea32309c7d102e4568862ce">D_code_list</a>,
<a name="l01650"></a>01650                                  ano);
<a name="l01651"></a>01651        } <span class="keywordflow">else</span> {
<a name="l01652"></a>01652            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\naperture number out of bounds : %d\n"</span>, 
<a name="l01653"></a>01653                                  fd-&gt;filename, ano);
<a name="l01654"></a>01654            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01655"></a>01655                              -1,
<a name="l01656"></a>01656                               <span class="keywordtype">string</span>,
<a name="l01657"></a>01657                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01658"></a>01658            g_free(<span class="keywordtype">string</span>);
<a name="l01659"></a>01659        }
<a name="l01660"></a>01660        <span class="comment">/* Add aperture info to stats-&gt;aperture_list here */</span>
<a name="l01661"></a>01661        
<a name="l01662"></a>01662        <span class="keywordflow">break</span>;
<a name="l01663"></a>01663     <span class="keywordflow">case</span> A2I(<span class="charliteral">'A'</span>,<span class="charliteral">'M'</span>): <span class="comment">/* Aperture Macro */</span>
<a name="l01664"></a>01664        tmp_amacro = image-&gt;amacro;
<a name="l01665"></a>01665        image-&gt;<a class="code" href="structgerbv__image__t.html#09fb735cb7cab4951d26104ff1098668">amacro</a> = parse_aperture_macro(fd);
<a name="l01666"></a>01666        <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#09fb735cb7cab4951d26104ff1098668">amacro</a>) {
<a name="l01667"></a>01667            image-&gt;<a class="code" href="structgerbv__image__t.html#09fb735cb7cab4951d26104ff1098668">amacro</a>-&gt;next = tmp_amacro;
<a name="l01668"></a>01668 <span class="preprocessor">#ifdef AMACRO_DEBUG</span>
<a name="l01669"></a>01669 <span class="preprocessor"></span>           print_program(image-&gt;<a class="code" href="structgerbv__image__t.html#09fb735cb7cab4951d26104ff1098668">amacro</a>);
<a name="l01670"></a>01670 <span class="preprocessor">#endif</span>
<a name="l01671"></a>01671 <span class="preprocessor"></span>       } <span class="keywordflow">else</span> {
<a name="l01672"></a>01672            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s, \nfailed to parse aperture macro\n"</span>, 
<a name="l01673"></a>01673                                  fd-&gt;filename);
<a name="l01674"></a>01674            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01675"></a>01675                              -1,
<a name="l01676"></a>01676                               <span class="keywordtype">string</span>,
<a name="l01677"></a>01677                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01678"></a>01678            g_free(<span class="keywordtype">string</span>);
<a name="l01679"></a>01679        }
<a name="l01680"></a>01680        <span class="keywordflow">break</span>;
<a name="l01681"></a>01681        <span class="comment">/* Layer */</span>
<a name="l01682"></a>01682     <span class="keywordflow">case</span> A2I(<span class="charliteral">'L'</span>,<span class="charliteral">'N'</span>): <span class="comment">/* Layer Name */</span>
<a name="l01683"></a>01683        state-&gt;layer = gerbv_image_return_new_layer (state-&gt;layer);
<a name="l01684"></a>01684        state-&gt;layer-&gt;<a class="code" href="structgerbv__layer__t.html#1b7d361006e3e2d1f60e2ec3aeddb73c">name</a> = gerb_fgetstring(fd, <span class="charliteral">'*'</span>);
<a name="l01685"></a>01685        <span class="keywordflow">break</span>;
<a name="l01686"></a>01686     <span class="keywordflow">case</span> A2I(<span class="charliteral">'L'</span>,<span class="charliteral">'P'</span>): <span class="comment">/* Layer Polarity */</span>
<a name="l01687"></a>01687        state-&gt;layer = gerbv_image_return_new_layer (state-&gt;layer);
<a name="l01688"></a>01688        <span class="keywordflow">switch</span> (gerb_fgetc(fd)) {
<a name="l01689"></a>01689        <span class="keywordflow">case</span> <span class="charliteral">'D'</span>: <span class="comment">/* Dark Polarity (default) */</span>
<a name="l01690"></a>01690            state-&gt;layer-&gt;<a class="code" href="structgerbv__layer__t.html#5a34fe35525dd75b47c4c5908daedc9c">polarity</a> = <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f465370c835027dac9365386bde35d500b82">GERBV_POLARITY_DARK</a>;
<a name="l01691"></a>01691            <span class="keywordflow">break</span>;
<a name="l01692"></a>01692        <span class="keywordflow">case</span> <span class="charliteral">'C'</span>: <span class="comment">/* Clear Polarity */</span>
<a name="l01693"></a>01693            state-&gt;layer-&gt;polarity = <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f4651d2d9836da807afaa7c732d93749a478">GERBV_POLARITY_CLEAR</a>;
<a name="l01694"></a>01694            <span class="keywordflow">break</span>;
<a name="l01695"></a>01695        <span class="keywordflow">default</span>:
<a name="l01696"></a>01696            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nunknown Layer Polarity: %c\n"</span>, 
<a name="l01697"></a>01697                                  fd-&gt;filename, op[0]);
<a name="l01698"></a>01698            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01699"></a>01699                              -1,
<a name="l01700"></a>01700                               <span class="keywordtype">string</span>,
<a name="l01701"></a>01701                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01702"></a>01702            g_free(<span class="keywordtype">string</span>);
<a name="l01703"></a>01703        }
<a name="l01704"></a>01704        <span class="keywordflow">break</span>;
<a name="l01705"></a>01705     <span class="keywordflow">case</span> A2I(<span class="charliteral">'K'</span>,<span class="charliteral">'O'</span>): <span class="comment">/* Knock Out */</span>
<a name="l01706"></a>01706         state-&gt;layer = gerbv_image_return_new_layer (state-&gt;layer);
<a name="l01707"></a>01707         gerber_update_any_running_knockout_measurements (image);
<a name="l01708"></a>01708         <span class="comment">/* reset any previous knockout measurements */</span>
<a name="l01709"></a>01709         knockoutMeasure = FALSE;
<a name="l01710"></a>01710         op[0] = gerb_fgetc(fd);
<a name="l01711"></a>01711        <span class="keywordflow">if</span> (op[0] == <span class="charliteral">'*'</span>) { <span class="comment">/* Disable previous SR parameters */</span>
<a name="l01712"></a>01712            state-&gt;layer-&gt;knockout.type = GERBV_KNOCKOUT_TYPE_NOKNOCKOUT;
<a name="l01713"></a>01713            <span class="keywordflow">break</span>;
<a name="l01714"></a>01714        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (op[0] == <span class="charliteral">'C'</span>) {
<a name="l01715"></a>01715            state-&gt;layer-&gt;knockout.polarity = <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f4651d2d9836da807afaa7c732d93749a478">GERBV_POLARITY_CLEAR</a>;
<a name="l01716"></a>01716        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (op[0] == <span class="charliteral">'D'</span>) {
<a name="l01717"></a>01717            state-&gt;layer-&gt;knockout.polarity = <a class="code" href="gerbv_8h.html#42e426131be82b5e215429994035f465370c835027dac9365386bde35d500b82">GERBV_POLARITY_DARK</a>;
<a name="l01718"></a>01718        } <span class="keywordflow">else</span> {
<a name="l01719"></a>01719            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nknockout must supply a polarity (C, D, or *)\n"</span>,
<a name="l01720"></a>01720                                  fd-&gt;filename);
<a name="l01721"></a>01721            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01722"></a>01722                              -1,
<a name="l01723"></a>01723                               <span class="keywordtype">string</span>,
<a name="l01724"></a>01724                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01725"></a>01725            g_free(<span class="keywordtype">string</span>);
<a name="l01726"></a>01726        }
<a name="l01727"></a>01727        state-&gt;layer-&gt;knockout.lowerLeftX = 0.0;
<a name="l01728"></a>01728        state-&gt;layer-&gt;knockout.lowerLeftY = 0.0;
<a name="l01729"></a>01729        state-&gt;layer-&gt;knockout.width = 0.0;
<a name="l01730"></a>01730        state-&gt;layer-&gt;knockout.height = 0.0;
<a name="l01731"></a>01731        state-&gt;layer-&gt;knockout.border = 0.0;
<a name="l01732"></a>01732        state-&gt;layer-&gt;knockout.firstInstance = TRUE;
<a name="l01733"></a>01733        op[0] = gerb_fgetc(fd);
<a name="l01734"></a>01734        <span class="keywordflow">while</span> ((op[0] != <span class="charliteral">'*'</span>)&amp;&amp;(op[0] != EOF)) { 
<a name="l01735"></a>01735            <span class="keywordflow">switch</span> (op[0]) {
<a name="l01736"></a>01736            <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
<a name="l01737"></a>01737                state-&gt;layer-&gt;knockout.type = GERBV_KNOCKOUT_TYPE_FIXEDKNOCK;
<a name="l01738"></a>01738               state-&gt;layer-&gt;knockout.lowerLeftX = gerb_fgetdouble(fd) / scale;
<a name="l01739"></a>01739               <span class="keywordflow">break</span>;
<a name="l01740"></a>01740            <span class="keywordflow">case</span> <span class="charliteral">'Y'</span>:
<a name="l01741"></a>01741                state-&gt;layer-&gt;knockout.type = GERBV_KNOCKOUT_TYPE_FIXEDKNOCK;
<a name="l01742"></a>01742               state-&gt;layer-&gt;knockout.lowerLeftY = gerb_fgetdouble(fd) / scale;
<a name="l01743"></a>01743               <span class="keywordflow">break</span>;
<a name="l01744"></a>01744            <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
<a name="l01745"></a>01745                state-&gt;layer-&gt;knockout.type = GERBV_KNOCKOUT_TYPE_FIXEDKNOCK;
<a name="l01746"></a>01746               state-&gt;layer-&gt;knockout.width = gerb_fgetdouble(fd) / scale;
<a name="l01747"></a>01747               <span class="keywordflow">break</span>;
<a name="l01748"></a>01748            <span class="keywordflow">case</span> <span class="charliteral">'J'</span>:
<a name="l01749"></a>01749                state-&gt;layer-&gt;knockout.type = GERBV_KNOCKOUT_TYPE_FIXEDKNOCK;
<a name="l01750"></a>01750               state-&gt;layer-&gt;knockout.height = gerb_fgetdouble(fd) / scale;
<a name="l01751"></a>01751               <span class="keywordflow">break</span>;
<a name="l01752"></a>01752            <span class="keywordflow">case</span> <span class="charliteral">'K'</span>:
<a name="l01753"></a>01753                state-&gt;layer-&gt;knockout.type = GERBV_KNOCKOUT_TYPE_BORDER;
<a name="l01754"></a>01754                state-&gt;layer-&gt;knockout.border = gerb_fgetdouble(fd) / scale;
<a name="l01755"></a>01755                <span class="comment">/* this is a bordered knockout, so we need to start measuring the</span>
<a name="l01756"></a>01756 <span class="comment">                  size of a square bordering all future components */</span>
<a name="l01757"></a>01757                knockoutMeasure = TRUE;
<a name="l01758"></a>01758                knockoutLimitXmin = HUGE_VAL;
<a name="l01759"></a>01759                knockoutLimitYmin = HUGE_VAL;
<a name="l01760"></a>01760                knockoutLimitXmax = -HUGE_VAL;
<a name="l01761"></a>01761                knockoutLimitYmax = -HUGE_VAL;
<a name="l01762"></a>01762                knockoutLayer = state-&gt;layer;
<a name="l01763"></a>01763                <span class="keywordflow">break</span>;
<a name="l01764"></a>01764            <span class="keywordflow">default</span>:
<a name="l01765"></a>01765               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s, \nunknown variable in knockout"</span>,
<a name="l01766"></a>01766                                     fd-&gt;filename);
<a name="l01767"></a>01767               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01768"></a>01768                                  -1,
<a name="l01769"></a>01769                                   <span class="keywordtype">string</span>,
<a name="l01770"></a>01770                                  <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01771"></a>01771               g_free(<span class="keywordtype">string</span>);
<a name="l01772"></a>01772            }
<a name="l01773"></a>01773            op[0] = gerb_fgetc(fd);
<a name="l01774"></a>01774        }
<a name="l01775"></a>01775        <span class="keywordflow">break</span>;
<a name="l01776"></a>01776     <span class="keywordflow">case</span> A2I(<span class="charliteral">'S'</span>,<span class="charliteral">'R'</span>): <span class="comment">/* Step and Repeat */</span>
<a name="l01777"></a>01777         <span class="comment">/* start by generating a new layer (duplicating previous layer settings */</span>
<a name="l01778"></a>01778         state-&gt;layer = gerbv_image_return_new_layer (state-&gt;layer);
<a name="l01779"></a>01779        op[0] = gerb_fgetc(fd);
<a name="l01780"></a>01780        <span class="keywordflow">if</span> (op[0] == <span class="charliteral">'*'</span>) { <span class="comment">/* Disable previous SR parameters */</span>
<a name="l01781"></a>01781            state-&gt;layer-&gt;stepAndRepeat.X = 1;
<a name="l01782"></a>01782            state-&gt;layer-&gt;stepAndRepeat.Y = 1;
<a name="l01783"></a>01783            state-&gt;layer-&gt;stepAndRepeat.dist_X = 0.0;
<a name="l01784"></a>01784            state-&gt;layer-&gt;stepAndRepeat.dist_Y = 0.0;
<a name="l01785"></a>01785            <span class="keywordflow">break</span>;
<a name="l01786"></a>01786        }
<a name="l01787"></a>01787        <span class="keywordflow">while</span> ((op[0] != <span class="charliteral">'*'</span>)&amp;&amp;(op[0] != EOF)) { 
<a name="l01788"></a>01788            <span class="keywordflow">switch</span> (op[0]) {
<a name="l01789"></a>01789            <span class="keywordflow">case</span> <span class="charliteral">'X'</span>:
<a name="l01790"></a>01790               state-&gt;layer-&gt;stepAndRepeat.X = gerb_fgetint(fd, NULL);
<a name="l01791"></a>01791               <span class="keywordflow">break</span>;
<a name="l01792"></a>01792            <span class="keywordflow">case</span> <span class="charliteral">'Y'</span>:
<a name="l01793"></a>01793               state-&gt;layer-&gt;stepAndRepeat.Y = gerb_fgetint(fd, NULL);
<a name="l01794"></a>01794               <span class="keywordflow">break</span>;
<a name="l01795"></a>01795            <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
<a name="l01796"></a>01796               state-&gt;layer-&gt;stepAndRepeat.dist_X = gerb_fgetdouble(fd) / scale;
<a name="l01797"></a>01797               <span class="keywordflow">break</span>;
<a name="l01798"></a>01798            <span class="keywordflow">case</span> <span class="charliteral">'J'</span>:
<a name="l01799"></a>01799               state-&gt;layer-&gt;stepAndRepeat.dist_Y = gerb_fgetdouble(fd) / scale;
<a name="l01800"></a>01800               <span class="keywordflow">break</span>;
<a name="l01801"></a>01801            <span class="keywordflow">default</span>:
<a name="l01802"></a>01802               <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nstep-and-repeat parameter error\n"</span>,
<a name="l01803"></a>01803                                     fd-&gt;filename);
<a name="l01804"></a>01804               gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01805"></a>01805                                  -1,
<a name="l01806"></a>01806                                   <span class="keywordtype">string</span>,
<a name="l01807"></a>01807                                   <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01808"></a>01808               g_free(<span class="keywordtype">string</span>);
<a name="l01809"></a>01809            }
<a name="l01810"></a>01810            
<a name="l01811"></a>01811            <span class="comment">/*</span>
<a name="l01812"></a>01812 <span class="comment">            * Repeating 0 times in any direction would disable the whole plot, and</span>
<a name="l01813"></a>01813 <span class="comment">            * is probably not intended. At least one other tool (viewmate) seems</span>
<a name="l01814"></a>01814 <span class="comment">            * to interpret 0-time repeating as repeating just once too.</span>
<a name="l01815"></a>01815 <span class="comment">            */</span>
<a name="l01816"></a>01816            <span class="keywordflow">if</span>(state-&gt;layer-&gt;stepAndRepeat.X == 0)
<a name="l01817"></a>01817               state-&gt;layer-&gt;stepAndRepeat.X = 1;
<a name="l01818"></a>01818            <span class="keywordflow">if</span>(state-&gt;layer-&gt;stepAndRepeat.Y == 0)
<a name="l01819"></a>01819               state-&gt;layer-&gt;stepAndRepeat.Y = 1;
<a name="l01820"></a>01820            
<a name="l01821"></a>01821            op[0] = gerb_fgetc(fd);
<a name="l01822"></a>01822        }
<a name="l01823"></a>01823        <span class="keywordflow">break</span>;
<a name="l01824"></a>01824        <span class="comment">/* is this an actual RS274X command??  It isn't explainined in the spec... */</span>
<a name="l01825"></a>01825     <span class="keywordflow">case</span> A2I(<span class="charliteral">'R'</span>,<span class="charliteral">'O'</span>):
<a name="l01826"></a>01826        state-&gt;layer = gerbv_image_return_new_layer (state-&gt;layer);
<a name="l01827"></a>01827        
<a name="l01828"></a>01828        state-&gt;layer-&gt;<a class="code" href="structgerbv__layer__t.html#bb532b1003968400c7a693d39d005f68">rotation</a> = gerb_fgetdouble(fd) * M_PI / 180;
<a name="l01829"></a>01829        op[0] = gerb_fgetc(fd);
<a name="l01830"></a>01830        <span class="keywordflow">if</span> (op[0] != <span class="charliteral">'*'</span>) {
<a name="l01831"></a>01831            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nerror in layer rotation command\n"</span>,
<a name="l01832"></a>01832                                  fd-&gt;filename);
<a name="l01833"></a>01833            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01834"></a>01834                              -1,
<a name="l01835"></a>01835                               <span class="keywordtype">string</span>,
<a name="l01836"></a>01836                              <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01837"></a>01837            g_free(<span class="keywordtype">string</span>);
<a name="l01838"></a>01838        }
<a name="l01839"></a>01839        <span class="keywordflow">break</span>;
<a name="l01840"></a>01840     <span class="keywordflow">default</span>:
<a name="l01841"></a>01841        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nunknown RS-274X extension found %%%c%c%%\n"</span>, 
<a name="l01842"></a>01842                              fd-&gt;filename, op[0], op[1]);
<a name="l01843"></a>01843        gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l01844"></a>01844                           -1,
<a name="l01845"></a>01845                            <span class="keywordtype">string</span>,
<a name="l01846"></a>01846                           <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l01847"></a>01847        g_free(<span class="keywordtype">string</span>);
<a name="l01848"></a>01848     }
<a name="l01849"></a>01849     
<a name="l01850"></a>01850     <span class="keywordflow">return</span>;
<a name="l01851"></a>01851 } <span class="comment">/* parse_rs274x */</span>
<a name="l01852"></a>01852 
<a name="l01853"></a>01853 
<a name="l01854"></a>01854 <span class="comment">/*</span>
<a name="l01855"></a>01855 <span class="comment"> * Stack declarations and operations to be used by the simple engine that</span>
<a name="l01856"></a>01856 <span class="comment"> * executes the parsed aperture macros.</span>
<a name="l01857"></a>01857 <span class="comment"> */</span>
<a name="l01858"></a>01858 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l01859"></a>01859     <span class="keywordtype">double</span> *stack;
<a name="l01860"></a>01860     <span class="keywordtype">int</span> sp;
<a name="l01861"></a>01861 } macro_stack_t;
<a name="l01862"></a>01862 
<a name="l01863"></a>01863 
<a name="l01864"></a>01864 <span class="keyword">static</span> macro_stack_t *
<a name="l01865"></a>01865 new_stack(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stack_size)
<a name="l01866"></a>01866 {
<a name="l01867"></a>01867     macro_stack_t *s;
<a name="l01868"></a>01868 
<a name="l01869"></a>01869     s = (macro_stack_t *) g_new0 (macro_stack_t,1);
<a name="l01870"></a>01870     s-&gt;stack = (<span class="keywordtype">double</span> *) g_new0 (<span class="keywordtype">double</span>, stack_size);
<a name="l01871"></a>01871     s-&gt;sp = 0;
<a name="l01872"></a>01872     <span class="keywordflow">return</span> s;
<a name="l01873"></a>01873 } <span class="comment">/* new_stack */</span>
<a name="l01874"></a>01874 
<a name="l01875"></a>01875 
<a name="l01876"></a>01876 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01877"></a>01877 free_stack(macro_stack_t *s)
<a name="l01878"></a>01878 {
<a name="l01879"></a>01879     <span class="keywordflow">if</span> (s &amp;&amp; s-&gt;stack)
<a name="l01880"></a>01880        free(s-&gt;stack);
<a name="l01881"></a>01881 
<a name="l01882"></a>01882     <span class="keywordflow">if</span> (s)
<a name="l01883"></a>01883        free(s);
<a name="l01884"></a>01884 
<a name="l01885"></a>01885     <span class="keywordflow">return</span>;
<a name="l01886"></a>01886 } <span class="comment">/* free_stack */</span>
<a name="l01887"></a>01887 
<a name="l01888"></a>01888 
<a name="l01889"></a>01889 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01890"></a>01890 push(macro_stack_t *s, <span class="keywordtype">double</span> val)
<a name="l01891"></a>01891 {
<a name="l01892"></a>01892     s-&gt;stack[s-&gt;sp++] = val;
<a name="l01893"></a>01893     <span class="keywordflow">return</span>;
<a name="l01894"></a>01894 } <span class="comment">/* push */</span>
<a name="l01895"></a>01895 
<a name="l01896"></a>01896 
<a name="l01897"></a>01897 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01898"></a>01898 pop(macro_stack_t *s, <span class="keywordtype">double</span> *value)
<a name="l01899"></a>01899 {
<a name="l01900"></a>01900     <span class="comment">/* Check if we try to pop an empty stack */</span>
<a name="l01901"></a>01901     <span class="keywordflow">if</span> (s-&gt;sp == 0) {
<a name="l01902"></a>01902        <span class="keywordflow">return</span> -1;
<a name="l01903"></a>01903     }
<a name="l01904"></a>01904     
<a name="l01905"></a>01905     *value = s-&gt;stack[--s-&gt;sp];
<a name="l01906"></a>01906     <span class="keywordflow">return</span> 0;
<a name="l01907"></a>01907 } <span class="comment">/* pop */</span>
<a name="l01908"></a>01908 
<a name="l01909"></a>01909 
<a name="l01910"></a>01910 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l01911"></a>01911 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01912"></a>01912 simplify_aperture_macro(gerbv_aperture_t *aperture, gdouble scale)
<a name="l01913"></a>01913 {
<a name="l01914"></a>01914     <span class="keyword">const</span> <span class="keywordtype">int</span> extra_stack_size = 10;
<a name="l01915"></a>01915     macro_stack_t *s;
<a name="l01916"></a>01916     gerbv_instruction_t *ip;
<a name="l01917"></a>01917     <span class="keywordtype">int</span> handled = 1, nuf_parameters = 0, i, j, clearOperatorUsed = FALSE;
<a name="l01918"></a>01918     <span class="keywordtype">double</span> *lp; <span class="comment">/* Local copy of parameters */</span>
<a name="l01919"></a>01919     <span class="keywordtype">double</span> tmp[2] = {0.0, 0.0};
<a name="l01920"></a>01920     <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237">gerbv_aperture_type_t</a> type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123799b2da8d27a81aff5e8360e45b42cd84">GERBV_APTYPE_NONE</a>;
<a name="l01921"></a>01921     gerbv_simplified_amacro_t *sam;
<a name="l01922"></a>01922 
<a name="l01923"></a>01923     <span class="keywordflow">if</span> (aperture == NULL)
<a name="l01924"></a>01924        GERB_FATAL_ERROR(<span class="stringliteral">"aperture NULL in simplify aperture macro\n"</span>);
<a name="l01925"></a>01925 
<a name="l01926"></a>01926     <span class="keywordflow">if</span> (aperture-&gt;amacro == NULL)
<a name="l01927"></a>01927        GERB_FATAL_ERROR(<span class="stringliteral">"aperture-&gt;amacro NULL in simplify aperture macro\n"</span>);
<a name="l01928"></a>01928 
<a name="l01929"></a>01929     <span class="comment">/* Allocate stack for VM */</span>
<a name="l01930"></a>01930     s = new_stack(aperture-&gt;amacro-&gt;nuf_push + extra_stack_size);
<a name="l01931"></a>01931     <span class="keywordflow">if</span> (s == NULL) 
<a name="l01932"></a>01932        GERB_FATAL_ERROR(<span class="stringliteral">"malloc stack failed\n"</span>);
<a name="l01933"></a>01933 
<a name="l01934"></a>01934     <span class="comment">/* Make a copy of the parameter list that we can rewrite if necessary */</span>
<a name="l01935"></a>01935     lp = (<span class="keywordtype">double</span> *)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * APERTURE_PARAMETERS_MAX);
<a name="l01936"></a>01936     <span class="keywordflow">if</span> (lp == NULL)
<a name="l01937"></a>01937        GERB_FATAL_ERROR(<span class="stringliteral">"malloc local parameter storage failed\n"</span>);
<a name="l01938"></a>01938 
<a name="l01939"></a>01939     memcpy(lp, aperture-&gt;parameter, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * APERTURE_PARAMETERS_MAX);
<a name="l01940"></a>01940     
<a name="l01941"></a>01941     <span class="keywordflow">for</span>(ip = aperture-&gt;amacro-&gt;program; ip != NULL; ip = ip-&gt;next) {
<a name="l01942"></a>01942        <span class="keywordflow">switch</span>(ip-&gt;opcode) {
<a name="l01943"></a>01943        <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#9fada014b0ba5ff4b89b4797e6621b6c77414a1a821a4a749a7a649ffc0e1ce7">GERBV_OPCODE_NOP</a>:
<a name="l01944"></a>01944            <span class="keywordflow">break</span>;
<a name="l01945"></a>01945        <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#9fada014b0ba5ff4b89b4797e6621b6c63cd15ffeebdf3d21355aa132a07c0e3">GERBV_OPCODE_PUSH</a> :
<a name="l01946"></a>01946            push(s, ip-&gt;data.fval);
<a name="l01947"></a>01947            <span class="keywordflow">break</span>;
<a name="l01948"></a>01948         <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#9fada014b0ba5ff4b89b4797e6621b6c490e7955fcbe704467b78ffe853c5ee7">GERBV_OPCODE_PPUSH</a> :
<a name="l01949"></a>01949            push(s, lp[ip-&gt;data.ival - 1]);
<a name="l01950"></a>01950            <span class="keywordflow">break</span>;
<a name="l01951"></a>01951        <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#9fada014b0ba5ff4b89b4797e6621b6c6197be5cc8215744b9c89359898d6664">GERBV_OPCODE_PPOP</a>:
<a name="l01952"></a>01952            <span class="keywordflow">if</span> (pop(s, &amp;tmp[0]) &lt; 0)
<a name="l01953"></a>01953               GERB_FATAL_ERROR(<span class="stringliteral">"Tried to pop an empty stack"</span>);
<a name="l01954"></a>01954            lp[ip-&gt;data.ival - 1] = tmp[0];
<a name="l01955"></a>01955            <span class="keywordflow">break</span>;
<a name="l01956"></a>01956        <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#9fada014b0ba5ff4b89b4797e6621b6c4d207a62486421dd38120b73cc4b001c">GERBV_OPCODE_ADD</a> :
<a name="l01957"></a>01957            <span class="keywordflow">if</span> (pop(s, &amp;tmp[0]) &lt; 0)
<a name="l01958"></a>01958               GERB_FATAL_ERROR(<span class="stringliteral">"Tried to pop an empty stack"</span>);
<a name="l01959"></a>01959            <span class="keywordflow">if</span> (pop(s, &amp;tmp[1]) &lt; 0)
<a name="l01960"></a>01960               GERB_FATAL_ERROR(<span class="stringliteral">"Tried to pop an empty stack"</span>);
<a name="l01961"></a>01961            push(s, tmp[1] + tmp[0]);
<a name="l01962"></a>01962            <span class="keywordflow">break</span>;
<a name="l01963"></a>01963        <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#9fada014b0ba5ff4b89b4797e6621b6c6bc6030f30a80045422d4460edf4bf3c">GERBV_OPCODE_SUB</a> :
<a name="l01964"></a>01964            <span class="keywordflow">if</span> (pop(s, &amp;tmp[0]) &lt; 0)
<a name="l01965"></a>01965               GERB_FATAL_ERROR(<span class="stringliteral">"Tried to pop an empty stack"</span>);
<a name="l01966"></a>01966            <span class="keywordflow">if</span> (pop(s, &amp;tmp[1]) &lt; 0)
<a name="l01967"></a>01967               GERB_FATAL_ERROR(<span class="stringliteral">"Tried to pop an empty stack"</span>);
<a name="l01968"></a>01968            push(s, tmp[1] - tmp[0]);
<a name="l01969"></a>01969            <span class="keywordflow">break</span>;
<a name="l01970"></a>01970        <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#9fada014b0ba5ff4b89b4797e6621b6cbadd2a040df88693ca48a1fcb8bcba3b">GERBV_OPCODE_MUL</a> :
<a name="l01971"></a>01971            <span class="keywordflow">if</span> (pop(s, &amp;tmp[0]) &lt; 0)
<a name="l01972"></a>01972               GERB_FATAL_ERROR(<span class="stringliteral">"Tried to pop an empty stack"</span>);
<a name="l01973"></a>01973            <span class="keywordflow">if</span> (pop(s, &amp;tmp[1]) &lt; 0)
<a name="l01974"></a>01974               GERB_FATAL_ERROR(<span class="stringliteral">"Tried to pop an empty stack"</span>);
<a name="l01975"></a>01975            push(s, tmp[1] * tmp[0]);
<a name="l01976"></a>01976            <span class="keywordflow">break</span>;
<a name="l01977"></a>01977        <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#9fada014b0ba5ff4b89b4797e6621b6c77714d00c73dac825cba907294e8ec8a">GERBV_OPCODE_DIV</a> :
<a name="l01978"></a>01978            <span class="keywordflow">if</span> (pop(s, &amp;tmp[0]) &lt; 0)
<a name="l01979"></a>01979               GERB_FATAL_ERROR(<span class="stringliteral">"Tried to pop an empty stack"</span>);
<a name="l01980"></a>01980            <span class="keywordflow">if</span> (pop(s, &amp;tmp[1]) &lt; 0)
<a name="l01981"></a>01981               GERB_FATAL_ERROR(<span class="stringliteral">"Tried to pop an empty stack"</span>);
<a name="l01982"></a>01982            push(s, tmp[1] / tmp[0]);
<a name="l01983"></a>01983            <span class="keywordflow">break</span>;
<a name="l01984"></a>01984        <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#9fada014b0ba5ff4b89b4797e6621b6cbae82bab21ab95e4e34239fee87be7c7">GERBV_OPCODE_PRIM</a> :
<a name="l01985"></a>01985            <span class="comment">/* </span>
<a name="l01986"></a>01986 <span class="comment">            * This handles the exposure thing in the aperture macro</span>
<a name="l01987"></a>01987 <span class="comment">            * The exposure is always the first element on stack independent</span>
<a name="l01988"></a>01988 <span class="comment">            * of aperture macro.</span>
<a name="l01989"></a>01989 <span class="comment">            */</span>
<a name="l01990"></a>01990            <span class="keywordflow">switch</span>(ip-&gt;data.ival) {
<a name="l01991"></a>01991            <span class="keywordflow">case</span> 1:
<a name="l01992"></a>01992               dprintf(<span class="stringliteral">"  Aperture macro circle [1] ("</span>);
<a name="l01993"></a>01993               type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e12374aa4d6be02b88c38208a8d57568e0e25">GERBV_APTYPE_MACRO_CIRCLE</a>;
<a name="l01994"></a>01994               nuf_parameters = 4;
<a name="l01995"></a>01995               <span class="keywordflow">break</span>;
<a name="l01996"></a>01996            <span class="keywordflow">case</span> 3:
<a name="l01997"></a>01997               <span class="keywordflow">break</span>;
<a name="l01998"></a>01998            <span class="keywordflow">case</span> 4 :
<a name="l01999"></a>01999               dprintf(<span class="stringliteral">"  Aperture macro outline [4] ("</span>);
<a name="l02000"></a>02000               type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123745da38f5ee1b382588d0990bb2c7a61d">GERBV_APTYPE_MACRO_OUTLINE</a>;
<a name="l02001"></a>02001               <span class="comment">/*</span>
<a name="l02002"></a>02002 <span class="comment">               * Number of parameters are:</span>
<a name="l02003"></a>02003 <span class="comment">               * - number of points defined in entry 1 of the stack + </span>
<a name="l02004"></a>02004 <span class="comment">               *   start point. Times two since it is both X and Y.</span>
<a name="l02005"></a>02005 <span class="comment">               * - Then three more; exposure,  nuf points and rotation.</span>
<a name="l02006"></a>02006 <span class="comment">               */</span>
<a name="l02007"></a>02007               nuf_parameters = ((int)s-&gt;stack[1] + 1) * 2 + 3;
<a name="l02008"></a>02008               <span class="keywordflow">break</span>;
<a name="l02009"></a>02009            <span class="keywordflow">case</span> 5 :
<a name="l02010"></a>02010               dprintf(<span class="stringliteral">"  Aperture macro polygon [5] ("</span>);
<a name="l02011"></a>02011               type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237a102b604a3b05bf6c141edacf5ed1126">GERBV_APTYPE_MACRO_POLYGON</a>;
<a name="l02012"></a>02012               nuf_parameters = 6;
<a name="l02013"></a>02013               <span class="keywordflow">break</span>;
<a name="l02014"></a>02014            <span class="keywordflow">case</span> 6 :
<a name="l02015"></a>02015               dprintf(<span class="stringliteral">"  Aperture macro moir [6] ("</span>);
<a name="l02016"></a>02016               type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237e76651c204dbffde21b0dc5332565e18">GERBV_APTYPE_MACRO_MOIRE</a>;
<a name="l02017"></a>02017               nuf_parameters = 9;
<a name="l02018"></a>02018               <span class="keywordflow">break</span>;
<a name="l02019"></a>02019            <span class="keywordflow">case</span> 7 :
<a name="l02020"></a>02020               dprintf(<span class="stringliteral">"  Aperture macro thermal [7] ("</span>);
<a name="l02021"></a>02021               type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237dabe9b77a94c2120f39baed9ac18df4e">GERBV_APTYPE_MACRO_THERMAL</a>;
<a name="l02022"></a>02022               nuf_parameters = 6;
<a name="l02023"></a>02023               <span class="keywordflow">break</span>;
<a name="l02024"></a>02024            <span class="keywordflow">case</span> 2  :
<a name="l02025"></a>02025            <span class="keywordflow">case</span> 20 :
<a name="l02026"></a>02026               dprintf(<span class="stringliteral">"  Aperture macro line 20/2 ("</span>);
<a name="l02027"></a>02027               type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123705b2b411854f499ec367cba6143dd725">GERBV_APTYPE_MACRO_LINE20</a>;
<a name="l02028"></a>02028               nuf_parameters = 7;
<a name="l02029"></a>02029               <span class="keywordflow">break</span>;
<a name="l02030"></a>02030            <span class="keywordflow">case</span> 21 :
<a name="l02031"></a>02031               dprintf(<span class="stringliteral">"  Aperture macro line 21 ("</span>);
<a name="l02032"></a>02032               type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123706618241ba60c1d2e90a63a13033a419">GERBV_APTYPE_MACRO_LINE21</a>;
<a name="l02033"></a>02033               nuf_parameters = 6;
<a name="l02034"></a>02034               <span class="keywordflow">break</span>;
<a name="l02035"></a>02035            <span class="keywordflow">case</span> 22 :
<a name="l02036"></a>02036               dprintf(<span class="stringliteral">"  Aperture macro line 22 ("</span>);
<a name="l02037"></a>02037               type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237e52e5a1629e8f1e68c29b66eb78e6021">GERBV_APTYPE_MACRO_LINE22</a>;
<a name="l02038"></a>02038               nuf_parameters = 6;
<a name="l02039"></a>02039               <span class="keywordflow">break</span>;
<a name="l02040"></a>02040            <span class="keywordflow">default</span> :
<a name="l02041"></a>02041               handled = 0;
<a name="l02042"></a>02042            }
<a name="l02043"></a>02043 
<a name="l02044"></a>02044            <span class="keywordflow">if</span> (type != <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123799b2da8d27a81aff5e8360e45b42cd84">GERBV_APTYPE_NONE</a>) { 
<a name="l02045"></a>02045               <span class="keywordflow">if</span> (nuf_parameters &gt; APERTURE_PARAMETERS_MAX) {
<a name="l02046"></a>02046                   GERB_COMPILE_ERROR(<span class="stringliteral">"Number of parameters to aperture macro are more than gerbv is able to store\n"</span>);
<a name="l02047"></a>02047               }
<a name="l02048"></a>02048 
<a name="l02049"></a>02049               <span class="comment">/*</span>
<a name="l02050"></a>02050 <span class="comment">               * Create struct for simplified aperture macro and</span>
<a name="l02051"></a>02051 <span class="comment">               * start filling in the blanks.</span>
<a name="l02052"></a>02052 <span class="comment">               */</span>
<a name="l02053"></a>02053               sam = (gerbv_simplified_amacro_t *)malloc(<span class="keyword">sizeof</span>(gerbv_simplified_amacro_t));
<a name="l02054"></a>02054               <span class="keywordflow">if</span> (sam == NULL)
<a name="l02055"></a>02055                   GERB_FATAL_ERROR(<span class="stringliteral">"Failed to malloc simplified aperture macro\n"</span>);
<a name="l02056"></a>02056               sam-&gt;type = type;
<a name="l02057"></a>02057               sam-&gt;next = NULL;
<a name="l02058"></a>02058               memset(sam-&gt;parameter, 0, 
<a name="l02059"></a>02059                      <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) * APERTURE_PARAMETERS_MAX);
<a name="l02060"></a>02060               memcpy(sam-&gt;parameter, s-&gt;stack, 
<a name="l02061"></a>02061                      <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) *  nuf_parameters);
<a name="l02062"></a>02062               
<a name="l02063"></a>02063               <span class="comment">/* convert any mm values to inches */</span>
<a name="l02064"></a>02064               <span class="keywordflow">switch</span> (type) {
<a name="l02065"></a>02065                   <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e12374aa4d6be02b88c38208a8d57568e0e25">GERBV_APTYPE_MACRO_CIRCLE</a>:
<a name="l02066"></a>02066                      <span class="keywordflow">if</span> (fabs(sam-&gt;parameter[0]) &lt; 0.001)
<a name="l02067"></a>02067                          clearOperatorUsed = TRUE;
<a name="l02068"></a>02068                      sam-&gt;parameter[1]/=scale;
<a name="l02069"></a>02069                      sam-&gt;parameter[2]/=scale;
<a name="l02070"></a>02070                      sam-&gt;parameter[3]/=scale;
<a name="l02071"></a>02071                      <span class="keywordflow">break</span>;
<a name="l02072"></a>02072                   <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123745da38f5ee1b382588d0990bb2c7a61d">GERBV_APTYPE_MACRO_OUTLINE</a>:
<a name="l02073"></a>02073                      <span class="keywordflow">if</span> (fabs(sam-&gt;parameter[0]) &lt; 0.001)
<a name="l02074"></a>02074                          clearOperatorUsed = TRUE;
<a name="l02075"></a>02075                      <span class="keywordflow">for</span> (j=2; j&lt;nuf_parameters-1; j++){
<a name="l02076"></a>02076                          sam-&gt;parameter[j]/=scale;
<a name="l02077"></a>02077                      }
<a name="l02078"></a>02078                      <span class="keywordflow">break</span>;
<a name="l02079"></a>02079                   <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237a102b604a3b05bf6c141edacf5ed1126">GERBV_APTYPE_MACRO_POLYGON</a>:
<a name="l02080"></a>02080                      <span class="keywordflow">if</span> (fabs(sam-&gt;parameter[0]) &lt; 0.001)
<a name="l02081"></a>02081                          clearOperatorUsed = TRUE;
<a name="l02082"></a>02082                      sam-&gt;parameter[2]/=scale;
<a name="l02083"></a>02083                      sam-&gt;parameter[3]/=scale;
<a name="l02084"></a>02084                      sam-&gt;parameter[4]/=scale;
<a name="l02085"></a>02085                      <span class="keywordflow">break</span>;
<a name="l02086"></a>02086                   <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237e76651c204dbffde21b0dc5332565e18">GERBV_APTYPE_MACRO_MOIRE</a>:
<a name="l02087"></a>02087                      sam-&gt;parameter[0]/=scale;
<a name="l02088"></a>02088                      sam-&gt;parameter[1]/=scale;
<a name="l02089"></a>02089                      sam-&gt;parameter[2]/=scale;
<a name="l02090"></a>02090                      sam-&gt;parameter[3]/=scale;
<a name="l02091"></a>02091                      sam-&gt;parameter[4]/=scale;
<a name="l02092"></a>02092                      sam-&gt;parameter[6]/=scale;
<a name="l02093"></a>02093                      sam-&gt;parameter[7]/=scale;
<a name="l02094"></a>02094                      <span class="keywordflow">break</span>;
<a name="l02095"></a>02095                   <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237dabe9b77a94c2120f39baed9ac18df4e">GERBV_APTYPE_MACRO_THERMAL</a>:
<a name="l02096"></a>02096                      sam-&gt;parameter[0]/=scale;
<a name="l02097"></a>02097                      sam-&gt;parameter[1]/=scale;
<a name="l02098"></a>02098                      sam-&gt;parameter[2]/=scale;
<a name="l02099"></a>02099                      sam-&gt;parameter[3]/=scale;
<a name="l02100"></a>02100                      sam-&gt;parameter[4]/=scale;
<a name="l02101"></a>02101                      <span class="keywordflow">break</span>;
<a name="l02102"></a>02102                   <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123705b2b411854f499ec367cba6143dd725">GERBV_APTYPE_MACRO_LINE20</a>:
<a name="l02103"></a>02103                      <span class="keywordflow">if</span> (fabs(sam-&gt;parameter[0]) &lt; 0.001)
<a name="l02104"></a>02104                          clearOperatorUsed = TRUE;
<a name="l02105"></a>02105                      sam-&gt;parameter[1]/=scale;
<a name="l02106"></a>02106                      sam-&gt;parameter[2]/=scale;
<a name="l02107"></a>02107                      sam-&gt;parameter[3]/=scale;
<a name="l02108"></a>02108                      sam-&gt;parameter[4]/=scale;
<a name="l02109"></a>02109                      sam-&gt;parameter[5]/=scale;
<a name="l02110"></a>02110                      <span class="keywordflow">break</span>;
<a name="l02111"></a>02111                   <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e123706618241ba60c1d2e90a63a13033a419">GERBV_APTYPE_MACRO_LINE21</a>:
<a name="l02112"></a>02112                   <span class="keywordflow">case</span> <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237e52e5a1629e8f1e68c29b66eb78e6021">GERBV_APTYPE_MACRO_LINE22</a>:
<a name="l02113"></a>02113                      <span class="keywordflow">if</span> (fabs(sam-&gt;parameter[0]) &lt; 0.001)
<a name="l02114"></a>02114                          clearOperatorUsed = TRUE;
<a name="l02115"></a>02115                      sam-&gt;parameter[1]/=scale;
<a name="l02116"></a>02116                      sam-&gt;parameter[2]/=scale;
<a name="l02117"></a>02117                      sam-&gt;parameter[3]/=scale;
<a name="l02118"></a>02118                      sam-&gt;parameter[4]/=scale;
<a name="l02119"></a>02119                      <span class="keywordflow">break</span>;
<a name="l02120"></a>02120                   <span class="keywordflow">default</span>: 
<a name="l02121"></a>02121                      <span class="keywordflow">break</span>;               
<a name="l02122"></a>02122               }
<a name="l02123"></a>02123               <span class="comment">/* </span>
<a name="l02124"></a>02124 <span class="comment">               * Add this simplified aperture macro to the end of the list</span>
<a name="l02125"></a>02125 <span class="comment">               * of simplified aperture macros. If first entry, put it</span>
<a name="l02126"></a>02126 <span class="comment">               * in the top.</span>
<a name="l02127"></a>02127 <span class="comment">               */</span>
<a name="l02128"></a>02128               <span class="keywordflow">if</span> (aperture-&gt;simplified == NULL) {
<a name="l02129"></a>02129                   aperture-&gt;simplified = sam;
<a name="l02130"></a>02130               } <span class="keywordflow">else</span> {
<a name="l02131"></a>02131                   gerbv_simplified_amacro_t *tmp_sam;
<a name="l02132"></a>02132                   tmp_sam = aperture-&gt;simplified;
<a name="l02133"></a>02133                   <span class="keywordflow">while</span> (tmp_sam-&gt;next != NULL) {
<a name="l02134"></a>02134                      tmp_sam = tmp_sam-&gt;next;
<a name="l02135"></a>02135                   }
<a name="l02136"></a>02136                   tmp_sam-&gt;next = sam;
<a name="l02137"></a>02137               }
<a name="l02138"></a>02138 
<a name="l02139"></a>02139 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l02140"></a>02140 <span class="preprocessor"></span>              <span class="keywordflow">for</span> (i = 0; i &lt; nuf_parameters; i++) {
<a name="l02141"></a>02141                   dprintf(<span class="stringliteral">"%f, "</span>, s-&gt;stack[i]);
<a name="l02142"></a>02142               }
<a name="l02143"></a>02143 <span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>
<a name="l02144"></a>02144               dprintf(<span class="stringliteral">")\n"</span>);
<a name="l02145"></a>02145            }
<a name="l02146"></a>02146 
<a name="l02147"></a>02147            <span class="comment">/* </span>
<a name="l02148"></a>02148 <span class="comment">            * Here we reset the stack pointer. It's not general correct</span>
<a name="l02149"></a>02149 <span class="comment">            * correct to do this, but since I know how the compiler works</span>
<a name="l02150"></a>02150 <span class="comment">            * I can do this. The correct way to do this should be to </span>
<a name="l02151"></a>02151 <span class="comment">            * subtract number of used elements in each primitive operation.</span>
<a name="l02152"></a>02152 <span class="comment">            */</span>
<a name="l02153"></a>02153            s-&gt;sp = 0;
<a name="l02154"></a>02154            <span class="keywordflow">break</span>;
<a name="l02155"></a>02155        <span class="keywordflow">default</span> :
<a name="l02156"></a>02156            <span class="keywordflow">break</span>;
<a name="l02157"></a>02157        }
<a name="l02158"></a>02158     }
<a name="l02159"></a>02159     free_stack(s);
<a name="l02160"></a>02160 
<a name="l02161"></a>02161     <span class="comment">/* store a flag to let the renderer know if it should expect any "clear"</span>
<a name="l02162"></a>02162 <span class="comment">       primatives */</span>
<a name="l02163"></a>02163     aperture-&gt;parameter[0]= (gdouble) clearOperatorUsed;
<a name="l02164"></a>02164     <span class="keywordflow">return</span> handled;
<a name="l02165"></a>02165 } <span class="comment">/* simplify_aperture_macro */</span>
<a name="l02166"></a>02166 
<a name="l02167"></a>02167 
<a name="l02168"></a>02168 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l02169"></a>02169 <span class="keyword">static</span> <span class="keywordtype">int</span> 
<a name="l02170"></a>02170 parse_aperture_definition(gerb_file_t *fd, gerbv_aperture_t *aperture,
<a name="l02171"></a>02171                        <a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image, gdouble scale)
<a name="l02172"></a>02172 {
<a name="l02173"></a>02173     <span class="keywordtype">int</span> ano, i;
<a name="l02174"></a>02174     <span class="keywordtype">char</span> *ad;
<a name="l02175"></a>02175     <span class="keywordtype">char</span> *token;
<a name="l02176"></a>02176     gerbv_amacro_t *curr_amacro;
<a name="l02177"></a>02177     gerbv_amacro_t *amacro = image-&gt;<a class="code" href="structgerbv__image__t.html#09fb735cb7cab4951d26104ff1098668">amacro</a>;
<a name="l02178"></a>02178     <a class="code" href="structgerbv__stats__t.html">gerbv_stats_t</a> *stats = image-&gt;<a class="code" href="structgerbv__image__t.html#0d803a4e74d2247e3029b21eda386558">gerbv_stats</a>;
<a name="l02179"></a>02179     gdouble tempHolder;
<a name="l02180"></a>02180     gchar *string;
<a name="l02181"></a>02181     
<a name="l02182"></a>02182     <span class="keywordflow">if</span> (gerb_fgetc(fd) != <span class="charliteral">'D'</span>) {
<a name="l02183"></a>02183        <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Found AD code with no following 'D' in file \n%s\n"</span>, 
<a name="l02184"></a>02184                              fd-&gt;filename);
<a name="l02185"></a>02185        gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l02186"></a>02186                           -1,
<a name="l02187"></a>02187                            <span class="keywordtype">string</span>,
<a name="l02188"></a>02188                           <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);  
<a name="l02189"></a>02189        g_free(<span class="keywordtype">string</span>);
<a name="l02190"></a>02190        <span class="keywordflow">return</span> -1;
<a name="l02191"></a>02191     }
<a name="l02192"></a>02192     
<a name="l02193"></a>02193     <span class="comment">/*</span>
<a name="l02194"></a>02194 <span class="comment">     * Get aperture no</span>
<a name="l02195"></a>02195 <span class="comment">     */</span>
<a name="l02196"></a>02196     ano = gerb_fgetint(fd, NULL);
<a name="l02197"></a>02197     
<a name="l02198"></a>02198     <span class="comment">/*</span>
<a name="l02199"></a>02199 <span class="comment">     * Read in the whole aperture defintion and tokenize it</span>
<a name="l02200"></a>02200 <span class="comment">     */</span>
<a name="l02201"></a>02201     ad = gerb_fgetstring(fd, <span class="charliteral">'*'</span>);
<a name="l02202"></a>02202     token = strtok(ad, <span class="stringliteral">","</span>);
<a name="l02203"></a>02203     
<a name="l02204"></a>02204     <span class="keywordflow">if</span> (strlen(token) == 1) {
<a name="l02205"></a>02205        <span class="keywordflow">switch</span> (token[0]) {
<a name="l02206"></a>02206        <span class="keywordflow">case</span> <span class="charliteral">'C'</span>:
<a name="l02207"></a>02207            aperture-&gt;type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237562331d94d824b3711bd0c8b7296e366">GERBV_APTYPE_CIRCLE</a>;
<a name="l02208"></a>02208            <span class="keywordflow">break</span>;
<a name="l02209"></a>02209        <span class="keywordflow">case</span> <span class="charliteral">'R'</span> :
<a name="l02210"></a>02210            aperture-&gt;type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237aeafcbf11dd893e46930f813e353c27a">GERBV_APTYPE_RECTANGLE</a>;
<a name="l02211"></a>02211            <span class="keywordflow">break</span>;
<a name="l02212"></a>02212        <span class="keywordflow">case</span> <span class="charliteral">'O'</span> :
<a name="l02213"></a>02213            aperture-&gt;type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e12374498025ab88968326d79bab43020469f">GERBV_APTYPE_OVAL</a>;
<a name="l02214"></a>02214            <span class="keywordflow">break</span>;
<a name="l02215"></a>02215        <span class="keywordflow">case</span> <span class="charliteral">'P'</span> :
<a name="l02216"></a>02216            aperture-&gt;type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e12379f80359e7ff5ff5fdf024434ec98fc7d">GERBV_APTYPE_POLYGON</a>;
<a name="l02217"></a>02217            <span class="keywordflow">break</span>;
<a name="l02218"></a>02218        }
<a name="l02219"></a>02219        <span class="comment">/* Here a should a T be defined, but I don't know what it represents */</span>
<a name="l02220"></a>02220     } <span class="keywordflow">else</span> {
<a name="l02221"></a>02221        aperture-&gt;type = <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237555091fa58982b0afde79e6eb51215a7">GERBV_APTYPE_MACRO</a>;
<a name="l02222"></a>02222        <span class="comment">/*</span>
<a name="l02223"></a>02223 <span class="comment">        * In aperture definition, point to the aperture macro </span>
<a name="l02224"></a>02224 <span class="comment">        * used in the defintion</span>
<a name="l02225"></a>02225 <span class="comment">        */</span>
<a name="l02226"></a>02226        curr_amacro = amacro;
<a name="l02227"></a>02227        <span class="keywordflow">while</span> (curr_amacro) {
<a name="l02228"></a>02228            <span class="keywordflow">if</span> ((strlen(curr_amacro-&gt;name) == strlen(token)) &amp;&amp;
<a name="l02229"></a>02229               (strcmp(curr_amacro-&gt;name, token) == 0)) {
<a name="l02230"></a>02230               aperture-&gt;amacro = curr_amacro;
<a name="l02231"></a>02231               <span class="keywordflow">break</span>;
<a name="l02232"></a>02232            }
<a name="l02233"></a>02233            curr_amacro = curr_amacro-&gt;next;
<a name="l02234"></a>02234        }
<a name="l02235"></a>02235     }
<a name="l02236"></a>02236     
<a name="l02237"></a>02237     <span class="comment">/*</span>
<a name="l02238"></a>02238 <span class="comment">     * Parse all parameters</span>
<a name="l02239"></a>02239 <span class="comment">     */</span>
<a name="l02240"></a>02240     <span class="keywordflow">for</span> (token = strtok(NULL, <span class="stringliteral">"X"</span>), i = 0; token != NULL; 
<a name="l02241"></a>02241         token = strtok(NULL, <span class="stringliteral">"X"</span>), i++) {
<a name="l02242"></a>02242        <span class="keywordflow">if</span> (i == APERTURE_PARAMETERS_MAX) {
<a name="l02243"></a>02243            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"In file %s,\nmaximum number of allowed parameters exceeded in aperture %d\n"</span>, 
<a name="l02244"></a>02244                                  fd-&gt;filename, ano);
<a name="l02245"></a>02245            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l02246"></a>02246                               -1,
<a name="l02247"></a>02247                               <span class="keywordtype">string</span>, 
<a name="l02248"></a>02248                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d31e862b571deb98ab0dac738451458d12">GERBV_MESSAGE_ERROR</a>);
<a name="l02249"></a>02249            g_free(<span class="keywordtype">string</span>);
<a name="l02250"></a>02250            <span class="keywordflow">break</span>;
<a name="l02251"></a>02251        }
<a name="l02252"></a>02252        errno = 0;
<a name="l02253"></a>02253 
<a name="l02254"></a>02254        tempHolder = strtod(token, NULL);
<a name="l02255"></a>02255        <span class="comment">/* convert any MM values to inches */</span>
<a name="l02256"></a>02256        <span class="comment">/* don't scale polygon angles or side numbers, or macro parmaeters */</span>
<a name="l02257"></a>02257        <span class="keywordflow">if</span> (!(((aperture-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e12379f80359e7ff5ff5fdf024434ec98fc7d">GERBV_APTYPE_POLYGON</a>) &amp;&amp; ((i==1) || (i==2)))||
<a name="l02258"></a>02258               (aperture-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237555091fa58982b0afde79e6eb51215a7">GERBV_APTYPE_MACRO</a>))) {
<a name="l02259"></a>02259            tempHolder /= scale;
<a name="l02260"></a>02260        }
<a name="l02261"></a>02261        
<a name="l02262"></a>02262        aperture-&gt;parameter[i] = tempHolder;
<a name="l02263"></a>02263        <span class="keywordflow">if</span> (errno) {
<a name="l02264"></a>02264            <span class="keywordtype">string</span> = g_strdup_printf(<span class="stringliteral">"Failed to read all parameters exceeded in aperture %d\n"</span>, ano);
<a name="l02265"></a>02265            gerbv_stats_add_error(stats-&gt;<a class="code" href="structgerbv__stats__t.html#9ab39063b9449f7ee77ed0fdff1913e9">error_list</a>,
<a name="l02266"></a>02266                               -1,
<a name="l02267"></a>02267                               <span class="keywordtype">string</span>,
<a name="l02268"></a>02268                               <a class="code" href="gerbv_8h.html#748b853fa7b95afbc791e995e43150d3bbb704bfe4710b05d75a865e59fe4e72">GERBV_MESSAGE_WARNING</a>);
<a name="l02269"></a>02269            g_free(<span class="keywordtype">string</span>);
<a name="l02270"></a>02270             aperture-&gt;parameter[i] = 0.0;
<a name="l02271"></a>02271         }
<a name="l02272"></a>02272     }
<a name="l02273"></a>02273     
<a name="l02274"></a>02274     aperture-&gt;nuf_parameters = i;
<a name="l02275"></a>02275     
<a name="l02276"></a>02276     gerb_ungetc(fd);
<a name="l02277"></a>02277 
<a name="l02278"></a>02278     <span class="keywordflow">if</span> (aperture-&gt;type == <a class="code" href="gerbv_8h.html#c99303749c4afdc6a24eafbfa37e1237555091fa58982b0afde79e6eb51215a7">GERBV_APTYPE_MACRO</a>) {
<a name="l02279"></a>02279        dprintf(<span class="stringliteral">"Simplifying aperture %d using aperture macro \"%s\"\n"</span>, ano,
<a name="l02280"></a>02280               aperture-&gt;amacro-&gt;name);
<a name="l02281"></a>02281        simplify_aperture_macro(aperture, scale);
<a name="l02282"></a>02282        dprintf(<span class="stringliteral">"Done simplifying\n"</span>);
<a name="l02283"></a>02283     }
<a name="l02284"></a>02284     
<a name="l02285"></a>02285     g_free(ad);
<a name="l02286"></a>02286     
<a name="l02287"></a>02287     <span class="keywordflow">return</span> ano;
<a name="l02288"></a>02288 } <span class="comment">/* parse_aperture_definition */</span>
<a name="l02289"></a>02289 
<a name="l02290"></a>02290 
<a name="l02291"></a>02291 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l02292"></a>02292 <span class="keyword">static</span> <span class="keywordtype">void</span> 
<a name="l02293"></a>02293 calc_cirseg_sq(<span class="keyword">struct</span> <a class="code" href="structgerbv__net.html">gerbv_net</a> *net, <span class="keywordtype">int</span> cw, 
<a name="l02294"></a>02294               <span class="keywordtype">double</span> delta_cp_x, <span class="keywordtype">double</span> delta_cp_y)
<a name="l02295"></a>02295 {
<a name="l02296"></a>02296     <span class="keywordtype">double</span> d1x, d1y, d2x, d2y;
<a name="l02297"></a>02297     <span class="keywordtype">double</span> alfa, beta;
<a name="l02298"></a>02298     <span class="keywordtype">int</span> quadrant = 0;
<a name="l02299"></a>02299 
<a name="l02300"></a>02300     
<a name="l02301"></a>02301     <span class="comment">/*</span>
<a name="l02302"></a>02302 <span class="comment">     * Quadrant detection (based on ccw, converted below if cw)</span>
<a name="l02303"></a>02303 <span class="comment">     *  Y ^</span>
<a name="l02304"></a>02304 <span class="comment">     *   /!\</span>
<a name="l02305"></a>02305 <span class="comment">     *    !</span>
<a name="l02306"></a>02306 <span class="comment">     *    ----&gt;X</span>
<a name="l02307"></a>02307 <span class="comment">     */</span>
<a name="l02308"></a>02308     <span class="keywordflow">if</span> (net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> &gt; net-&gt;<a class="code" href="structgerbv__net.html#5e221f216fd25e09358da99191821d25">stop_x</a>)
<a name="l02309"></a>02309        <span class="comment">/* 1st and 2nd quadrant */</span>
<a name="l02310"></a>02310        <span class="keywordflow">if</span> (net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> &lt; net-&gt;<a class="code" href="structgerbv__net.html#322975adbc33c1a642fb5e8cfadd2eb7">stop_y</a>)
<a name="l02311"></a>02311            quadrant = 1;
<a name="l02312"></a>02312        <span class="keywordflow">else</span>
<a name="l02313"></a>02313            quadrant = 2;
<a name="l02314"></a>02314     <span class="keywordflow">else</span>
<a name="l02315"></a>02315        <span class="comment">/* 3rd and 4th quadrant */</span>
<a name="l02316"></a>02316        <span class="keywordflow">if</span> (net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> &gt; net-&gt;<a class="code" href="structgerbv__net.html#322975adbc33c1a642fb5e8cfadd2eb7">stop_y</a>)
<a name="l02317"></a>02317            quadrant = 3;
<a name="l02318"></a>02318        <span class="keywordflow">else</span>
<a name="l02319"></a>02319            quadrant = 4;
<a name="l02320"></a>02320 
<a name="l02321"></a>02321     <span class="comment">/* </span>
<a name="l02322"></a>02322 <span class="comment">     * If clockwise, rotate quadrant</span>
<a name="l02323"></a>02323 <span class="comment">     */</span>
<a name="l02324"></a>02324     <span class="keywordflow">if</span> (cw) {
<a name="l02325"></a>02325        <span class="keywordflow">switch</span> (quadrant) {
<a name="l02326"></a>02326        <span class="keywordflow">case</span> 1 : 
<a name="l02327"></a>02327            quadrant = 3;
<a name="l02328"></a>02328            <span class="keywordflow">break</span>;
<a name="l02329"></a>02329        <span class="keywordflow">case</span> 2 : 
<a name="l02330"></a>02330            quadrant = 4;
<a name="l02331"></a>02331            <span class="keywordflow">break</span>;
<a name="l02332"></a>02332        <span class="keywordflow">case</span> 3 : 
<a name="l02333"></a>02333            quadrant = 1;
<a name="l02334"></a>02334            <span class="keywordflow">break</span>;
<a name="l02335"></a>02335        <span class="keywordflow">case</span> 4 : 
<a name="l02336"></a>02336            quadrant = 2;
<a name="l02337"></a>02337            <span class="keywordflow">break</span>;
<a name="l02338"></a>02338        <span class="keywordflow">default</span> : 
<a name="l02339"></a>02339            GERB_COMPILE_ERROR(<span class="stringliteral">"Unknow quadrant value while converting to cw\n"</span>);
<a name="l02340"></a>02340        }
<a name="l02341"></a>02341     }
<a name="l02342"></a>02342 
<a name="l02343"></a>02343     <span class="comment">/*</span>
<a name="l02344"></a>02344 <span class="comment">     * Calculate arc center point</span>
<a name="l02345"></a>02345 <span class="comment">     */</span>
<a name="l02346"></a>02346     <span class="keywordflow">switch</span> (quadrant) {
<a name="l02347"></a>02347     <span class="keywordflow">case</span> 1 :
<a name="l02348"></a>02348        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_x = net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> - delta_cp_x;
<a name="l02349"></a>02349        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_y = net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> - delta_cp_y;
<a name="l02350"></a>02350        <span class="keywordflow">break</span>;
<a name="l02351"></a>02351     <span class="keywordflow">case</span> 2 :
<a name="l02352"></a>02352        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_x = net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> + delta_cp_x;
<a name="l02353"></a>02353        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_y = net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> - delta_cp_y;
<a name="l02354"></a>02354        <span class="keywordflow">break</span>;
<a name="l02355"></a>02355     <span class="keywordflow">case</span> 3 : 
<a name="l02356"></a>02356        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_x = net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> + delta_cp_x;
<a name="l02357"></a>02357        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_y = net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> + delta_cp_y;
<a name="l02358"></a>02358        <span class="keywordflow">break</span>;
<a name="l02359"></a>02359     <span class="keywordflow">case</span> 4 :
<a name="l02360"></a>02360        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_x = net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> - delta_cp_x;
<a name="l02361"></a>02361        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_y = net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> + delta_cp_y;
<a name="l02362"></a>02362        <span class="keywordflow">break</span>;
<a name="l02363"></a>02363     <span class="keywordflow">default</span> :
<a name="l02364"></a>02364        GERB_COMPILE_ERROR(<span class="stringliteral">"Strange quadrant : %d\n"</span>, quadrant);
<a name="l02365"></a>02365     }
<a name="l02366"></a>02366 
<a name="l02367"></a>02367     <span class="comment">/*</span>
<a name="l02368"></a>02368 <span class="comment">     * Some good values </span>
<a name="l02369"></a>02369 <span class="comment">     */</span>
<a name="l02370"></a>02370     d1x = fabs(net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> - net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_x);
<a name="l02371"></a>02371     d1y = fabs(net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> - net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_y);
<a name="l02372"></a>02372     d2x = fabs(net-&gt;<a class="code" href="structgerbv__net.html#5e221f216fd25e09358da99191821d25">stop_x</a> - net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_x);
<a name="l02373"></a>02373     d2y = fabs(net-&gt;<a class="code" href="structgerbv__net.html#322975adbc33c1a642fb5e8cfadd2eb7">stop_y</a> - net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_y);
<a name="l02374"></a>02374 
<a name="l02375"></a>02375     alfa = atan2(d1y, d1x);
<a name="l02376"></a>02376     beta = atan2(d2y, d2x);
<a name="l02377"></a>02377 
<a name="l02378"></a>02378     <span class="comment">/*</span>
<a name="l02379"></a>02379 <span class="comment">     * Avoid divide by zero when sin(0) = 0 and cos(90) = 0</span>
<a name="l02380"></a>02380 <span class="comment">     */</span>
<a name="l02381"></a>02381     net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;width = alfa &lt; beta ? 
<a name="l02382"></a>02382        2 * (d1x / cos(alfa)) : 2 * (d2x / cos(beta));
<a name="l02383"></a>02383     net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;height = alfa &gt; beta ? 
<a name="l02384"></a>02384        2 * (d1y / sin(alfa)) : 2 * (d2y / sin(beta));
<a name="l02385"></a>02385 
<a name="l02386"></a>02386     <span class="keywordflow">if</span> (alfa &lt; 0.000001 &amp;&amp; beta &lt; 0.000001) {
<a name="l02387"></a>02387        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;height = 0;
<a name="l02388"></a>02388     }
<a name="l02389"></a>02389 
<a name="l02390"></a>02390 <span class="preprocessor">#define RAD2DEG(a) (a * 180 / M_PI) </span>
<a name="l02391"></a>02391 <span class="preprocessor"></span>    
<a name="l02392"></a>02392     <span class="keywordflow">switch</span> (quadrant) {
<a name="l02393"></a>02393     <span class="keywordflow">case</span> 1 :
<a name="l02394"></a>02394        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle1 = RAD2DEG(alfa);
<a name="l02395"></a>02395        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 = RAD2DEG(beta);
<a name="l02396"></a>02396        <span class="keywordflow">break</span>;
<a name="l02397"></a>02397     <span class="keywordflow">case</span> 2 :
<a name="l02398"></a>02398        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle1 = 180.0 - RAD2DEG(alfa);
<a name="l02399"></a>02399        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 = 180.0 - RAD2DEG(beta);
<a name="l02400"></a>02400        <span class="keywordflow">break</span>;
<a name="l02401"></a>02401     <span class="keywordflow">case</span> 3 : 
<a name="l02402"></a>02402        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle1 = 180.0 + RAD2DEG(alfa);
<a name="l02403"></a>02403        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 = 180.0 + RAD2DEG(beta);
<a name="l02404"></a>02404        <span class="keywordflow">break</span>;
<a name="l02405"></a>02405     <span class="keywordflow">case</span> 4 :
<a name="l02406"></a>02406        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle1 = 360.0 - RAD2DEG(alfa);
<a name="l02407"></a>02407        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 = 360.0 - RAD2DEG(beta);
<a name="l02408"></a>02408        <span class="keywordflow">break</span>;
<a name="l02409"></a>02409     <span class="keywordflow">default</span> :
<a name="l02410"></a>02410        GERB_COMPILE_ERROR(<span class="stringliteral">"Strange quadrant : %d\n"</span>, quadrant);
<a name="l02411"></a>02411     }
<a name="l02412"></a>02412 
<a name="l02413"></a>02413     <span class="keywordflow">if</span> (net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;width &lt; 0.0)
<a name="l02414"></a>02414        GERB_COMPILE_WARNING(<span class="stringliteral">"Negative width [%f] in quadrant %d [%f][%f]\n"</span>, 
<a name="l02415"></a>02415                           net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;width, quadrant, alfa, beta);
<a name="l02416"></a>02416     
<a name="l02417"></a>02417     <span class="keywordflow">if</span> (net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;height &lt; 0.0)
<a name="l02418"></a>02418        GERB_COMPILE_WARNING(<span class="stringliteral">"Negative height [%f] in quadrant %d [%f][%f]\n"</span>, 
<a name="l02419"></a>02419                           net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;height, quadrant, RAD2DEG(alfa), RAD2DEG(beta));
<a name="l02420"></a>02420 
<a name="l02421"></a>02421     <span class="keywordflow">return</span>;
<a name="l02422"></a>02422 
<a name="l02423"></a>02423 } <span class="comment">/* calc_cirseg_sq */</span>
<a name="l02424"></a>02424 
<a name="l02425"></a>02425 
<a name="l02426"></a>02426 <span class="comment">/* ------------------------------------------------------------------ */</span>
<a name="l02427"></a>02427 <span class="keyword">static</span> <span class="keywordtype">void</span> 
<a name="l02428"></a>02428 calc_cirseg_mq(<span class="keyword">struct</span> <a class="code" href="structgerbv__net.html">gerbv_net</a> *net, <span class="keywordtype">int</span> cw, 
<a name="l02429"></a>02429               <span class="keywordtype">double</span> delta_cp_x, <span class="keywordtype">double</span> delta_cp_y)
<a name="l02430"></a>02430 {
<a name="l02431"></a>02431     <span class="keywordtype">double</span> d1x, d1y, d2x, d2y;
<a name="l02432"></a>02432     <span class="keywordtype">double</span> alfa, beta;
<a name="l02433"></a>02433 
<a name="l02434"></a>02434     net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_x = net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> + delta_cp_x;
<a name="l02435"></a>02435     net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_y = net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> + delta_cp_y;
<a name="l02436"></a>02436 
<a name="l02437"></a>02437     <span class="comment">/*</span>
<a name="l02438"></a>02438 <span class="comment">     * Some good values </span>
<a name="l02439"></a>02439 <span class="comment">     */</span>
<a name="l02440"></a>02440     d1x = net-&gt;<a class="code" href="structgerbv__net.html#6189e51df43105b4225cb6324f34d87f">start_x</a> - net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_x;
<a name="l02441"></a>02441     d1y = net-&gt;<a class="code" href="structgerbv__net.html#8a34ce21baab8da09fdf6301f211ff6f">start_y</a> - net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_y;
<a name="l02442"></a>02442     d2x = net-&gt;<a class="code" href="structgerbv__net.html#5e221f216fd25e09358da99191821d25">stop_x</a> - net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_x;
<a name="l02443"></a>02443     d2y = net-&gt;<a class="code" href="structgerbv__net.html#322975adbc33c1a642fb5e8cfadd2eb7">stop_y</a> - net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;cp_y;
<a name="l02444"></a>02444     
<a name="l02445"></a>02445     alfa = atan2(d1y, d1x);
<a name="l02446"></a>02446     beta = atan2(d2y, d2x);
<a name="l02447"></a>02447 
<a name="l02448"></a>02448     net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;width = sqrt(delta_cp_x*delta_cp_x + delta_cp_y*delta_cp_y);
<a name="l02449"></a>02449     net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;width *= 2.0;
<a name="l02450"></a>02450     net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;height = net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;width;
<a name="l02451"></a>02451 
<a name="l02452"></a>02452     net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle1 = RAD2DEG(alfa);
<a name="l02453"></a>02453     net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 = RAD2DEG(beta);
<a name="l02454"></a>02454 
<a name="l02455"></a>02455     <span class="comment">/*</span>
<a name="l02456"></a>02456 <span class="comment">     * Make sure it's always positive angles</span>
<a name="l02457"></a>02457 <span class="comment">     */</span>
<a name="l02458"></a>02458     <span class="keywordflow">if</span> (net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle1 &lt; 0.0) {
<a name="l02459"></a>02459        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle1 += 360.0;
<a name="l02460"></a>02460        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 += 360.0;
<a name="l02461"></a>02461     }
<a name="l02462"></a>02462 
<a name="l02463"></a>02463     <span class="keywordflow">if</span> (net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 &lt; 0.0) 
<a name="l02464"></a>02464        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 += 360.0;
<a name="l02465"></a>02465 
<a name="l02466"></a>02466     <span class="keywordflow">if</span>(net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 == 0.0) 
<a name="l02467"></a>02467        net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 = 360.0;
<a name="l02468"></a>02468 
<a name="l02469"></a>02469     <span class="comment">/*</span>
<a name="l02470"></a>02470 <span class="comment">     * This is a sanity check for angles after the nature of atan2.</span>
<a name="l02471"></a>02471 <span class="comment">     * If cw we must make sure angle1-angle2 are always positive,</span>
<a name="l02472"></a>02472 <span class="comment">     * If ccw we must make sure angle2-angle1 are always negative.</span>
<a name="l02473"></a>02473 <span class="comment">     * We should really return one angle and the difference as GTK</span>
<a name="l02474"></a>02474 <span class="comment">     * uses them. But what the heck, it works for me.</span>
<a name="l02475"></a>02475 <span class="comment">     */</span>
<a name="l02476"></a>02476     <span class="keywordflow">if</span> (cw) {
<a name="l02477"></a>02477        <span class="keywordflow">if</span> (net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle1 &lt;= net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2)
<a name="l02478"></a>02478            net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 -= 360.0;
<a name="l02479"></a>02479     } <span class="keywordflow">else</span> {
<a name="l02480"></a>02480        <span class="keywordflow">if</span> (net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle1 &gt;= net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2)
<a name="l02481"></a>02481            net-&gt;<a class="code" href="structgerbv__net.html#d3b4aebb1c8b89627580795063c7cf75">cirseg</a>-&gt;angle2 += 360.0;
<a name="l02482"></a>02482     }
<a name="l02483"></a>02483 
<a name="l02484"></a>02484     <span class="keywordflow">return</span>;
<a name="l02485"></a>02485 } <span class="comment">/* calc_cirseg_mq */</span>
<a name="l02486"></a>02486 
<a name="l02487"></a>02487 
<a name="l02488"></a>02488 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02489"></a>02489 gerber_update_any_running_knockout_measurements (<a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image)
<a name="l02490"></a>02490 {
<a name="l02491"></a>02491     <span class="keywordflow">if</span> (knockoutMeasure) {
<a name="l02492"></a>02492        knockoutLayer-&gt;<a class="code" href="structgerbv__layer__t.html#6f96208e1a15cfa9f0c1d2ac3c5cd7fe">knockout</a>.lowerLeftX = knockoutLimitXmin;
<a name="l02493"></a>02493        knockoutLayer-&gt;<a class="code" href="structgerbv__layer__t.html#6f96208e1a15cfa9f0c1d2ac3c5cd7fe">knockout</a>.lowerLeftY = knockoutLimitYmin;
<a name="l02494"></a>02494        knockoutLayer-&gt;<a class="code" href="structgerbv__layer__t.html#6f96208e1a15cfa9f0c1d2ac3c5cd7fe">knockout</a>.width = knockoutLimitXmax - knockoutLimitXmin;
<a name="l02495"></a>02495        knockoutLayer-&gt;<a class="code" href="structgerbv__layer__t.html#6f96208e1a15cfa9f0c1d2ac3c5cd7fe">knockout</a>.height = knockoutLimitYmax - knockoutLimitYmin;
<a name="l02496"></a>02496        knockoutMeasure = FALSE;
<a name="l02497"></a>02497     }
<a name="l02498"></a>02498 }
<a name="l02499"></a>02499 
<a name="l02500"></a>02500 
<a name="l02501"></a>02501 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02502"></a>02502 gerber_calculate_final_justify_effects(<a class="code" href="structgerbv__image__t.html">gerbv_image_t</a> *image)
<a name="l02503"></a>02503 {
<a name="l02504"></a>02504     gdouble translateA = 0.0, translateB = 0.0;
<a name="l02505"></a>02505     
<a name="l02506"></a>02506     <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#50bcbb6c1aa5d238dd9b8a5084ad8e66">imageJustifyTypeA</a> != GERBV_JUSTIFY_NOJUSTIFY) {
<a name="l02507"></a>02507        <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#50bcbb6c1aa5d238dd9b8a5084ad8e66">imageJustifyTypeA</a> == GERBV_JUSTIFY_CENTERJUSTIFY)
<a name="l02508"></a>02508            translateA = (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a> - image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a>) / 2.0;
<a name="l02509"></a>02509        <span class="keywordflow">else</span>
<a name="l02510"></a>02510            translateA = -image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a>;
<a name="l02511"></a>02511     }
<a name="l02512"></a>02512     <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#fd754e52ac7c4b3447b95c25bd488ef1">imageJustifyTypeB</a> != GERBV_JUSTIFY_NOJUSTIFY) {
<a name="l02513"></a>02513        <span class="keywordflow">if</span> (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#fd754e52ac7c4b3447b95c25bd488ef1">imageJustifyTypeB</a> == GERBV_JUSTIFY_CENTERJUSTIFY)
<a name="l02514"></a>02514            translateB = (image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a> - image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a>) / 2.0;
<a name="l02515"></a>02515        <span class="keywordflow">else</span>
<a name="l02516"></a>02516            translateB = -image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a>;
<a name="l02517"></a>02517     }
<a name="l02518"></a>02518 
<a name="l02519"></a>02519     <span class="comment">/* update the min/max values so the autoscale function can correctly</span>
<a name="l02520"></a>02520 <span class="comment">       centered a justified image */</span>
<a name="l02521"></a>02521     image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a> += translateA+ image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#678ef7ef39870fbf61a1d1f2e2d685d6">imageJustifyOffsetA</a>;
<a name="l02522"></a>02522     image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a> += translateA+ image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#678ef7ef39870fbf61a1d1f2e2d685d6">imageJustifyOffsetA</a>;
<a name="l02523"></a>02523     image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a> += translateB+ image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#c2188f9f81755e4147be0d43a7f70b7c">imageJustifyOffsetB</a>;
<a name="l02524"></a>02524     image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a> += translateB+ image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#c2188f9f81755e4147be0d43a7f70b7c">imageJustifyOffsetB</a>;
<a name="l02525"></a>02525  
<a name="l02526"></a>02526     <span class="comment">/* store the absolute offset for the justify so we can quickly offset</span>
<a name="l02527"></a>02527 <span class="comment">       the rendered picture during drawing */</span>
<a name="l02528"></a>02528     image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#44842bb09b536e7e2a11b6cb26d9aca5">imageJustifyOffsetActualA</a> = translateA + 
<a name="l02529"></a>02529        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#678ef7ef39870fbf61a1d1f2e2d685d6">imageJustifyOffsetA</a>;
<a name="l02530"></a>02530     image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#980c20b8a389bc4a7cacf533689ef9a7">imageJustifyOffsetActualB</a> = translateB + 
<a name="l02531"></a>02531        image-&gt;<a class="code" href="structgerbv__image__t.html#ee14513fd6f516dc355948f49a10375c">info</a>-&gt;<a class="code" href="structgerbv__image__info.html#c2188f9f81755e4147be0d43a7f70b7c">imageJustifyOffsetB</a>;
<a name="l02532"></a>02532 } <span class="comment">/* gerber_calculate_final_justify_effects */</span>
<a name="l02533"></a>02533 
<a name="l02534"></a>02534 
<a name="l02535"></a>02535 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02536"></a>02536 gerber_update_min_and_max(<a class="code" href="structgerbv__image__info.html">gerbv_image_info_t</a> *info, gdouble repeatX, gdouble repeatY,
<a name="l02537"></a>02537                        gdouble x, gdouble y, gdouble apertureSizeX1,
<a name="l02538"></a>02538                        gdouble apertureSizeX2,gdouble apertureSizeY1,
<a name="l02539"></a>02539                        gdouble apertureSizeY2)
<a name="l02540"></a>02540 {
<a name="l02541"></a>02541     gdouble ourX1 = x - apertureSizeX1, ourY1 = y - apertureSizeY1;
<a name="l02542"></a>02542     gdouble ourX2 = x + apertureSizeX2, ourY2 = y + apertureSizeY2;
<a name="l02543"></a>02543     
<a name="l02544"></a>02544     <span class="keywordflow">if</span> (repeatX &gt; 0)
<a name="l02545"></a>02545        ourX2 += repeatX;
<a name="l02546"></a>02546     <span class="keywordflow">if</span> (repeatY &gt; 0)
<a name="l02547"></a>02547        ourY2 += repeatY;
<a name="l02548"></a>02548     
<a name="l02549"></a>02549 <span class="preprocessor">#ifndef RENDER_USING_GDK</span>
<a name="l02550"></a>02550 <span class="preprocessor"></span>    <span class="comment">/* transform the point to the final rendered position, accounting</span>
<a name="l02551"></a>02551 <span class="comment">       for any scaling, offsets, mirroring, etc */</span>
<a name="l02552"></a>02552     <span class="comment">/* NOTE: we need to already add/subtract in the aperture size since</span>
<a name="l02553"></a>02553 <span class="comment">       the final rendering may be scaled */</span>
<a name="l02554"></a>02554     cairo_matrix_transform_point (&amp;currentMatrix, &amp;ourX1, &amp;ourY1);
<a name="l02555"></a>02555     cairo_matrix_transform_point (&amp;currentMatrix, &amp;ourX2, &amp;ourY2);
<a name="l02556"></a>02556 <span class="preprocessor">#endif</span>
<a name="l02557"></a>02557 <span class="preprocessor"></span>
<a name="l02558"></a>02558     <span class="comment">/* check both points against the min/max, since depending on the rotation,</span>
<a name="l02559"></a>02559 <span class="comment">       mirroring, etc, either point could possibly be a min or max */</span>
<a name="l02560"></a>02560     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a> &gt; ourX1)
<a name="l02561"></a>02561        info-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a> = ourX1;
<a name="l02562"></a>02562     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a> &gt; ourX2)
<a name="l02563"></a>02563        info-&gt;<a class="code" href="structgerbv__image__info.html#0fad6186a591051fbba6e0a7edf48f35">min_x</a> = ourX2;
<a name="l02564"></a>02564     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a> &lt; ourX1)
<a name="l02565"></a>02565        info-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a> = ourX1;
<a name="l02566"></a>02566     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a> &lt; ourX2)
<a name="l02567"></a>02567        info-&gt;<a class="code" href="structgerbv__image__info.html#07aaa71dfb30b7a1c3e88ce75af66800">max_x</a> = ourX2;
<a name="l02568"></a>02568     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a> &gt; ourY1)
<a name="l02569"></a>02569        info-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a> = ourY1;
<a name="l02570"></a>02570     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a> &gt; ourY2)
<a name="l02571"></a>02571        info-&gt;<a class="code" href="structgerbv__image__info.html#7e636c4e5c25f993eadac7a649bdb29b">min_y</a> = ourY2;
<a name="l02572"></a>02572     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a> &lt; ourY1)
<a name="l02573"></a>02573        info-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a> = ourY1;
<a name="l02574"></a>02574     <span class="keywordflow">if</span>(info-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a> &lt; ourY2)
<a name="l02575"></a>02575        info-&gt;<a class="code" href="structgerbv__image__info.html#941183edd18cbf427b4703608eeb0f02">max_y</a> = ourY2;
<a name="l02576"></a>02576 
<a name="l02577"></a>02577     <span class="keywordflow">if</span> (knockoutMeasure) {
<a name="l02578"></a>02578        <span class="keywordflow">if</span>(knockoutLimitXmin &gt; ourX1)
<a name="l02579"></a>02579            knockoutLimitXmin = ourX1;
<a name="l02580"></a>02580        <span class="keywordflow">if</span>(knockoutLimitXmin &gt; ourX2)
<a name="l02581"></a>02581            knockoutLimitXmin = ourX2;
<a name="l02582"></a>02582        <span class="keywordflow">if</span>(knockoutLimitXmax &lt; ourX1)
<a name="l02583"></a>02583            knockoutLimitXmax = ourX1;
<a name="l02584"></a>02584        <span class="keywordflow">if</span>(knockoutLimitXmax &lt; ourX2)
<a name="l02585"></a>02585            knockoutLimitXmax = ourX2;
<a name="l02586"></a>02586        <span class="keywordflow">if</span>(knockoutLimitYmin &gt; ourY1)
<a name="l02587"></a>02587            knockoutLimitYmin = ourY1;
<a name="l02588"></a>02588        <span class="keywordflow">if</span>(knockoutLimitYmin &gt; ourY2)
<a name="l02589"></a>02589            knockoutLimitYmin = ourY2;
<a name="l02590"></a>02590        <span class="keywordflow">if</span>(knockoutLimitYmax &lt; ourY1)
<a name="l02591"></a>02591            knockoutLimitYmax = ourY1;
<a name="l02592"></a>02592        <span class="keywordflow">if</span>(knockoutLimitYmax &lt; ourY2)
<a name="l02593"></a>02593            knockoutLimitYmax = ourY2; 
<a name="l02594"></a>02594     }
<a name="l02595"></a>02595 } <span class="comment">/* gerber_update_min_and_max */</span>
<a name="l02596"></a>02596 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Tue Aug 19 00:14:48 2008 for gerbv by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
